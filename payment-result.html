<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ä»˜æ¬¾çµæœï½œReelMind</title>
<meta name="description" content="ReelMind ä»˜æ¬¾çµæœé é¢">
<meta name="theme-color" content="#2563EB" />
<!-- Favicon: ä½¿ç”¨ SVG data URIï¼Œé¿å… 404 éŒ¯èª¤ -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ¬%3C/text%3E%3C/svg%3E" />
<!-- HTTP å¿«å–æ¨™é ­ -->
<meta http-equiv="Cache-Control" content="public, max-age=3600">
<meta http-equiv="Expires" content="3600">
<style>
:root{
  --bg:#F8FAFC; --ink:#0F172A; --sub:#475569; --line:#E2E8F0; --card:#FFFFFF;
  --blue:#2563EB; --blue-deep:#1D4ED8; --ok:#16A34A; --warn:#F59E0B; --red:#DC2626;
  --shadow:0 16px 40px rgba(2,6,23,.08); --r:16px;
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased}
body{font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC",Segoe UI,Roboto,Arial}
a{text-decoration:none;color:inherit}
.wrap{width:100%} .safe{max-width:1120px;margin:0 auto;padding:0 16px}
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);border:1px solid var(--line)}
.card .body{padding:40px 20px;text-align:center}
.h2{font-size:28px;font-weight:900;margin:0 0 12px}
.sub{color:var(--sub);margin:0 0 24px;font-size:16px;line-height:1.6}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 24px;border-radius:999px;font-weight:700;cursor:pointer;border:none;font-size:16px;transition:all 0.2s}
.btn.blue{background:var(--blue);color:white}
.btn.blue:hover{background:var(--blue-deep)}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
.btn.ghost:hover{background:var(--bg)}
.row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:24px}
.icon{font-size:64px;margin-bottom:20px}
.success .icon{color:var(--ok)}
.error .icon{color:var(--red)}
.pending .icon{color:var(--warn)}
</style>
</head>
<body>
<main class="wrap" style="padding:60px 0">
  <div class="safe">
    <section class="card" id="resultCard">
      <div class="body">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </section>
  </div>
</main>

<script>
  // HTML è½‰ç¾©å‡½æ•¸ï¼ˆé˜²æ­¢ XSSï¼‰
  function escapeHtml(text) {
    if (text == null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }
  
  // å¾ URL åƒæ•¸è®€å–ä»˜æ¬¾çµæœ
  const urlParams = new URLSearchParams(window.location.search);
  const status = urlParams.get('status') || urlParams.get('RtnCode');
  const orderId = urlParams.get('order_id') || urlParams.get('MerchantTradeNo') || urlParams.get('orderId');
  const message = urlParams.get('message') || urlParams.get('RtnMsg');
  const paymentType = urlParams.get('PaymentType');
  
  // è½‰ç¾©æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥ï¼ˆé˜²æ­¢ XSSï¼‰
  const safeOrderId = orderId ? escapeHtml(orderId) : '';
  const safeMessage = message ? escapeHtml(message) : '';
  const safePaymentType = paymentType ? escapeHtml(paymentType) : '';
  
  const card = document.getElementById('resultCard');
  const body = card.querySelector('.body');
  
  // åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹
  // ECPay çš„ RtnCode: 1=æˆåŠŸ, å…¶ä»–=å¤±æ•—
  // å¦‚æœæ²’æœ‰ status åƒæ•¸ä½†æœ‰ orderIdï¼Œå˜—è©¦æŸ¥è©¢è¨‚å–®ç‹€æ…‹
  const isSuccess = status === 'success' || status === '1';
  const isPending = status === 'pending' || paymentType === 'ATM' || paymentType === 'CVS';
  const hasNoStatus = !status && !paymentType; // æ²’æœ‰ç‹€æ…‹åƒæ•¸
  const isError = !isSuccess && !isPending && !hasNoStatus;
  
  if (isSuccess) {
    // ä»˜æ¬¾æˆåŠŸ
    body.className = 'body success';
    body.innerHTML = `
      <div class="icon">âœ…</div>
      <h2 class="h2" style="color: var(--ok);">ä»˜æ¬¾æˆåŠŸï¼</h2>
      <p class="sub">æ„Ÿè¬æ‚¨çš„è¨‚é–±ï¼Œæ‚¨çš„å¸³è™Ÿå·²é–‹é€šä½¿ç”¨æ¬Šé™</p>
      ${safeOrderId ? `<p style="color: var(--sub); font-size: 14px; margin-bottom: 24px;">è¨‚å–®ç·¨è™Ÿï¼š${safeOrderId}</p>` : ''}
      <div class="row">
        <button class="btn blue" onclick="window.location.href='/'">é–‹å§‹ä½¿ç”¨</button>
        <button class="btn ghost" onclick="window.location.href='subscription.html'">è¿”å›è¨‚é–±é </button>
      </div>
    `;
    
    // å˜—è©¦æ›´æ–°è¨‚é–±ç‹€æ…‹ï¼ˆå¦‚æœå·²ç™»å…¥ï¼‰
    updateSubscriptionStatus();
    
  } else if (isPending) {
    // å¾…ä»˜æ¬¾ï¼ˆATM/è¶…å•†ï¼‰
    body.className = 'body pending';
    const paymentTypeText = safePaymentType === 'ATM' ? 'ATM' : 'è¶…å•†';
    body.innerHTML = `
      <div class="icon">â³</div>
      <h2 class="h2" style="color: var(--warn);">å¾…å®Œæˆä»˜æ¬¾</h2>
      <p class="sub">æ‚¨é¸æ“‡äº† ${paymentTypeText} ä»˜æ¬¾æ–¹å¼ï¼Œè«‹å®Œæˆä»˜æ¬¾å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•é–‹é€šæ‚¨çš„å¸³è™Ÿ</p>
      ${safeOrderId ? `<p style="color: var(--sub); font-size: 14px; margin-bottom: 24px;">è¨‚å–®ç·¨è™Ÿï¼š${safeOrderId}</p>` : ''}
      <div class="row">
        <button class="btn blue" onclick="checkOrderStatus('${safeOrderId.replace(/'/g, "\\'")}')">æª¢æŸ¥ä»˜æ¬¾ç‹€æ…‹</button>
        <button class="btn ghost" onclick="window.location.href='subscription.html'">è¿”å›è¨‚é–±é </button>
      </div>
    `;
    
  } else if (hasNoStatus && safeOrderId) {
    // æ²’æœ‰ç‹€æ…‹åƒæ•¸ä½†æœ‰è¨‚å–®ç·¨è™Ÿï¼Œå˜—è©¦æŸ¥è©¢è¨‚å–®ç‹€æ…‹
    body.className = 'body pending';
    body.innerHTML = `
      <div class="icon">â³</div>
      <h2 class="h2" style="color: var(--warn);">æŸ¥è©¢è¨‚å–®ç‹€æ…‹</h2>
      <p class="sub">æ­£åœ¨æŸ¥è©¢æ‚¨çš„è¨‚å–®ç‹€æ…‹...</p>
      ${safeOrderId ? `<p style="color: var(--sub); font-size: 14px; margin-bottom: 24px;">è¨‚å–®ç·¨è™Ÿï¼š${safeOrderId}</p>` : ''}
      <div class="row">
        <button class="btn blue" onclick="checkOrderStatus('${safeOrderId.replace(/'/g, "\\'")}')">æª¢æŸ¥ä»˜æ¬¾ç‹€æ…‹</button>
        <button class="btn ghost" onclick="window.location.href='subscription.html'">è¿”å›è¨‚é–±é </button>
      </div>
    `;
    // è‡ªå‹•å˜—è©¦æŸ¥è©¢è¨‚å–®ç‹€æ…‹
    if (safeOrderId) {
      setTimeout(() => {
        checkOrderStatus(safeOrderId);
      }, 500);
    }
  } else {
    // ä»˜æ¬¾å¤±æ•—æˆ–æœªçŸ¥ç‹€æ…‹
    body.className = 'body error';
    body.innerHTML = `
      <div class="icon">âŒ</div>
      <h2 class="h2" style="color: var(--red);">${hasNoStatus ? 'ç„¡æ³•ç¢ºèªä»˜æ¬¾ç‹€æ…‹' : 'ä»˜æ¬¾å¤±æ•—'}</h2>
      <p class="sub">${safeMessage || (hasNoStatus ? 'è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœç¢ºèªè¨‚å–®ç‹€æ…‹' : 'ä»˜æ¬¾éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœ')}</p>
      ${safeOrderId ? `<p style="color: var(--sub); font-size: 14px; margin-bottom: 24px;">è¨‚å–®ç·¨è™Ÿï¼š${safeOrderId}</p>` : ''}
      <div class="row">
        ${safeOrderId ? `<button class="btn blue" onclick="checkOrderStatus('${safeOrderId.replace(/'/g, "\\'")}')">æª¢æŸ¥ä»˜æ¬¾ç‹€æ…‹</button>` : ''}
        <button class="btn blue" onclick="window.location.href='subscription.html'">${hasNoStatus ? 'è¿”å›è¨‚é–±é ' : 'é‡æ–°è¨‚é–±'}</button>
        <button class="btn ghost" onclick="window.location.href='/'">è¿”å›é¦–é </button>
      </div>
    `;
  }
  
  // æ›´æ–°è¨‚é–±ç‹€æ…‹
  async function updateSubscriptionStatus() {
    try {
      const token = localStorage.getItem('ipPlanningToken');
      if (!token) return;
      
      // å˜—è©¦é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡è¨Šä»¥æ›´æ–°è¨‚é–±ç‹€æ…‹
      const response = await fetch('https://aivideobackend.zeabur.app/api/auth/me', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const userInfo = await response.json();
        if (userInfo.is_subscribed) {
          // æ›´æ–°æœ¬åœ°å„²å­˜çš„ç”¨æˆ¶è³‡è¨Š
          const userStr = localStorage.getItem('ipPlanningUser');
          if (userStr) {
            const user = JSON.parse(userStr);
            user.is_subscribed = true;
            localStorage.setItem('ipPlanningUser', JSON.stringify(user));
          }
        }
      }
    } catch (error) {
      console.error('æ›´æ–°è¨‚é–±ç‹€æ…‹å¤±æ•—:', error);
    }
  }
  
  // Toast é€šçŸ¥å‡½æ•¸ï¼ˆå¦‚æœ common.js æœªè¼‰å…¥ï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆï¼‰
  function showToast(message, duration = 3000) {
    if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
      window.ReelMindCommon.showToast(message, duration);
      return;
    }
    // é™ç´šæ–¹æ¡ˆï¼šå‰µå»ºç°¡å–®çš„ toast
    let toastEl = document.getElementById('toast');
    if (!toastEl) {
      toastEl = document.createElement('div');
      toastEl.id = 'toast';
      toastEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1f2937;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: opacity 0.3s;
        max-width: 400px;
        word-wrap: break-word;
      `;
      document.body.appendChild(toastEl);
    }
    toastEl.textContent = message;
    toastEl.style.display = 'block';
    toastEl.style.opacity = '1';
    setTimeout(() => {
      toastEl.style.opacity = '0';
      setTimeout(() => {
        toastEl.style.display = 'none';
      }, 300);
    }, duration);
  }
  
  // æª¢æŸ¥è¨‚å–®ç‹€æ…‹ï¼ˆç”¨æ–¼ ATM/è¶…å•†ä»˜æ¬¾ï¼‰
  // æ”¯æ´å·²ç™»å…¥å’Œæœªç™»å…¥ç”¨æˆ¶
  async function checkOrderStatus(orderId) {
    if (!orderId) {
      showToast('ç„¡æ³•æŸ¥è©¢è¨‚å–®ç‹€æ…‹', 3000);
      return;
    }
    
    try {
      const token = localStorage.getItem('ipPlanningToken') || '';
      
      // å¦‚æœå·²ç™»å…¥ï¼Œä½¿ç”¨ç”¨æˆ¶è¨‚å–® API
      if (token) {
        const response = await fetch(`https://aivideobackend.zeabur.app/api/user/orders`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const order = data.orders?.find(o => o.order_id === orderId);
          
          if (order) {
            if (order.payment_status === 'paid') {
              showToast('âœ… ä»˜æ¬¾æˆåŠŸï¼æ‚¨çš„å¸³è™Ÿå·²é–‹é€š', 3000);
              setTimeout(() => {
                window.location.href = '/';
              }, 1500);
            } else {
              showToast('â³ å°šæœªå®Œæˆä»˜æ¬¾ï¼Œè«‹å®Œæˆä»˜æ¬¾å¾Œå†è©¦', 3000);
            }
          } else {
            showToast('æ‰¾ä¸åˆ°è¨‚å–®è³‡è¨Š', 3000);
          }
        } else {
          showToast('ç„¡æ³•æŸ¥è©¢è¨‚å–®ç‹€æ…‹', 3000);
        }
      } else {
        // æœªç™»å…¥ç”¨æˆ¶ï¼šæç¤ºç™»å…¥æˆ–ç¨å¾Œå†è©¦
        showToast('è«‹å…ˆç™»å…¥ä»¥æŸ¥è©¢è¨‚å–®ç‹€æ…‹ï¼Œæˆ–ç¨å¾Œå†è©¦', 4000);
      }
    } catch (error) {
      console.error('æª¢æŸ¥è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
      showToast('æª¢æŸ¥è¨‚å–®ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 3000);
    }
  }
</script>
</body>
</html>

