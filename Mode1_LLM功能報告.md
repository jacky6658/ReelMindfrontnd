# Mode1 LLM 功能完整報告

## 📋 目錄
1. [RAG 搜索機制](#rag-搜索機制)
2. [記憶系統](#記憶系統)
3. [LLM 工作流程](#llm-工作流程)
4. [功能清單](#功能清單)
5. [技術架構](#技術架構)

---

## 🔍 RAG 搜索機制

### 觸發條件
RAG（Retrieval-Augmented Generation）搜索會在**每次用戶發送訊息時自動觸發**，無需手動操作。

### 啟用條件（需全部滿足）
1. ✅ **用戶已登入**：有有效的 `user_id`
2. ✅ **有 API Key**：用戶的 Gemini key 或系統的 Gemini key
3. ✅ **有查詢內容**：用戶訊息、主題、定位等至少有一個
4. ✅ **有已索引的內容**：用戶之前保存過腳本或 IP 規劃結果

### 搜索流程
```
用戶發送訊息
    ↓
後端自動組合查詢關鍵字（訊息 + 主題 + 定位）
    ↓
使用向量搜索在資料庫中查找相關內容
    ↓
最多返回 3 個最相關的結果
    ↓
將結果整合到 prompt 中供 LLM 參考
    ↓
LLM 生成回應（參考相關歷史內容）
```

### BYOK（Bring Your Own Key）支援
- **優先使用用戶的 Gemini key**：如果用戶在 userDB 中插入了自己的 Gemini API Key，RAG 會優先使用用戶的 key
- **回退機制**：如果用戶沒有 Gemini key（例如只有 GPT key），RAG 會使用系統的 Gemini key
- **成本優化**：使用用戶的 key 可以節省系統成本

### 搜索內容類型
- `script`：用戶保存的腳本
- `ip_planning`：用戶保存的 IP 規劃結果

---

## 🧠 記憶系統

### 短期記憶（STM - Short-Term Memory）

#### 觸發時機
每次用戶發送訊息時自動載入

#### 內容範圍
- **最近 5-10 輪對話**（根據 `conversation_type` 過濾）
- **僅包含 `ip_planning` 類型的對話**
- 用於提供當前會話的上下文

#### 過濾機制
```python
# 後端自動過濾（app.py:3435-3451）
if body.conversation_type:
    filtered_turns = [
        turn for turn in memory.get("recent_turns", [])
        if turn.get("metadata", {}).get("conversation_type") == body.conversation_type
    ]
```

### 長期記憶（LTM - Long-Term Memory）

#### 觸發時機
每次用戶發送訊息時自動載入

#### 內容範圍
- **跨會話的長期記憶**（根據 `conversation_type` 過濾）
- 包含用戶的：
  - 帳號定位
  - 選題方向
  - 歷史對話摘要
  - 個人化資訊

#### 過濾機制
```python
# 後端自動過濾（app.py:3460-3461）
conversation_type = body.conversation_type or None
ltm_memory = get_user_memory(user_id, conversation_type) if user_id else ""
```

---

## ⚙️ LLM 工作流程

### 不是「一個口令一個動作」
Mode1 的 LLM **不是簡單的命令執行器**，而是會：

1. **自動搜索資料庫（RAG）**
   - 查找用戶之前保存的相關內容
   - 參考歷史腳本和 IP 規劃結果

2. **自動讀取記憶（STM + LTM）**
   - 了解用戶的歷史對話
   - 記住用戶的個人資訊和偏好

3. **智能整合資訊**
   - 結合 RAG 結果、記憶、知識庫
   - 生成個性化和上下文相關的回應

### 完整工作流程
```
用戶發送訊息
    ↓
前端：sendMode1Message()
    ↓
後端：/api/chat/stream
    ↓
1. 載入短期記憶（STM）- 最近對話
    ↓
2. 載入長期記憶（LTM）- 跨會話記憶
    ↓
3. RAG 搜索相關內容（如果啟用）
    ↓
4. 組合增強版 prompt
   - 知識庫
   - STM 上下文
   - LTM 記憶
   - RAG 檢索結果
   - 用戶當前設定
    ↓
5. 調用 LLM 生成回應
    ↓
6. 流式返回結果給前端
    ↓
7. 保存對話到 STM 和 LTM
```

---

## 🎯 功能清單

### 1. 對話功能

#### 深度對話建立 IP 人設
- 與 AI 進行多輪對話
- 記錄用戶的背景、專長、價值觀
- 建立完整的 IP 個人檔案

#### 智能記憶
- **記住用戶說過的話**：STM 記錄最近對話
- **跨會話記憶**：LTM 保存長期資訊
- **上下文理解**：基於對話歷史提供建議

#### 個性化回應
- 根據用戶的歷史對話調整回應
- 避免重複詢問已回答的問題
- 推進對話進展

### 2. 生成功能

#### 帳號定位分析
生成內容包含：
- **目標受眾**：清楚說明目標受眾是誰
- **傳達目標**：說明想要達成的目標（例如：進群、portally、建立品牌等）
- **帳號定位**：用一句話清楚說明帳號定位
- **內容方向**：描述主要內容方向
- **風格調性**：說明帳號的風格和調性
- **差異化優勢**：說明與其他帳號的差異化優勢

#### 選題方向與影片類型配比
- **表格格式呈現**：使用 Markdown 表格
- **動態調整配比**：根據帳號定位動態調整，不使用固定配比
- **內容策略矩陣**：參考知識庫中的「內容策略矩陣」邏輯
- **自創類型**：如果用戶主題不符合範例類別，根據邏輯自創新類型

表格欄位：
- 影片類型
- 佔比
- 目的
- 內容方向

#### 一週腳本生成
生成 7 天的短影音腳本，每支腳本包含：
- **主題標題**：用一句話清楚說明這支影片的主題
- **開場鉤子**：吸引人的開場
- **核心內容**：2-3 句說明影片要傳達的價值
- **行動呼籲**：引導觀眾採取行動
- **畫面描述**：描述畫面應該呈現什麼
- **發佈文案**：適合社群媒體的文案

表格欄位：
- 日期
- 主題
- 時間
- 段落
- 台詞
- 畫面描述
- 字幕文字
- 音效與轉場

### 3. 快速按鈕功能

#### IP Profile
- **查看已保存的 IP Profile**：如果有，直接顯示
- **生成新的 IP Profile**：如果沒有，發送訊息給 LLM 生成
- 基於之前的對話內容生成

#### 14天規劃
- **檢查已保存的規劃**：如果有且與當前 IP Profile 匹配，直接顯示
- **重新生成**：如果沒有或不匹配，發送訊息給 LLM 重新生成
- 根據最新的帳號定位和對話內容生成

#### 今日腳本
- 發送訊息給 LLM
- LLM 會詢問用戶選擇腳本結構（A/B/C/D/E）
- 根據選擇的結構生成今日腳本

#### 換腳本結構
- 讓 LLM 列出所有腳本結構（A/B/C/D/E）
- 說明每個結構的特點
- 讓用戶選擇要使用的結構

#### 重新定位
- **完全重新開始**：忽略之前所有的對話內容、帳號定位結果和長期記憶
- 從頭開始詢問：
  1. 目標受眾是誰？
  2. 想要達成的目標是什麼？
  3. 主要使用的平台是什麼？
  4. 偏好的內容風格是什麼？
- 生成全新的、獨立的帳號定位

### 4. 一鍵生成功能

#### 一鍵生成全部
- 同時生成三個內容：
  1. 帳號定位
  2. 選題方向（影片類型配比）
  3. 一週腳本
- 適合快速取得完整規劃

#### 個別生成
- 可依序生成：
  1. 帳號定位
  2. 選題方向
  3. 一週腳本
- 適合需要逐步調整的用戶

### 5. 自動保存功能

#### 觸發條件
- 用戶在對話中輸入「儲存」或「保存」
- 後端檢測到關鍵字後，發送 `save_request` SSE 事件
- 前端自動調用 `saveMode1Result()`

#### 保存內容
- 帳號定位
- 選題方向
- 一週腳本

#### 保存位置
- 後端資料庫：`ip_planning_results` 表
- 前端顯示：創作者資料庫 → IP人設規劃結果

### 6. 過往紀錄功能

#### 查看歷史結果
- 在「生成結果」Modal 中查看所有已保存的生成結果
- 每個結果都可以：
  - 展開查看完整內容
  - 使用此結果到生成區域
  - 匯出為 CSV 檔案

---

## 🏗️ 技術架構

### 前端（mode1.js）

#### 主要函數
- `sendMode1Message(message, conversationType)`: 發送訊息給 LLM
- `loadUserMemory()`: 載入用戶記憶（STM + LTM）
- `handleQuickButton(type)`: 處理快速按鈕點擊
- `generateMode1All()`: 一鍵生成全部
- `saveMode1Result()`: 保存生成結果
- `recordMode1ConversationMessage()`: 記錄對話到長期記憶

#### API 端點
- `/api/chat/stream`: 流式對話（SSE）
- `/api/user/memory/full/{user_id}`: 獲取完整記憶
- `/api/ip-planning/save`: 保存 IP 規劃結果
- `/api/ip-planning/my`: 獲取已保存的結果

### 後端（app.py）

#### 主要端點
- `POST /api/chat/stream`: 流式對話端點
  - 載入 STM 和 LTM
  - RAG 搜索相關內容
  - 組合增強版 prompt
  - 調用 LLM 生成回應
  - 保存對話到 STM 和 LTM

#### 記憶系統
- **STM（memory.py）**：
  - `add_turn()`: 添加對話輪次
  - `get_context_for_prompt()`: 獲取上下文
  - `_format_context_from_memory()`: 格式化記憶為上下文

- **LTM（app.py）**：
  - `get_user_memory()`: 獲取長期記憶
  - `save_conversation_summary()`: 保存對話摘要

#### RAG 系統（rag.py）
- `RAGSystem.search_relevant_content()`: 搜索相關內容
- `RAGSystem.format_retrieved_content()`: 格式化檢索結果
- `get_rag_instance()`: 獲取 RAG 實例（支援 BYOK）

### Prompt 構建（prompt_builder.py）

#### 增強版 Prompt 結構
1. **系統提示詞**：角色定義和核心原則
2. **當前用戶設定**：平台、主題、定位、時長、風格
3. **長期記憶（LTM）**：跨會話記憶
4. **短期記憶（STM）**：當前會話記憶
5. **RAG 檢索內容**：相關歷史內容
6. **知識庫**：短影音知識庫

---

## 📊 數據流程圖

```
┌─────────────┐
│   用戶輸入   │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│  sendMode1Message│
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ /api/chat/stream│
└──────┬──────────┘
       │
       ├──► 載入 STM（最近對話）
       ├──► 載入 LTM（長期記憶）
       ├──► RAG 搜索（相關內容）
       └──► 組合 Prompt
            │
            ▼
       ┌─────────┐
       │   LLM   │
       └────┬────┘
            │
            ▼
       ┌─────────┐
       │ 流式回應 │
       └────┬────┘
            │
            ▼
       ┌─────────┐
       │ 保存記憶 │
       └─────────┘
```

---

## 🔐 安全與隱私

### API Key 管理
- **加密存儲**：使用 Fernet 對稱加密
- **BYOK 支援**：用戶可以使用自己的 API Key
- **優先級**：用戶 Key > 系統 Key

### 記憶隱私
- **用戶隔離**：每個用戶的記憶完全隔離
- **類型過濾**：根據 `conversation_type` 過濾記憶
- **加密傳輸**：使用 HTTPS

---

## 📝 總結

Mode1 的 LLM 是一個**智能、記憶化、個性化的 AI 助手**，它會：

1. ✅ **自動搜索資料庫**（RAG）查找相關歷史內容
2. ✅ **自動讀取記憶**（STM + LTM）了解用戶背景
3. ✅ **智能整合資訊**生成個性化回應
4. ✅ **記住對話歷史**避免重複詢問
5. ✅ **生成專業內容**（帳號定位、選題方向、腳本）
6. ✅ **支援快速操作**（快速按鈕、一鍵生成）
7. ✅ **自動保存功能**（檢測「儲存」關鍵字）

**不是簡單的命令執行器，而是會思考、記憶、學習的 AI 顧問！**

---

*報告生成時間：2025-01-17*
*版本：v1.0*

