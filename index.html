<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    
    <!-- Favicon 引用 -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="assets/images/favicon.ico" type="image/x-icon">
    <!-- Web Manifest (for Android Chrome) -->
    <link rel="manifest" href="assets/images/site.webmanifest">
    <!-- Mask Icon (for Safari pinned tabs) - 如果存在此文件 -->
    <!-- <link rel="mask-icon" href="assets/images/safari-pinned-tab.svg" color="#5bbad5"> -->
    <!-- Windows Tile Color -->
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="assets/images/android-chrome-192x192.png">
    <!-- Theme Color (for browser UI, e.g., Android Chrome) -->
    <meta name="theme-color" content="#ffffff">
    
    <style>
      /* 防止頁面載入時顯示內容，等 JavaScript 載入完成後再顯示 */
      body:not(.page-loaded) {
        opacity: 0;
        visibility: hidden;
        overflow: hidden;
      }
      body.page-loaded {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease-in;
      }
      /* Fallback: 如果 3 秒後 JavaScript 仍未執行，強制顯示頁面 */
      body:not(.page-loaded)::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        z-index: 999999;
        animation: showPageFallback 3s forwards;
      }
      @keyframes showPageFallback {
        0%, 99% { opacity: 0; }
        100% { opacity: 1; display: none; }
      }
    </style>
    
    <!-- 立即處理授權連結（不依賴 DOMContentLoaded） -->
    <script>
      (function() {
        'use strict';
        try {
          // 立即檢查 URL 中的 token 參數
          const urlParams = new URLSearchParams(window.location.search);
          const token = urlParams.get('token');
          
          if (token) {
            // 檢查是否已登入
            const currentToken = sessionStorage.getItem('ipPlanningToken');
            
            if (!currentToken) {
              // 未登入，先顯示 popup-callback.html 動畫，然後跳轉到 Google 登入
              // 保存 activation_token 到 sessionStorage，供 popup-callback.html 使用
              sessionStorage.setItem('pendingActivationToken', token);
              // 跳轉到 popup-callback.html，它會自動處理登入流程
              window.location.replace('/auth/popup-callback.html?activation_token=' + encodeURIComponent(token));
              return;
            } else {
              // 已登入，標記需要處理授權（等 DOMContentLoaded 時處理）
              sessionStorage.setItem('pendingActivationToken', token);
            }
          }
          
          // 確保頁面在 3 秒後顯示（fallback）
          setTimeout(function() {
            if (document.body && !document.body.classList.contains('page-loaded')) {
              console.warn('⚠️ JavaScript 載入超時，強制顯示頁面');
              document.body.classList.add('page-loaded');
            }
          }, 3000);
        } catch (e) {
          console.error('❌ 授權連結處理錯誤:', e);
          // 發生錯誤時，確保頁面能顯示
          setTimeout(function() {
            if (document.body) {
              document.body.classList.add('page-loaded');
            }
          }, 1000);
        }
      })();
    </script>
    
    <!-- Primary SEO Meta Tags -->
    <title>ReelMind | AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音</title>
    <meta name="title" content="ReelMind | AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音" />
    <meta name="description" content="ReelMind AI 短影音智能體： 專為 IG、TikTok、Shorts 打造。AI 生成爆款腳本、精準帳號定位，從靈感枯竭到內容量產，效率提升 70%。每天不到 NT$66，立即開始您的 台灣在地化 短影音行銷！" />
    <meta name="keywords" content="AI短影音,AI智能體,AI腳本,AI帳號定位,短影音製作,IG短影音,TikTok短影音,YouTube Shorts,短影音腳本,短影音靈感,短影音工具,AI短影音平台,一鍵生成,AI短影音生成器,短影音內容創作,台北短影音,台中短影音,高雄短影音,台灣短影音,短影音行銷,短影音腳本生成,AI短影音助手,短影音創作者工具" />
    <meta name="author" content="ReelMind AI" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="zh-Hant" />
    <meta name="revisit-after" content="7 days" />
    
    <!-- Google Search Console Verification -->
    <!-- TODO: 請從 Google Search Console 獲取 HTML 標籤驗證的 meta tag 並替換下面的內容 -->
    <!-- 格式：<meta name="google-site-verification" content="您的驗證碼" /> -->
    <meta name="google-site-verification" content="請從SearchConsole獲取驗證碼並替換此處" />
    
    <link rel="canonical" href="https://reelmind.aijob.com.tw/" />
    
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://www.youtube.com" />
    
    <!-- GEO / Location Meta Tags -->
    <meta name="geo.region" content="TW" />
    <meta name="geo.placename" content="台灣" />
    <meta name="geo.position" content="25.0330;121.5654" />
    <meta name="ICBM" content="25.0330, 121.5654" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://reelmind.aijob.com.tw/" />
    <meta property="og:title" content="ReelMind | AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音" />
    <meta property="og:description" content="ReelMind AI 短影音智能體：專為 IG、TikTok、Shorts 打造。AI 生成爆款腳本、精準帳號定位，從靈感枯竭到內容量產，效率提升 70%。每天不到 NT$66，立即開始您的台灣在地化短影音行銷！" />
    <meta property="og:image" content="https://reelmind.aijob.com.tw/assets/images/ReelMind.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="ReelMind AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:locale" content="zh_TW" />
    <meta property="og:site_name" content="ReelMind" />
    <meta property="og:video" content="https://www.youtube.com/embed/Pw1_MRIJ9GA" />
    <meta property="og:video:type" content="text/html" />
    <meta property="og:video:width" content="1280" />
    <meta property="og:video:height" content="720" />
    <meta property="og:video:secure_url" content="https://www.youtube.com/embed/Pw1_MRIJ9GA" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://reelmind.aijob.com.tw/" />
    <meta name="twitter:title" content="ReelMind | AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音" />
    <meta name="twitter:description" content="ReelMind AI 短影音智能體：專為 IG、TikTok、Shorts 打造。AI 生成爆款腳本、精準帳號定位，從靈感枯竭到內容量產，效率提升 70%。" />
    <meta name="twitter:image" content="https://reelmind.aijob.com.tw/assets/images/ReelMind.png" />
    <meta name="twitter:image:alt" content="ReelMind AI 短影音智能體 - AI 生成腳本 × AI 帳號定位 × 爆款短影音" />
    <meta name="twitter:site" content="@ReelMind" />
    <meta name="twitter:creator" content="@ReelMind" />
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#2563EB" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ReelMind" />
    
    <!-- HTTP 快取標頭 -->
    <meta http-equiv="Cache-Control" content="public, max-age=3600">
    <meta http-equiv="Expires" content="3600">
    
    <!-- Favicon: ReelMind Logo -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="assets/images/android-chrome-512x512.png" />
    <link rel="shortcut icon" href="assets/images/favicon.ico" />
    
    <!-- SEO 結構化資料 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ReelMind｜AI 短影音平台",
      "applicationCategory": "Multimedia",
      "operatingSystem": "Web",
      "inLanguage": "zh-Hant",
      "areaServed": "TW",
      "description": "AI 短影音智能體：AI 生成腳本、AI 帳號定位、AI 智能體一鍵生成爆款短影音。支援 IG、TikTok、YouTube Shorts。服務地區：台北、台中、高雄。每天不到 NT$66，全年 AI 幫你帳號定位、生成靈感選題與爆款腳本。",
      "url": "https://reelmind.aijob.com.tw/",
      "applicationSubCategory": "AI 短影音工具",
      "keywords": "AI短影音,AI智能體,AI生成腳本,AI帳號定位,短影音製作",
      "provider": {
        "@type": "Organization",
        "name": "ReelMind AI",
        "url": "https://reelmind.aijob.com.tw/",
        "address": {
          "@type": "PostalAddress",
          "addressCountry": "TW",
          "addressRegion": "台灣"
        }
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "150"
      },
      "offers": [
        {
          "@type": "Offer",
          "name": "Creator Pro 雙年方案",
          "price": "9900",
          "priceCurrency": "TWD",
          "availability": "https://schema.org/InStock"
        },
        {
          "@type": "Offer",
          "name": "Script Lite 入門版",
          "price": "8280",
          "priceCurrency": "TWD",
          "availability": "https://schema.org/InStock"
        }
      ]
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        { 
          "@type": "Question", 
          "name": "什麼是 AI 短影音？", 
          "acceptedAnswer": { 
            "@type": "Answer", 
            "text": "AI 依產業與平台，自動生成題材、腳本、口播、分鏡，縮短製作時間並提升上片頻率，支援台北、台中、高雄等地區的創作者。" 
          } 
        },
        { 
          "@type": "Question", 
          "name": "AI 生成腳本怎麼運作？", 
          "acceptedAnswer": { 
            "@type": "Answer", 
            "text": "輸入主題與平台，系統輸出開場 Hook、橋段重點與 CTA，並能自動在地化語氣，適合台灣市場的創作者使用。" 
          } 
        },
        { 
          "@type": "Question", 
          "name": "AI 帳號定位能幫什麼？", 
          "acceptedAnswer": { 
            "@type": "Answer", 
            "text": "分析受眾、內容支柱與上片節奏，幫助你快速找到帳號風格與定位，特別針對 IG、TikTok、YouTube Shorts 等平台優化。" 
          } 
        }
      ]
    }
    </script>
    
    <!-- GEO / Local Business 結構化資料 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "ReelMind AI 短影音智能體",
      "description": "AI 短影音智能體服務，提供 AI 生成腳本、AI 帳號定位等服務",
      "url": "https://reelmind.aijob.com.tw/",
      "telephone": "+886-2-1234-5678",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "TW",
        "addressRegion": "台灣",
        "addressLocality": "台北市"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": "25.0330",
        "longitude": "121.5654"
      },
      "areaServed": [
        {
          "@type": "City",
          "name": "台北市"
        },
        {
          "@type": "City",
          "name": "台中市"
        },
        {
          "@type": "City",
          "name": "高雄市"
        }
      ],
      "priceRange": "NT$2,980 - NT$23,760"
    }
    </script>
    
    <!-- VideoObject 結構化資料 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoObject",
      "name": "ReelMind AI 短影音智能體示範影片",
      "description": "ReelMind AI 短影音智能體：AI 生成腳本、AI 帳號定位，一次完成。",
      "thumbnailUrl": "https://img.youtube.com/vi/Pw1_MRIJ9GA/maxresdefault.jpg",
      "uploadDate": "2025-11-24T00:00:00+08:00",
      "contentUrl": "https://www.youtube.com/watch?v=Pw1_MRIJ9GA",
      "embedUrl": "https://www.youtube.com/embed/Pw1_MRIJ9GA"
    }
    </script>
    
    <!-- Organization 結構化資料 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "ReelMind AI",
      "url": "https://reelmind.aijob.com.tw/",
        "logo": "https://reelmind.aijob.com.tw/assets/images/reelmind-logo.png",
      "description": "AI 短影音智能體平台，提供 AI 生成腳本、AI 帳號定位等服務",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "TW",
        "addressRegion": "台灣"
      },
      "sameAs": [
        "https://www.facebook.com/reelmindai",
        "https://www.instagram.com/reelmindai"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "email": "aiagent168168@gmail.com",
        "contactType": "customer service",
        "areaServed": "TW",
        "availableLanguage": ["zh-Hant", "zh-Hans"]
      }
    }
    </script>
    
    <!-- WebSite 結構化資料 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "ReelMind AI 短影音智能體",
      "url": "https://reelmind.aijob.com.tw/",
      "description": "AI 短影音智能體平台，提供 AI 生成腳本、AI 帳號定位、AI 智能體一鍵生成爆款短影音服務",
      "inLanguage": "zh-Hant",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://reelmind.aijob.com.tw/search?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "publisher": {
        "@type": "Organization",
        "name": "ReelMind AI",
        "logo": {
          "@type": "ImageObject",
          "url": "https://reelmind.aijob.com.tw/assets/images/reelmind-logo.png"
        }
      }
    }
    </script>
    
    <!-- Markdown 和語法高亮函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Highlight.js: 使用瀏覽器 UMD 版本（/build/ 而非 /lib/）避免 module is not defined 錯誤 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/javascript.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/css.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/html.min.js"></script>
    <!-- Font Awesome 圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- ReelMind 動畫和樣式 -->
    <script defer src="assets/js/subscription-animations.js"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {}
        }
      }
    </script>
    
    <!-- CSS 文件 -->
    <link rel="stylesheet" href="assets/css/variables.css" />
    <link rel="stylesheet" href="assets/css/animations.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <script defer src="assets/js/config.js?v=20250127"></script>
    <script defer src="assets/js/common.js?v=20250127"></script>
    <script defer src="assets/js/auth.js?v=20251120"></script>
    <script defer src="assets/js/api.js?v=20250127"></script>
    <script defer src="assets/js/ui.js?v=20251120"></script>
    <script defer src="assets/js/bootstrap.js?v=20251120"></script>
    
    <style>
      /* 主題變數 */
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --border-color: #e5e7eb;
        --card-bg: #ffffff;
        --navbar-bg: #ffffff;
        --input-bg: #ffffff;
        --input-border: #e5e7eb;
        --button-bg: #3b82f6;
        --button-hover: #2563eb;
        --button-text: #ffffff;
        --shadow: rgba(0, 0, 0, 0.1);
      }
      
      .theme-dark {
        /* 使用深色漸變背景，避免全黑 */
        --bg-primary: #0a0e27;
        --bg-secondary: #1a1f3a;
        --bg-tertiary: #252b47;
        --text-primary: #f0f4ff;
        --text-secondary: #cbd5e1;
        --text-tertiary: #94a3b8;
        --border-color: #3d4a6b;
        --card-bg: #1e2640;
        --navbar-bg: #151a2e;
        --input-bg: #252b47;
        --input-border: #3d4a6b;
        --button-bg: #3b82f6;
        --button-hover: #2563eb;
        --button-text: #ffffff;
        --shadow: rgba(0, 0, 0, 0.4);
        /* 新增漸變和強調色 */
        --accent-blue: #3b82f6;
        --accent-purple: #8b5cf6;
        --accent-green: #10b981;
        --accent-orange: #f59e0b;
        --gradient-primary: linear-gradient(135deg, #1e2640 0%, #252b47 100%);
        --gradient-card: linear-gradient(135deg, #1e2640 0%, #252b47 50%, #1a1f3a 100%);
      }
      
      /* 全局深色模式適配規則 */
      .theme-dark {
        color-scheme: dark;
        /* 添加整體背景漸變 */
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式動畫效果 */
      @keyframes darkModeGlow {
        0%, 100% {
          box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1);
        }
        50% {
          box-shadow: 0 4px 30px rgba(59, 130, 246, 0.2);
        }
      }
      
      @keyframes darkModeGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      
      /* 全局深色模式適配 - 覆蓋所有硬編碼的背景色 */
      .theme-dark .top-navbar,
      .theme-dark .mode1-left,
      .theme-dark .mode1-right,
      .theme-dark .mode-card,
      .theme-dark .user-story-card,
      .theme-dark .login-container,
      .theme-dark .card,
      .theme-dark .setting-group,
      .theme-dark .db-section,
      .theme-dark .sidebar,
      .theme-dark .left-content,
      .theme-dark .user-drawer-sidebar,
      .theme-dark .user-drawer-content,
      .theme-dark .sidebar-page-container,
      .theme-dark .sidebar-page-content,
      .theme-dark .result-tabs,
      .theme-dark .chat-container,
      .theme-dark .results-container,
      .theme-dark .settings-container,
      .theme-dark [style*="background: white"],
      .theme-dark [style*="background:#ffffff"],
      .theme-dark [style*="background: #ffffff"],
      .theme-dark [style*="background:white"],
      .theme-dark [style*="background:#fff"] {
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      .theme-dark .sidebar-page-header,
      .theme-dark .result-tab:not(.active),
      .theme-dark [style*="background: #f8fafc"],
      .theme-dark [style*="background:#f8fafc"],
      .theme-dark [style*="background: #F8FAFC"],
      .theme-dark [style*="background:#f3f4f6"],
      .theme-dark [style*="background: #f3f4f6"] {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
      }
      
      /* 輸入框和選擇框 */
      .theme-dark input,
      .theme-dark select,
      .theme-dark textarea {
        background: var(--input-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--input-border) !important;
      }
      
      /* 所有文字元素 */
      .theme-dark h1,
      .theme-dark h2,
      .theme-dark h3,
      .theme-dark h4,
      .theme-dark h5,
      .theme-dark h6,
      .theme-dark p,
      .theme-dark span,
      .theme-dark label,
      .theme-dark div,
      .theme-dark li,
      .theme-dark td,
      .theme-dark th,
      .theme-dark a:not(.navbar-tab):not(.btn):not(.logout-btn) {
        color: var(--text-primary) !important;
      }
      
      /* 次要文字 */
      .theme-dark .setting-desc,
      .theme-dark .text-secondary,
      .theme-dark [style*="color: #6b7280"],
      .theme-dark [style*="color:#6b7280"],
      .theme-dark [style*="color: #64748B"],
      .theme-dark [style*="color:#64748B"],
      .theme-dark [style*="color: #475569"],
      .theme-dark [style*="color:#475569"],
      .theme-dark [style*="color: #374151"],
      .theme-dark [style*="color:#374151"],
      .theme-dark [style*="color: #1f2937"],
      .theme-dark [style*="color:#1f2937"],
      .theme-dark [style*="color: #1E293B"],
      .theme-dark [style*="color:#1E293B"] {
        color: var(--text-secondary) !important;
      }
      
      /* 邊框顏色 */
      .theme-dark [style*="border: 1px solid #e5e7eb"],
      .theme-dark [style*="border:1px solid #e5e7eb"],
      .theme-dark [style*="border: 1px solid #E5E7EB"],
      .theme-dark [style*="border-bottom: 1px solid #e5e7eb"],
      .theme-dark [style*="border: 1px solid #d1d5db"],
      .theme-dark [style*="border:1px solid #d1d5db"],
      .theme-dark [style*="border: 1px solid #E2E8F0"],
      .theme-dark [style*="border:1px solid #E2E8F0"] {
        border-color: var(--border-color) !important;
      }
      
      /* 結果標籤 */
      .theme-dark .result-tab.active {
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .result-tab {
        background: var(--bg-secondary) !important;
        color: var(--text-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 設定容器 */
      .theme-dark .settings-container {
        background: transparent !important;
      }
      
      .theme-dark .setting-group {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
        padding: 20px !important;
        border-radius: 12px !important;
        margin-bottom: 20px !important;
      }
      
      /* 結果容器 */
      .theme-dark .results-container,
      .theme-dark .result-content {
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 資料庫區塊 */
      .theme-dark .db-section,
      .theme-dark .section-content {
        background: transparent !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .user-db-sidebar,
      .theme-dark .user-db-content {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
        transition: all 0.3s ease !important;
      }
      
      /* 深色模式卡片增強效果 */
      .theme-dark .mode-card,
      .theme-dark .user-story-card,
      .theme-dark [style*="background: white"][style*="border-radius"] {
        background: var(--gradient-card) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(59, 130, 246, 0.1) !important;
        transition: all 0.3s ease !important;
      }
      
      .theme-dark .mode-card:hover,
      .theme-dark .user-story-card:hover {
        transform: translateY(-4px) !important;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2) !important;
        animation: darkModeGlow 2s ease-in-out infinite !important;
      }
      
      /* 深色模式：修復「介紹如何開始」區塊的建議使用順序提示框 */
      .theme-dark [style*="background: linear-gradient(135deg, #FEF3C7"],
      .theme-dark [style*="background:linear-gradient(135deg, #FEF3C7"] {
        background: linear-gradient(135deg, #3d2e1f 0%, #4a3a28 100%) !important;
        border: 2px solid #f59e0b !important;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2) !important;
      }
      
      .theme-dark [style*="background: linear-gradient(135deg, #FEF3C7"] p,
      .theme-dark [style*="background:linear-gradient(135deg, #FEF3C7"] p,
      .theme-dark [style*="background: linear-gradient(135deg, #FEF3C7"] strong,
      .theme-dark [style*="background:linear-gradient(135deg, #FEF3C7"] strong {
        color: #fef3c7 !important;
      }
      
      .theme-dark [style*="background: linear-gradient(135deg, #FEF3C7"] i,
      .theme-dark [style*="background:linear-gradient(135deg, #FEF3C7"] i {
        color: #fbbf24 !important;
      }
      
      /* 深色模式：修復「別人怎麼用」區塊的標籤 */
      .theme-dark [style*="background: #EFF6FF"],
      .theme-dark [style*="background:#EFF6FF"] {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
        border: 1px solid rgba(59, 130, 246, 0.3) !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2) !important;
      }
      
      .theme-dark [style*="background: #F0FDF4"],
      .theme-dark [style*="background:#F0FDF4"] {
        background: linear-gradient(135deg, #1e3a2e 0%, #059669 100%) !important;
        color: #d1fae5 !important;
        border: 1px solid rgba(16, 185, 129, 0.3) !important;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2) !important;
      }
      
      .theme-dark [style*="background: #FEF3C7"],
      .theme-dark [style*="background:#FEF3C7"] {
        background: linear-gradient(135deg, #3d2e1f 0%, #d97706 100%) !important;
        color: #fef3c7 !important;
        border: 1px solid rgba(245, 158, 11, 0.3) !important;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2) !important;
      }
      
      .theme-dark [style*="background: #F3E8FF"],
      .theme-dark [style*="background:#F3E8FF"] {
        background: linear-gradient(135deg, #3d2e4a 0%, #7c3aed 100%) !important;
        color: #e9d5ff !important;
        border: 1px solid rgba(139, 92, 246, 0.3) !important;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2) !important;
      }
      
      /* 深色模式：修復頁尾 */
      .theme-dark .rm-footer,
      .theme-dark [style*="background: #EFF6FF"][class*="rm-footer"],
      .theme-dark footer,
      .theme-dark [style*="background: #f8fafc"] {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-top: 1px solid var(--border-color) !important;
      }
      
      .theme-dark footer p,
      .theme-dark footer div,
      .theme-dark footer span,
      .theme-dark .rm-footer p,
      .theme-dark .rm-footer div,
      .theme-dark .rm-footer span {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：首頁區塊背景 */
      .theme-dark section[id="introduction"],
      .theme-dark section[class*="user-story-section"],
      .theme-dark section[id="mode-cards"] {
        background: var(--gradient-primary) !important;
        position: relative;
      }
      
      .theme-dark section[id="introduction"]::before,
      .theme-dark section[class*="user-story-section"]::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 80% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        pointer-events: none;
        animation: darkModeGradient 10s ease infinite;
        background-size: 200% 200%;
      }
      
      /* 深色模式：Discord 區塊紫色調整，與深色背景更協調 */
      .theme-dark .discord-share-section,
      .theme-dark [style*="background: linear-gradient(to bottom right, #8B5CF6"],
      .theme-dark [style*="background:linear-gradient(to bottom right, #8B5CF6"] {
        background: linear-gradient(135deg, #3d2a5f 0%, #4c1d95 50%, #5b21b6 100%) !important;
        position: relative;
        overflow: hidden;
      }
      
      /* Discord 區塊添加微妙的發光效果 */
      .theme-dark .discord-share-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
        animation: darkModeGradient 8s ease infinite;
        pointer-events: none;
      }
      
      /* Discord 區塊內的卡片樣式調整 */
      .theme-dark .discord-share-section [style*="background: rgba(255,255,255,0.15)"],
      .theme-dark .discord-share-section [style*="background:rgba(255,255,255,0.15)"] {
        background: rgba(30, 38, 64, 0.6) !important;
        backdrop-filter: blur(10px) !important;
        border: 1px solid rgba(139, 92, 246, 0.3) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(139, 92, 246, 0.2) !important;
      }
      
      /* Discord 按鈕樣式調整（白色按鈕改為深色模式友好） */
      .theme-dark .discord-share-section a[style*="background: white"],
      .theme-dark .discord-share-section a[style*="background:white"] {
        background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%) !important;
        color: white !important;
        box-shadow: 0 4px 20px rgba(88, 101, 242, 0.3) !important;
        transition: all 0.3s ease !important;
        border: 1px solid rgba(139, 92, 246, 0.3) !important;
      }
      
      .theme-dark .discord-share-section a[style*="background: white"]:hover,
      .theme-dark .discord-share-section a[style*="background:white"]:hover {
        transform: translateY(-2px) scale(1.05) !important;
        box-shadow: 0 6px 30px rgba(88, 101, 242, 0.5) !important;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) !important;
      }
      
      /* Discord 區塊內的圖標顏色調整 */
      .theme-dark .discord-share-section i.fab.fa-discord {
        color: white !important;
      }
      
      .theme-dark .menu-item:not(.active) {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .menu-item.active {
        background: var(--button-bg) !important;
        color: var(--button-text) !important;
      }
      
      .theme-dark .menu-item:hover:not(.active) {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .menu-divider {
        background: var(--border-color) !important;
      }
      
      .theme-dark .detail-item {
        background: var(--bg-secondary) !important;
      }
      
      .theme-dark .detail-item label,
      .theme-dark .detail-item span {
        color: var(--text-primary) !important;
      }
      
      /* 用戶抽屜 */
      .theme-dark .user-drawer-close:hover {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      :root { 
        color-scheme: light; 
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --safe-area-inset-left: env(safe-area-inset-left);
        --safe-area-inset-right: env(safe-area-inset-right);
      }
      html {
        overflow-x: hidden !important; /* 防止整個頁面左右滑動 */
        width: 100%;
        max-width: 100vw;
      }
      body { 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
        background: var(--bg-primary); 
        color: var(--text-primary); 
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-text-size-adjust: 100%;
      }
      
      /* 深色模式 body 背景 */
      .theme-dark body {
        background: var(--gradient-primary) !important;
        background-attachment: fixed !important;
      }
      
      /* 深色模式：步驟卡片增強 */
      .theme-dark [style*="background: white"][style*="border-radius: 20px"] {
        background: var(--gradient-card) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(59, 130, 246, 0.1) !important;
        transition: all 0.3s ease !important;
      }
      
      .theme-dark [style*="background: white"][style*="border-radius: 20px"]:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2) !important;
      }
      
      /* 深色模式：聯絡方式卡片 */
      .theme-dark [style*="background: white"][style*="border: 1px solid #e2e8f0"] {
        background: var(--gradient-card) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4) !important;
      }
      
      /* 深色模式：標題和文字顏色修復 */
      .theme-dark h1, .theme-dark h2, .theme-dark h3,
      .theme-dark [style*="color: #1E293B"],
      .theme-dark [style*="color:#1E293B"],
      .theme-dark [style*="color: #0f172a"],
      .theme-dark [style*="color:#0f172a"] {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：次要文字顏色 */
      .theme-dark [style*="color: #64748B"],
      .theme-dark [style*="color:#64748B"],
      .theme-dark [style*="color: #475569"],
      .theme-dark [style*="color:#475569"] {
        color: var(--text-secondary) !important;
      }
      
      /* ========== 深色模式：Mode1 一鍵生成模式 ========== */
      .theme-dark .mode1-page {
        background: var(--gradient-primary) !important;
      }
      
      .theme-dark .mode1-left,
      .theme-dark .mode1-right {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
      }
      
      .theme-dark .mode1-left input,
      .theme-dark .mode1-left select,
      .theme-dark .mode1-left textarea,
      .theme-dark .mode1-right input,
      .theme-dark .mode1-right select,
      .theme-dark .mode1-right textarea {
        background: var(--input-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--input-border) !important;
      }
      
      .theme-dark .mode1-left label,
      .theme-dark .mode1-right label,
      .theme-dark .mode1-left h2,
      .theme-dark .mode1-left h3,
      .theme-dark .mode1-right h2,
      .theme-dark .mode1-right h3 {
        color: var(--text-primary) !important;
      }
      
      /* Mode1 設定區塊 */
      .theme-dark .settings-block {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
      }
      
      .theme-dark .settings-block h3 {
        color: var(--text-primary) !important;
        border-bottom-color: var(--border-color) !important;
      }
      
      /* Mode1 一鍵生成使用說明 */
      .theme-dark .one-click-instructions {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .one-click-instructions h3 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .step-content strong {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .step-content p {
        color: var(--text-secondary) !important;
      }
      
      /* Mode1 AI 說明區塊 */
      .theme-dark .ai-instructions {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .instructions-header {
        background: transparent !important;
      }
      
      .theme-dark .instructions-header:hover {
        background: var(--bg-tertiary) !important;
      }
      
      .theme-dark .instructions-header h3 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .instruction-list {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .instruction-list p {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .instruction-list p:last-child {
        border-top-color: var(--border-color) !important;
        color: var(--text-tertiary) !important;
      }
      
      /* Mode1 LLM 輸出文字顏色 */
      .theme-dark .result-body,
      .theme-dark .result-body.has-content,
      .theme-dark .result-content,
      .theme-dark .result-content.has-content {
        color: var(--text-primary) !important;
        background: var(--card-bg) !important;
      }
      
      .theme-dark .result-header h3 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .result-actions {
        border-top-color: var(--border-color) !important;
      }
      
      /* 深色模式：AI 對話泡泡 - 強制覆蓋所有白色背景，背景改為深色，文字改為純白色 */
      /* 使用最高特異性來覆蓋淺色模式的 !important */
      .theme-dark .message.ai .message-content,
      .theme-dark .message.assistant .message-content,
      .theme-dark .message.ai[style*="background"] .message-content,
      .theme-dark .message.assistant[style*="background"] .message-content,
      .theme-dark #chatMessages .message.ai .message-content,
      .theme-dark #chatMessages .message.assistant .message-content {
        background: var(--gradient-card) !important; /* 深色背景 */
        color: #ffffff !important; /* 白色文字 */
        border-color: var(--border-color) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      }
      
      /* 強制覆蓋所有可能的白色背景 - 使用更強的特異性 */
      .theme-dark .message.ai .message-content[style],
      .theme-dark .message.assistant .message-content[style],
      .theme-dark #chatMessages .message.ai .message-content[style],
      .theme-dark #chatMessages .message.assistant .message-content[style] {
        background: var(--gradient-card) !important; /* 深色背景 */
        color: #ffffff !important; /* 白色文字 */
      }
      
      /* 覆蓋內聯樣式中的白色背景 */
      /* 強制覆蓋所有白色和淺色背景 - 改為深色背景 */
      .theme-dark .message.ai .message-content[style*="background: #f8fafc"],
      .theme-dark .message.ai .message-content[style*="background:#f8fafc"],
      .theme-dark .message.ai .message-content[style*="background: #F8FAFC"],
      .theme-dark .message.ai .message-content[style*="background:#F8FAFC"],
      .theme-dark .message.ai .message-content[style*="background: white"],
      .theme-dark .message.ai .message-content[style*="background:white"],
      .theme-dark .message.ai .message-content[style*="background:#fff"],
      .theme-dark .message.ai .message-content[style*="background: #fff"],
      .theme-dark .message.assistant .message-content[style*="background: #f8fafc"],
      .theme-dark .message.assistant .message-content[style*="background:#f8fafc"],
      .theme-dark .message.assistant .message-content[style*="background: white"],
      .theme-dark .message.assistant .message-content[style*="background:white"],
      .theme-dark .message.assistant .message-content[style*="background:#fff"],
      .theme-dark .message.assistant .message-content[style*="background: #fff"] {
        background: var(--gradient-card) !important; /* 深色背景 */
        color: #ffffff !important; /* 白色文字 */
        border-color: var(--border-color) !important;
      }
      
      /* 覆蓋內聯樣式中的深色文字 - 強制改為白色 */
      .theme-dark .message.ai .message-content[style*="color: #1f2937"],
      .theme-dark .message.ai .message-content[style*="color:#1f2937"],
      .theme-dark .message.ai .message-content[style*="color: #374151"],
      .theme-dark .message.ai .message-content[style*="color:#374151"],
      .theme-dark .message.ai .message-content[style*="color: #0c4a6e"],
      .theme-dark .message.ai .message-content[style*="color:#0c4a6e"],
      .theme-dark .message.assistant .message-content[style*="color: #1f2937"],
      .theme-dark .message.assistant .message-content[style*="color:#1f2937"],
      .theme-dark .message.assistant .message-content[style*="color: #374151"],
      .theme-dark .message.assistant .message-content[style*="color:#374151"],
      .theme-dark .message.assistant .message-content[style*="color: #0c4a6e"],
      .theme-dark .message.assistant .message-content[style*="color:#0c4a6e"] {
        color: #ffffff !important; /* 強制改為純白色 */
      }
      
      /* 所有 AI 對話泡泡內的文字元素 - 強制改為白色 */
      .theme-dark .message.ai .message-content p,
      .theme-dark .message.assistant .message-content p,
      .theme-dark .message.ai .message-content li,
      .theme-dark .message.assistant .message-content li,
      .theme-dark .message.ai .message-content h1,
      .theme-dark .message.ai .message-content h2,
      .theme-dark .message.ai .message-content h3,
      .theme-dark .message.ai .message-content h4,
      .theme-dark .message.ai .message-content h5,
      .theme-dark .message.ai .message-content h6,
      .theme-dark .message.ai .message-content strong,
      .theme-dark .message.ai .message-content em,
      .theme-dark .message.ai .message-content code,
      .theme-dark .message.ai .message-content pre,
      .theme-dark .message.ai .message-content span,
      .theme-dark .message.ai .message-content div,
      .theme-dark .message.assistant .message-content span,
      .theme-dark .message.assistant .message-content div,
      .theme-dark .message.assistant .message-content h1,
      .theme-dark .message.assistant .message-content h2,
      .theme-dark .message.assistant .message-content h3,
      .theme-dark .message.assistant .message-content h4,
      .theme-dark .message.assistant .message-content h5,
      .theme-dark .message.assistant .message-content h6,
      .theme-dark .message.assistant .message-content strong,
      .theme-dark .message.assistant .message-content em,
      .theme-dark .message.assistant .message-content code,
      .theme-dark .message.assistant .message-content pre {
        color: #ffffff !important; /* 強制改為純白色 */
      }
      
      .theme-dark .message.ai .message-content pre {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .message.user .message-content {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
        border-color: rgba(59, 130, 246, 0.3) !important;
      }
      
      /* 深色模式：聊天消息容器 */
      .theme-dark .chat-messages,
      .theme-dark #chatMessages,
      .theme-dark #mode3 #mode3-chatMessages,
      .theme-dark #mode3 #mode3-chat-messages {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      /* 覆蓋內聯樣式中的白色背景 */
      .theme-dark .chat-messages[style*="background: white"],
      .theme-dark .chat-messages[style*="background:white"],
      .theme-dark #chatMessages[style*="background: white"],
      .theme-dark #chatMessages[style*="background:white"] {
        background: var(--bg-secondary) !important;
      }
      
      /* 說明抽屜 */
      .theme-dark .instructions-drawer {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
      }
      
      .theme-dark .drawer-header {
        background: transparent !important;
        border-bottom-color: var(--border-color) !important;
      }
      
      .theme-dark .drawer-header h3 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .drawer-close-btn {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .drawer-close-btn:hover {
        background: var(--bg-tertiary) !important;
      }
      
      .theme-dark .drawer-content {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .drawer-content p,
      .theme-dark .drawer-content strong,
      .theme-dark .drawer-content li {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .step-guide {
        background: transparent !important;
      }
      
      .theme-dark .step {
        background: rgba(30, 38, 64, 0.4) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .step-content strong {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .step-content p {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .chat-container {
        background: var(--bg-secondary) !important;
      }
      
      /* Mode1 結果標籤和容器 */
      .theme-dark .result-tabs {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .result-tab {
        background: transparent !important;
        color: var(--text-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .result-tab.active {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        border-bottom-color: var(--accent-blue) !important;
      }
      
      .theme-dark .result-tab:hover:not(.active) {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .results-container {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      /* ========== 深色模式：Mode3 IP人設規劃模式 ========== */
      .theme-dark .mode3-page,
      .theme-dark .mode3-fixed {
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式：Mode3 IP人設規劃對話泡泡 - 強制覆蓋白色背景 */
      .theme-dark #mode3 .message.ai .message-content,
      .theme-dark #mode3-chatMessages .message.ai .message-content,
      .theme-dark #mode3-chat-messages .message.ai .message-content,
      .theme-dark #mode3 .message.assistant .message-content,
      .theme-dark #mode3-chatMessages .message.assistant .message-content,
      .theme-dark #mode3-chat-messages .message.assistant .message-content,
      .theme-dark #mode3 .message.ai .message-content[style*="background"],
      .theme-dark #mode3-chatMessages .message.ai .message-content[style*="background"],
      .theme-dark #mode3-chat-messages .message.ai .message-content[style*="background"] {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      }
      
      /* 覆蓋 Mode3 內聯樣式中的白色背景 */
      .theme-dark #mode3 .message.ai .message-content[style*="background: #f8fafc"],
      .theme-dark #mode3 .message.ai .message-content[style*="background:#f8fafc"],
      .theme-dark #mode3 .message.ai .message-content[style*="background: white"],
      .theme-dark #mode3 .message.ai .message-content[style*="background:white"],
      .theme-dark #mode3-chatMessages .message.ai .message-content[style*="background: #f8fafc"],
      .theme-dark #mode3-chatMessages .message.ai .message-content[style*="background: white"],
      .theme-dark #mode3-chat-messages .message.ai .message-content[style*="background: #f8fafc"],
      .theme-dark #mode3-chat-messages .message.ai .message-content[style*="background: white"] {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 覆蓋 Mode3 內聯樣式中的深色文字 */
      .theme-dark #mode3 .message.ai .message-content[style*="color: #1f2937"],
      .theme-dark #mode3 .message.ai .message-content[style*="color:#1f2937"],
      .theme-dark #mode3 .message.ai .message-content[style*="color: #374151"],
      .theme-dark #mode3 .message.ai .message-content[style*="color:#374151"],
      .theme-dark #mode3-chatMessages .message.ai .message-content[style*="color: #1f2937"],
      .theme-dark #mode3-chat-messages .message.ai .message-content[style*="color: #1f2937"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark #mode3 .message.ai .message-content p,
      .theme-dark #mode3-chatMessages .message.ai .message-content p,
      .theme-dark #mode3-chat-messages .message.ai .message-content p,
      .theme-dark #mode3 .message.assistant .message-content p,
      .theme-dark #mode3-chatMessages .message.assistant .message-content p,
      .theme-dark #mode3-chat-messages .message.assistant .message-content p,
      .theme-dark #mode3 .message.ai .message-content li,
      .theme-dark #mode3 .message.ai .message-content h1,
      .theme-dark #mode3 .message.ai .message-content h2,
      .theme-dark #mode3 .message.ai .message-content h3,
      .theme-dark #mode3 .message.ai .message-content strong,
      .theme-dark #mode3 .message.ai .message-content code {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：Mode3 用戶對話泡泡 */
      .theme-dark #mode3 .message.user .message-content,
      .theme-dark #mode3-chatMessages .message.user .message-content,
      .theme-dark #mode3-chat-messages .message.user .message-content {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
        border-color: rgba(59, 130, 246, 0.3) !important;
      }
      
      /* 覆蓋 Mode3 用戶消息的內聯樣式 */
      .theme-dark #mode3 .message.user .message-content[style*="background: #dbeafe"],
      .theme-dark #mode3 .message.user .message-content[style*="background:#dbeafe"],
      .theme-dark #mode3-chatMessages .message.user .message-content[style*="background: #dbeafe"],
      .theme-dark #mode3-chat-messages .message.user .message-content[style*="background: #dbeafe"] {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
      }
      
      .theme-dark #mode3 .message.user .message-content[style*="color: #1e40af"],
      .theme-dark #mode3 .message.user .message-content[style*="color:#1e40af"],
      .theme-dark #mode3-chatMessages .message.user .message-content[style*="color: #1e40af"],
      .theme-dark #mode3-chat-messages .message.user .message-content[style*="color: #1e40af"] {
        color: #dbeafe !important;
      }
      
      .theme-dark #mode3-chatMessages,
      .theme-dark #mode3-chat-messages {
        background: var(--bg-secondary) !important;
      }
      
      .theme-dark .mode3-result-content {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-result-content h1,
      .theme-dark .mode3-result-content h2,
      .theme-dark .mode3-result-content h3,
      .theme-dark .mode3-result-content h4,
      .theme-dark .mode3-result-content p {
        color: var(--text-primary) !important;
      }
      
      /* Mode3 使用說明和生成結果抽屜 */
      .theme-dark .mode3-instructions-drawer,
      .theme-dark .mode3-results-drawer {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
      }
      
      .theme-dark .mode3-drawer-header {
        background: transparent !important;
        border-bottom-color: var(--border-color) !important;
      }
      
      .theme-dark .mode3-drawer-header h3 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-drawer-content {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-drawer-content p,
      .theme-dark .mode3-drawer-content strong,
      .theme-dark .mode3-drawer-content li {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-step {
        background: rgba(30, 38, 64, 0.4) !important;
        border-left-color: var(--accent-purple) !important;
      }
      
      .theme-dark .mode3-step-content strong {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-step-content p {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .mode3-result-type {
        background: rgba(30, 38, 64, 0.4) !important;
        border-left-color: var(--accent-green) !important;
      }
      
      .theme-dark .mode3-result-type strong {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .mode3-result-type p {
        color: var(--text-secondary) !important;
      }
      
      /* ========== 深色模式：創作者資料庫 - LLM 輸出文字 ========== */
      .theme-dark .script-item,
      .theme-dark .script-content,
      .theme-dark .script-header {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .script-content p,
      .theme-dark .script-content div,
      .theme-dark .script-content span,
      .theme-dark .script-content strong,
      .theme-dark .script-content em {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-item,
      .theme-dark .topic-content,
      .theme-dark .ip-planning-item,
      .theme-dark .ip-planning-content-item {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .topic-content p,
      .theme-dark .topic-content div,
      .theme-dark .ip-planning-content-item p,
      .theme-dark .ip-planning-content-item div {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-section,
      .theme-dark .topic-section-header,
      .theme-dark .topic-section-content {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .topic-section-header h5,
      .theme-dark .topic-section-content {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-section-toggle {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .topic-item-actions button {
        background: #ef4444 !important;
        color: white !important;
      }
      
      .theme-dark .topic-item-actions button:hover {
        background: #dc2626 !important;
      }
      
      .theme-dark .topic-header,
      .theme-dark .topic-meta {
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .topic-item-title {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-date {
        color: var(--text-secondary) !important;
      }
      
      /* 深色模式：覆蓋選題內容中的內聯樣式 */
      .theme-dark .topic-item[style*="background: white"],
      .theme-dark .topic-item[style*="background:white"],
      .theme-dark .topic-item[style*="background: #ffffff"],
      .theme-dark .topic-item[style*="background:#ffffff"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：選題內容卡片內的所有文字 */
      .theme-dark .topic-item,
      .theme-dark .topic-item * {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-item .topic-header,
      .theme-dark .topic-item .topic-content-sections,
      .theme-dark .topic-item .topic-header *,
      .theme-dark .topic-item .topic-content-sections * {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-header[style*="border-bottom"],
      .theme-dark .topic-header[style*="border-bottom: 2px solid #e5e7eb"] {
        border-bottom-color: var(--border-color) !important;
      }
      
      .theme-dark .topic-item-title[style*="color: #1f2937"],
      .theme-dark h4[style*="color: #1f2937"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-meta span[style*="background: #f3f4f6"],
      .theme-dark span[style*="background: #f3f4f6"] {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-meta span[style*="color: #374151"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-section[style*="background: #f9fafb"] {
        background: var(--bg-secondary) !important;
      }
      
      .theme-dark .topic-section-header h5[style*="color: #1f2937"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .topic-section-content[style*="color: #374151"] {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：模態框和表格 */
      .theme-dark .script-modal-overlay {
        background: rgba(0, 0, 0, 0.8) !important;
      }
      
      .theme-dark .script-modal-content {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .script-modal-content h2[style*="color: #1f2937"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .script-modal-content button[style*="color: #6b7280"] {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .script-modal-content button[style*="color: #6b7280"]:hover {
        background: var(--bg-tertiary) !important;
      }
      
      .theme-dark .script-modal-content table {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .script-modal-content th[style*="color: #374151"] {
        color: var(--text-primary) !important;
        background: var(--bg-tertiary) !important;
      }
      
      .theme-dark .script-modal-content td[style*="color: #1f2937"],
      .theme-dark .script-modal-content td[style*="color: #4b5563"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .script-modal-content tr[style*="background: #ffffff"],
      .theme-dark .script-modal-content tr[style*="background: #f9fafb"] {
        background: var(--bg-secondary) !important;
      }
      
      .theme-dark .script-modal-content tr[style*="background: #f9fafb"] {
        background: var(--bg-tertiary) !important;
      }
      
      .theme-dark .script-modal-content tr[style*="border-bottom: 1px solid #e5e7eb"] {
        border-bottom-color: var(--border-color) !important;
      }
      
      /* 深色模式：PDF生成中的表格（雖然是打印，但也要考慮預覽） */
      .theme-dark table[style*="background: white"] {
        background: var(--bg-secondary) !important;
      }
      
      /* 深色模式：首頁區塊中的白色背景 */
      /* 深色模式：所有 section 白色背景 */
      .theme-dark section[style*="background: white"],
      .theme-dark section[style*="background:white"],
      .theme-dark section[style*="background: #ffffff"],
      .theme-dark section[style*="background:#ffffff"],
      .theme-dark section[style*="background: #F8FAFC"],
      .theme-dark section[style*="background:#F8FAFC"] {
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式：首頁卡片白色背景 */
      .theme-dark div[style*="background: white"][style*="border-radius: 20px"],
      .theme-dark div[style*="background:white"][style*="border-radius: 20px"],
      .theme-dark div[style*="background: #ffffff"][style*="border-radius: 20px"],
      .theme-dark div[style*="background:#ffffff"][style*="border-radius: 20px"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
      }
      
      /* 深色模式：首頁卡片內的文字顏色 - 全面覆蓋 */
      .theme-dark div[style*="background: white"] [style*="color: #1E293B"],
      .theme-dark div[style*="background:white"] [style*="color: #1E293B"],
      .theme-dark div[style*="background: white"] [style*="color:#1E293B"],
      .theme-dark div[style*="background:white"] [style*="color:#1E293B"],
      .theme-dark div[style*="background: white"] [style*="color: #64748B"],
      .theme-dark div[style*="background:white"] [style*="color: #64748B"],
      .theme-dark div[style*="background: white"] [style*="color:#64748B"],
      .theme-dark div[style*="background:white"] [style*="color:#64748B"],
      .theme-dark div[style*="background: white"] [style*="color: #475569"],
      .theme-dark div[style*="background:white"] [style*="color: #475569"],
      .theme-dark div[style*="background: white"] [style*="color:#475569"],
      .theme-dark div[style*="background:white"] [style*="color:#475569"] {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：首頁卡片內的次要文字 */
      .theme-dark div[style*="background: white"] [style*="color: #64748B"],
      .theme-dark div[style*="background:white"] [style*="color: #64748B"],
      .theme-dark div[style*="background: white"] [style*="color:#64748B"],
      .theme-dark div[style*="background:white"] [style*="color:#64748B"] {
        color: var(--text-secondary) !important;
      }
      
      /* 深色模式：全面覆蓋所有內聯樣式中的深色文字 */
      .theme-dark [style*="color: #1E293B"],
      .theme-dark [style*="color:#1E293B"],
      .theme-dark [style*="color: #1e293b"],
      .theme-dark [style*="color:#1e293b"],
      .theme-dark [style*="color: #334155"],
      .theme-dark [style*="color:#334155"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark [style*="color: #64748B"],
      .theme-dark [style*="color:#64748B"],
      .theme-dark [style*="color: #64748b"],
      .theme-dark [style*="color:#64748b"],
      .theme-dark [style*="color: #475569"],
      .theme-dark [style*="color:#475569"] {
        color: var(--text-secondary) !important;
      }
      
      /* 深色模式：覆蓋所有白色背景的 div（包括首頁卡片、步驟卡片等） */
      .theme-dark div[style*="background: white"][style*="border-radius"],
      .theme-dark div[style*="background:white"][style*="border-radius"],
      .theme-dark div[style*="background: #ffffff"][style*="border-radius"],
      .theme-dark div[style*="background:#ffffff"][style*="border-radius"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 深色模式：覆蓋所有白色背景的 div，不限定 border-radius */
      .theme-dark div[style*="background: white"]:not([style*="linear-gradient"]):not([style*="radial-gradient"]),
      .theme-dark div[style*="background:white"]:not([style*="linear-gradient"]):not([style*="radial-gradient"]),
      .theme-dark div[style*="background: #ffffff"]:not([style*="linear-gradient"]):not([style*="radial-gradient"]),
      .theme-dark div[style*="background:#ffffff"]:not([style*="linear-gradient"]):not([style*="radial-gradient"]) {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：首頁卡片底部區域 */
      .theme-dark div[style*="background: #F8FAFC"],
      .theme-dark div[style*="background:#F8FAFC"],
      .theme-dark div[style*="background: #f8fafc"],
      .theme-dark div[style*="background:#f8fafc"] {
        background: var(--bg-secondary) !important;
      }
      
      /* 深色模式：用戶故事區塊 */
      .theme-dark .user-story-section[style*="background: white"],
      .theme-dark .user-story-section[style*="background:white"] {
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式：實戰指南區塊 */
      .theme-dark .rm-guide-section[style*="background: #F8FAFC"],
      .theme-dark .rm-guide-section[style*="background:#F8FAFC"] {
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式：介紹如何開始區塊 */
      .theme-dark section#introduction[style*="background: white"],
      .theme-dark section#introduction[style*="background:white"] {
        background: var(--gradient-primary) !important;
      }
      
      /* 深色模式：覆蓋所有白色背景的 a 標籤（按鈕） */
      .theme-dark a[style*="background: white"][style*="color: #2563EB"],
      .theme-dark a[style*="background:white"][style*="color: #2563EB"],
      .theme-dark a[style*="background: white"][style*="color:#2563EB"],
      .theme-dark a[style*="background:white"][style*="color:#2563EB"] {
        background: var(--gradient-card) !important;
        color: var(--accent-blue) !important;
        border-color: var(--accent-blue) !important;
      }
      
      /* 深色模式：覆蓋 Discord 分享按鈕 */
      .theme-dark a[style*="background: white"][style*="color: #5865F2"],
      .theme-dark a[style*="background:white"][style*="color: #5865F2"] {
        background: var(--gradient-card) !important;
        color: #5865F2 !important;
        border-color: var(--border-color) !important;
      }
      
      /* 深色模式：覆蓋所有白色背景的按鈕和連結 */
      .theme-dark a[style*="background: white"]:not([style*="linear-gradient"]),
      .theme-dark a[style*="background:white"]:not([style*="linear-gradient"]),
      .theme-dark button[style*="background: white"],
      .theme-dark button[style*="background:white"] {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 深色模式：覆蓋所有白色背景的容器（包括 Discord 頻道卡片等） */
      .theme-dark div[style*="background: white"][style*="border: 1px solid"],
      .theme-dark div[style*="background:white"][style*="border: 1px solid"],
      .theme-dark div[style*="background: white"][style*="border-radius: 16px"],
      .theme-dark div[style*="background:white"][style*="border-radius: 16px"],
      .theme-dark div[style*="background: white"][style*="border-radius: 14px"],
      .theme-dark div[style*="background:white"][style*="border-radius: 14px"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .homepage-title[style*="color: #1f2937"] {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：首頁 Hero 區塊文字優化 */
      .theme-dark .rm-hero-title,
      .theme-dark .rm-hero h1,
      .theme-dark h1[style*="color: #1E293B"],
      .theme-dark h1[style*="color:#1E293B"] {
        color: var(--text-primary) !important;
        font-weight: 900 !important;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      }
      
      .theme-dark .rm-hero p,
      .theme-dark .rm-hero p[style*="color: #64748B"],
      .theme-dark .rm-hero p[style*="color:#64748B"] {
        color: var(--text-secondary) !important;
        font-weight: 500 !important;
        opacity: 1 !important;
      }
      
      .theme-dark .rm-hero span[style*="color: #94A3B8"],
      .theme-dark .rm-hero span[style*="color:#94A3B8"] {
        color: var(--text-tertiary) !important;
        opacity: 0.9 !important;
      }
      
      .theme-dark .homepage-subtitle,
      .theme-dark .homepage-subtitle[style*="color: #6b7280"],
      .theme-dark .homepage-subtitle[style*="color:#6b7280"],
      .theme-dark p[style*="color: #6b7280"],
      .theme-dark p[style*="color:#6b7280"] {
        color: var(--text-secondary) !important;
        font-weight: 500 !important;
        opacity: 1 !important;
      }
      
      /* 深色模式：首頁 Hero 區塊背景優化 */
      .theme-dark .rm-hero {
        background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 15%, #2563EB 30%, #3B82F6 45%, #1E293B 60%, #0F172A 75%, #020617 100%) !important;
        background-size: 400% 400% !important;
        animation: heroGradientFlow 10s ease infinite !important;
      }
      
      /* 深色模式：首頁按鈕優化 */
      .theme-dark .rm-hero a[style*="background: white"],
      .theme-dark .rm-hero a[style*="background:white"] {
        background: var(--gradient-card) !important;
        color: var(--accent-blue) !important;
        border: 2px solid var(--accent-blue) !important;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2) !important;
      }

      /* 深色模式：首頁主要行動按鈕（開始使用）提高可讀性 */
      .theme-dark .rm-hero a[style*="linear-gradient(135deg, #3B82F6"],
      .theme-dark .rm-hero a[style*="linear-gradient(135deg,#3B82F6"] {
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6) !important;
        font-weight: 800 !important;
      }
      .theme-dark .rm-hero a[style*="linear-gradient(135deg, #3B82F6"]:hover,
      .theme-dark .rm-hero a[style*="linear-gradient(135deg,#3B82F6"]:hover {
        filter: brightness(1.05) !important;
        color: #ffffff !important;
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.7) !important;
      }
      
      .theme-dark .rm-hero a[style*="background: white"]:hover,
      .theme-dark .rm-hero a[style*="background:white"]:hover {
        background: var(--accent-blue) !important;
        color: white !important;
        box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4) !important;
        transform: translateY(-2px) !important;
      }
      
      .theme-dark div[style*="background: white"][style*="border-radius: 20px"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark div[style*="background: white"][style*="border-radius: 16px"],
      .theme-dark div[style*="background: white"][style*="border-radius: 12px"] {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 深色模式：IP人設規劃中的文字顏色 */
      .theme-dark .ip-planning-content-item[style*="color: #374151"] {
        color: var(--text-primary) !important;
      }
      
      .theme-dark h3[style*="color: #374151"] {
        color: var(--text-primary) !important;
      }
      
      /* 深色模式：按鈕和連結 */
      .theme-dark a[style*="background: white"][style*="color: #2563EB"] {
        background: var(--gradient-card) !important;
        color: var(--accent-blue) !important;
        border-color: var(--accent-blue) !important;
      }
      
      .theme-dark a[style*="background: white"]:hover {
        background: var(--bg-tertiary) !important;
      }
      
      /* ========== 深色模式：實戰指南和論壇介紹頁面 ========== */
      .theme-dark .rm-guide-section,
      .theme-dark #guide,
      .theme-dark #forum {
        background: var(--gradient-primary) !important;
      }
      
      .theme-dark .rm-guide-section [style*="background: white"],
      .theme-dark #guide [style*="background: white"],
      .theme-dark #forum [style*="background: white"] {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .step-guide,
      .theme-dark .guide-article {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .step-guide h1,
      .theme-dark .step-guide h2,
      .theme-dark .step-guide h3,
      .theme-dark .step-guide p,
      .theme-dark .guide-article h1,
      .theme-dark .guide-article h2,
      .theme-dark .guide-article p {
        color: var(--text-primary) !important;
      }
      
      /* ========== 深色模式：輸入框和按鈕 ========== */
      .theme-dark .input-row {
        background: transparent !important;
        border-top-color: var(--border-color) !important;
      }
      
      .theme-dark .input-container {
        background: transparent !important;
      }
      
      .theme-dark .input-wrapper {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .input-wrapper:focus-within {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
      }
      
      .theme-dark #messageInput,
      .theme-dark #mode3-message-input,
      .theme-dark .input-wrapper input,
      .theme-dark .input-wrapper textarea,
      .theme-dark .chat-input {
        background: var(--input-bg) !important;
        color: #ffffff !important; /* 改為純白色 */
        border-color: var(--input-border) !important;
      }
      
      .theme-dark .chat-input::placeholder,
      .theme-dark #messageInput::placeholder,
      .theme-dark #mode3-message-input::placeholder,
      .theme-dark input::placeholder,
      .theme-dark textarea::placeholder {
        color: var(--text-tertiary) !important;
        opacity: 0.8 !important;
      }
      
      .theme-dark .quick-buttons {
        border-top-color: var(--border-color) !important;
      }
      
      /* 深色模式：建議按鈕和快速按鈕 - 強制覆蓋所有樣式，文字改為純白色 */
      .theme-dark .suggestion-btn,
      .theme-dark .quick-btn,
      .theme-dark button[class*="suggestion"],
      .theme-dark button[class*="quick"],
      .theme-dark .input-wrapper .quick-btn,
      .theme-dark .mode3 .quick-btn,
      .theme-dark #mode3 .quick-btn,
      .theme-dark .mode3-quick-btn {
        background: var(--card-bg) !important;
        color: #ffffff !important; /* 改為純白色 */
        border-color: var(--border-color) !important;
        font-weight: 500 !important;
      }
      
      /* 覆蓋內聯樣式中的白色背景和深色文字 */
      .theme-dark .quick-btn[style*="background: white"],
      .theme-dark .quick-btn[style*="background:white"],
      .theme-dark .quick-btn[style*="background: #ffffff"],
      .theme-dark .quick-btn[style*="background:#ffffff"],
      .theme-dark .suggestion-btn[style*="background: white"],
      .theme-dark .suggestion-btn[style*="background:white"],
      .theme-dark .mode3-quick-btn[style*="background: white"],
      .theme-dark .mode3-quick-btn[style*="background:white"] {
        background: var(--card-bg) !important;
        color: #ffffff !important; /* 改為純白色 */
        border-color: var(--border-color) !important;
      }
      
      /* 覆蓋所有深色文字，強制改為白色 */
      .theme-dark .quick-btn[style*="color: #374151"],
      .theme-dark .quick-btn[style*="color:#374151"],
      .theme-dark .quick-btn[style*="color: #1f2937"],
      .theme-dark .quick-btn[style*="color:#1f2937"],
      .theme-dark .suggestion-btn[style*="color: #374151"],
      .theme-dark .suggestion-btn[style*="color:#374151"],
      .theme-dark .mode3-quick-btn[style*="color: #374151"],
      .theme-dark .mode3-quick-btn[style*="color:#374151"],
      .theme-dark .mode3-quick-btn[style*="color: #1f2937"],
      .theme-dark .mode3-quick-btn[style*="color:#1f2937"] {
        color: #ffffff !important; /* 強制改為純白色 */
      }
      
      .theme-dark .suggestion-btn:hover,
      .theme-dark .quick-btn:hover,
      .theme-dark button[class*="suggestion"]:hover,
      .theme-dark button[class*="quick"]:hover,
      .theme-dark .input-wrapper .quick-btn:hover,
      .theme-dark .mode3 .quick-btn:hover,
      .theme-dark #mode3 .quick-btn:hover {
        background: var(--accent-blue) !important;
        border-color: var(--accent-blue) !important;
        color: white !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
      }
      
      
      .theme-dark .send-btn {
        background: var(--button-bg) !important;
        color: var(--button-text) !important;
      }
      
      .theme-dark .send-btn:hover:not(:disabled) {
        background: var(--button-hover) !important;
      }
      
      .theme-dark .send-btn:disabled {
        background: var(--bg-tertiary) !important;
        color: var(--text-tertiary) !important;
        opacity: 0.5 !important;
      }
      
      /* ========== 深色模式：Modal 和彈窗 ========== */
      .theme-dark .detail-modal {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-modal-header,
      .theme-dark .detail-modal-body {
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .detail-modal-header h3,
      .theme-dark .detail-content {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-info span {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .detail-info strong {
        color: var(--text-primary) !important;
      }
      
      /* ========== 深色模式：論壇介紹頁面特殊樣式 ========== */
      .theme-dark #forum [style*="background: linear-gradient(135deg, #eff6ff"],
      .theme-dark #forum [style*="background:linear-gradient(135deg, #eff6ff"] {
        background: var(--gradient-primary) !important;
      }
      
      .theme-dark #forum [style*="background: rgba(255,255,255,0.15)"],
      .theme-dark #forum [style*="background:rgba(255,255,255,0.15)"] {
        background: rgba(30, 38, 64, 0.6) !important;
        backdrop-filter: blur(10px) !important;
        border-color: var(--border-color) !important;
      }
      
      /* 代碼示例區塊 */
      .theme-dark pre,
      .theme-dark code,
      .theme-dark [class*="code"],
      .theme-dark [style*="background"][style*="code"] {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* ========== 深色模式：改進與優化 ========== */
      
      /* 1. 導航欄標籤優化 */
      .theme-dark .navbar-tab {
        color: var(--text-secondary) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      .theme-dark .navbar-tab.active {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
        transform: translateY(-1px) !important;
      }
      
      .theme-dark .navbar-tab:hover:not(.active) {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        transform: translateY(-1px) !important;
      }
      
      /* 2. 滾動條樣式優化 */
      .theme-dark ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      
      .theme-dark ::-webkit-scrollbar-track {
        background: var(--bg-secondary) !important;
        border-radius: 10px;
      }
      
      .theme-dark ::-webkit-scrollbar-thumb {
        background: var(--border-color) !important;
        border-radius: 10px;
        border: 2px solid var(--bg-secondary);
        transition: background 0.3s ease;
      }
      
      .theme-dark ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-blue) !important;
        box-shadow: 0 0 8px rgba(59, 130, 246, 0.4) !important;
      }
      
      .theme-dark * {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) var(--bg-secondary);
      }
      
      /* 3. 選中文字樣式 */
      .theme-dark ::selection {
        background: rgba(59, 130, 246, 0.3) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark ::-moz-selection {
        background: rgba(59, 130, 246, 0.3) !important;
        color: var(--text-primary) !important;
      }
      
      /* 4. 加載動畫和骨架屏 */
      .theme-dark .ai-loading,
      .theme-dark .loading,
      .theme-dark .spinner,
      .theme-dark .popup-spinner {
        background: var(--bg-secondary) !important;
      }
      
      .theme-dark .ai-loading-dot,
      .theme-dark .loading::after {
        background: var(--accent-blue) !important;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;
      }
      
      .theme-dark .loading-text {
        color: var(--text-secondary) !important;
      }
      
      /* 5. Toast 通知優化 */
      .theme-dark .toast {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.1) !important;
        backdrop-filter: blur(10px) !important;
      }
      
      /* 6. 按鈕增強效果 */
      .theme-dark .btn-primary,
      .theme-dark .apply-btn,
      .theme-dark button[style*="background: #3b82f6"],
      .theme-dark button[style*="background:#3b82f6"] {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%) !important;
        color: white !important;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        border: none !important;
      }
      
      .theme-dark .btn-primary:hover,
      .theme-dark .apply-btn:hover,
      .theme-dark button[style*="background: #3b82f6"]:hover,
      .theme-dark button[style*="background:#3b82f6"]:hover {
        transform: translateY(-2px) scale(1.02) !important;
        box-shadow: 0 6px 24px rgba(59, 130, 246, 0.5) !important;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
      }
      
      .theme-dark .btn-primary:active,
      .theme-dark .apply-btn:active {
        transform: translateY(0) scale(0.98) !important;
      }
      
      /* 7. 輸入框聚焦效果增強 */
      .theme-dark input:focus,
      .theme-dark select:focus,
      .theme-dark textarea:focus {
        outline: none !important;
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 0 20px rgba(59, 130, 246, 0.1) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      /* 8. 卡片懸停效果優化 */
      .theme-dark .card:hover,
      .theme-dark .mode-card:hover,
      .theme-dark .user-story-card:hover,
      .theme-dark .setting-group:hover {
        transform: translateY(-4px) !important;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 
                    0 0 0 1px rgba(59, 130, 246, 0.2),
                    0 0 30px rgba(59, 130, 246, 0.1) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      /* 9. 手機版抽屜優化 */
      .theme-dark .mobile-drawer,
      .theme-dark .user-drawer-sidebar,
      .theme-dark .user-drawer-content {
        background: var(--gradient-card) !important;
        box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5) !important;
        border-left: 1px solid var(--border-color) !important;
      }
      
      .theme-dark .mobile-drawer-toggle,
      .theme-dark .hamburger-icon {
        color: var(--text-primary) !important;
        transition: all 0.3s ease !important;
      }
      
      .theme-dark .mobile-drawer-toggle:hover,
      .theme-dark .hamburger-icon:hover {
        color: var(--accent-blue) !important;
        transform: scale(1.1) !important;
      }
      
      /* 10. 下拉選單優化 */
      .theme-dark select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 12px center !important;
        padding-right: 36px !important;
        appearance: none !important;
        cursor: pointer !important;
      }
      
      .theme-dark select:hover {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1) !important;
      }
      
      /* 11. 代碼高亮優化（Highlight.js 深色主題適配） */
      .theme-dark .hljs {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 8px !important;
        padding: 16px !important;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      }
      
      .theme-dark .hljs-keyword,
      .theme-dark .hljs-selector-tag,
      .theme-dark .hljs-built_in,
      .theme-dark .hljs-name {
        color: #c792ea !important;
      }
      
      .theme-dark .hljs-string,
      .theme-dark .hljs-attr {
        color: #c3e88d !important;
      }
      
      .theme-dark .hljs-comment {
        color: var(--text-tertiary) !important;
        font-style: italic !important;
      }
      
      .theme-dark .hljs-number {
        color: #f78c6c !important;
      }
      
      .theme-dark .hljs-function,
      .theme-dark .hljs-title {
        color: #82aaff !important;
      }
      
      /* 12. 表格優化 */
      .theme-dark table {
        border-collapse: separate !important;
        border-spacing: 0 !important;
      }
      
      .theme-dark th {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        border-bottom: 2px solid var(--border-color) !important;
        font-weight: 600 !important;
      }
      
      .theme-dark td {
        border-bottom: 1px solid var(--border-color) !important;
      }
      
      .theme-dark tr:hover {
        background: var(--bg-tertiary) !important;
        transition: background 0.2s ease !important;
      }
      
      /* 13. 連結優化 */
      .theme-dark a:not(.navbar-tab):not(.btn):not(.logout-btn) {
        color: var(--accent-blue) !important;
        text-decoration: none !important;
        transition: all 0.2s ease !important;
        border-bottom: 1px solid transparent !important;
      }
      
      .theme-dark a:not(.navbar-tab):not(.btn):not(.logout-btn):hover {
        color: #60a5fa !important;
        border-bottom-color: var(--accent-blue) !important;
      }
      
      /* 14. 標題優化 */
      .theme-dark h1,
      .theme-dark h2,
      .theme-dark h3 {
        background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* 15. 分隔線優化 */
      .theme-dark hr,
      .theme-dark .divider,
      .theme-dark .menu-divider {
        border-color: var(--border-color) !important;
        background: linear-gradient(90deg, 
          transparent 0%, 
          var(--border-color) 20%, 
          var(--border-color) 80%, 
          transparent 100%) !important;
        height: 1px !important;
        border: none !important;
      }
      
      /* 16. 標籤和徽章優化 */
      .theme-dark .badge,
      .theme-dark .tag,
      .theme-dark [class*="badge"],
      .theme-dark [class*="tag"] {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
      }
      
      /* 17. 工具提示優化 */
      .theme-dark [title]:hover::after,
      .theme-dark [data-tooltip]:hover::after {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4) !important;
      }
      
      /* 18. 整體過渡動畫優化（僅針對需要動畫的元素） */
      .theme-dark .card,
      .theme-dark .mode-card,
      .theme-dark .user-story-card,
      .theme-dark .setting-group,
      .theme-dark .btn-primary,
      .theme-dark .apply-btn,
      .theme-dark button,
      .theme-dark input,
      .theme-dark select,
      .theme-dark textarea,
      .theme-dark a {
        transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      /* 19. 導航欄標題優化 */
      .theme-dark .navbar-title,
      .theme-dark .clickable-title {
        background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease !important;
      }
      
      .theme-dark .clickable-title:hover {
        filter: brightness(1.2) !important;
        transform: scale(1.05) !important;
      }
      
      /* 20. 用戶資訊優化 */
      .theme-dark .user-info {
        color: var(--text-secondary) !important;
        transition: all 0.3s ease !important;
      }
      
      .theme-dark .user-info:hover {
        color: var(--text-primary) !important;
        transform: translateX(2px) !important;
      }
      
      /* 頁面容器 */
      .app-container {
        display: flex;
        min-height: 100vh;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important;
        box-sizing: border-box;
      }
      
      /* 主內容區域 */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: margin-right 0.3s ease;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important;
        box-sizing: border-box;
      }
      
      .main-content.sidebar-open {
        margin-right: 300px;
      }
      
      /* 頂部導航欄 */
      .top-navbar {
        background: var(--navbar-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px var(--shadow);
        padding-top: calc(16px + var(--safe-area-inset-top));
        min-height: 60px;
        position: sticky;
        top: 0;
        z-index: 100;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .navbar-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }
      
      .navbar-title {
        font-size: 30px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
        flex-grow: 1;
        transition: color 0.3s ease;
      }
      
      .clickable-title {
        cursor: pointer;
        transition: color 0.2s ease;
      }
      
      .clickable-title:hover {
        color: #3b82f6;
      }
      
      .navbar-tabs {
        display: flex;
        gap: 8px;
      }
      
      .navbar-tab {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
      }
      
      .navbar-tab.active {
        background: var(--button-bg);
        color: var(--button-text);
      }
      
      .navbar-tab:hover:not(.active) {
        background: var(--bg-tertiary);
      }
      
      .navbar-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 14px;
        transition: color 0.3s ease;
      }
      
      .logout-btn {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }
      
      .logout-btn:hover {
        background: #dc2626;
      }
      
      /* 頁面內容區域 */
      .page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* 手機版：移除左右 padding */
      @media (max-width: 768px) {
        .page-content {
          padding: 12px 0;
        }
      }
      
      /* 觸控設備：讓卡片有按壓動畫 */
      @media (hover: none) and (pointer: coarse) {
        /* 觸控設備上的卡片 */
        [class*="group"].bg-white {
          -webkit-tap-highlight-color: transparent;
          touch-action: manipulation;
          cursor: pointer;
        }
        
        /* 卡片按壓效果 */
        [class*="group"].bg-white:active {
          transform: scale(0.96) !important;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* 顯示底部連結 */
        [class*="opacity-0"] {
          opacity: 0.7 !important;
        }
      }
      
      /* 首頁樣式 */
      .homepage {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        text-align: center;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important; /* 防止首頁左右滑動 */
        box-sizing: border-box;
      }
      
      /* 首頁視圖容器 */
      .homepage-view {
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important; /* 防止首頁視圖左右滑動 */
        box-sizing: border-box;
      }
      
      /* 別人怎麼用區塊樣式 */
      .user-story-section {
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important;
        box-sizing: border-box;
      }
      
      .user-story-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px var(--shadow);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        transition: background-color 0.3s ease;
      }
      
      .user-story-card > div {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      
      /* Hero 區域樣式修復 */
      .rm-hero {
        position: relative;
        overflow-x: hidden !important;
        box-sizing: border-box;
        /* 漸層流動背景 */
        background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 15%, #3B82F6 30%, #60A5FA 45%, #DBEAFE 60%, #F8FAFC 75%, #FFFFFF 100%) !important;
        background-size: 400% 400% !important;
        animation: heroGradientFlow 10s ease infinite !important;
      }
      
      /* Hero 漸層流動動畫 */
      @keyframes heroGradientFlow {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      
      /* Hero 額外的流動波紋效果 */
      .rm-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        animation: heroRotate 25s linear infinite;
        pointer-events: none;
        z-index: 0;
      }
      
      @keyframes heroRotate {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      
      /* 確保 Hero 內容在背景之上 */
      .rm-hero > * {
        position: relative;
        z-index: 1;
      }
      
      /* Hero 按鈕動態渲染動畫 */
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a {
        opacity: 0;
        transform: translateY(20px);
        animation: heroButtonFadeIn 0.8s ease-out forwards;
      }
      
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a:nth-child(1) {
        animation-delay: 0.3s;
      }
      
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a:nth-child(2) {
        animation-delay: 0.5s;
      }
      
      @keyframes heroButtonFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* 體驗區塊動畫 */
      @keyframes floatAnimation {
        0%, 100% {
          transform: translate(0, 0) scale(1);
          opacity: 0.6;
        }
        50% {
          transform: translate(30px, -30px) scale(1.1);
          opacity: 0.8;
        }
      }
      
      @keyframes sparkleAnimation {
        0%, 100% {
          opacity: 0;
          transform: scale(0);
        }
        50% {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      @keyframes pulseGlow {
        0%, 100% {
          box-shadow: 0 4px 12px rgba(239,68,68,0.4);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 4px 20px rgba(239,68,68,0.6);
          transform: scale(1.05);
        }
      }
      
      @keyframes firePulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes sparkleRotate {
        0%, 100% {
          transform: rotate(0deg) scale(1);
        }
        50% {
          transform: rotate(180deg) scale(1.2);
        }
      }
      
      @keyframes ctaPulse {
        0%, 100% {
          box-shadow: 0 4px 20px rgba(59,130,246,0.3), 0 0 0 0 rgba(59,130,246,0.5);
        }
        50% {
          box-shadow: 0 4px 20px rgba(59,130,246,0.3), 0 0 0 8px rgba(59,130,246,0);
        }
      }
      
      @keyframes magicSpin {
        0%, 100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(-10deg);
        }
        75% {
          transform: rotate(10deg);
        }
      }
      
      @keyframes arrowBounce {
        0%, 100% {
          transform: translateX(0);
        }
        50% {
          transform: translateX(5px);
        }
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      
      /* Hero 按鈕懸浮動畫 */
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }
      
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a:hover::before {
        width: 300px;
        height: 300px;
      }
      
      .rm-hero .rm-hero-container .rm-hero-grid > div:first-child > div:last-child > a:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      
      .rm-hero-container {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding-left: max(16px, env(safe-area-inset-left)) !important;
        padding-right: max(16px, env(safe-area-inset-right)) !important;
      }
      
      .rm-hero-grid {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .rm-hero-grid > div {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      
      .homepage-title {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
      }
      
      .homepage-subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 48px;
        max-width: 600px;
        line-height: 1.6;
      }
      
      .mode-cards {
        display: flex;
        gap: 24px;
        max-width: 800px;
      }
      
      .mode-card {
        flex: 1;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 32px 24px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        user-select: none;
      }
      
      .mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
      }
      
      .mode-card-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      
      .mode-card-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        transition: color 0.3s ease;
      }
      
      .mode-card-desc {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
        transition: color 0.3s ease;
      }
      
      /* 深色模式：模式卡片說明文字改為白色 */
      .theme-dark .mode-card-desc,
      .theme-dark .mode-card p {
        color: #ffffff !important; /* 改為純白色 */
      }
      
      /* 覆蓋內聯樣式 */
      .theme-dark .mode-card-desc[style*="color"],
      .theme-dark .mode-card p[style*="color: #374151"],
      .theme-dark .mode-card p[style*="color:#374151"],
      .theme-dark .mode-card p[style*="color: #6b7280"],
      .theme-dark .mode-card p[style*="color:#6b7280"] {
        color: #ffffff !important; /* 強制改為白色 */
      }
      
      /* 模式1：一鍵生成頁面 */
      .mode1-page {
        display: flex;
        gap: 24px;
        height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px var(--shadow);
        overflow-y: auto;
        transition: background-color 0.3s ease;
      }
      
      .mode1-right {
        flex: 1;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px var(--shadow);
        overflow-y: auto;
        transition: background-color 0.3s ease;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.3s ease;
      }
      
      /* 說明按鈕 */
      .instructions-toggle-btn {
        position: fixed;
        top: 90px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.2s ease;
        z-index: 1000;
      }
      
      .instructions-toggle-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      
      .btn-icon {
        font-size: 16px;
      }
      
      .btn-text {
        font-size: 13px;
      }
      
      /* 抽屜背景遮罩 */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      /* 說明抽屜 */
      .instructions-drawer {
        position: fixed;
        top: 80px;
        right: -400px;
        width: 400px;
        height: calc(100vh - 80px);
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1001;
        display: flex;
        flex-direction: column;
      }
      
      .instructions-drawer.open {
        right: 0;
      }
      
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .drawer-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .drawer-close-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .drawer-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .drawer-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      
      .drawer-content p {
        margin: 0 0 16px 0;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }
      
      .drawer-content p:last-child {
        margin-bottom: 0;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #6b7280;
      }
      
      .step-guide {
        margin: 16px 0;
      }
      
      .step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 12px;
      }
      
      .step-number {
        background: #3b82f6;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
      }
      
      .step-content {
        flex: 1;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .chat-container {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      /* 側邊欄樣式 */
      .sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100vh;
        background: var(--card-bg);
        border-left: 1px solid var(--border-color);
        box-shadow: -2px 0 8px var(--shadow);
        transition: right 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
      }
      
      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: border-color 0.3s ease;
      }
      
      .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      
      .sidebar-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      
      .sidebar-menu {
        padding: 20px 0;
      }
      
      .sidebar-item {
        display: block;
        width: 100%;
        padding: 12px 20px;
        border: none;
        background: none;
        text-align: left;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .sidebar-item:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .sidebar-item.active {
        background: var(--button-bg);
        color: var(--button-text);
      }
      
      
      /* 側邊欄頁面樣式 */
      .sidebar-page-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .sidebar-page-container {
        background: var(--card-bg);
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90%;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px var(--shadow);
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s ease;
      }
      
      .sidebar-page-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .sidebar-page-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      
      .sidebar-page-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .sidebar-page-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .sidebar-page-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: var(--card-bg);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* 側邊欄頁面內容樣式 */
      .profile-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      
      .profile-section h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .user-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .detail-item label {
        font-weight: 500;
        color: #6b7280;
        min-width: 80px;
      }
      
      .detail-item span {
        color: #1f2937;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
      
      .stat-item {
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      
      .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 12px;
        color: #6b7280;
      }
      
      .scripts-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .script-item {
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f8fafc;
      }
      
      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .script-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
      }
      
      .script-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .script-preview {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 12px;
        line-height: 1.4;
      }
      
      .script-actions {
        display: flex;
        gap: 8px;
      }
      
      .btn-primary {
        padding: 6px 12px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .btn-danger {
        padding: 6px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .help-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      
      .help-section {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      
      .help-section h3,
      .help-section h4 {
        margin: 0 0 12px 0;
        color: #1f2937;
      }
      
      .help-section h3 {
        font-size: 20px;
        font-weight: 600;
      }
      
      .help-section h4 {
        font-size: 16px;
        font-weight: 500;
      }
      
      .help-section p {
        margin: 8px 0;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 一鍵生成使用說明樣式 */
      .one-click-instructions {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }
      
      .one-click-instructions h3 {
        margin: 0 0 16px 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .instruction-steps {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .step {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      
      .step-number {
        width: 24px;
        height: 24px;
        background: #3b82f6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
      }
      
      .step-content {
        flex: 1;
      }
      
      .step-content strong {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
      }
      
      .step-content p {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
      }
      
      /* 頁面隱藏/顯示 */
      .page {
        display: none !important;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important; /* 防止頁面左右滑動 */
        box-sizing: border-box;
        position: relative;
        z-index: 1;
      }
      
      .page.active {
        display: block !important;
        z-index: 2;
      }
      
      /* 確保首頁在最上層 */
      #homepage.active {
        z-index: 10;
      }
      
      /* 動畫效果 */
      @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(5deg); }
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* iOS Safari 相容性 */
      html, body {
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      
      @supports (height: 100svh) {
        .min-h-screen {
          min-height: 100svh;
        }
      }
      
      /* 響應式設計 */
      @media (max-width: 1024px) {
        .rm-hero-grid {
          grid-template-columns: 1fr !important;
          gap: 40px !important;
        }
        .rm-pricing-cards {
          flex-direction: column !important;
          gap: 16px !important;
        }
        .rm-pricing-cards > div {
          width: 100% !important;
          max-width: 100% !important;
        }
      }
      
      @media (max-width: 768px) {
        .rm-hero {
          padding: 40px 0 !important;
          margin: -20px 0 0 0 !important;
        }
        .rm-hero-container {
          padding: 0 16px !important;
        }
        .rm-hero-grid {
          gap: 24px !important;
        }
        .rm-hero-title {
          font-size: 1.75rem !important;
          line-height: 1.3 !important;
        }
        .rm-hero p {
          font-size: 0.95rem !important;
          line-height: 1.6 !important;
        }
        
      /* 打字機動畫樣式 */
      .typewriter-title {
        min-height: 1.2em; /* 確保高度穩定 */
      }
      
      .typewriter-text {
        display: inline;
        color: inherit; /* 繼承父元素顏色，確保文字可見 */
        opacity: 1; /* 確保文字不透明 */
      }
      
      .typewriter-cursor {
        display: inline-block;
        animation: blink 1s infinite;
        margin-left: 2px;
        font-weight: 300;
        color: inherit;
      }
      
      @keyframes blink {
        0%, 50% {
          opacity: 1;
        }
        51%, 100% {
          opacity: 0;
        }
      }
      
      /* 深色模式：打字機光標 */
      .theme-dark .typewriter-cursor {
        color: var(--text-primary) !important;
      }
      
        .rm-guide-section {
          padding: 60px 0 !important;
          margin: -20px 0 0 0 !important;
        }
        .rm-guide-section > div {
          padding: 0 16px !important;
        }
        .rm-pricing {
          padding: 60px 0 !important;
          margin: -20px 0 0 0 !important;
        }
        .rm-pricing > div {
          padding: 0 16px !important;
        }
        .rm-pricing-cards {
          gap: 16px !important;
        }
        .rm-footer {
          padding: 40px 0 !important;
          margin: -20px 0 0 0 !important;
        }
        .rm-footer > div {
          padding: 0 16px !important;
        }
        
        .mode1-page {
          flex-direction: column;
          height: auto;
        }
        
        .mode1-left,
        .mode1-right {
          flex: none;
        }
        
        .mode-cards {
          flex-direction: column;
        }
        
        .main-content.sidebar-open {
          margin-right: 0;
        }
        
        .sidebar {
          width: 100%;
          right: -100%;
        }
        
        .user-name { display: none !important; }
        .navbar-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .user-info { padding: 6px 8px; }
        .user-avatar { margin: 0; }
        .logout-btn { margin: 0; }
        .top-navbar { justify-content: space-between; }
        .navbar-left { flex: 1; position: relative; }
        .navbar-title { 
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          max-width: calc(100% - 80px);
          z-index: 1;
        }
        /* 一鍵生成/IP人設卡片加寬 */
        .mode-cards { grid-template-columns: 1fr; }
        .mode-card { width: 100%; max-width: none; }
      }
      
      .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
      
      /* 確保原有功能在新佈局中正常顯示 */
      .userSettingsContainer,
      .oneClickGenerationContainer,
      .chatContainer {
        width: 100%;
        height: 100%;
      }
      
      /* 用戶需求設定樣式調整 */
      .settings-block {
        margin-bottom: 20px;
      }
      
      .settings-content {
        margin-top: 16px;
      }
      
      /* 一鍵生成頁面布局 */
      .mode1-page {
        display: flex;
        gap: 24px;
        min-height: calc(100vh - 120px);
      }
      
      .mode1-left {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .mode1-right {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* 一鍵生成結果區塊樣式調整 */
      .result-tabs {
        margin-bottom: 0;
      }
      
      .results-container {
        flex: 1;
        min-height: 400px;
      }
      
      /* 聊天容器樣式調整 - ChatGPT 風格 */
      .chat-container {
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        max-width: 800px !important;
        margin: 0 auto !important;
        width: 100% !important;
        background: var(--bg-secondary) !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
        transition: background-color 0.3s ease;
      }
      
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 0 0 5px 0;
        margin-bottom: 5px;
      }
      
      /* 當說明收起時，聊天訊息區延長高度 */
      .instruction-list.collapsed + #chatContainer #chatMessages {
        min-height: 600px;
      }

      /* ===== 聊天訊息樣式 - ChatGPT 風格 ===== */
      
      /* 聊天訊息容器 - 採用更簡潔的設計 */
      .message {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
      }

      .message:last-child {
        margin-bottom: 0;
      }

      .message-avatar {
        width: 30px !important;
        height: 30px !important;
        min-width: 30px !important;
        border-radius: 4px !important;
        background: #10a37f !important;
        color: white !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        font-size: 16px !important;
        font-weight: bold !important;
        margin-right: 15px !important;
        flex-shrink: 0 !important;
      }

      .user .message-avatar {
        background: transparent !important;
        color: #374151 !important;
      }

      .assistant .message-avatar {
        background: #10a37f !important;
        color: white !important;
      }

      .message-content {
        flex: 1 !important;
        padding: 0 !important;
        margin: 0 !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        white-space: pre-wrap !important;
        max-width: 100% !important; /* 防止超出容器 */
        overflow: hidden !important; /* 防止內容溢出 */
        box-sizing: border-box !important; /* 包含邊框在內 */
      }

      /* 訊息內容的樣式重置 */
      .message-content p:first-child {
        margin-top: 0 !important;
      }
      .message-content p:last-child {
        margin-bottom: 0 !important;
      }

      /* Markdown 渲染樣式 - ChatGPT 風格 */
      .message-content pre {
        background: #202123 !important;
        color: #f8f8f2 !important;
        padding: 10px !important;
        border-radius: 6px !important;
        overflow-x: auto !important;
        position: relative !important;
        margin: 15px 0 !important;
      }

      .message-content pre code {
        display: block !important;
        padding: 0 !important;
        background: none !important;
        color: inherit !important;
      }

      .message-content table {
        border-collapse: collapse !important;
        width: 100% !important;
        margin: 15px 0 !important;
      }

      .message-content th, 
      .message-content td {
        border: 1px solid #ddd !important;
        padding: 8px !important;
        text-align: left !important;
      }
      
      .theme-dark .message-content th,
      .theme-dark .message-content td {
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }

      .message-content th {
        background-color: #f2f2f2 !important;
      }
      
      .theme-dark .message-content th {
        background-color: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }

      .message-content blockquote {
        border-left: 4px solid #ccc !important;
        padding-left: 15px !important;
        margin: 15px 0 !important;
        color: #666 !important;
      }
      
      .theme-dark .message-content blockquote {
        border-left-color: var(--accent-blue) !important;
        color: var(--text-secondary) !important;
      }

      .message-content ul, 
      .message-content ol {
        margin: 15px 0 !important;
        padding-left: 20px !important;
      }

      .message-content h1,
      .message-content h2,
      .message-content h3,
      .message-content h4,
      .message-content h5,
      .message-content h6 {
        margin: 16px 0 8px 0 !important;
        font-weight: 600 !important;
        line-height: 1.3 !important;
      }

      .message-content p {
        margin: 8px 0 !important;
        line-height: 1.6 !important;
      }

      .message-content code {
        background: #f1f3f4 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
        font-size: 0.9em !important;
      }

      /* AI 思考中動畫 - ChatGPT 風格 */
      .typing-indicator {
        display: flex !important;
        align-items: center !important;
        font-style: italic !important;
        color: #6b7280 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .typing-dots {
        display: flex !important;
        margin-left: 10px !important;
      }

      .typing-dot {
        width: 6px !important;
        height: 6px !important;
        margin: 0 2px !important;
        background-color: #3b82f6 !important;
        border-radius: 50% !important;
        animation: dot-flashing 1s infinite alternate !important;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s !important;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s !important;
      }

      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }

      /* 串流文字效果 */
      .streaming-text {
        position: relative;
      }

      .streaming-cursor {
        display: inline-block;
        width: 2px;
        height: 1.2em;
        background: #374151;
        animation: blink 1s infinite;
        margin-left: 2px;
      }

      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }

      .message-content p {
        margin: 0 0 8px 0;
        line-height: 1.5;
      }

      .message-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .message-content li {
        margin: 4px 0;
      }

      .message-content:last-child p:last-child {
        margin-bottom: 0;
      }
      
      /* AI思考中載入動畫 */
      .ai-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }

      .ai-loading-dots {
        display: flex;
        gap: 4px;
      }

      .ai-loading-dot {
        width: 6px;
        height: 6px;
        background: #3b82f6;
        border-radius: 50%;
        animation: ai-bounce 1.4s infinite ease-in-out both;
      }

      .ai-loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .ai-loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes ai-bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      
      /* 輸入欄位：預設隱藏，只在 mode3 頁面顯示 */
      .input-row {
        display: none !important;
      }
      
      #mode3.active .input-row {
        display: flex !important;
        flex-direction: column !important;
        padding: 16px 24px; /* 左右 padding 與對話內容對齊 */
        margin-top: 0;
        border-top: 1px solid #e5e7eb;
        background: transparent;
        border-radius: 0;
        gap: 12px; /* 輸入框和快速按鈕之間的間距 */
      }
      
      #mode3.active .input-container {
        display: flex !important;
        gap: 12px;
        align-items: flex-start;
        width: 100%;
      }
      
      /* 輸入框包裝器（用於容納快速按鈕） */
      .input-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 120px; /* 放大整體高度，容納快速按鈕 */
        background: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px;
        gap: 8px;
      }
      
      .input-wrapper:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      /* 輸入框和發送按鈕在同一行 */
      .input-row-inner {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex: 1;
      }
      
      .input-wrapper .chat-input {
        flex: 1;
        min-height: 44px; /* 恢復到較小高度 */
        max-height: 100px;
        padding: 10px 12px;
        border: 1px solid transparent;
        background: transparent;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        outline: none;
        line-height: 1.5;
      }
      
      .input-wrapper .chat-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }
      
      .input-wrapper .send-btn {
        height: 44px; /* 與輸入框高度一致 */
        min-width: 44px;
        padding: 0 18px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .input-wrapper .send-btn:hover {
        background: #2563eb;
      }
      
      /* 快速按鈕在輸入框內底部 */
      .input-wrapper .quick-buttons {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 0 0 0;
        margin: 0;
        border-top: 1px solid #e5e7eb;
        background: transparent;
      }
      
      .input-wrapper .quick-btn {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      
      .input-wrapper .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      /* Mode3 顯示/隱藏邏輯由 .input-row 控制 */
      
      /* 優化聊天訊息樣式 */
      .msg {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        max-width: 85%;
      }
      
      .msg.user {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      
      .msg.assistant {
        margin-right: auto;
      }
      
      .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        margin: 0 8px;
        flex-shrink: 0;
      }
      
      .msg.user .msg-avatar {
        background: #3b82f6;
        color: white;
      }
      
      .msg.assistant .msg-avatar {
        background: #f3f4f6;
        color: #374151;
      }
      
      .msg-bubble {
        flex: 1;
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        line-height: 1.5;
        font-size: 15px;
        box-sizing: border-box;
        overflow: hidden;
      }
      
      .msg.user .msg-bubble {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
        max-width: 100%;
        word-wrap: break-word;
      }
      
      .msg.assistant .msg-bubble {
        background: #f8fafc;
        border-color: #e5e7eb;
        color: #1f2937;
        max-width: 100%;
        word-wrap: break-word;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      /* 深色模式：msg-bubble 樣式（另一種創建消息的方式） */
      .theme-dark .msg.assistant .msg-bubble,
      .theme-dark .msg-bubble {
        background: var(--gradient-card) !important;
        color: #ffffff !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .msg.assistant .msg-bubble p,
      .theme-dark .msg.assistant .msg-bubble span,
      .theme-dark .msg.assistant .msg-bubble div,
      .theme-dark .msg-bubble p,
      .theme-dark .msg-bubble span,
      .theme-dark .msg-bubble div {
        color: #ffffff !important;
      }
      
      .theme-dark .msg.assistant .msg-avatar {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
      }
      
      .msg-bubble p {
        margin: 0 0 4px 0;
        line-height: 1.3;
      }
      
      .msg-bubble ul {
        margin: 4px 0;
        padding-left: 20px;
      }
      
      .msg-bubble li {
        margin: 2px 0;
        line-height: 1.3;
      }
      
      .msg-bubble:last-child p:last-child {
        margin-bottom: 0;
      }
      
      .msg-label {
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 6px;
        color: #6b7280;
      }
      
      /* 優化輸入框樣式 - 恢復到較小高度 */
      #messageInput {
        flex: 1;
        min-height: 44px; /* 恢復到較小高度 */
        max-height: 100px; /* 最大高度，允許調整 */
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical; /* 允許垂直調整高度 */
        outline: none;
        transition: border-color 0.2s;
        line-height: 1.5;
        overflow-y: auto; /* 內容超出時顯示滾動條 */
      }
      
      #messageInput:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      #sendBtn {
        height: 44px; /* 與輸入框高度一致 */
        min-width: 44px;
        padding: 0 18px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #sendBtn:hover {
        background: #2563eb;
      }
      
      #sendBtn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      
      /* 快速提問按鈕樣式（套用IP模式設計） */
      .quick-questions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      
      .quick-question-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        color: #6b7280;
        transition: all 0.2s;
      }
      
      .quick-question-btn:hover {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      /* ChatGPT 風格快速按鈕 */
      /* 快速按鈕和輸入欄位：預設隱藏，只在 mode3 頁面顯示 */
      .quick-buttons,
      #quickButtons,
      .input-row,
      #messageInput,
      #sendBtn {
        display: none !important;
      }
      
      
      #mode2.active #messageInput {
        display: block !important;
      }
      
      /* Mode2 頁面的快速按鈕樣式 */
      #mode2.active .quick-buttons { 
        gap: 8px !important; 
        margin-bottom: 12px !important; 
        flex-wrap: wrap !important;
        padding: 0 !important;
        background: transparent !important;
        border: none !important;
        position: relative !important;
        bottom: auto !important;
        z-index: auto !important;
        flex-shrink: 0 !important;
        height: auto !important;
      }

      .quick-btn {
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        color: #374151 !important;
        padding: 8px 16px !important;
        border-radius: 16px !important;
        font-size: 14px !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        font-weight: 400 !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
      }

      .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      /* 主要布局：左右分欄 5:5 */
      .main-layout { 
        display: flex; 
        gap: 20px; 
        min-height: calc(100vh - 100px);
      }
      
      /* 左側面板 - 5份 */
      .left-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 右側面板 - 5份 */
      .right-panel { 
        flex: 5; 
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      /* 左側內容區域 */
      .left-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px var(--shadow);
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s ease;
      }
      
      /* 結果區塊標籤切換 */
      .result-tabs {
        display: flex;
        background: var(--card-bg);
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px var(--shadow);
        border: 1px solid var(--border-color);
        border-bottom: none;
        overflow: hidden;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .result-tab {
        flex: 1;
        padding: 16px 20px;
        background: var(--bg-secondary);
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
        border-right: 1px solid var(--border-color);
      }
      
      .result-tab:last-child {
        border-right: none;
      }
      
      .result-tab.active {
        background: var(--card-bg);
        color: var(--text-primary);
        border-bottom: 2px solid var(--button-bg);
      }
      
      .result-tab:hover {
        background: var(--bg-tertiary);
      }
      
      /* 結果區塊容器 */
      .results-container {
        background: var(--card-bg);
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px var(--shadow);
        border: 1px solid var(--border-color);
        border-top: none;
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .result-content {
        flex: 1;
        padding: 20px;
        min-height: 400px;
        color: var(--text-secondary);
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
        transition: color 0.3s ease;
      }
      
      .result-content.has-content {
        color: var(--text-primary);
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      /* 結果區塊新樣式 */
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      
      .result-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .generate-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .generate-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      
      .result-body {
        min-height: 200px;
        color: #6b7280;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .result-body.has-content {
        color: #1f2937;
        font-style: normal;
        text-align: left;
        align-items: flex-start;
      }
      
      .result-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }
      
      .save-btn, .regenerate-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .save-btn {
        background: #10b981;
        color: white;
        border-color: #10b981;
      }
      
      .save-btn:hover {
        background: #059669;
        border-color: #059669;
      }
      
      .regenerate-btn {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
      }
      
      .regenerate-btn:hover {
        background: #d97706;
        border-color: #d97706;
      }
      
      /* 聊天區域樣式 */
      .chat-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 20px;
        min-height: 600px;
        flex: 1;
      }
      
      .chat-messages {
        background: white;
        border-radius: 12px;
        padding: 16px;
        min-height: 500px; /* 向上拉高：從 400px 增加到 500px */
        max-height: 700px; /* 向上拉高：從 600px 增加到 700px */
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex: 1;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .message.user {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        flex-direction: row-reverse;
        background: transparent !important;
      }
      
      .message.user .message-content {
        flex: 1;
        background: #dbeafe !important;
        padding: 28px 40px !important; /* 上下間距增加到 28px，左右保持 40px */
        padding-left: 50px !important; /* 增加左邊 padding，避免文字太貼邊界 */
        border-radius: 12px !important;
        border: 1px solid #3b82f6 !important;
        color: #1e40af !important;
        margin-right: 12px !important;
        font-size: 16px !important; /* 用戶對話泡泡字體大小 */
        line-height: 1.6 !important; /* 行高 */
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        text-align: right !important; /* 用戶對話泡泡靠右對齊 */
        box-sizing: border-box !important;
      }
      
      .message.ai,
      .message.assistant {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
        background: transparent !important;
      }
      
      .message.ai .message-content,
      .message.assistant .message-content {
        flex: 1;
        background: #f8fafc !important;
        padding: 20px 40px;
        border-radius: 12px;
        border: 1px solid #e5e7eb !important;
        color: #1f2937 !important;
        margin-left: 12px;
        font-size: 16px; /* AI 對話泡泡字體大小 */
        line-height: 1.6; /* 行高 */
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        text-align: left; /* AI 對話泡泡靠左對齊 */
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      /* 深色模式：強制覆蓋淺色模式的 !important - 使用更高特異性 */
      .theme-dark .message.ai .message-content,
      .theme-dark .message.assistant .message-content,
      .theme-dark #mode2 .message.ai .message-content,
      .theme-dark #mode2 .message.assistant .message-content,
      .theme-dark #chatMessages .message.ai .message-content,
      .theme-dark #chatMessages .message.assistant .message-content,
      .theme-dark #mode2 #chatMessages .message.ai .message-content,
      .theme-dark #mode2 #chatMessages .message.assistant .message-content {
        background: var(--gradient-card) !important; /* 深色背景 - 覆蓋淺色模式的 !important */
        color: #ffffff !important; /* 白色文字 - 覆蓋淺色模式的 !important */
        border-color: var(--border-color) !important;
      }
      
      /* 深色模式：使用最高特異性覆蓋所有內聯樣式 */
      .theme-dark #mode2 #chatMessages .message.ai .message-content[style*="background"],
      .theme-dark #mode2 #chatMessages .message.assistant .message-content[style*="background"],
      .theme-dark #mode2 .message.ai .message-content[style*="background"],
      .theme-dark #mode2 .message.assistant .message-content[style*="background"],
      .theme-dark #chatMessages .message.ai .message-content[style*="background"],
      .theme-dark #chatMessages .message.assistant .message-content[style*="background"] {
        background: var(--gradient-card) !important;
        color: #ffffff !important;
      }
      
      .theme-dark #mode2 #chatMessages .message.ai .message-content[style*="color"],
      .theme-dark #mode2 #chatMessages .message.assistant .message-content[style*="color"],
      .theme-dark #mode2 .message.ai .message-content[style*="color"],
      .theme-dark #mode2 .message.assistant .message-content[style*="color"],
      .theme-dark #chatMessages .message.ai .message-content[style*="color"],
      .theme-dark #chatMessages .message.assistant .message-content[style*="color"] {
        color: #ffffff !important;
      }
      
      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .message.user .message-avatar {
        background: #3b82f6;
        color: white;
        margin-right: 0;
        margin-left: 12px;
        overflow: hidden;
      }
      
      .message.user .message-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        display: block;
      }
      
      .message.user .message-avatar:has(img) {
        background: transparent !important;
      }
      
      .message.ai .message-avatar,
      .message.assistant .message-avatar {
        background: #10a37f !important;
        color: white !important;
      }
      
      .message-content p {
        margin: 0 0 8px 0;
        line-height: 1.5;
      }
      
      .message-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }
      
      .message-content li {
        margin: 4px 0;
      }
      
      .message-content:last-child p:last-child {
        margin-bottom: 0;
      }
      
      
      
      
      
      /* 聊天訊息區域 */
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden; /* 防止水平滾動 */
        padding: 16px 24px 140px 24px; /* 內距更貼近圖1 */
        min-height: calc(100vh - 200px);
        background: #ffffff; /* 對話畫布白底 */
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #e5e7eb; /* 細邊框 */
        border-radius: 8px;       /* 略圓角 */
      }
      
      /* 聊天訊息樣式 */
      .message {
        display: flex;
        margin-bottom: 0;
        align-items: flex-start;
        padding: 20px 0;
        border-bottom: 1px solid #e5e7eb;
        width: 100%; /* 確保寬度固定 */
        max-width: 100%; /* 防止超出容器 */
        box-sizing: border-box; /* 包含邊框在內 */
        overflow: hidden; /* 防止內容溢出 */
      }

      .message:last-child {
        border-bottom: none;
      }

      .message-avatar {
        width: 30px;
        height: 30px;
        min-width: 30px;
        border-radius: 50%;
        background: transparent;
        color: #374151;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
        margin-right: 15px;
        flex-shrink: 0;
        overflow: hidden;
      }

      .user .message-avatar {
        background: transparent;
      }

      .message-content {
        flex: 1;
        padding: 20px 40px;
        margin: 0;
        line-height: 1.6;
        color: #374151;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
        max-width: 100%; /* 限制最大寬度 */
        width: 100%;
        box-sizing: border-box; /* 包含邊框在內 */
        overflow: visible; /* 讓內容可見 */
      }

      .message-content p:first-child {
        margin-top: 0;
      }
      .message-content p:last-child {
        margin-bottom: 0;
      }

      /* Mode2 頁面固定設計 - 防止左右滑動 */
      .mode2 {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      .mode2-page {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* 快速按鈕列 */
      .mode2.fig1 .quick-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding: 8px 0 12px 0; /* 與輸入框留白 */
        margin: 0;
        background: transparent;
        border: none;
        justify-content: flex-start;
      }

      .mode2.fig1 .quick-btn {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 8px; /* 讓高度一致且容納長文 */
        border-radius: 16px;
        font-size: 12px !important; /* 調整為 10px 並確保覆寫 */
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 400;
        box-shadow: none;
        backdrop-filter: none;
        width: 100% !important;  /* 填滿grid欄位 */
        min-width: 0 !important; /* 防止撐破 */
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        text-align: center !important; /* 文字置中 */
        display: inline-flex !important; /* 垂直水平置中 */
        justify-content: center !important;
        align-items: center !important;
      }

      .mode2.fig1 .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      /* 輸入區域（貼近圖1：寬、扁、右側送出） */
      .mode2.fig1 .input-row {
        background: transparent;
        border: none;
        padding: 8px 24px 16px 24px; /* 左右 padding 與對話內容對齊 */
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .mode2.fig1 .input-container {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        width: 100%;
      }

      /* Mode2 和 Mode3 共用相同的輸入框包裝器樣式 */
      .mode2.fig1 .input-wrapper,
      .mode3.fig1 .input-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 120px; /* 放大整體高度，容納快速按鈕 */
        background: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px;
        gap: 8px;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .mode2.fig1 .input-wrapper:focus-within,
      .mode3.fig1 .input-wrapper:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      /* Mode2 和 Mode3 輸入框和發送按鈕在同一行 */
      .mode2.fig1 .input-row-inner,
      .mode3.fig1 .input-row-inner {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex: 1;
      }
      
      .mode2.fig1 .input-wrapper .chat-input,
      .mode3.fig1 .input-wrapper .chat-input,
      .mode3.fig1 .input-wrapper #mode3-message-input {
        flex: 1;
        min-height: 44px; /* 恢復到較小高度 */
        max-height: 100px;
        padding: 10px 12px;
        border: 1px solid transparent;
        background: transparent;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        outline: none;
        line-height: 1.5;
      }
      
      .mode2.fig1 .input-wrapper .chat-input:focus,
      .mode3.fig1 .input-wrapper .chat-input:focus,
      .mode3.fig1 .input-wrapper #mode3-message-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .mode2.fig1 .input-wrapper .send-btn,
      .mode3.fig1 .input-wrapper .send-btn,
      .mode3.fig1 .input-wrapper #mode3-send-btn {
        height: 44px; /* 恢復到較小高度 */
        min-width: 44px;
        border-radius: 8px;
        background: #3b82f6;
        color: #ffffff;
        border: none;
        padding: 0 18px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .mode2.fig1 .input-wrapper .send-btn:hover,
      .mode3.fig1 .input-wrapper .send-btn:hover,
      .mode3.fig1 .input-wrapper #mode3-send-btn:hover {
        background: #2563eb;
      }
      
      /* Mode2 和 Mode3 快速按鈕在輸入框內底部 */
      .mode2.fig1 .input-wrapper .quick-buttons,
      .mode3.fig1 .input-wrapper .quick-buttons {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 0 0 0;
        margin: 0;
        border-top: 1px solid #e5e7eb;
        background: transparent;
      }
      
      .mode2.fig1 .input-wrapper .quick-btn {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      
      .mode3.fig1 .input-wrapper .quick-btn {
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        color: #1f2937 !important;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 500;
      }
      
      .mode2.fig1 .input-wrapper .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      .mode3.fig1 .input-wrapper .quick-btn:hover {
        background: #f3f4f6 !important;
        border-color: #3b82f6 !important;
        color: #1f2937 !important;
      }

      /* 手機版微調 */
      @media (max-width: 768px) {
        /* 確保手機版 body 不滾動 */
        body.mode2-active, html.mode2-active,
        body.mode3-active, html.mode3-active {
          overflow: hidden !important;
          height: 100% !important;
          position: fixed !important;
          width: 100% !important;
        }
        
        .mode2.fig1 .mode2-page,
        .mode3.fig1 .mode3-page {
          padding-top: 70px !important; /* 手機版 header 較小 */
        }
        
        .mode2.fig1 #chatMessages,
        .mode3.fig1 #mode3-chat-messages {
          padding: 12px !important; /* 手機版較小的 padding */
        }
        
        .mode2.fig1 .quick-buttons,
        .mode3.fig1 .quick-buttons { 
          gap: 4px !important; 
          padding: 6px 8px !important; /* 手機版較小的 padding */
        }
        
        /* Mode2 和 Mode3 手機版快速按鈕變得更小（像圖2那樣） */
        .mode2.fig1 .quick-btn {
          padding: 3px 6px !important; /* 手機版快速按鈕變得更小 */
          font-size: 10px !important; /* 手機版快速按鈕字體變得更小 */
        }
        
        .mode3.fig1 .quick-btn {
          padding: 3px 6px !important; /* 手機版快速按鈕變得更小 */
          font-size: 10px !important; /* 手機版快速按鈕字體變得更小 */
          background: #ffffff !important;
          color: #1f2937 !important;
          border: 1px solid #d1d5db !important;
        }
        
        /* Mode2 和 Mode3 手機版輸入區域樣式統一 */
        .mode2.fig1 .input-row,
        .mode3.fig1 .input-row {
          position: static !important; /* 強制覆蓋手機版的 fixed 定位 */
          bottom: auto !important;
          left: auto !important;
          right: auto !important;
          padding: 8px 12px 16px 12px !important; /* 手機版較小的 padding */
          flex-direction: column !important; /* 統一為垂直排列 */
          flex-shrink: 0 !important; /* 固定在底部 */
        }
        
        .mode2.fig1 .chat-input,
        .mode3.fig1 .chat-input,
        .mode3.fig1 #mode3-message-input { 
          font-size: 15px !important; 
        }
        
        /* Mode3 手機版輸入框包裝器樣式（與 Mode2 一致） */
        .mode3.fig1 .input-wrapper {
          min-height: 100px !important; /* 手機版稍微小一點 */
          padding: 8px !important;
        }
        
        .mode3.fig1 .input-row-inner {
          display: flex !important;
          flex-direction: row !important;
          gap: 8px !important;
          align-items: center !important;
        }
        
        .mode3.fig1 #mode3-message-input {
          flex: 1 !important;
          min-height: 40px !important;
          max-height: 80px !important;
          padding: 8px 12px !important;
          font-size: 15px !important;
          border-radius: 8px !important;
        }
        
        .mode3.fig1 #mode3-send-btn {
          height: 40px !important;
          min-width: 40px !important;
          padding: 0 12px !important;
          border-radius: 8px !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
        }
      }

      /* fig1 強制覆寫（提高優先級） */
      /* 鎖住整頁滾動：當 mode2.fig1 或 mode3.fig1 存在時，頁面不捲動，只讓對話框捲動 */
      /* 確保 body 和 html 不滾動 */
      body.mode2-active, html.mode2-active,
      body.mode3-active, html.mode3-active {
        overflow: hidden !important;
        height: 100% !important;
        position: fixed !important;
        width: 100% !important;
      }
      
      .mode2.fig1 {
        height: 100dvh !important; /* 整頁固定高度 */
        overflow: hidden !important; /* 鎖住整頁，只讓對話框滾動 */
        position: fixed !important;
        top: 0 !important; /* 從頂部開始，header 會覆蓋在上面 */
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        display: flex !important; /* 最外層容器直接使用 flex */
        flex-direction: column !important;
        z-index: 1 !important; /* 確保在 header 下方（header z-index: 100） */
      }

      .mode2.fig1 .mode2-page {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important; /* 占滿剩餘空間（header下方） */
        min-height: 0 !important; /* 允許子元素正確捲動 */
        overflow: hidden !important; /* 只讓對話框滾動 */
        padding: 0 !important; /* 移除所有 padding，讓內容直接貼邊 */
        padding-top: 80px !important; /* 為 header 預留空間（約 60px + padding） */
        margin: 0 !important;
        box-sizing: border-box !important;
        position: relative !important;
      }

      .mode2.fig1 #chatMessages {
        margin: 0 !important;
        padding: 16px 24px !important; /* 左右 padding，讓內容不貼邊 */
        background: transparent !important; /* 移除白色背景，直接顯示在最外層 */
        border: none !important; /* 移除邊框 */
        border-radius: 0 !important;
        flex: 1 !important; /* 占滿剩餘高度 */
        min-height: 0 !important; /* 允許子元素正確捲動 */
        height: auto !important; /* 由flex決定高度 */
        -webkit-overflow-scrolling: touch !important; /* iOS 慣性捲動 */
        overscroll-behavior: contain !important;
        touch-action: pan-y !important;
        overflow-y: auto !important; /* chat list 滾動，這是唯一可滾動的區域 */
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* Mode3 固定佈局 - 與 Mode2 相同 */
      .mode3.fig1 {
        height: 100dvh !important;
        overflow: hidden !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        z-index: 1 !important;
      }

      .mode3.fig1 .mode3-page {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
        min-height: 0 !important;
        overflow: hidden !important;
        padding: 0 !important;
        padding-top: 80px !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        position: relative !important;
      }

      .mode3.fig1 .mode3-chat-container {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
        min-height: 0 !important;
        overflow: hidden !important;
        position: relative !important;
      }

      .mode3.fig1 #mode3-chat-messages {
        margin: 0 !important;
        padding: 16px 24px !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        flex: 1 !important;
        min-height: 0 !important;
        height: auto !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: contain !important;
        touch-action: pan-y !important;
        overflow-y: auto !important;
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      /* 快速按鈕放在輸入欄位底部 - 電腦版 */
      .mode2.fig1 .input-row .quick-buttons {
        gap: 8px !important;
        padding: 8px 0 0 0 !important; /* 在輸入框下方，留一點間距 */
        margin: 0 !important;
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
        width: 100% !important;
        background: transparent !important;
        box-sizing: border-box !important;
      }
      
      .mode2.fig1 .input-row .quick-btn {
        background: transparent !important;
        border: 1px solid #d1d5db !important;
        color: #374151 !important;
        padding: 8px 16px !important;
        border-radius: 16px !important;
        font-size: 14px !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        font-weight: 400 !important;
        box-shadow: none !important;
        width: auto !important; /* 自動寬度，不填滿 */
        min-width: fit-content !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
        justify-content: center !important;
        align-items: center !important;
      }
      
      .mode2.fig1 .input-row .quick-btn:hover {
        background: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
      }

      .mode2.fig1 .chat-input {
        flex: 1 !important;
        height: 44px !important;
        min-height: 44px !important;
        max-height: 44px !important;
        border: 1px solid #d1d5db !important;
        border-radius: 10px !important;
        padding: 10px 12px !important;
        font-size: 14px !important;
        background: #ffffff !important;
      }

      .mode2.fig1 .send-btn {
        height: 44px !important;
        min-width: 44px !important;
        border-radius: 10px !important;
        background: #3b82f6 !important;
        color: #ffffff !important;
        border: none !important;
        padding: 0 18px !important;
        width: auto !important; /* 覆寫先前手機樣式的 100% 寬 */
      }
      
      /* 載入動畫樣式 */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #ffffff;
        border-radius: 18px 18px 18px 4px;
        border: 1px solid #e5e7eb;
        margin: 8px 0;
      }
      
      .typing-dots {
        display: flex;
        gap: 4px;
      }
      
      .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
      }
      
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      
      @keyframes typing {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* 輸入區域：預設隱藏，只在 mode2 頁面顯示 */
      .input-row {
        display: none !important;
      }
      
      #mode2.active .input-row {
        display: flex !important;
        padding: 20px;
        background: #f7f7f8;
        border: none;
        flex-shrink: 0;
        z-index: 100;
        box-shadow: none;
        flex-direction: column;
        gap: 8px;
      }

      /* 快速按鈕區域：預設隱藏，只在 mode2 頁面顯示 */
      .quick-buttons {
        display: none !important;
      }
      
      #mode2.active .quick-buttons {
        display: flex !important;
        gap: 8px;
        flex-wrap: wrap;
        padding: 20px;
        background: #f7f7f8;
        border: none;
        z-index: 99;
        justify-content: center;
      }
      
      .input-container {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 8px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: border-color 0.2s;
      }

      .input-container:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .chat-input {
        flex: 1;
        border: none;
        resize: none;
        outline: none;
        padding: 8px 0;
        font-size: 16px;
        line-height: 1.5;
        max-height: 200px;
        overflow-y: auto;
        background: transparent;
        font-family: inherit;
        min-height: 24px;
      }
      
      .chat-input:focus {
        outline: none;
      }
      
      .send-btn {
        background: #3b82f6;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 16px;
        transition: all 0.2s;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        height: 40px;
      }
      
      .send-btn:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-1px);
      }
      
      .send-btn:disabled {
        color: #d1d5db;
        cursor: not-allowed;
      }

      /* Markdown 渲染樣式 */
      .message-content pre {
        background: #202123;
        color: #f8f8f2;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 16px 0;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 14px;
        line-height: 1.5;
      }

      .message-content pre code {
        background: none;
        padding: 0;
        color: inherit;
        font-size: inherit;
      }

      .message-content code {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        color: #d63384;
      }
      
      .theme-dark .message-content code {
        background: var(--bg-tertiary) !important;
        color: #f472b6 !important;
      }

      .message-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
        font-size: 14px;
      }

      .message-content th,
      .message-content td {
        border: 1px solid #e5e7eb;
        padding: 12px;
        text-align: left;
      }

      .message-content th {
        background: #f8f9fa;
        font-weight: 600;
      }
      
      .theme-dark .message-content th {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .message-content td {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .message-content table {
        border-color: var(--border-color) !important;
      }

      .message-content blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 16px;
        margin: 16px 0;
        color: #6b7280;
        font-style: italic;
      }
      
      .theme-dark .message-content blockquote {
        border-left-color: var(--accent-blue) !important;
        color: var(--text-secondary) !important;
      }

      .message-content ul,
      .message-content ol {
        margin: 16px 0;
        padding-left: 24px;
      }

      .message-content li {
        margin: 8px 0;
        line-height: 1.6;
      }

      .message-content h1,
      .message-content h2,
      .message-content h3,
      .message-content h4,
      .message-content h5,
      .message-content h6 {
        margin: 24px 0 16px 0;
        font-weight: 600;
        line-height: 1.3;
        color: #1f2937;
      }

      .message-content h1 { font-size: 1.5em; }
      .message-content h2 { font-size: 1.3em; }
      .message-content h3 { font-size: 1.1em; }

      /* 載入動畫 */
      .typing-indicator {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #6b7280;
        margin: 0;
        padding: 0;
      }

      .typing-dots {
        display: flex;
        margin-left: 10px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: dot-flashing 1s infinite alternate;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dot-flashing {
        0% {
          opacity: 0.2;
        }
        100% {
          opacity: 1;
        }
      }
      
      .input-container button:hover {
        background: #2563eb;
      }
      
      /* 用戶抽屜樣式 - 左右兩欄彈出式視窗 */
      .user-drawer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 800px;
        max-width: 95vw;
        height: 600px;
        max-height: 90vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
      }
      
      .user-drawer.open {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        visibility: visible;
      }
      
      .user-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      
      .user-drawer-overlay.open {
        display: block;
      }
      
      .user-drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        flex-shrink: 0;
      }
      
      .user-drawer-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .app-logo {
        font-size: 20px;
        font-weight: bold;
        color: #3b82f6;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .app-name {
        font-size: 16px;
        color: #374151;
        font-weight: 500;
      }
      
      .user-drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .user-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      /* 左右兩欄布局 */
      .user-drawer-body {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      /* 左側選單欄 */
      .user-drawer-sidebar {
        width: 250px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .user-profile {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: border-color 0.3s ease;
      }
      
      .user-drawer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        transition: border-color 0.3s ease;
      }
      
      .user-drawer-info h3 {
        margin: 0;
        font-size: 16px;
        color: var(--text-primary);
        font-weight: 600;
        transition: color 0.3s ease;
      }
      
      .user-drawer-info p {
        margin: 4px 0 0 0;
        font-size: 14px;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      
      /* 右側內容區域 */
      .user-drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: var(--card-bg);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      
      .user-drawer-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
      }
      
      .user-drawer-menu li {
        margin: 0;
      }
      
      .user-drawer-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: 0;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        font-weight: 500;
      }
      
      .user-drawer-menu a:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .user-drawer-menu a.active {
        background: rgba(59, 130, 246, 0.2);
        color: var(--button-bg);
        border-left-color: var(--button-bg);
        font-weight: 600;
      }
      
      .user-drawer-menu .icon {
        width: 20px;
        height: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h2 {
        margin: 0 0 24px 0;
        font-size: 24px;
        color: #1f2937;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 12px;
      }
      
      .user-info-detail {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      
      .info-item label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }
      
      .info-item span {
        color: #6b7280;
        word-break: break-all;
      }
      
      .generations-list, .conversations-list, .memory-content {
        max-height: 500px;
        overflow-y: auto;
      }
      
      .generation-item, .conversation-item {
        background: #f9fafb;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
      }
      
      /* 腳本列表樣式 */
      .script-item {
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      
      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        cursor: pointer;
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }
      
      .script-header:hover {
        background: #f9fafb;
      }
      
      .script-info {
        display: flex;
        align-items: center;
        gap: 16px;
        flex: 1;
      }
      
      .script-number {
        background: #3b82f6;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        width: 60px;
        min-width: 60px;
        max-width: 60px;
        text-align: center;
        white-space: nowrap;
        display: inline-block;
        box-sizing: border-box;
      }
      
      .script-name {
        font-weight: 500;
        color: #1f2937;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      
      .script-name:hover {
        background: #e5e7eb;
      }
      
      .script-date {
        color: #6b7280;
        font-size: 14px;
      }
      
      .script-toggle {
        color: #6b7280;
        font-size: 14px;
      }
      
      .script-content {
        padding: 16px;
        background: #fff;
        border-top: 1px solid #e5e7eb;
      }
      
      .script-table {
        overflow-x: auto;
      }
      
      .script-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      
      .script-table th,
      .script-table td {
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        text-align: left;
      }
      
      .script-table th {
        background: #f3f4f6;
        font-weight: 600;
        color: #374151;
      }
      
      .script-table td {
        color: #4b5563;
      }
      
      .script-actions {
        display: flex;
        gap: 8px;
        padding: 16px;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .download-pdf-btn {
        background: #10b981;
        color: white;
      }
      
      .download-pdf-btn:hover {
        background: #059669;
      }
      .download-csv-btn {
        background: #06b6d4;
        color: white;
      }
      
      .download-csv-btn:hover {
        background: #0891b2;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 深色模式：操作按鈕 */
      .theme-dark .action-btn {
        color: #ffffff !important;
      }
      
      .theme-dark .view-btn {
        background: var(--accent-blue) !important;
        color: #ffffff !important;
      }
      
      .theme-dark .view-btn:hover {
        background: var(--button-hover) !important;
      }
      
      .theme-dark .delete-btn {
        background: #ef4444 !important;
        color: #ffffff !important;
      }
      
      .theme-dark .delete-btn:hover {
        background: #dc2626 !important;
      }
      
      .theme-dark .action-btn.view-btn,
      .theme-dark .action-btn.delete-btn {
        color: #ffffff !important;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform, .generation-topic {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .generation-content, .conversation-summary {
        color: #374151;
        line-height: 1.5;
        margin-bottom: 8px;
      }
      
      .generation-date, .conversation-date {
        font-size: 12px;
        color: #9ca3af;
      }
      
      .loading-text {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 20px;
      }
      
      /* 底部導航欄默認隱藏（桌面版） */
      .bottom-navbar {
        display: none;
      }
      
      /* 帳號定位記錄樣式 */
      .positioning-record-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s ease;
      }
      
      .positioning-record-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }
      
      /* 深色模式：帳號定位記錄卡片 */
      .theme-dark .positioning-record-item {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .positioning-record-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
        transform: translateY(-2px) !important;
      }
      
      .theme-dark .record-header,
      .theme-dark .record-preview,
      .theme-dark .record-actions {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .record-number,
      .theme-dark .record-date {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .record-preview {
        color: var(--text-secondary) !important;
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        color: #6b7280;
        font-size: 12px;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 12px;
        background: white;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #3b82f6;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 彈出視窗樣式 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      
      .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* 深色模式：模態框 */
      .theme-dark .modal-content {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .modal-header {
        background: var(--bg-secondary) !important;
        border-bottom-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .modal-body {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .modal-close {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .modal-close:hover {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8f9fa;
      }
      
      .modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }
      
      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }
      
      .modal-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      
      .record-detail {
        line-height: 1.6;
      }
      
      .detail-meta {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-label {
        font-weight: 600;
        color: #374151;
        margin-right: 8px;
      }
      
      .detail-value {
        color: #6b7280;
      }
      
      .detail-content {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      
      .content-text {
        color: #1f2937;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e5e7eb;
        background: #f8f9fa;
        text-align: right;
      }
      
      /* 抽屜內容區域樣式 */
      .drawer-content {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .content-section {
        display: none;
      }
      
      .content-section.active {
        display: block;
      }
      
      .content-section h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      
      .user-info-detail {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      
      .info-item {
        display: flex;
        margin-bottom: 10px;
      }
      
      .info-item label {
        font-weight: bold;
        min-width: 80px;
        color: #666;
      }
      
      .info-item span {
        color: #333;
      }
      
      .generations-list,
      .conversations-list,
      .memory-content {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .generation-item,
      .conversation-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 3px solid #007bff;
      }
      
      .generation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .generation-platform {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-topic {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      
      .generation-content,
      .conversation-summary {
        color: #333;
        margin-bottom: 5px;
        line-height: 1.4;
      }
      
      .generation-date,
      .conversation-date {
        color: #666;
        font-size: 12px;
      }
      
      .loading-text {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      
      /* 設定區塊樣式 */
      .settings-block {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }
      
      .settings-block h3 {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .setting-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .setting-item label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      
      .setting-item input,
      .setting-item select {
        padding: 12px 16px;
        border: 1px solid var(--input-border);
        border-radius: 8px;
        font-size: 14px;
        background: var(--input-bg);
        color: var(--text-primary);
        transition: border-color 0.2s, background-color 0.3s ease, color 0.3s ease;
      }
      
      .setting-item input:focus,
      .setting-item select:focus {
        outline: none;
        border-color: var(--button-bg);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .apply-btn {
        width: 100%;
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .apply-btn:hover {
        background: #2563eb;
      }
      
      /* AI 說明區塊樣式 */
      .ai-instructions {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 20px;
      }
      
      .instructions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        cursor: pointer;
        border-radius: 12px 12px 0 0;
        transition: background-color 0.2s;
      }
      
      .instructions-header:hover {
        background-color: #f8fafc;
      }
      
      .instructions-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      
      .instructions-toggle {
        font-size: 16px;
        color: #6b7280;
        transition: transform 0.2s ease;
      }
      
      .instruction-list {
        padding: 0 20px 20px 20px;
        transition: all 0.3s ease;
        overflow: hidden;
        display: none;
      }
      
      .instruction-list.collapsed {
        padding: 0 20px;
        max-height: 0;
        display: none;
      }
      
      .instruction-list.show {
        display: block;
      }
      
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }
      
      /* 簡潔說明樣式 */
      .instruction-list p {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
      }
      
      .instruction-list p:last-child {
        margin-bottom: 0;
        padding-top: 8px;
        border-top: 1px solid #e5e7eb;
        font-size: 13px;
        color: #9ca3af;
      }
      
      /* 控制區域樣式 */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .controls .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .control-btn, .secondary-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
      }
      
      .control-btn {
        background: #10b981;
        color: white;
      }
      
      .control-btn:hover {
        background: #059669;
      }
      
      .secondary-btn {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      
      .secondary-btn:hover {
        background: #e5e7eb;
      }
      
      .controls textarea {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
      }
      
      .controls textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .send-btn {
        padding: 12px 24px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }
      
      .send-btn:hover {
        background: #2563eb;
      }
      
      /* 手機版優化 */
      @media (max-width: 768px) {
        .container { padding: 12px; }
        .main-layout { 
          flex-direction: column; 
          gap: 16px;
        }
        .left-panel { 
          order: 1;
        }
        .right-panel { 
          order: 2;
        }
        .left-content {
          padding: 16px;
        }
        .settings-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .chat-messages {
          min-height: 300px;
          max-height: 400px;
        }
        .result-tabs {
          flex-direction: column;
        }
        .result-tab {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }
        .result-tab:last-child {
          border-bottom: none;
        }
        .result-content {
          min-height: 200px;
        }
        .user-drawer {
          width: 280px;
          right: -280px;
        }
        .input-row {
          flex-direction: column;
          gap: 8px;
        }
        
        .input-container {
          flex-direction: row;
          gap: 8px;
          align-items: flex-end;
        }
        .input-container button {
          width: auto;
          min-width: 80px;
          flex-shrink: 0;
        }
        h1 { font-size: 16px; margin-bottom: 12px; }
        .chat { height: 50vh; padding: 12px; }
        .msg-bubble { max-width: 90%; padding: 10px 14px; font-size: 14px; }
        .settings-block { padding: 16px; margin-bottom: 12px; }
        .settings-block h3 { font-size: 14px; margin-bottom: 12px; }
        .settings-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
        .setting-item input, .setting-item select { padding: 10px 12px; font-size: 16px; }
        .apply-btn { padding: 12px 16px; font-size: 14px; }
        .controls { flex-direction: column; gap: 10px; }
        .controls .row { flex-direction: row !important; justify-content: space-between; }
        .controls .row button { flex: 1; margin: 0 4px; }
        textarea { min-height: 40px; font-size: 16px; }
        button { padding: 12px 16px; font-size: 14px; }
        .results-block { padding: 16px; }
        .results-block h3 { font-size: 14px; }
        .result-item h4 { font-size: 13px; }
        .result-item .content { padding: 10px; font-size: 14px; }
        .toast { top: 10px; right: 10px; left: 10px; max-width: none; font-size: 13px; }
      }
      h1 { font-size: 18px; font-weight: 600; color:#2563eb; margin: 0 0 16px; }
      
      /* 用戶認證樣式 */
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 16px; 
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-info { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .user-info:hover {
        background: #f3f4f6;
      }
      .user-avatar { 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        border: 2px solid #e5ecef; 
        object-fit: cover;
        object-position: center;
      }
      .user-name { font-size: 14px; font-weight: 500; color: #374151; }
      .auth-buttons { display: flex; gap: 8px; }
      .login-btn, .logout-btn { 
        padding: 8px 16px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s;
      }
      .login-btn { 
        background: #4285f4; 
        color: white; 
      }
      .login-btn:hover { background: #3367d6; }
      .logout-btn { 
        background: #f3f4f6; 
        color: #374151; 
        border: 1px solid #d1d5db;
      }
      .logout-btn:hover { background: #e5e7eb; }
      
      /* 彈跳視窗登入樣式 */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .popup-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* 深色模式：彈出視窗 */
      .theme-dark .popup-content {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .popup-content h3,
      .theme-dark .popup-content p {
        color: var(--text-primary) !important;
      }
      
      .popup-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      
      .popup-message {
        font-size: 16px;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      
      .popup-btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 10px;
      }
      
      .popup-btn:hover {
        background: #2980b9;
      }
      
      .popup-btn.secondary {
        background: #95a5a6;
      }
      
      .popup-btn.secondary:hover {
        background: #7f8c8d;
      }
      
      /* 手機版用戶認證優化 */
      @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; gap: 12px; }
        .user-info { width: 100%; justify-content: space-between; }
        .auth-buttons { width: 100%; justify-content: flex-end; }
        .login-btn, .logout-btn { padding: 10px 16px; font-size: 16px; }
      }
      .chat { border: 1px solid #e5e7eb; background: #f9fafb; border-radius: 12px; height: 60vh; overflow: auto; padding: 16px; }
      .msg { margin: 12px 0; line-height: 1.6; display: flex; }
      .msg.user { justify-content: flex-end; }
      .msg.assistant { justify-content: flex-start; }
      .msg-bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; }
      .msg.user .msg-bubble { background: #3b82f6; color: #ffffff; border-bottom-right-radius: 4px; }
      .msg.assistant .msg-bubble { background: #f3f4f6; color: #374151; border-bottom-left-radius: 4px; }
      
      /* 深色模式：手機版 msg-bubble */
      .theme-dark .msg.assistant .msg-bubble {
        background: var(--gradient-card) !important;
        color: #ffffff !important;
      }
      
      .theme-dark .msg.assistant .msg-bubble p,
      .theme-dark .msg.assistant .msg-bubble span,
      .theme-dark .msg.assistant .msg-bubble div {
        color: #ffffff !important;
      }
      .msg-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
      .msg.user .msg-label { text-align: right; }
      .msg.assistant .msg-label { text-align: left; }
      
      /* 載入動畫 */
      .loading { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        padding: 8px 12px;
        background: #f0f9ff;
        color: #0c4a6e;
        border-radius: 8px;
        margin-right: 20px;
        max-width: 70%;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid #f0f9ff;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
      }
      .spinner { 
        width: 16px; 
        height: 16px; 
        border: 2px solid #e5e7eb; 
        border-top: 2px solid #3b82f6; 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .controls { display: flex; gap: 8px; margin-top: 12px; align-items:center; }
      textarea { flex: 1; min-height: 40px; max-height: 140px; resize: vertical; border-radius: 10px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding: 10px 12px; line-height: 1.4; -webkit-appearance: none; }
      button { padding: 10px 14px; border-radius: 10px; border:1px solid #d1d5db; background:#f9fafb; color:#374151; cursor:pointer; -webkit-appearance: none; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .row { display:flex; gap:8px; flex-direction:column; }
      .meta { display:flex; gap:8px; margin-bottom:8px; align-items:center; flex-wrap:wrap; }
      .meta input, .meta select { flex:1; min-width: 200px; border-radius: 8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; padding:8px 10px; }
      .small { font-size:12px; color:#6b7280; }
      .tag { display:inline-block; padding:4px 8px; border:1px solid #d1d5db; border-radius:999px; font-size:12px; color:#6b7280; background:#f3f4f6; }
      
      /* 設定區塊樣式 */
      .settings-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; transition: background-color 0.3s ease, border-color 0.3s ease; }
      .settings-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px; }
      .settings-block h3:hover { color:#1d4ed8; }
      .settings-toggle { font-size:12px; transition:transform 0.2s ease; }
      .settings-content { transition:all 0.3s ease; overflow:hidden; }
      .settings-content.collapsed { max-height:0; margin:0; padding:0; }
      .settings-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px; }
      .setting-item { display:flex; flex-direction:column; gap:6px; }
      .setting-item label { font-size:12px; color:#6b7280; font-weight:500; transition: color 0.3s ease; }
      .setting-item input, .setting-item select { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#ffffff; color:#374151; -webkit-appearance: none; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
      
      /* 深色模式：設定區塊 */
      .theme-dark .settings-block {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .settings-block h3 {
        color: var(--accent-blue) !important;
      }
      
      .theme-dark .settings-block h3:hover {
        color: #60a5fa !important;
      }
      
      .theme-dark .setting-item label {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .setting-item input,
      .theme-dark .setting-item select {
        background: var(--input-bg) !important;
        color: #ffffff !important; /* 白色文字 */
        border-color: var(--input-border) !important;
      }
      
      .theme-dark .setting-item input::placeholder,
      .theme-dark .setting-item select::placeholder {
        color: var(--text-tertiary) !important;
        opacity: 0.8 !important;
      }
      
      /* 覆蓋內聯樣式中的白色背景和深色文字 */
      .theme-dark .setting-item input[style*="background"],
      .theme-dark .setting-item select[style*="background"],
      .theme-dark input[style*="background: white"],
      .theme-dark input[style*="background:white"],
      .theme-dark input[style*="background: #ffffff"],
      .theme-dark input[style*="background:#ffffff"],
      .theme-dark select[style*="background: white"],
      .theme-dark select[style*="background:white"] {
        background: var(--input-bg) !important;
        color: #ffffff !important; /* 白色文字 */
        border-color: var(--input-border) !important;
      }
      
      .theme-dark input[style*="color: #374151"],
      .theme-dark input[style*="color:#374151"],
      .theme-dark select[style*="color: #374151"],
      .theme-dark select[style*="color:#374151"] {
        color: #ffffff !important; /* 強制改為白色 */
      }
      .apply-btn { background:#3b82f6; border:1px solid #2563eb; color:#ffffff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; }
      .apply-btn:hover { background:#2563eb; }
      .applied-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
      
      /* 結果區塊樣式 */
      .results-block { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-top:16px; display:none; }
      .results-block h3 { margin:0 0 16px; color:#2563eb; font-size:16px; }
      
      .theme-dark .results-block {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .results-block h3 {
        color: var(--accent-blue) !important;
      }
      .result-item { margin-bottom:16px; }
      .result-item h4 { margin:0 0 8px; color:#374151; font-size:14px; font-weight:500; }
      .result-item .content { background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:12px; color:#374151; white-space:pre-wrap; line-height:1.6; }
      
      .theme-dark .result-item h4 {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .result-item .content {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      /* 彈出框樣式 */
      .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; }
      
      .theme-dark .toast {
        background: #10b981 !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
      }
      .toast.show { animation: slideIn 0.3s ease-out; }
      .toast.hide { animation: slideOut 0.3s ease-in; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      
      /* iOS Safari 特定優化 */
      @supports (-webkit-touch-callout: none) {
        .chat { -webkit-overflow-scrolling: touch; }
        textarea { -webkit-user-select: text; }
        input, select { -webkit-user-select: text; }
        .msg-bubble { -webkit-user-select: text; }
        .result-item .content { -webkit-user-select: text; }
      }
      
      /* 防止 iOS Safari 縮放 */
      input[type="text"], input[type="email"], input[type="password"], textarea, select { font-size: 16px; }
      
      /* 快速按鈕樣式 */
      /* 快速按鈕：預設隱藏，只在 mode2 頁面顯示 */
      .quick-buttons { 
        display: none !important; 
      }
      
      #mode2.active .quick-buttons {
        display: flex !important;
        gap: 8px; 
        margin-bottom: 12px; 
        flex-wrap: wrap;
        justify-content: center;
      }
      .quick-btn { 
        padding: 10px 18px; 
        border-radius: 20px; 
        border: 1px solid #3b82f6; 
        background: #ffffff; 
        color: #3b82f6; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .quick-btn:hover { 
        background: #3b82f6; 
        color: #ffffff; 
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .quick-btn:active { 
        transform: translateY(0); 
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
      }
      
      /* 手機版快速按鈕優化：只在 mode2 頁面顯示 */
      @media (max-width: 768px) {
        /* 預設隱藏 */
        .quick-buttons,
        .input-row {
          display: none !important;
        }
        
        /* 只在 mode2 頁面顯示 */
        #mode2.active .quick-buttons { 
          display: flex !important;
          gap: 6px; 
          margin-bottom: 8px;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: auto !important;
          padding: 0 !important;
          background: transparent !important;
        }
        .quick-btn { 
          padding: 6px 8px; 
          font-size: 12px;
          flex: 1;
          min-width: 0;
          text-align: center;
        }
        #mode2.active .input-row {
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: 80px !important;
        }
      }
      
      /* 帳號定位記錄列表樣式 */
      .positioning-history-content {
        padding: 10px;
        max-height: 500px;
        overflow-y: auto;
      }
      
      .positioning-records {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .positioning-record-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
      }
      
      .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .record-number {
        font-weight: 600;
        color: #3b82f6;
        font-size: 14px;
      }
      
      .record-date {
        font-size: 12px;
        color: #6b7280;
      }
      
      .record-preview {
        color: #374151;
        font-size: 14px;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      
      .record-actions {
        display: flex;
        gap: 8px;
      }
      
      .view-btn, .delete-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .view-btn {
        background: #3b82f6;
        color: white;
      }
      
      .view-btn:hover {
        background: #2563eb;
      }
      
      .delete-btn {
        background: #ef4444;
        color: white;
      }
      
      .delete-btn:hover {
        background: #dc2626;
      }
      
      /* 詳細內容彈出視窗樣式 */
      .detail-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      
      .detail-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* 深色模式：詳細內容模態框（已在上面定義，這裡確保覆蓋） */
      .theme-dark .detail-modal {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-modal-header {
        background: var(--bg-secondary) !important;
        border-bottom-color: var(--border-color) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-modal-body {
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-info,
      .theme-dark .detail-content,
      .theme-dark .record-detail,
      .theme-dark .detail-meta,
      .theme-dark .detail-value,
      .theme-dark .content-text {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .detail-meta .detail-label {
        color: var(--text-secondary) !important;
      }
      
      .theme-dark .close-detail-btn {
        color: var(--text-primary) !important;
      }
      
      .theme-dark .close-detail-btn:hover {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
      }
      
      .detail-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #111827;
      }
      
      .close-detail-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }
      
      .close-detail-btn:hover {
        background: #f3f4f6;
        color: #111827;
      }
      
      .detail-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }
      
      .detail-info {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .detail-info span {
        font-size: 14px;
        color: #6b7280;
      }
      
      .detail-info strong {
        color: #111827;
        font-weight: 600;
      }
      
      .detail-content {
        color: #374151;
        line-height: 1.8;
        font-size: 15px;
      }
      
      
      /* 擴大用戶抽屜視窗 */
      .user-drawer {
        width: 85%;
        max-width: 1000px;
        height: 85vh;
        max-height: 700px;
      }
      
      /* 個人資料庫頁面樣式 */
      .user-db-page {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 24px;
        text-align: center;
      }
      
      .user-db-container {
        display: flex;
        gap: 24px;
        min-height: 600px;
      }
      
      .user-db-sidebar {
        width: 280px;
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px var(--shadow);
        transition: background-color 0.3s ease;
      }
      
      .sidebar-header {
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        transition: border-color 0.3s ease;
      }
      
      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        transition: border-color 0.3s ease;
      }
      
      .profile-info h3 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      
      .profile-info p {
        margin: 0;
        font-size: 14px;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      
      .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        background: none;
        text-align: left;
        font-size: 14px;
        color: var(--text-secondary);
      }
      
      .menu-item:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .menu-item.active {
        background: var(--button-bg);
        color: var(--button-text);
      }
      
      .menu-icon {
        font-size: 16px;
      }
      
      .menu-text {
        font-weight: 500;
      }
      
      .menu-divider {
        height: 1px;
        background: var(--border-color);
        margin: 12px 0;
        transition: background-color 0.3s ease;
      }
      
      .logout-item {
        color: #dc2626;
      }
      
      .logout-item:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
      }
      
      .user-db-content {
        flex: 1;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px var(--shadow);
        transition: background-color 0.3s ease;
      }
      
      .db-section {
        display: none;
      }
      
      .db-section.active {
        display: block;
      }
      
      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        transition: color 0.3s ease;
      }
      
      .section-content {
        color: var(--text-secondary);
        line-height: 1.6;
        transition: color 0.3s ease;
      }
      
      .profile-details {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }
      
      .detail-item label {
        font-weight: 600;
        color: var(--text-primary);
        min-width: 80px;
        transition: color 0.3s ease;
      }
      
      .detail-item span {
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }

      /* ===== 模式3：IP人設規劃模式樣式 ===== */
      .mode3-page {
        min-height: 100vh;
        background: transparent; /* 與 Mode2 一致，移除灰色背景 */
        padding: 0;
      }
      
      /* IP人設規劃固定佈局 */
      .mode3-fixed {
        position: relative;
        width: 100%;
        min-height: calc(100vh - 60px);
        background: transparent; /* 與 Mode2 一致，移除灰色背景 */
      }
      
      .mode3-page {
        position: relative;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      .mode3-chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 80px 20px 0 20px;
        overflow: hidden;
      }
      
      /* Mode3 使用與 Mode2 相同的樣式結構 */
      .mode3-chat-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
      }
      
      #mode3-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
        margin: 0;
        background: transparent;
        border: none;
        border-radius: 0;
        min-height: 0;
        height: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        touch-action: pan-y;
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Mode3 輸入區域使用與 Mode2 相同的樣式 */
      .mode3-chat-container .input-row {
        background: transparent;
        border: none;
        padding: 8px 24px 16px 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .mode3-chat-container .input-container {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        width: 100%;
      }
      
      /* Mode3 快速按鈕使用與 Mode2 相同的樣式（電腦版） */
      .mode3-chat-container .quick-buttons {
        gap: 8px;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 100%;
        background: transparent;
        box-sizing: border-box;
      }
      
      .mode3-chat-container .quick-btn {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 8px 16px;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 400;
        box-shadow: none;
        width: auto;
        min-width: fit-content;
        flex-shrink: 0;
        display: inline-flex;
        justify-content: center;
        align-items: center;
      }
      
      .mode3-chat-container .quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      /* Mode3 輸入框使用與 Mode2 相同的樣式 */
      #mode3-message-input {
        flex: 1;
        min-height: 44px;
        max-height: 200px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        background: #ffffff;
        resize: vertical;
        overflow-y: auto;
        line-height: 1.5;
      }
      
      #mode3-message-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
      }
      
      #mode3-send-btn {
        height: 44px;
        min-width: 44px;
        border-radius: 10px;
        background: #3b82f6;
        color: #ffffff;
        border: none;
        padding: 0 18px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #mode3-send-btn:hover {
        background: #2563eb;
      }
      
      #mode3-send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      
      /* 保留舊的 mode3 樣式作為備用（但會被新樣式覆蓋） */
      .mode3-input-container {
        position: sticky;
        bottom: 0;
      }
      
      /* Mode3 訊息框樣式 - 與 Mode2 一致，確保用戶對話在右邊 */
      #mode3 .message.user,
      #mode3-chatMessages .message.user,
      #mode3-chat-messages .message.user,
      #mode3 .message.user.message,
      #mode3-chatMessages .message.user.message {
        display: flex !important;
        flex-direction: row !important; /* 正常順序：內容在左，頭像在右 */
        align-items: flex-start !important;
        justify-content: flex-end !important; /* 右對齊，讓整個消息靠右 */
        margin-bottom: 16px !important;
        background: transparent !important;
        margin-left: auto !important; /* 確保消息整體靠右 */
      }
      
      #mode3 .message.user .message-content,
      #mode3-chatMessages .message.user .message-content,
      #mode3-chat-messages .message.user .message-content {
        flex: 1 !important;
        background: #dbeafe !important; /* 添加背景色，與 Mode2 一致 */
        padding: 20px 40px !important; /* 與 AI 回覆框一樣的 padding，與 Mode2 一致 */
        padding-left: 50px !important; /* 增加左邊 padding，避免文字太貼邊界 */
        border-radius: 12px !important; /* 添加圓角 */
        border: 1px solid #3b82f6 !important; /* 添加邊框 */
        color: #1e40af !important; /* 添加文字顏色 */
        line-height: 1.6 !important; /* 與 Mode2 一致的行高 */
        text-align: right !important; /* 用戶對話泡泡文字靠右對齊 */
        margin-right: 12px !important; /* 對話泡泡與頭像之間的間距 */
        margin-left: 0 !important;
        order: 1 !important; /* 確保內容在左邊 */
        font-size: 16px !important; /* 字體大小 */
        box-sizing: border-box !important;
      }
      
      /* Mode3 用戶頭像樣式 - 確保在對話泡泡右邊 */
      #mode3 .message.user .message-avatar,
      #mode3-chatMessages .message.user .message-avatar,
      #mode3-chat-messages .message.user .message-avatar {
        width: 32px !important;
        height: 32px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex-shrink: 0 !important;
        margin-right: 0 !important;
        margin-left: 0 !important; /* 移除左邊距，因為已經在右邊 */
        background: #3b82f6 !important;
        color: white !important;
        overflow: hidden !important;
        order: 2 !important; /* 確保頭像在右邊 */
      }
      
      #mode3 .message.user .message-avatar img,
      #mode3-chatMessages .message.user .message-avatar img,
      #mode3-chat-messages .message.user .message-avatar img {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        object-fit: cover !important;
        display: block !important;
      }
      
      #mode3 .message.user .message-avatar:has(img),
      #mode3-chatMessages .message.user .message-avatar:has(img),
      #mode3-chat-messages .message.user .message-avatar:has(img) {
        background: transparent !important;
      }
      
      /* Mode3 AI 訊息容器樣式 - 與 Mode2 一致 */
      #mode3 .message.ai,
      #mode3-chatMessages .message.ai,
      #mode3-chat-messages .message.ai,
      #mode3 .message.assistant,
      #mode3-chatMessages .message.assistant,
      #mode3-chat-messages .message.assistant {
        display: flex !important;
        margin-bottom: 16px !important;
        align-items: flex-start !important;
        background: transparent !important;
      }
      
      /* Mode3 AI 對話泡泡內容樣式 - 與 Mode2 完全一致 */
      #mode3 .message.ai .message-content,
      #mode3-chatMessages .message.ai .message-content,
      #mode3-chat-messages .message.ai .message-content,
      #mode3 .message.assistant .message-content,
      #mode3-chatMessages .message.assistant .message-content,
      #mode3-chat-messages .message.assistant .message-content {
        flex: 1 !important;
        background: #f8fafc !important;
        padding: 20px 40px !important;
        border-radius: 12px !important;
        border: 1px solid #e5e7eb !important;
        color: #1f2937 !important;
        margin-left: 12px !important;
        font-size: 16px !important; /* AI 對話泡泡字體大小 */
        line-height: 1.6 !important; /* 行高 */
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji" !important;
        text-align: left !important; /* AI 對話泡泡靠左對齊 */
        box-sizing: border-box !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* Mode3 AI 頭像樣式 - 與 Mode2 一致 */
      #mode3 .message.ai .message-avatar,
      #mode3-chatMessages .message.ai .message-avatar,
      #mode3-chat-messages .message.ai .message-avatar,
      #mode3 .message.assistant .message-avatar,
      #mode3-chatMessages .message.assistant .message-avatar,
      #mode3-chat-messages .message.assistant .message-avatar {
        width: 32px !important;
        height: 32px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 16px !important;
        margin-right: 12px !important;
        flex-shrink: 0 !important;
        background: #10a37f !important;
        color: white !important;
      }
      
      /* Mode3 AI 對話泡泡段落樣式 - 與 Mode2 完全一致，降低行距 */
      #mode3 .message.ai .message-content,
      #mode3-chatMessages .message.ai .message-content,
      #mode3-chat-messages .message.ai .message-content,
      #mode3 .message.assistant .message-content,
      #mode3-chatMessages .message.assistant .message-content,
      #mode3-chat-messages .message.assistant .message-content {
        line-height: 1.5 !important; /* 降低整體行距，與 Mode2 一致 */
      }
      
      #mode3 .message.ai .message-content p,
      #mode3-chatMessages .message.ai .message-content p,
      #mode3-chat-messages .message.ai .message-content p,
      #mode3 .message.assistant .message-content p,
      #mode3-chatMessages .message.assistant .message-content p,
      #mode3-chat-messages .message.assistant .message-content p {
        margin: 0 0 6px 0 !important; /* 減少段落間距 */
        line-height: 1.4 !important; /* 降低段落內行距 */
      }
      
      #mode3 .message.ai .message-content p:first-child,
      #mode3-chatMessages .message.ai .message-content p:first-child,
      #mode3-chat-messages .message.ai .message-content p:first-child,
      #mode3 .message.assistant .message-content p:first-child,
      #mode3-chatMessages .message.assistant .message-content p:first-child,
      #mode3-chat-messages .message.assistant .message-content p:first-child {
        margin-top: 0 !important;
      }
      
      #mode3 .message.ai .message-content p:last-child,
      #mode3-chatMessages .message.ai .message-content p:last-child,
      #mode3-chat-messages .message.ai .message-content p:last-child,
      #mode3 .message.assistant .message-content p:last-child,
      #mode3-chatMessages .message.assistant .message-content p:last-child,
      #mode3-chat-messages .message.assistant .message-content p:last-child {
        margin-bottom: 0 !important;
      }
      
      /* Mode3 AI 對話泡泡列表樣式 - 與 Mode2 一致 */
      #mode3 .message.ai .message-content ul,
      #mode3-chatMessages .message.ai .message-content ul,
      #mode3-chat-messages .message.ai .message-content ul,
      #mode3 .message.assistant .message-content ul,
      #mode3-chatMessages .message.assistant .message-content ul,
      #mode3-chat-messages .message.assistant .message-content ul {
        margin: 8px 0 !important;
        padding-left: 20px !important;
      }
      
      #mode3 .message.ai .message-content li,
      #mode3-chatMessages .message.ai .message-content li,
      #mode3-chat-messages .message.ai .message-content li,
      #mode3 .message.assistant .message-content li,
      #mode3-chatMessages .message.assistant .message-content li,
      #mode3-chat-messages .message.assistant .message-content li {
        margin: 4px 0 !important;
      }
      
      /* Mode3 AI 對話泡泡最後一個段落樣式 - 與 Mode2 一致 */
      #mode3 .message.ai .message-content:last-child p:last-child,
      #mode3-chatMessages .message.ai .message-content:last-child p:last-child,
      #mode3-chat-messages .message.ai .message-content:last-child p:last-child,
      #mode3 .message.assistant .message-content:last-child p:last-child,
      #mode3-chatMessages .message.assistant .message-content:last-child p:last-child,
      #mode3-chat-messages .message.assistant .message-content:last-child p:last-child {
        margin-bottom: 0 !important;
      }
      
      /* 確保 mode3 的 typing-indicator 正確顯示 */
      #mode3-chatMessages .typing-indicator,
      #mode3-chat-messages .typing-indicator {
        display: flex !important;
        align-items: center !important;
        font-style: italic !important;
        color: #6b7280 !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      #mode3-chatMessages .typing-dots,
      #mode3-chat-messages .typing-dots {
        display: flex !important;
        margin-left: 10px !important;
      }
      
      #mode3-chatMessages .typing-dot,
      #mode3-chat-messages .typing-dot {
        width: 6px !important;
        height: 6px !important;
        margin: 0 2px !important;
        background-color: #3b82f6 !important;
        border-radius: 50% !important;
        animation: dot-flashing 1s infinite alternate !important;
      }
      
      #mode3-chatMessages .typing-dot:nth-child(2),
      #mode3-chat-messages .typing-dot:nth-child(2) {
        animation-delay: 0.2s !important;
      }
      
      #mode3-chatMessages .typing-dot:nth-child(3),
      #mode3-chat-messages .typing-dot:nth-child(3) {
        animation-delay: 0.4s !important;
      }
      
      /* 使用說明步驟指南樣式 */
      .mode3-step-guide {
        margin: 16px 0;
      }
      
      .mode3-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border-left: 4px solid #4f46e5;
      }
      
      .mode3-step-number {
        width: 32px;
        height: 32px;
        background: #4f46e5;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .mode3-step-content {
        flex: 1;
      }
      
      .mode3-step-content strong {
        color: #1f2937;
        font-size: 14px;
        display: block;
        margin-bottom: 4px;
      }
      
      .mode3-step-content p {
        color: #6b7280;
        font-size: 13px;
        margin: 0;
        line-height: 1.4;
      }
      
      /* 生成內容類型樣式 */
      .mode3-result-types {
        margin: 12px 0;
      }
      
      .mode3-result-type {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        border-left: 3px solid #10b981;
      }
      
      .mode3-result-type strong {
        color: #1f2937;
        font-size: 13px;
        display: block;
        margin-bottom: 4px;
      }
      
      .mode3-result-type p {
        color: #6b7280;
        font-size: 12px;
        margin: 0;
        line-height: 1.3;
      }
      
      /* IP人設規劃使用說明按鈕和抽屜樣式 */
      /* 只在 mode3 頁面激活時顯示 */
      .mode3-instructions-btn-container,
      .mode3-results-btn-container {
        display: none;
      }
      
      #mode3.active .mode3-instructions-btn-container,
      #mode3.active .mode3-results-btn-container,
      body.mode3-active .mode3-instructions-btn-container,
      body.mode3-active .mode3-results-btn-container {
        display: block;
      }
      
      .mode3-instructions-btn-container {
        position: fixed;
        top: 75px;
        left: 20px; /* 改到左邊 */
        z-index: 1001;
      }
      
      .mode3-results-btn-container {
        position: fixed;
        top: 75px;
        left: 120px; /* 改到左邊 */
        z-index: 1001;
      }
      
      /* 抽屜元素只在 mode3 激活時顯示 */
      .mode3-instructions-overlay,
      .mode3-instructions-drawer,
      .mode3-results-overlay,
      .mode3-results-drawer {
        display: none;
      }
      
      body.mode3-active .mode3-instructions-overlay.open,
      body.mode3-active .mode3-instructions-drawer.open,
      body.mode3-active .mode3-results-overlay.open,
      body.mode3-active .mode3-results-drawer.open {
        display: block;
      }
      
      .mode3-results-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
      }
      
      .mode3-results-btn:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
      }
      
      .mode3-results-icon {
        font-size: 16px;
      }
      
      .mode3-results-text {
        font-size: 14px;
      }
      
      .mode3-instructions-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
      }
      
      .mode3-instructions-btn:hover {
        background: #4338ca;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(79, 70, 229, 0.4);
      }
      
      .mode3-instructions-icon {
        font-size: 16px;
      }
      
      .mode3-instructions-text {
        font-size: 14px;
      }
      
      /* 抽屜樣式 */
      .mode3-instructions-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .mode3-instructions-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      
      .mode3-instructions-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background: white;
        z-index: 9999;
        transition: right 0.3s ease;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .mode3-instructions-drawer.open {
        right: 0;
      }
      
      .mode3-instructions-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .mode3-instructions-drawer-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .mode3-instructions-drawer-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      
      .mode3-instructions-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .mode3-instructions-drawer-content {
        padding: 20px;
        color: #374151;
        line-height: 1.6;
      }
      
      .mode3-instructions-drawer-content p {
        margin: 0 0 16px 0;
      }
      
      .mode3-instructions-drawer-content ul {
        margin: 0 0 16px 0;
        padding-left: 20px;
      }
      
      .mode3-instructions-drawer-content li {
        margin-bottom: 8px;
      }
      
      /* 生成結果抽屜樣式 */
      .mode3-results-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .mode3-results-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      
      .mode3-results-drawer {
        position: fixed;
        top: 0;
        right: -500px;
        width: 500px;
        height: 100%;
        background: white;
        z-index: 9999;
        transition: right 0.3s ease;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      
      .mode3-results-drawer.open {
        right: 0;
      }
      
      .mode3-results-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      
      .mode3-results-drawer-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
      }
      
      .mode3-results-drawer-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      
      .mode3-results-drawer-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .mode3-results-drawer-content {
        padding: 20px;
        color: #374151;
        line-height: 1.6;
      }
      
      .mode3-results-drawer-content .mode3-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .mode3-results-drawer-content .mode3-tab {
        padding: 10px 16px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-size: 14px;
        color: #6b7280;
        transition: all 0.2s ease;
      }
      
      .mode3-results-drawer-content .mode3-tab.active {
        color: #4f46e5;
        border-bottom-color: #4f46e5;
      }
      
      .mode3-results-drawer-content .mode3-tab:hover {
        color: #4f46e5;
      }
      
      .mode3-results-drawer-content .mode3-result-block {
        display: none;
      }
      
      .mode3-results-drawer-content .mode3-result-block.active {
        display: block;
      }
      
      .mode3-results-drawer-content .mode3-result-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }
      
      .mode3-results-drawer-content .mode3-action-btn {
        flex: 1;
        padding: 10px 16px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .mode3-results-drawer-content .mode3-action-btn:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
      }
      
      /* 手機版適配 */
      @media (max-width: 768px) {
        .mode3-instructions-drawer,
        .mode3-results-drawer {
          width: 100%;
          right: -100%;
        }
        
        .mode3-instructions-btn-container {
          top: 65px;
          left: 15px; /* 改到左邊 */
          right: auto; /* 取消右邊定位 */
        }
        
        .mode3-results-btn-container {
          top: 65px;
          left: 80px; /* 改到左邊 */
          right: auto; /* 取消右邊定位 */
        }
        
        .mode3-instructions-btn,
        .mode3-results-btn {
          padding: 10px 12px;
          font-size: 13px;
        }
        
        .mode3-instructions-text,
        .mode3-results-text {
          display: none;
        }
        
        .mode3-fixed {
          min-height: calc(100vh - 50px);
        }
        
        .mode3-page {
          padding: 0 10px;
        }
        
        .mode3-chat-container {
          padding: 70px 10px 0 10px;
        }
        
        .mode3-input-container {
          padding: 12px 15px 15px 15px;
          margin-bottom: 0;
        }
        
        .mode3-quick-buttons {
          gap: 4px;
          margin-bottom: 6px;
        }
        
        .mode3-quick-btn {
          padding: 5px 10px;
          font-size: 12px;
          flex: 1;
          min-width: 0;
        }
        
        .mode3-message-input {
          padding: 6px 12px;
          min-height: 32px;
          max-height: 70px;
        }
      }

      .mode3-container {
        display: flex;
        height: calc(100vh - 60px);
        gap: 0;
      }

      .mode3-left-panel {
        flex: 1;
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }

      .mode3-right-panel {
        flex: 1;
        background: white;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
      }

      /* 說明欄位 */
      .mode3-instructions {
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }

      .mode3-instructions-header {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f1f5f9;
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }

      .mode3-instructions-header:hover {
        background: #e2e8f0;
      }

      .mode3-instructions-title {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      .mode3-instructions-toggle {
        font-size: 12px;
        color: #6b7280;
        transition: transform 0.2s;
      }

      .mode3-instructions.collapsed .mode3-instructions-toggle {
        transform: rotate(-90deg);
      }

      .mode3-instructions-content {
        padding: 16px;
        font-size: 13px;
        line-height: 1.6;
        color: #4b5563;
        max-height: 300px;
        overflow-y: auto;
        transition: max-height 0.3s ease;
      }

      .mode3-instructions.collapsed .mode3-instructions-content {
        max-height: 0;
        padding: 0 16px;
        overflow: hidden;
      }

      .mode3-instructions-content p {
        margin: 0 0 12px 0;
      }

      .mode3-instructions-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-instructions-content li {
        margin: 4px 0;
      }

      /* 聊天容器 */
      .mode3-chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .mode3-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        min-height: 200px;
        transition: min-height 0.3s ease;
      }

      .mode3-chat-messages.expanded {
        min-height: 400px;
      }

      .mode3-message {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
      }

      .mode3-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .mode3-user-message .mode3-message-avatar {
        background: #3b82f6;
        color: white;
      }

      .mode3-assistant-message .mode3-message-avatar {
        background: #f3f4f6;
        color: #374151;
      }

      .mode3-message-content {
        flex: 1;
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        color: #1f2937;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }

      .mode3-user-message .mode3-message-content {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
      }
      
      /* 深色模式：Mode3 消息內容 - AI 消息改為純白色 */
      .theme-dark .mode3-message-content {
        background: var(--gradient-card) !important;
        color: #ffffff !important; /* 改為純白色 */
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .mode3-user-message .mode3-message-content {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
        border-color: rgba(59, 130, 246, 0.3) !important;
      }
      
      /* 覆蓋內聯樣式 */
      .theme-dark .mode3-message-content[style*="background: #f8fafc"],
      .theme-dark .mode3-message-content[style*="background:#f8fafc"],
      .theme-dark .mode3-message-content[style*="background: white"],
      .theme-dark .mode3-message-content[style*="background:white"] {
        background: var(--gradient-card) !important;
        color: #ffffff !important; /* 改為純白色 */
      }
      
      .theme-dark .mode3-user-message .mode3-message-content[style*="background: #dbeafe"],
      .theme-dark .mode3-user-message .mode3-message-content[style*="background:#dbeafe"] {
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%) !important;
        color: #dbeafe !important;
      }
      
      /* 覆蓋 Mode3 內聯樣式中的深色文字 - 強制改為白色 */
      .theme-dark .mode3-message-content[style*="color: #1f2937"],
      .theme-dark .mode3-message-content[style*="color:#1f2937"],
      .theme-dark .mode3-message-content[style*="color: #374151"],
      .theme-dark .mode3-message-content[style*="color:#374151"] {
        color: #ffffff !important; /* 強制改為純白色 */
      }
      
      .theme-dark .mode3-user-message .mode3-message-content[style*="color: #1e40af"],
      .theme-dark .mode3-user-message .mode3-message-content[style*="color:#1e40af"] {
        color: #dbeafe !important;
      }
      
      /* Mode3 AI 消息內的所有文字元素 - 強制改為白色 */
      .theme-dark .mode3-message-content p,
      .theme-dark .mode3-message-content li,
      .theme-dark .mode3-message-content span,
      .theme-dark .mode3-message-content div,
      .theme-dark .mode3-message-content h1,
      .theme-dark .mode3-message-content h2,
      .theme-dark .mode3-message-content h3,
      .theme-dark .mode3-message-content h4,
      .theme-dark .mode3-message-content h5,
      .theme-dark .mode3-message-content h6,
      .theme-dark .mode3-message-content strong,
      .theme-dark .mode3-message-content em,
      .theme-dark .mode3-message-content code,
      .theme-dark .mode3-message-content pre {
        color: #ffffff !important; /* 強制改為純白色 */
      }
      
      .theme-dark .mode3-user-message .mode3-message-content p,
      .theme-dark .mode3-user-message .mode3-message-content li,
      .theme-dark .mode3-user-message .mode3-message-content span,
      .theme-dark .mode3-user-message .mode3-message-content div {
        color: #dbeafe !important;
      }

      .mode3-message-content p {
        margin: 0 0 8px 0;
        line-height: 1.5;
      }

      .mode3-message-content ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-message-content li {
        margin: 4px 0;
      }

      .mode3-message-content:last-child p:last-child {
        margin-bottom: 0;
      }

      /* 快速按鈕 */
      .mode3-quick-buttons {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        background: #f8fafc;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      /* 深色模式：Mode3 快速按鈕容器 */
      .theme-dark .mode3-quick-buttons {
        background: var(--bg-secondary) !important;
        border-top-color: var(--border-color) !important;
      }
      
      .theme-dark .mode3-quick-buttons[style*="background: #f8fafc"],
      .theme-dark .mode3-quick-buttons[style*="background:#f8fafc"] {
        background: var(--bg-secondary) !important;
      }

      .mode3-quick-btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      
      /* 深色模式：Mode3 快速按鈕 - 與 Mode2 一致，文字改為純白色 */
      .theme-dark .mode3-quick-btn {
        background: var(--card-bg) !important;
        color: #ffffff !important; /* 改為純白色 */
        border-color: var(--border-color) !important;
      }
      
      .theme-dark .mode3-quick-btn[style*="background: white"],
      .theme-dark .mode3-quick-btn[style*="background:white"],
      .theme-dark .mode3-quick-btn[style*="background: #ffffff"],
      .theme-dark .mode3-quick-btn[style*="background:#ffffff"] {
        background: var(--card-bg) !important;
        color: #ffffff !important; /* 改為純白色 */
      }
      
      .theme-dark .mode3-quick-btn[style*="color: #374151"],
      .theme-dark .mode3-quick-btn[style*="color:#374151"],
      .theme-dark .mode3-quick-btn[style*="color: #1f2937"],
      .theme-dark .mode3-quick-btn[style*="color:#1f2937"] {
        color: #ffffff !important; /* 強制改為純白色 */
      }

      .mode3-quick-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }
      
      .theme-dark .mode3-quick-btn:hover {
        background: var(--accent-blue) !important;
        border-color: var(--accent-blue) !important;
        color: white !important;
      }

      /* 輸入區域 */
      .mode3-input-container {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        background: white;
      }

      .mode3-input-wrapper {
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }

      .mode3-message-input {
        flex: 1;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        resize: vertical;
        min-height: 44px;
        max-height: 120px;
        font-family: inherit;
      }

      .mode3-message-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .mode3-send-btn {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        flex-shrink: 0;
      }

      .mode3-send-btn:hover {
        background: #2563eb;
      }

      .mode3-send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .mode3-send-icon {
        font-size: 16px;
      }

      /* 結果面板 */
      .mode3-results-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mode3-results-header h3 {
        margin: 0;
        font-size: 16px;
        color: #374151;
      }

      .mode3-result-actions {
        display: flex;
        gap: 8px;
      }

      .mode3-action-btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #6b7280;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .mode3-action-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
      }

      /* 標籤 */
      .mode3-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        background: white;
      }

      .mode3-tab {
        flex: 1;
        background: none;
        border: none;
        padding: 12px 16px;
        cursor: pointer;
        font-size: 13px;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .mode3-tab:hover {
        background: #f8fafc;
        color: #374151;
      }

      .mode3-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
        background: #f8fafc;
      }

      /* 結果內容 */
      .mode3-results-content {
        flex: 1;
        overflow-y: auto;
        background: white;
      }

      .mode3-result-block {
        display: none;
        padding: 16px;
        height: 100%;
      }

      .mode3-result-block.active {
        display: block;
      }
      .mode3-result-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #6b7280;
      }

      .mode3-placeholder-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .mode3-placeholder-icon h4 {
        margin: 0 0 8px 0;
        color: #374151;
        font-size: 18px;
      }

      .mode3-placeholder-icon p {
        margin: 0 0 24px 0;
        font-size: 14px;
        line-height: 1.5;
      }

      .mode3-generate-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mode3-generate-btn:hover {
        background: #2563eb;
      }

      .mode3-generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* 結果內容樣式 */
      .mode3-result-content {
        line-height: 1.6;
        color: #374151;
      }

      .mode3-result-content h1,
      .mode3-result-content h2,
      .mode3-result-content h3,
      .mode3-result-content h4 {
        color: #1f2937;
        margin: 16px 0 8px 0;
      }

      .mode3-result-content h1:first-child,
      .mode3-result-content h2:first-child,
      .mode3-result-content h3:first-child,
      .mode3-result-content h4:first-child {
        margin-top: 0;
      }

      .mode3-result-content p {
        margin: 8px 0;
      }

      .mode3-result-content ul,
      .mode3-result-content ol {
        margin: 8px 0;
        padding-left: 20px;
      }

      .mode3-result-content li {
        margin: 4px 0;
      }

      .mode3-result-content strong {
        color: #1f2937;
        font-weight: 600;
      }

      .mode3-result-content em {
        color: #6b7280;
        font-style: italic;
      }

      /* 載入動畫 */
      .mode3-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
      }

      .mode3-loading-dots {
        display: flex;
        gap: 4px;
      }

      .mode3-loading-dot {
        width: 6px;
        height: 6px;
        background: #3b82f6;
        border-radius: 50%;
        animation: mode3-bounce 1.4s infinite ease-in-out both;
      }

      .mode3-loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .mode3-loading-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes mode3-bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .mode3-container {
          flex-direction: column;
          height: auto;
          padding-top: 70px;
        }

        .mode3-left-panel,
        .mode3-right-panel {
          min-height: 50vh;
        }

        .mode3-tabs {
          flex-wrap: wrap;
        }

        .mode3-tab {
          flex: none;
          min-width: 120px;
        }
      }
      
      /* 桌面版樣式 */
      @media (min-width: 769px) {
        .desktop-only {
          display: block !important;
        }
      }
      
      /* 手機版抽屜導航樣式 */
      .mobile-drawer-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 20px;
        color: #374151;
        cursor: pointer;
        padding: 8px;
        margin-right: 12px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .mobile-drawer-toggle:hover {
        background-color: #f3f4f6;
      }

      .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }

      .mobile-drawer {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100%;
        background: white;
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .mobile-drawer.open {
        left: 0;
      }

      .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f8fafc;
      }

      .mobile-drawer-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }

      .mobile-drawer-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .mobile-drawer-close:hover {
        background-color: #e5e7eb;
      }

      .mobile-drawer-content {
        padding: 20px 0;
      }

      .mobile-drawer-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        color: #374151;
        text-decoration: none;
        transition: background-color 0.2s;
        border-left: 3px solid transparent;
      }

      .mobile-drawer-item:hover {
        background-color: #f8fafc;
        color: #1f2937;
      }

      .mobile-drawer-item.active {
        background-color: #eff6ff;
        color: #3b82f6;
        border-left-color: #3b82f6;
      }

      .mobile-drawer-icon {
        font-size: 20px;
        margin-right: 12px;
        width: 24px;
        text-align: center;
      }

      .mobile-drawer-text {
        font-size: 16px;
        font-weight: 500;
      }

      /* ChatGPT 風格響應式設計 */
      @media (max-width: 768px) {
        /* 手機版抽屜按鈕顯示 */
        .mobile-drawer-toggle {
          display: block !important;
        }

        /* 隱藏桌面版導航標籤 */
        .navbar-tabs {
          display: none !important;
        }

        /* 隱藏底部導覽列 */
        .bottom-navbar {
          display: none !important;
        }

        .chat-container {
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        
        .message {
          padding: 15px 0 !important;
          margin-bottom: 0 !important;
        }
        
        .message-avatar {
          width: 28px !important;
          height: 28px !important;
          min-width: 28px !important;
          font-size: 14px !important;
          margin-right: 12px !important;
        }
        
        .message-content {
          max-width: calc(100% - 40px) !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
        }
        
        .input-row {
          padding: 20px !important;
          background: #f7f7f8 !important;
          border: none !important;
          box-shadow: none !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 6px !important;
          z-index: auto !important;
        }
        
        .input-container {
          background: white !important;
          border: 1px solid #e5e7eb !important;
          border-radius: 12px !important;
          padding: 8px 12px !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        .input-container textarea {
          font-size: 16px !important; /* 防止iOS縮放 */
          padding: 8px 0 !important;
          min-height: 24px !important;
          max-height: 120px !important;
          line-height: 1.5 !important;
          resize: none !important;
        }
        
        .input-container button {
          background: #3b82f6 !important;
          color: white !important;
          border: none !important;
          border-radius: 8px !important;
          padding: 8px 12px !important;
          font-size: 16px !important;
          min-width: 40px !important;
          height: 40px !important;
        }
        
        .quick-buttons {
          gap: 6px !important;
          padding: 20px !important;
          background: #f7f7f8 !important;
          border: none !important;
          z-index: auto !important;
          display: flex !important;
          flex-wrap: wrap !important;
          justify-content: center !important;
        }
        
        .quick-btn {
          padding: 8px 16px !important;
          font-size: 14px !important;
          border-radius: 12px !important;
          background: white !important;
          border: 1px solid #d1d5db !important;
          white-space: nowrap !important;
          min-width: fit-content !important;
          flex-shrink: 0 !important;
        }
        
        
        /* 手機版聊天容器調整 */
        .chat-container {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          max-width: 100% !important;
          margin: 0 !important;
          display: flex !important;
          flex-direction: column !important;
        }
        
        .chat-messages {
          flex: 1 !important;
          padding: 0 !important;
          padding-top: 80px !important; /* 添加頂部間距避免被頁首遮住 */
          padding-bottom: 0 !important; /* 移除底部padding，讓訊息緊貼輸入區域 */
          overflow-y: auto !important;
          min-height: 0 !important;
          max-width: none !important;
          width: 100% !important;
        }
        
        /* 手機版快速按鈕獨立顯示 - 已在上方定義 */
        
        .input-row {
          padding: 15px !important;
          margin-top: 0 !important;
          background: white !important;
          border: none !important;
          box-shadow: none !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 6px !important;
          z-index: auto !important;
        }
        
        .message {
          padding: 15px 0 !important;
        }
        
        .message-content {
          padding: 15px 20px !important;
          max-width: none !important;
          width: 100% !important;
        }
        
        .message-avatar {
          width: 28px !important;
          height: 28px !important;
          min-width: 28px !important;
          font-size: 14px !important;
          margin-right: 12px !important;
        }
        
        .quick-btn {
          padding: 6px 12px !important;
          font-size: 13px !important;
        }
        
        
        .input-container {
          padding: 6px 10px !important;
          border-radius: 10px !important;
        }
        
        .chat-input {
          font-size: 16px !important; /* 防止iOS縮放 */
          padding: 6px 0 !important;
        }
        
        .send-btn {
          font-size: 16px !important;
          padding: 6px !important;
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .chat-container {
          max-width: 700px;
        }
      }
      
      @media (min-width: 1025px) {
        .chat-container {
          max-width: 800px;
        }
      }

      /* 桌面版樣式 - 隱藏手機版抽屜 */
      @media (min-width: 769px) {
        .mobile-drawer-toggle {
          display: none !important;
        }
        
        .mobile-drawer {
          display: none !important;
        }
        
        .mobile-drawer-overlay {
          display: none !important;
        }
        
        .bottom-navbar {
          display: none !important;
        }
      }
      
      /* 響應式設計 - 手機版 */
      @media (max-width: 768px) {
        /* 頂部導航欄手機版 */
        .top-navbar {
          padding: 12px 16px;
          padding-top: calc(12px + var(--safe-area-inset-top));
          flex-wrap: wrap;
          gap: 12px;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1000;
        }
        
        .navbar-left {
          gap: 16px;
          flex: 1;
          min-width: 0;
          position: relative;
        }
        
        .navbar-title {
          font-size: 25px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          text-align: center;
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          max-width: calc(100% - 80px);
          z-index: 1;
        }
        
        .navbar-tabs {
          display: none; /* 手機版隱藏標籤，改用底部導航 */
        }
        
        /* 主內容區域為固定頁首留出空間 */
        .main-content {
          padding-top: 80px;
          padding-bottom: 80px;
          height: calc(100vh - 80px - 80px);
          overflow: hidden;
        }
        
        /* 首頁內容區域獨立滾動 */
        #homepage {
          height: 100%;
          overflow-y: auto;
          overflow-x: hidden !important; /* 防止首頁左右滑動 */
          -webkit-overflow-scrolling: touch;
          padding: 20px 16px;
          width: 100%;
          max-width: 100vw;
          box-sizing: border-box;
        }
        
        /* 首頁卡片容器調整 */
        #homepage .mode-cards {
          padding-top: 20px;
          padding-bottom: 20px;
        }
        
        /* 首頁標題區域調整 */
        #homepage .homepage-title {
          margin-top: 40px;
          margin-bottom: 16px;
        }
        
        #homepage .homepage-subtitle {
          margin-bottom: 20px;
        }
        
        .navbar-right {
          gap: 8px;
        }
        
        .user-info {
          padding: 6px 12px;
          font-size: 14px;
        }
        
        .user-avatar {
          width: 28px !important;
          height: 28px !important;
          object-fit: cover !important;
          object-position: center !important;
        }
        
        .user-name {
          font-size: 14px;
        }
        
        .login-btn, .logout-btn {
          padding: 8px 16px;
          font-size: 14px;
        }
        
        /* 主內容區域手機版 - 滿版設計 */
        .main-content {
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          height: auto !important;
          min-height: calc(100vh - 60px) !important;
          min-height: calc(100dvh - 60px) !important;
          overflow: visible !important;
        }
        
        .main-content.sidebar-open {
          margin-right: 0 !important;
        }
        
        /* 首頁手機版 - 滿版設計 */
        .homepage {
          width: 100% !important;
          max-width: 100vw !important;
          height: auto !important;
          min-height: calc(100vh - 60px) !important;
          min-height: calc(100dvh - 60px) !important;
          margin: 0 !important;
          padding: 20px 0 !important;
          overflow-x: hidden !important; /* 防止水平滾動 */
          overflow-y: auto !important; /* 允許垂直滾動 */
          display: flex !important;
          flex-direction: column !important;
          box-sizing: border-box !important;
        }
        
        .homepage-title {
          font-size: 24px !important;
          margin-bottom: 16px !important;
          text-align: center !important;
          padding: 0 20px !important;
          line-height: 1.2 !important;
          color: #1f2937 !important;
          font-weight: 700 !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        /* 手機版標題換行效果 */
        .homepage-title .mobile-break {
          display: block;
          margin-top: 4px;
        }
        
        .homepage-subtitle {
          font-size: 16px !important;
          margin-bottom: 24px !important;
          text-align: center !important;
          padding: 0 20px !important;
          line-height: 1.5 !important;
          color: #6b7280 !important;
          font-weight: 400 !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        .mode-cards {
          display: flex !important;
          flex-direction: column !important;
          gap: 8px !important;
          padding: 0 16px !important;
          width: 100% !important;
          max-width: 100% !important;
          height: auto !important;
          overflow: hidden !important;
          flex: none !important;
          margin: 0 0 20px 0 !important;
          box-sizing: border-box !important;
        }
        
        .mode-card {
          width: 100% !important;
          max-width: 90% !important;
          height: auto !important;
          min-height: 100% !important;
          margin: 0 !important;
          padding: 16px 12px !important;
          border-radius: 12px !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
          background: white !important;
          border: 1px solid #e5e7eb !important;
          display: flex !important;
          flex-direction: column !important;
          justify-content: center !important;
          align-items: center !important;
          text-align: center !important;
          overflow: visible !important;
          cursor: pointer !important;
          position: relative !important;
          z-index: 1 !important;
          user-select: none !important;
          transition: all 0.2s ease !important;
        }
        
        .mode-card h3 {
          font-size: 14px !important;
          margin-bottom: 3px !important;
          font-weight: 600 !important;
          line-height: 1.1 !important;
          color: #1f2937 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
        }
        
        .mode-card p {
          font-size: 11px !important;
          line-height: 1.2 !important;
          color: #374151 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
          display: block !important;
          margin-bottom: 0 !important;
        }
        
        /* 確保模式卡片描述文字顯示 */
        .mode-card-desc {
          font-size: 11px !important;
          line-height: 1.2 !important;
          color: #374151 !important;
          text-align: center !important;
          width: 100% !important;
          white-space: normal !important;
          word-wrap: break-word !important;
          display: block !important;
          margin-bottom: 0 !important;
        }
        
        /* 所有模式卡片標題字體統一調整 */
        .mode-card:nth-child(1) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        .mode-card:nth-child(2) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        .mode-card:nth-child(3) .mode-card-title {
          font-size: 20px !important;
          font-weight: 700 !important;
        }
        
        /* 手機版模式卡片懸停效果 - 更靈敏的設計 */
        .mode-card {
          transition: all 0.1s ease !important;
        }
        .mode-card:active {
          transform: scale(0.95) !important;
          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
          border-color: #3b82f6 !important;
          background: #f0f9ff !important;
        }
        .mode-card:hover {
          transform: scale(1.02) !important;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2) !important;
          border-color: #3b82f6 !important;
        }
        
        /* 一鍵生成手機版 */
        .mode1-page {
          flex-direction: column;
          gap: 20px;
          padding: 0 8px;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .mode1-left {
          width: 100%;
          max-width: 100%;
          padding: 16px;
          box-sizing: border-box;
        }
        
        .mode1-right {
          width: 100%;
          max-width: 100%;
          padding: 16px;
          box-sizing: border-box;
        }
        
        
        
        .results-section {
          width: 100%;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        /* 結果區塊手機版優化 */
        .results-container {
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .result-content {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-body {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        
        .form-group {
          margin-bottom: 16px;
        }
        
        .form-group label {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
          padding: 10px;
          font-size: 16px; /* 防止iOS縮放 */
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        .generate-btn {
          padding: 10px 20px;
          font-size: 16px;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        .result-content {
          padding: 12px;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-header h3 {
          font-size: 18px;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-body {
          font-size: 14px;
          line-height: 1.6;
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .result-actions {
          flex-direction: column;
          gap: 8px;
          max-width: 100%;
        }
        
        .save-btn, .regenerate-btn {
          padding: 10px 16px;
          font-size: 14px;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        
        /* AI顧問手機版 */
        .mode2-container {
          padding: 16px;
          padding-top: 50px;
        }
        
        /* 手機版說明按鈕 */
        .instructions-toggle-btn {
          top: 80px;
          right: 16px;
          padding: 6px 12px;
          font-size: 13px;
        }
        
        .btn-text {
          font-size: 12px;
        }
        
        /* 手機版抽屜背景遮罩 */
        .drawer-overlay {
          z-index: 999;
        }
        
        /* 手機版說明抽屜 */
        .instructions-drawer {
          width: 100%;
          right: -100%;
          top: 70px;
          height: calc(100vh - 70px);
        }
        
        .drawer-header {
          padding: 16px;
        }
        
        .drawer-header h3 {
          font-size: 16px;
        }
        
        .drawer-content {
          padding: 16px;
        }
        
        .drawer-content p {
          font-size: 13px;
          margin-bottom: 12px;
        }
        
        .ai-instructions {
          margin-bottom: 20px;
        }
        
        .instructions-header {
          padding: 16px;
        }
        
        .instructions-header h3 {
          font-size: 16px;
        }
        
        .instruction-list {
          padding: 16px;
        }
        
        .instruction-list li {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .chat-container {
          height: calc(100vh - 80px - 80px);
          min-height: 500px;
          display: flex !important;
          flex-direction: column !important;
          overflow: hidden !important;
          margin-bottom: 0;
          margin-top: 10px !important;
          position: fixed !important;
          top: 80px !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 100 !important;
        }
        
        #chatContainer {
          display: flex !important;
          flex-direction: column !important;
          flex: 1 !important;
          height: 100% !important;
          overflow: visible !important;
        }
        
        .chat-messages {
          padding: 16px;
          flex: 1;
          overflow-y: auto;
          height: calc(100vh - 160px); /* 簡化高度計算 */
          min-height: 400px;
          max-height: calc(100vh - 160px);
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
          overscroll-behavior: contain;
        }
        
        .message {
          margin-bottom: 16px;
          max-width: 85%;
        }
        
        .message.user {
          margin-left: auto;
        }
        
        .message-content {
          padding: 12px 16px;
          font-size: 14px;
          line-height: 1.5;
        }
        
        .chat-input-container {
          padding: 16px;
          flex-direction: column;
          gap: 12px;
        }
        
        .chat-input {
          width: 100%;
          padding: 12px 16px;
          font-size: 16px;
          border-radius: 25px;
        }
        
        .send-btn {
          padding: 12px 24px;
          font-size: 16px;
          border-radius: 25px;
          width: 100%;
        }
        
        /* AI顧問模式的輸入區域手機版優化 */
        .input-row {
          padding: 16px !important;
          flex-direction: column !important;
          gap: 12px !important;
          display: flex !important;
          border-top: 1px solid #e5e7eb !important;
          background: #f7f7f8 !important;
          border-radius: 0 !important;
          flex-shrink: 0 !important;
          position: sticky !important;
          bottom: 0 !important;
          z-index: 100 !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          min-height: auto !important;
          margin: 0 !important;
        }
        
        .input-row textarea {
          width: 100% !important;
          padding: 12px 16px !important;
          font-size: 16px !important;
          border-radius: 25px !important;
          resize: none !important;
          border: 1px solid #d1d5db !important;
          height: 44px !important; /* 固定高度與送出按鈕一致 */
          min-height: 44px !important;
          max-height: 44px !important; /* 限制最大高度與最小高度一致 */
          line-height: 1.2 !important; /* 調整行高確保文字垂直居中 */
        }
        
        .input-row .send-btn {
          padding: 12px 24px !important;
          font-size: 16px !important;
          border-radius: 25px !important;
          width: 100% !important;
          background: #3b82f6 !important;
          color: white !important;
          border: none !important;
        }
        
        /* 手機版：只在 mode2 頁面且為 active 時顯示快速按鈕和輸入區域 */
        #mode2.active .quick-buttons,
        #mode2.active .input-row {
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important;
          position: relative !important;
          z-index: 100 !important;
        }
        
        #mode2.active .quick-buttons {
          min-height: auto !important;
          background: transparent !important;
          border: none !important;
          padding: 0 !important;
          flex-direction: row !important;
          gap: 8px !important;
          margin-bottom: 12px !important;
          position: relative !important;
          bottom: auto !important;
          left: auto !important;
          right: auto !important;
          z-index: auto !important;
          flex-wrap: wrap !important;
          justify-content: flex-start !important;
          height: auto !important;
        }
        
        /* 手機版快速按鈕文字對齊調整 */
        .mode2 .quick-btn {
          text-align: left !important; /* 強制文字左對齊 */
          padding: 8px 12px !important; /* 調整左右padding，左邊少一點 */
        }
        
        /* 手機版Mode2頁面固定設計 - 防止左右滑動 */
        .mode2 {
          width: 100% !important;
          max-width: 100vw !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        /* 手機版 Hero 區域樣式 */
        .rm-hero {
          width: 100% !important;
          max-width: 100vw !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        .rm-hero-container {
          width: 100% !important;
          max-width: 100% !important;
          padding-left: 16px !important;
          padding-right: 16px !important;
          box-sizing: border-box !important;
        }
        
        .rm-hero-grid {
          grid-template-columns: 1fr !important;
          gap: 32px !important;
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
        
        .rm-hero-grid > div {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
          padding-left: 0 !important;
          padding-right: 0 !important;
        }
        
        /* 手機版 別人怎麼用 區塊樣式 */
        .user-story-section {
          width: 100% !important;
          max-width: 100vw !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          padding-left: 0 !important;
          padding-right: 0 !important;
        }
        
        .user-story-section > div {
          width: 100% !important;
          max-width: 100% !important;
          padding-left: 16px !important;
          padding-right: 16px !important;
          box-sizing: border-box !important;
        }
        
        .user-story-section div[style*="grid-template-columns"] {
          grid-template-columns: 1fr !important;
          gap: 24px !important;
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
        
        .user-story-card {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
          padding: 24px !important;
        }
        
        /* 手機版：未訂閱用戶首頁 - 所有區塊對齊 */
        /* 別人怎麼用區塊作為對齊基準 */
        .user-story-section {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100% !important;
          max-width: 100vw !important;
        }
        
        .user-story-section > div {
          padding-left: 16px !important;
          padding-right: 16px !important;
          max-width: 100% !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        /* AI 短影音實戰指南區塊對齊 */
        .rm-guide-section {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100% !important;
          max-width: 100vw !important;
        }
        
        .rm-guide-section > div {
          padding-left: 16px !important;
          padding-right: 16px !important;
          max-width: 100% !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        .rm-guide-section div[style*="grid-template-columns"] {
          grid-template-columns: 1fr !important;
          gap: 24px !important;
          width: 100% !important;
          max-width: 100% !important;
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        .rm-guide-section a[onclick*="switchPage"] {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        .rm-guide-section a[onclick*="switchPage"] > div {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* 開始你的 AI 創作之旅區塊對齊 */
        .rm-pricing {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100% !important;
          max-width: 100vw !important;
        }
        
        .rm-pricing > div {
          padding-left: 16px !important;
          padding-right: 16px !important;
          max-width: 100% !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        .rm-pricing-cards {
          padding-left: 0 !important;
          padding-right: 0 !important;
          width: 100% !important;
          max-width: 100% !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        
        /* 所有使用 margin: -20px calc(-50vw + 50%) 的區塊在手機版都要重置 */
        section[style*="calc(-50vw + 50%)"] {
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100% !important;
          max-width: 100vw !important;
        }
        
        section[style*="calc(-50vw + 50%)"] > div {
          padding-left: 16px !important;
          padding-right: 16px !important;
        }
        
        /* 頁尾對齊 */
        .rm-footer {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100% !important;
          max-width: 100vw !important;
        }
        
        .rm-footer > div {
          padding-left: 16px !important;
          padding-right: 16px !important;
          max-width: 100% !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          text-align: center !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
        }
        
        .rm-footer > div > div {
          width: 100% !important;
          max-width: 100% !important;
          text-align: center !important;
        }
        
        /* 已訂閱用戶首頁 - 標題調整 */
        /* "歡迎使用AIJob短影音智能體" 字體大小與"介紹如何開始"一致 */
        #mode-cards .homepage-title {
          font-size: clamp(2rem, 4vw, 2.8rem) !important;
          font-weight: 800 !important;
          margin-bottom: 16px !important;
          margin-top: -30px !important;
          color: #1E293B !important;
          line-height: 1.2 !important;
        }
        
        #mode-cards .homepage-subtitle {
          font-size: clamp(1rem, 2vw, 1.1rem) !important;
          margin-bottom: 48px !important;
        }
        
        /* 確保"介紹如何開始"區塊的標題樣式一致 */
        #introduction h2 {
          font-size: clamp(2rem, 4vw, 2.8rem) !important;
          font-weight: 800 !important;
          margin-bottom: 16px !important;
        }
        
        /* 三大功能卡片保持置中 */
        #mode-cards .mode-cards {
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
          width: 100% !important;
          max-width: 100% !important;
          padding-left: 0 !important;
          padding-right: 0 !important;
        }
        
        #mode-cards .mode-card {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
        
      .mode2-page {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
      }
        
        .mode2 #chatMessages {
          width: 100% !important;
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        .mode2 .message {
          width: 100% !important;
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
          position: relative !important;
          z-index: 1 !important;
        }
        
        .mode2 .message-content {
          width: 100% !important;
          max-width: 90% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        /* 確保用戶訊息文字可見 */
        .mode2 .message.user {
          position: relative !important;
          z-index: 10 !important;
        }
        
        .mode2 .message.user .message-content {
          color: #000000 !important;
          background: #dbeafe !important;
          font-size: 14px !important;
          line-height: 1.5 !important;
          min-width: 200px !important;
          position: relative !important;
          z-index: 11 !important;
          padding: 20px 40px !important; /* 與 AI 回覆框一樣的 padding */
          padding-left: 50px !important; /* 增加左邊 padding，避免文字太貼邊界，與 Mode3 一致 */
        }
        
        /* 確保AI訊息文字可見 */
        .mode2 .message.ai {
          position: relative !important;
          z-index: 5 !important;
        }
        
        .mode2 .message.ai .message-content {
          color: #0c4a6e !important;
          background: #f0f9ff !important;
          font-size: 14px !important;
          line-height: 1.5 !important;
          position: relative !important;
          z-index: 6 !important;
        }
        
        /* 覆蓋舊的手機版固定定位規則，改用 flex 布局 */
        .mode2.fig1 .input-row {
          position: static !important; /* 改為 static，使用 flex 布局 */
          bottom: auto !important;
          left: auto !important;
          right: auto !important;
          z-index: auto !important;
          min-height: auto !important;
          background: transparent !important;
          border: none !important;
          padding: 8px 12px 16px 12px !important; /* 使用統一的 padding */
          flex-direction: row !important; /* 橫向排列 */
          gap: 12px !important;
          box-shadow: none !important;
          margin: 0 !important;
          height: auto !important;
          border-radius: 0 !important;
          max-height: none !important;
          flex-shrink: 0 !important; /* 固定在底部 */
          display: flex !important;
          align-items: center !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* 保留舊規則給沒有 fig1 的情況 */
        .mode2:not(.fig1) .input-row {
          min-height: auto !important;
          background: transparent !important;
          border: none !important;
          padding: 12px 16px !important;
          flex-direction: column !important;
          gap: 0 !important;
          position: fixed !important;
          bottom: 80px !important;
          left: 16px !important;
          right: 16px !important;
          z-index: 1001 !important;
          box-shadow: none !important;
          margin: 0 !important;
          height: auto !important;
          border-radius: 0 !important;
          max-height: none !important;
        }
        
        .mode2 .input-container {
          flex-direction: row !important;
          gap: 8px !important;
          align-items: flex-end !important;
        }
        
        .mode2 .input-container button {
          width: auto !important;
          min-width: 80px !important;
          flex-shrink: 0 !important;
        }
        
        .mode2 .input-container textarea {
          height: 44px !important; /* 固定高度與送出按鈕一致 */
          min-height: 44px !important;
          max-height: 44px !important; /* 限制最大高度與最小高度一致 */
          resize: none !important; /* 禁止調整大小保持固定高度 */
          line-height: 1.2 !important; /* 調整行高確保文字垂直居中 */
        }
        
        /* 創作者資料庫手機版 */
        .user-db-page {
          padding: 16px;
          padding-top: 50px;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .user-db-container {
          flex-direction: column;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .user-db-sidebar {
          width: 100%;
          margin-bottom: 20px;
          border-radius: 12px;
          max-width: 100%;
        }
        
        .user-db-content {
          width: 100%;
          max-width: 100%;
          overflow-x: hidden;
        }
        
        /* 個人資料卡片手機版優化 */
        .db-section {
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .section-content {
          max-width: 100%;
          overflow-x: hidden;
          word-wrap: break-word;
        }
        
        .user-info-detail {
          max-width: 100%;
          overflow-x: hidden;
          width: 100%;
          padding: 20px;
        }
        
        .info-item {
          max-width: 100%;
          overflow-x: hidden;
          white-space: nowrap;
          display: flex;
          align-items: center;
        }
        
        .info-item label {
          flex-shrink: 0;
          margin-right: 8px;
        }
        
        .info-item span {
          flex: 1;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        /* 強制防止資料庫頁面水平滾動 */
        #userDB {
          overflow-x: hidden !important;
          max-width: 100vw !important;
        }
        
        .user-db-page * {
          box-sizing: border-box !important;
        }
        
        .user-db-page input,
        .user-db-page span,
        .user-db-page div {
          max-width: 100% !important;
          overflow-x: hidden !important;
        }
        
        .user-db-page .info-item {
          white-space: nowrap !important;
          display: flex !important;
          align-items: center !important;
        }
        
        .user-db-page .info-item span {
          text-overflow: ellipsis !important;
          overflow: hidden !important;
        }
        
        /* 強制拉長個人資料灰底寬度 */
        .user-db-page .user-info-detail {
          width: 100% !important;
          max-width: 100% !important;
          padding: 50px !important;
          margin: 0 !important;
        }
        
        .user-db-page .section-content {
          width: 100% !important;
          max-width: 100% !important;
          padding: 0 !important;
        }
        
        .user-db-page .db-section {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        /* 個人資料灰底寬度手機版 */
        .user-db-page .detail-item {
          width: 100% !important;
          max-width: 100% !important;
          padding: 16px !important;
        }
        
        .user-db-page .profile-details {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        .sidebar-header {
          padding: 16px;
        }
        
        .user-profile {
          flex-direction: column;
          text-align: center;
          gap: 12px;
        }
        
        .profile-avatar {
          width: 60px;
          height: 60px;
        }
        
        .profile-info h3 {
          font-size: 18px;
        }
        
        .profile-info p {
          font-size: 14px;
        }
        
        .sidebar-menu {
          padding: 16px;
        }
        
        .menu-item {
          padding: 12px 16px;
          margin-bottom: 8px;
          border-radius: 8px;
        }
        
        .menu-text {
          font-size: 14px;
        }
        
        .user-db-content {
          width: 100%;
        }
        
        .db-section {
          padding: 16px;
        }
        
        .section-title {
          font-size: 18px;
          margin-bottom: 16px;
        }
        
        /* 腳本表格手機版 */
        /* 我的腳本手機版優化 */
        .script-item {
          margin-bottom: 16px;
          border-radius: 12px;
        }
        
        .script-header {
          padding: 12px 16px;
          flex-wrap: wrap;
          gap: 8px;
        }
        
        .script-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
          width: 100%;
        }
        
        .script-name {
          font-size: 14px;
          word-break: break-word;
          max-width: 100%;
        }
        
        .script-date {
          font-size: 12px;
        }
        
        .script-table {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 12px 0;
          border-radius: 8px;
          border: 1px solid #e5e7eb;
        }
        
        .script-table table {
          min-width: 800px;
          font-size: 11px;
          margin: 0;
        }
        
        .script-table th,
        .script-table td {
          padding: 10px 8px;
          white-space: normal;
          word-break: break-word;
          vertical-align: top;
        }
        
        .script-table th {
          font-size: 11px;
          font-weight: 600;
          background: #f8fafc;
          position: sticky;
          left: 0;
          z-index: 1;
        }
        
        .script-table td:first-child {
          position: sticky;
          left: 0;
          background: white;
          z-index: 1;
          font-weight: 500;
        }
        
        .script-table tr:nth-child(even) td:first-child {
          background: #f9fafb;
        }
        
        .script-actions {
          flex-direction: column;
          gap: 10px;
          padding: 12px;
          background: #f8fafc;
          border-top: 1px solid #e5e7eb;
        }
        
        .action-btn {
          padding: 12px 16px;
          font-size: 14px;
          width: 100%;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.2s;
        }
        
        .action-btn.view-btn {
          background: #3b82f6;
          color: white;
        }
        
        .action-btn.view-btn:active {
          background: #2563eb;
          transform: scale(0.98);
        }
        
        .action-btn.download-pdf-btn {
          background: #10b981;
          color: white;
        }
        
        .action-btn.download-pdf-btn:active {
          background: #059669;
          transform: scale(0.98);
        }
        
        .action-btn.download-csv-btn {
          background: #06b6d4;
          color: white;
        }
        
        .action-btn.download-csv-btn:active {
          background: #0891b2;
          transform: scale(0.98);
        }
        
        /* 手機版彈窗優化 */
        @media (max-width: 768px) {
          .script-modal-overlay {
            padding: 10px !important;
          }
          
          .script-modal-overlay > div {
            max-width: 100% !important;
            max-height: 95vh !important;
            padding: 16px !important;
          }
          
          .script-modal-overlay table {
            font-size: 10px !important;
          }
          
          .script-modal-overlay th,
          .script-modal-overlay td {
            padding: 8px 6px !important;
          }
        }
        
        .action-btn.delete-btn {
          background: #ef4444;
          color: white;
        }
        
        .action-btn.delete-btn:active {
          background: #dc2626;
          transform: scale(0.98);
        }
        
        /* 用戶抽屜手機版 */
        .user-drawer {
          width: 100%;
          max-width: 100vw;
          right: 0;
          border-radius: 0;
        }
        
        .user-drawer-header {
          padding: 20px 16px;
          padding-top: calc(20px + var(--safe-area-inset-top));
        }
        
        .user-drawer-content {
          padding: 16px;
        }
        
        .drawer-section h3 {
          font-size: 16px;
          margin-bottom: 12px;
        }
        
        .drawer-section p {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        /* 底部導航欄（手機版專用） */
        .bottom-navbar {
          display: flex !important;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          border-top: 1px solid #e5e7eb;
          padding: 8px 0;
          padding-bottom: calc(8px + var(--safe-area-inset-bottom));
          z-index: 1000;
        }
        
        .bottom-nav-item {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 8px 4px;
          text-decoration: none;
          color: #6b7280;
          font-size: 12px;
          transition: color 0.2s;
        }
        
        .bottom-nav-item.active {
          color: #3b82f6;
        }
        
        .bottom-nav-item span {
          margin-top: 4px;
        }
        
        /* 隱藏桌面版導航 */
        .navbar-tabs {
          display: none;
        }
      }
      
      /* 超小螢幕手機 */
      @media (max-width: 480px) {
        .homepage-title {
          font-size: 20px;
        }
        
        .homepage-subtitle {
          font-size: 14px;
        }
        
        .mode-card {
          padding: 20px 16px;
        }
        
        .mode-card h3 {
          font-size: 18px;
        }
        
        .mode-card p {
          font-size: 13px;
        }
        
        .chat-container {
          height: calc(100vh - 180px);
        }
        
        .script-table table {
          font-size: 11px;
        }
        
        .script-table th,
        .script-table td {
          padding: 6px 4px;
        }
      }
      
      /* iOS Safari 特殊處理 */
      @supports (-webkit-touch-callout: none) {
        .chat-container {
          height: calc(100vh - 220px);
          height: calc(100dvh - 220px);
        }
        
        .main-content {
          min-height: calc(100vh - 60px);
          min-height: calc(100dvh - 60px);
        }
        
        .app-container {
          min-height: 100vh;
          min-height: 100dvh;
        }
      }
      
      /* 登入頁面樣式 */
      .login-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        background-image: 
          radial-gradient(circle at 20% 20%, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          radial-gradient(circle at 40% 40%, rgba(0, 0, 0, 0.08) 1px, transparent 1px),
          radial-gradient(circle at 60% 60%, rgba(0, 0, 0, 0.06) 1px, transparent 1px),
          radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
          radial-gradient(circle at 30% 70%, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
          radial-gradient(circle at 70% 30%, rgba(0, 0, 0, 0.07) 1px, transparent 1px);
        background-size: 50px 50px, 60px 60px, 40px 40px, 70px 70px, 30px 30px, 80px 80px;
        animation: starField 15s linear infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        overflow: hidden;
      }
      
      /* 星星動畫 */
      @keyframes starField {
        0% {
          background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;
        }
        25% {
          background-position: 25% 25%, 25% 25%, 25% 25%, 25% 25%, 25% 25%;
        }
        50% {
          background-position: 50% 50%, 50% 50%, 50% 50%, 50% 50%, 50% 50%;
        }
        75% {
          background-position: 75% 75%, 75% 75%, 75% 75%, 75% 75%, 75% 75%;
        }
        100% {
          background-position: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
        }
      }
      
      /* 登入容器動畫 */
      .login-container {
        background: white;
        border-radius: 16px;
        padding: 40px;
        border: 2px solid #e5e7eb;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(255, 255, 255, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.9),
          inset 0 -1px 0 rgba(0, 0, 0, 0.05);
        max-width: 400px;
        width: 90%;
        text-align: center;
        animation: fadeInUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
      }
      
      .login-container:hover {
        transform: translateY(-2px);
        box-shadow: 
          0 32px 64px -12px rgba(0, 0, 0, 0.35),
          0 0 0 1px rgba(255, 255, 255, 0.9),
          inset 0 1px 0 rgba(255, 255, 255, 0.95),
          inset 0 -1px 0 rgba(0, 0, 0, 0.08);
        border-color: #d1d5db;
        transition: all 0.3s ease;
      }
      
      .login-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.03), transparent);
        animation: shimmer 3s ease-in-out infinite;
        pointer-events: none;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }
      
      .login-header {
        margin-bottom: 32px;
      }
      
      .login-title {
        font-size: 35px;
        font-weight: bold;
        color: #1f2937;
        margin: 0 0 8px 0;
        animation: titleGlow 2s ease-in-out infinite alternate;
      }
      
      @keyframes titleGlow {
        from {
          text-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
        }
        to {
          text-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4);
        }
      }
      
      .login-subtitle {
        font-size: 16px;
        color: #6b7280;
        margin: 0 0 16px 0;
      }
      
      .login-prompt {
        font-size: 14px;
        color: #9ca3af;
        margin: 0;
      }
      
      .login-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 24px;
      }
      
      .login-btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .skip-btn {
        background: #fbbf24;
        color: #1f2937;
      }
      
      .skip-btn:hover {
        background: #f59e0b;
      }
      
      .google-btn {
        background: #3b82f6;
        color: white;
        border: 2px solid #1d4ed8;
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      }
      
      .google-btn:hover {
        background: #2563eb;
        border-color: #1e40af;
        transform: translateY(-2px);
        box-shadow: 
          0 8px 25px -5px rgba(59, 130, 246, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3),
          inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      }
      
      .google-btn:active {
        transform: translateY(0);
        background: #1d4ed8;
        border-color: #1e3a8a;
        box-shadow: 
          0 2px 4px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      }
      
      .line-btn {
        background: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
      }
      
      .google-icon, .line-icon {
        width: 18px;
        height: 18px;
      }
      
      .login-note {
        font-size: 12px;
        color: #9ca3af;
        margin: 0 0 24px 0;
      }
      
      .language-selector {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
      
      .lang-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .lang-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }
      
      .lang-btn:hover:not(.active) {
        background: #f9fafb;
      }
      
      /* 手機版登入頁面 */
      @media (max-width: 768px) {
        .login-container {
          padding: 32px 24px;
          margin: 16px;
        }
        
        /* 手機版隱藏登出按鈕 */
        .logout-btn {
          display: none !important;
        }
        
        /* 防止整個頁面水平滾動 */
        body {
          overflow-x: hidden !important;
        }
        
        .main-content {
          overflow-x: hidden !important;
        }
        
        /* 一鍵生成模式防止水平滾動 */
        #mode1 {
          overflow-x: hidden !important;
          max-width: 100vw !important;
        }
        
        .mode1-page {
          overflow-x: hidden !important;
          max-width: 100% !important;
        }
        
        .mode1-left,
        .mode1-right {
          overflow-x: hidden !important;
          word-wrap: break-word !important;
        }
        
        .login-title {
          font-size: 30px;
        }
        
        .login-subtitle {
          font-size: 14px;
        }
        
        .login-btn {
          padding: 14px 20px;
          font-size: 15px;
        }
      }
      
      /* Mode3 頁面樣式（從 index-ai-consultant.html 遷移） */
      .mode3-page {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 60px);
        overflow: hidden;
        background: #f8fafc;
      }
      
      .mode3.fig1 {
        height: 100dvh !important;
        overflow: hidden !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        z-index: 1 !important;
      }
      
      .mode3.fig1 .mode3-page {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
        min-height: 0 !important;
        overflow: hidden !important;
        padding: 0 !important;
        padding-top: 60px !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        position: relative !important;
      }
      
      body.mode3-active, html.mode3-active {
        overflow: hidden !important;
        height: 100% !important;
        position: fixed !important;
        width: 100% !important;
      }
      
      /* Mode3 聊天訊息區域 - 與 Mode2 一致，移除白色背景 */
      #mode3-chatMessages {
        margin: 0 !important;
        padding: 16px 24px !important;
        background: transparent !important; /* 與 Mode2 一致，使用透明背景 */
        border: none !important;
        border-radius: 0 !important;
        flex: 1 !important;
        min-height: 0 !important;
        height: auto !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: contain !important;
        touch-action: pan-y !important;
        overflow-y: auto !important;
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* Mode3 輸入區域 */
      #mode3 .input-row,
      #mode3.active .input-row {
        display: flex !important;
        flex-direction: column !important;
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        background: transparent;
      }
      
      #mode3 .input-container,
      #mode3.active .input-container {
        display: flex !important;
        gap: 12px;
        align-items: flex-start;
        width: 100%;
      }
      
      #mode3 .input-wrapper,
      #mode3.active .input-wrapper {
        position: relative;
        flex: 1;
        display: flex !important;
        flex-direction: column !important;
        min-height: 120px !important;
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        border-radius: 12px !important;
        padding: 12px !important;
        gap: 8px !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      #mode3 .input-wrapper:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      /* 深色模式：Mode3 輸入欄位容器 */
      .theme-dark #mode3 .input-wrapper,
      .theme-dark #mode3.active .input-wrapper,
      .theme-dark .mode3.fig1 .input-wrapper {
        background: var(--gradient-card) !important;
        border-color: var(--border-color) !important;
      }
      
      .theme-dark #mode3 .input-wrapper:focus-within,
      .theme-dark .mode3.fig1 .input-wrapper:focus-within {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
      }
      
      #mode3 .input-row-inner,
      #mode3.active .input-row-inner {
        display: flex !important;
        gap: 12px;
        align-items: flex-end;
        flex: 1;
      }
      
      #mode3 .chat-input,
      #mode3.active .chat-input {
        flex: 1;
        min-height: 44px;
        max-height: 100px;
        padding: 10px 12px;
        border: 1px solid transparent !important;
        background: transparent !important;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        outline: none;
        line-height: 1.5;
        font-family: inherit;
      }
      
      #mode3 .chat-input:focus,
      #mode3.active .chat-input:focus {
        border-color: transparent !important;
        box-shadow: none !important;
      }
      
      #mode3 .send-btn,
      #mode3.active .send-btn {
        height: 44px;
        min-width: 44px;
        padding: 0 18px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #mode3 .send-btn:hover:not(:disabled),
      #mode3.active .send-btn:hover:not(:disabled) {
        background: #2563eb;
      }
      
      #mode3 .send-btn:disabled,
      #mode3.active .send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      
      #mode3 .quick-buttons,
      #mode3.active .quick-buttons {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px;
        padding: 8px 0 0 0;
        margin: 0;
        border-top: 1px solid #e5e7eb;
        background: transparent;
      }
      
      #mode3 .quick-btn,
      #mode3.active .quick-btn {
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        color: #1f2937 !important;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-family: inherit;
        width: auto !important;
        min-width: fit-content !important;
        flex-shrink: 0;
        font-weight: 500;
      }
      
      #mode3 .quick-btn:hover,
      #mode3.active .quick-btn:hover {
        background: #f3f4f6 !important;
        border-color: #3b82f6 !important;
        color: #1f2937 !important;
      }
      
      /* Mode3 桌面版樣式 - 確保快速按鈕大小合適 */
      @media (min-width: 769px) {
        #mode3 .quick-buttons,
        #mode3.active .quick-buttons {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 8px !important;
        }
        
        #mode3 .quick-btn,
        #mode3.active .quick-btn {
          width: auto !important;
          min-width: fit-content !important;
          max-width: none !important;
          flex: 0 0 auto !important;
        }
      }
      
      /* Mode3 手機版樣式 - 與 Mode2 一致 */
      @media (max-width: 768px) {
        body.mode3-active, html.mode3-active {
          overflow: hidden !important;
        }
        
        .mode3.fig1 .mode3-page {
          padding-top: 70px !important;
        }
        
        .mode3.fig1 #mode3-chatMessages {
          padding: 12px !important;
        }
        
        .mode3.fig1 .quick-btn {
          padding: 3px 6px !important;
          font-size: 10px !important;
        }
        
        .mode3.fig1 .input-row {
          padding: 8px 12px 16px 12px !important;
        }
        
        #mode3 .input-wrapper,
        #mode3.active .input-wrapper {
          min-height: 100px !important;
          padding: 8px !important;
        }
        
        /* Mode3 手機版輸入框樣式 - 與 Mode2 一致 */
        #mode3 .chat-input,
        #mode3.active .chat-input,
        .mode3.fig1 #mode3-messageInput {
          flex: 1 !important;
          min-height: 44px !important;
          max-height: 44px !important;
          height: 44px !important;
          border: 1px solid #d1d5db !important;
          border-radius: 10px !important;
          padding: 10px 12px !important;
          font-size: 14px !important;
          background: #ffffff !important;
          resize: none !important;
        }
        
        /* Mode3 手機版送出按鈕樣式 - 與 Mode2 一致 */
        #mode3 .send-btn,
        #mode3.active .send-btn,
        .mode3.fig1 #mode3-sendBtn {
          height: 44px !important;
          min-width: 44px !important;
          border-radius: 10px !important;
          background: #3b82f6 !important;
          color: #ffffff !important;
          border: none !important;
          padding: 0 18px !important;
          width: auto !important;
          flex-shrink: 0 !important;
        }
        
        /* Mode3 手機版輸入區域內部布局 */
        #mode3 .input-row-inner,
        #mode3.active .input-row-inner,
        .mode3.fig1 .input-row-inner {
          display: flex !important;
          flex-direction: row !important;
          gap: 8px !important;
          align-items: center !important;
          width: 100% !important;
        }
      }
    </style>
  </head>
  <body data-subscribed="false">
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-page" style="display: none;">
      <div class="login-container">
        <div class="login-header">
          <h1 class="login-title">ReelMind</h1>
          <p class="login-subtitle">讓你的短影音不再靠運氣，而靠策略。<br>AI 短影音顧問，幫你精準定位、快速生成。</p>
        </div>
        
        <div class="login-buttons">
          <button class="login-btn google-btn" onclick="if(typeof goLogin === 'function') { goLogin(); } else if(typeof window.goLogin === 'function') { window.goLogin(); } else { goToLogin(); } return false;">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjY0IDkuMjA0NTVDMTcuNjQgOC41NjY0MSAxNy41ODI3IDcuOTUyMjcgMTcuNDc3MyA3LjM2MzY0SDkuMTgzNjRWMTAuODQ1NUgxMy44NDA5QzEzLjYzNjQgMTIuMzI1IDEyLjgxODIgMTMuNTU0NSAxMS42MzY0IDE0LjM0NTVDMTEuNjM2NCAxNC4zNDU1IDExLjYzNjQgMTQuMzQ1NSAxMS42MzY0IDE0LjM0NTVMMTMuNDU0NSAxNS45OTU1QzE0LjkwOTEgMTQuNjU0NSAxNy42NCAxMi4zMjUgMTcuNjQgOS4yMDQ1NVoiIGZpbGw9IjQyODVGNCIvPgo8cGF0aCBkPSJNOS4xODM2NCAxOC4wMDAyQzExLjQzMTggMTguMDAwMiAxMy4yNzI3IDE3LjI3MjcgMTQuNjM2NCAxNi4wOTU1TDEyLjgxODIgMTQuNDQ1NUMxMi4wOTU1IDE1LjAwOTEgMTEuMTU0NSAxNS40MzE4IDEwLjAwOTEgMTUuNDMxOEM3Ljc0NTQ1IDE1LjQzMTggNS44NDU0NSAxMy45NTQ1IDUuMTU0NTUgMTEuOTU0NUwzLjI3MjczIDEzLjU0NTVDNC42MzYzNiAxNi4wOTU1IDYuNzI3MjcgMTguMDAwMiA5LjE4MzY0IDE4LjAwMDJaIiBmaWxsPSIzNEE4NTMiLz4KPHBhdGggZD0iTTMuMjcyNzMgMTEuOTU0NUMzLjAwOTA5IDExLjE4MTggMi44NzI3MyAxMC4zNjM2IDIuODcyNzMgOS41MDAwMkMyLjg3MjczIDguNjM2MzYgMy4wMDkwOSA3LjgxODE4IDMuMjcyNzMgNy4wNDU0NUw1LjE1NDU1IDguNjM2MzZDNC45NTQ1NSA5LjM2MzY0IDQuODcyNzMgMTAuMTM2NCA0Ljg3MjczIDEwLjk1NDVDNC44NzI3MyAxMS43NzI3IDQuOTU0NTUgMTIuNTQ1NSAzLjI3MjczIDEzLjU0NTVMMy4yNzI3MyAxMS45NTQ1WiIgZmlsbD0iRkJCQzA0Ii8+CjxwYXRoIGQ9Ik05LjE4MzY0IDMuNTY4MThDMTEuMTU0NSAzLjU2ODE4IDEyLjYzNjQgNC4zNDA5MSAxMy40NTQ1IDUuMDQ1NDVMMTQuNjM2NCAzLjkwOTA5QzEzLjI3MjcgMi42MzYzNiAxMS40MzE4IDEuOTk5OTggOS4xODM2NCAxLjk5OTk4QzYuNzI3MjcgMS45OTk5OCA0LjYzNjM2IDMuOTA5MDkgMy4yNzI3MyA2LjQ1OTA5TDUuMTU0NTUgOC4wNDU0NUM1Ljg0NTQ1IDYuMDQ1NDUgNy43NDU0NSA0LjU2ODE4IDkuMTgzNjQgMy41NjgxOFoiIGZpbGw9IjM0QTg1MyIvPgo8L3N2Zz4K" alt="Google" class="google-icon">
            使用 Google 登入
          </button>
          <p class="login-prompt">請登入以繼續</p>
        </div>
      </div>
    </div>

    <!-- 主應用程式容器 -->
    <div id="appContainer" class="app-container" style="display: block;">
      <!-- 主內容區域 -->
      <div class="main-content" id="mainContent">
        <!-- 頂部導航欄 -->
        <div class="top-navbar">
          <div class="navbar-left">
            <!-- 手機版抽屜按鈕 -->
            <button class="mobile-drawer-toggle" onclick="toggleMobileDrawer()">
              <span class="hamburger-icon">☰</span>
            </button>
            <div class="navbar-title clickable-title" onclick="switchPage('homepage')">ReelMind</div>
            <div class="navbar-tabs">
              <a href="#homepage" class="navbar-tab" onclick="switchPage('homepage'); return false;">首頁</a>
              <a href="mode1.html" class="navbar-tab" onclick="event.preventDefault(); (async function() { try { if(window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') { const canAccess = await window.ReelMindCommon.checkFeatureAccess(); if(canAccess) { window.location.href = 'mode1.html'; } } else { window.location.href = 'mode1.html'; } } catch(error) { console.error('檢查功能訪問失敗:', error); } })(); return false;">IP人設規劃</a>
              <a href="mode3.html" class="navbar-tab" onclick="event.preventDefault(); (async function() { try { if(window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') { const canAccess = await window.ReelMindCommon.checkFeatureAccess(); if(canAccess) { window.location.href = 'mode3.html'; } } else { window.location.href = 'mode3.html'; } } catch(error) { console.error('檢查功能訪問失敗:', error); } })(); return false;">一鍵生成</a>
              <a href="forum.html" class="navbar-tab">論壇介紹</a>
              <a href="guide.html" class="navbar-tab">實戰指南</a>
              <a href="about.html" class="navbar-tab">關於我們</a>
              <a href="#" id="userDBTab" class="navbar-tab" style="display:none;" onclick="handleUserDBClick(); return false;">創作者資料庫</a>
            </div>
          </div>
          <div class="navbar-right">
            <div class="user-info" id="userInfo" style="display: none;" onclick="handleUserDBClick()">
              <img id="userAvatar" class="user-avatar" src="" alt="用戶頭像" loading="lazy" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; object-position: center;">
            <span id="userName" class="user-name"></span>
          </div>
          <div class="auth-buttons">
              <button id="loginBtn" class="login-btn" onclick="goToLogin()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">🔐 登入</button>
          </div>
        </div>
      </div>

        <!-- 頁面內容區域 -->
        <div class="page-content">
          <!-- 首頁 -->
          <div id="homepage" class="page page-enter">
            <div class="homepage">
              <!-- 未登入用戶（訪客）視圖 - 顯示 index_unsubscribed.html 的內容 -->
              <div id="homepage-unsubscribed" class="homepage-view">
              <!-- Hero Section: 白＋藍冷系｜滿版全出血 -->
              <section class="rm-hero" style="position: relative; overflow: hidden; padding: 80px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                <!-- 背景淡藍光暈（增強效果） -->
                <div style="position: absolute; top: -100px; right: 0; width: 800px; height: 800px; background: radial-gradient(circle at 80% 20%, rgba(59,130,246,0.15), transparent 60%); pointer-events: none; z-index: 0;"></div>
                
                <div class="rm-hero-container" style="max-width: 1400px; margin: 0 auto; padding: 0 max(16px, env(safe-area-inset-left)) 0 max(16px, env(safe-area-inset-right)); position: relative; z-index: 1; width: 100%; box-sizing: border-box;">
                  <div class="rm-hero-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; width: 100%; max-width: 100%; box-sizing: border-box;">
                    
                    <!-- 左側：文案區 -->
                    <div style="padding: 20px 0; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                      <h1 id="hero-title-1" class="rm-hero-title typewriter-title" style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; color: white; margin-bottom: 20px; line-height: 1.2; letter-spacing: -0.02em; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; text-shadow: 0 2px 15px rgba(0,0,0,0.15);">
                        <span class="typewriter-text"></span><span class="typewriter-cursor">|</span>
                      </h1>
                      <p style="font-size: clamp(1rem, 2vw, 1.25rem); color: white; margin-bottom: 32px; line-height: 1.7; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; text-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        AI 生成腳本、AI 帳號定位，一次完成。
                      </p>
                      <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px;">
                        <a href="#" onclick="goToPricing(); return false;" style="padding: 16px 24px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border-radius: 12px; font-weight: 700; text-decoration: none; box-shadow: 0 4px 20px rgba(16,185,129,0.3); transition: all 0.3s; font-size: 0.9rem; min-height: 48px; display: inline-flex; align-items: center; justify-content: center; flex: 1; position: relative; overflow: hidden;">
                          立即啟用<br>AI 智能體
                        </a>
                        <a href="#experience-demo" id="hero-experience-btn" onclick="smoothScrollTo('experience-demo'); return false;" style="padding: 16px 24px; background: rgba(255,255,255,0.95); color: #2563EB; border: 2px solid rgba(255,255,255,0.5); border-radius: 12px; font-weight: 600; text-decoration: none; transition: all 0.3s; font-size: 0.9rem; min-height: 48px; display: inline-flex; align-items: center; justify-content: center; flex: 1; position: relative; overflow: hidden; backdrop-filter: blur(10px);">
                          搶先體驗ReelMind
                        </a>
                      </div>
                    </div>
                    
                    <!-- 右側：影片預覽 -->
                    <div style="position: relative;">
                      <div class="youtube-lazy-container" data-video-id="Pw1_MRIJ9GA" data-autoplay="0" style="aspect-ratio: 16/9; background: #E2E8F0; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); position: relative; cursor: pointer;">
                        <img src="https://img.youtube.com/vi/Pw1_MRIJ9GA/maxresdefault.jpg" alt="ReelMind AI 短影音智能體示範影片" style="width: 100%; height: 100%; object-fit: cover; display: block;" loading="lazy">
                        <div class="youtube-play-button" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background: rgba(255, 0, 0, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: all 0.3s;">
                          <svg width="32" height="32" viewBox="0 0 24 24" fill="white" style="margin-left: 4px;">
                            <path d="M8 5v14l11-7z"/>
                          </svg>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </section>

              <!-- 三功能卡區（保留原有 DOM 與事件） -->

              <!-- ReelMind 能為你做什麼？全新設計版 -->
              <section id="rm-overview-v2" style="background: white; padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw; position: relative; overflow: hidden;">
                <!-- 背景裝飾 -->
                <div style="position: absolute; inset: 0; background: linear-gradient(to bottom right, #EFF6FF, white, #F0FDF4); opacity: 0.5;"></div>
                <div style="position: absolute; top: 0; left: 0; width: 384px; height: 384px; background: #DBEAFE; border-radius: 50%; filter: blur(96px); opacity: 0.3;"></div>
                <div style="position: absolute; bottom: 0; right: 0; width: 384px; height: 384px; background: #D1FAE5; border-radius: 50%; filter: blur(96px); opacity: 0.3;"></div>
                
                <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px; position: relative; z-index: 10;">
                  <!-- 標題區 - 全新設計 -->
                  <div class="text-center mb-16 md:mb-24">
                    <!-- 標籤徽章 -->
                    <div class="inline-flex items-center gap-2.5 px-6 py-3 mb-6 bg-gradient-to-r from-blue-50 to-emerald-50 border border-blue-100 rounded-full">
                      <span class="text-xl animate-pulse">✨</span>
                      <span class="text-sm md:text-base font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-emerald-600">
                        四項核心功能，一站式短影音創作
                      </span>
                    </div>
                    
                    <!-- 主標題 -->
                    <h2 class="text-4xl md:text-5xl lg:text-6xl font-extrabold mb-6 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 bg-clip-text text-transparent leading-tight" style="cursor: default; pointer-events: none;">
                      ReelMind 能為你做什麼？
                    </h2>
                    
                    <!-- 副標題 -->
                    <p class="text-lg md:text-xl text-gray-600 max-w-4xl mx-auto leading-relaxed px-4">
                      以 <strong class="text-emerald-600">一鍵生成</strong>與 <strong class="text-purple-600">IP 人設規劃</strong>，協助創作者建立高效率的短影音內容系統。讓每次創作都有策略、每次發布都有轉換。
                    </p>
                    
                    <!-- 裝飾線 -->
                    <div class="flex items-center justify-center gap-4 mt-8">
                      <div class="w-16 h-0.5 bg-gradient-to-r from-transparent to-blue-400"></div>
                      <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                      <div class="w-24 h-0.5 bg-gradient-to-r from-blue-400 to-emerald-400"></div>
                      <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                      <div class="w-16 h-0.5 bg-gradient-to-r from-emerald-400 to-transparent"></div>
                    </div>
                  </div>
                  
                  <!-- 四張功能卡 - 全新網格設計 -->
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-16">
                    
                    <!-- 卡片 1: 一鍵生成 -->
                    <div class="group relative bg-white border-2 border-transparent hover:border-emerald-200 rounded-3xl p-8 shadow-sm hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 transform overflow-hidden">
                      <!-- 背景光效 -->
                      <div class="absolute inset-0 bg-gradient-to-br from-emerald-50/0 to-emerald-50/100 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                      
                      <!-- 圖標區 -->
                      <div class="relative z-10 flex items-center justify-center w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-2xl group-hover:scale-110 transition-transform duration-500">
                        <i class="fas fa-magic text-4xl text-emerald-600"></i>
                      </div>
                      
                      <!-- 內容區 -->
                      <div class="relative z-10">
                        <!-- 小標籤 -->
                        <div class="inline-block px-3 py-1 mb-4 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">
                          一鍵生成
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-emerald-600 transition-colors">
                          直接可用的腳本
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                          輸入平台與主題，立即產出<strong class="text-emerald-600">Hook 開場、口播文字、鏡頭指示</strong>與上片建議；可重生直到滿意。
                        </p>
                        
                        <!-- 列表 -->
                        <ul class="space-y-3 mb-6">
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-emerald-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">60 秒內完成短影音腳本</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-emerald-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">自動附 CTA 與情緒節奏</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-emerald-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">支援 IG / TikTok / Shorts 規格</span>
                          </li>
                        </ul>
                        
                        <!-- 底部連結 -->
                        <div class="flex items-center gap-2 text-xs font-semibold text-emerald-600 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="window.location.href='mode3.html';">
                          <span>了解更多</span>
                          <span class="text-lg">→</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 卡片 2: IP 人設規劃 -->
                    <div class="group relative bg-white border-2 border-transparent hover:border-purple-200 rounded-3xl p-8 shadow-sm hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 transform overflow-hidden">
                      <!-- 背景光效 -->
                      <div class="absolute inset-0 bg-gradient-to-br from-purple-50/0 to-purple-50/100 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                      
                      <!-- 圖標區 -->
                      <div class="relative z-10 flex items-center justify-center w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl group-hover:scale-110 transition-transform duration-500">
                        <i class="fas fa-id-card text-4xl text-purple-600"></i>
                      </div>
                      
                      <!-- 內容區 -->
                      <div class="relative z-10">
                        <!-- 小標籤 -->
                        <div class="inline-block px-3 py-1 mb-4 bg-purple-100 text-purple-700 text-xs font-bold rounded-full">
                          IP 人設
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-purple-600 transition-colors">
                          建立你的專屬聲音
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                          透過一系列訪談題，建立 IP Profile（人格特質、語氣設定、內容邏輯），並附 14 天內容規劃。
                        </p>
                        
                        <!-- 列表 -->
                        <ul class="space-y-3 mb-6">
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-purple-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">IP Profile + 14 天規劃</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-purple-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">品牌語氣與說話風格生成</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-purple-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">可持續優化與迭代</span>
                          </li>
                        </ul>
                        
                        <!-- 底部連結 -->
                        <div class="flex items-center gap-2 text-xs font-semibold text-purple-600 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="window.location.href='mode1.html';">
                          <span>了解更多</span>
                          <span class="text-lg">→</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 卡片 3: 創作者資料庫 -->
                    <div class="group relative bg-white border-2 border-transparent hover:border-orange-200 rounded-3xl p-8 shadow-sm hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 transform overflow-hidden">
                      <!-- 背景光效 -->
                      <div class="absolute inset-0 bg-gradient-to-br from-orange-50/0 to-orange-50/100 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                      
                      <!-- 圖標區 -->
                      <div class="relative z-10 flex items-center justify-center w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-orange-100 to-orange-200 rounded-2xl group-hover:scale-110 transition-transform duration-500">
                        <i class="fas fa-database text-4xl text-orange-600"></i>
                      </div>
                      
                      <!-- 內容區 -->
                      <div class="relative z-10">
                        <!-- 小標籤 -->
                        <div class="inline-block px-3 py-1 mb-4 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                          創作者資料庫
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-orange-600 transition-colors">
                          作品整合與再利用
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                          你的每一次生成（腳本、選題、定位）都會自動歸檔於個人資料庫；支援 PDF / CSV 下載、版本重生與標註。
                        </p>
                        
                        <!-- 列表 -->
                        <ul class="space-y-3 mb-6">
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">我的腳本：分鏡、口播、CTA 一次看</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">一鍵下載（PDF／CSV）與重生</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">可視化清單，方便整理與回顧</span>
                          </li>
                        </ul>
                        
                        <!-- 底部連結 -->
                        <div class="flex items-center gap-2 text-xs font-semibold text-orange-600 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="window.location.href='userDB.html';">
                          <span>了解更多</span>
                          <span class="text-lg">→</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 卡片 4: 實戰指南 -->
                    <div class="group relative bg-white border-2 border-transparent hover:border-orange-200 rounded-3xl p-8 shadow-sm hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 transform overflow-hidden">
                      <!-- 背景光效 -->
                      <div class="absolute inset-0 bg-gradient-to-br from-orange-50/0 to-orange-50/100 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                      
                      <!-- 圖標區 -->
                      <div class="relative z-10 flex items-center justify-center w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-orange-100 to-orange-200 rounded-2xl group-hover:scale-110 transition-transform duration-500">
                        <i class="fas fa-book-open text-4xl text-orange-600"></i>
                      </div>
                      
                      <!-- 內容區 -->
                      <div class="relative z-10">
                        <!-- 小標籤 -->
                        <div class="inline-block px-3 py-1 mb-4 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">
                          實戰指南
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-orange-600 transition-colors">
                          學習 AI 短影音技巧
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                          從基礎到進階，完整教學如何用 AI 打造爆款短影音內容。包含腳本生成技巧、平台差異、結構選擇指南。
                        </p>
                        
                        <!-- 列表 -->
                        <ul class="space-y-3 mb-6">
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">基礎教學：三步生成腳本</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">進階技巧：IP 人設規劃</span>
                          </li>
                          <li class="flex items-start gap-3 text-sm">
                            <span class="text-orange-500 text-lg mt-0 flex-shrink-0">✓</span>
                            <span class="text-gray-700">平台差異與結構選擇</span>
                          </li>
                        </ul>
                        
                        <!-- 底部連結 -->
                        <div class="flex items-center gap-2 text-xs font-semibold text-orange-600 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="window.location.href='guide.html';">
                          <span>了解更多</span>
                          <span class="text-lg">→</span>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                  
                  <!-- 底部 CTA 區 - 全新設計 -->
                  <div class="relative">
                    <div class="bg-gradient-to-r from-yellow-50 via-orange-50 to-yellow-50 rounded-3xl p-8 md:p-12 border-2 border-yellow-200 shadow-xl">
                      <!-- 建議文字 -->
                      <div class="text-center mb-10">
                        <p class="text-base md:text-lg text-gray-800 mb-2">
                          <i class="fas fa-lightbulb text-2xl text-orange-600"></i>
                        </p>
                        <p class="text-base md:text-lg text-gray-800 font-medium">
                          <strong class="text-orange-700">建議使用順序：</strong>先做 IP 人設 → 取得 14 天規劃 → 每日使用一鍵生成。AI 會記住你之前的內容並持續優化。
                        </p>
                      </div>
                      
                      <!-- CTA 按鈕 -->
                      <div class="flex justify-center">
                        <a href="#" onclick="goToLogin(); return false;" class="group inline-flex items-center gap-4 px-10 md:px-14 py-5 md:py-6 bg-gradient-to-r from-orange-500 via-orange-500 to-yellow-500 text-white rounded-2xl font-bold text-lg md:text-xl shadow-lg hover:shadow-2xl hover:shadow-orange-500/50 hover:scale-105 transition-all duration-300 transform">
                          <i class="fas fa-lock-open text-2xl"></i>
                          <span>登入解鎖你的專屬 AI 智能體</span>
                          <span class="text-3xl group-hover:translate-x-1 transition-transform">→</span>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
              
              <!-- 教學文章 / 實戰指南區（取代「精彩作品展示」）-->
              <section class="rm-guide-section" style="background: #F8FAFC; padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                  <div style="text-align: center; margin-bottom: 60px;">
                    <h2 onclick="window.location.href='guide.html'; return false;" style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: #1E293B; margin-bottom: 16px; cursor: pointer; transition: color 0.3s;" onmouseover="this.style.color='#2563EB';" onmouseout="this.style.color='#1E293B';"><i class="fas fa-book-open" style="margin-right: 10px;"></i>AI 短影音實戰指南</h2>
                    <p style="font-size: 1.1rem; color: #64748B; max-width: 600px; margin: 0 auto;">學習如何用 AI 打造爆款短影音內容</p>
                </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 32px; margin-top: 40px;">
                    <!-- 文章 1 -->
                    <a onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article1'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                      <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                        <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                          <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">三步生成 30 秒短影音腳本</div>
                          <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                            只需三步：設定平台與主題、AI 生成劇本大綱、確認並儲存。本教學將示範完整流程，幫你在 5 分鐘內產出 Instagram Reels 腳本...
                </div>
                </div>
                        <div style="padding: 20px 32px; background: #F8FAFC;">
                          <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
              </div>
                      </div>
                    </a>
                    
                    <!-- 文章 2 -->
                    <a onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article2'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                      <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                        <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                          <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">AI 帳號定位：內容支柱與 14 天計畫</div>
                          <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                            了解如何用 AI 分析你的內容定位，並自動生成 14 天發布計畫。包含內容支柱（教育、娛樂、啟發、成交）與排程建議...
                          </div>
                        </div>
                        <div style="padding: 20px 32px; background: #F8FAFC;">
                          <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                        </div>
                      </div>
                    </a>
                    
                    <!-- 文章 3 -->
                    <a onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article3'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                      <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                        <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                          <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">Reels / Shorts / TikTok<br>腳本差異</div>
                          <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                            每個平台的短影音都有不同特性：IG Reels 偏重品牌敘事，YouTube Shorts 強調快速爆點，TikTok 重視娛樂性。本指南解析 AI 如何自動調整...
                          </div>
                        </div>
                        <div style="padding: 20px 32px; background: #F8FAFC;">
                          <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                        </div>
                      </div>
                    </a>
                    
                    <!-- 文章 4 -->
                    <a onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article4'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                      <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                        <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                          <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">腳本結構選擇指南</div>
                          <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                            了解 ReelMind 提供的 5 種腳本結構（A/B/C/D/E），每種結構適合不同的內容類型和目標。本指南幫助你選擇最適合的腳本結構，提升內容效果...
                          </div>
                        </div>
                        <div style="padding: 20px 32px; background: #F8FAFC;">
                          <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
              </section>

              <!-- 免費體驗版區塊（移到"別人怎麼用"前面，增強動態動畫和 FOMO 感） -->
              <section id="experience-demo" style="background: linear-gradient(to bottom right, #F0FDF4 0%, #EFF6FF 100%); padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw; position: relative; overflow: hidden;">
                <!-- 動態背景動畫 -->
                <div class="experience-animated-bg" style="position: absolute; inset: 0; overflow: hidden; pointer-events: none;">
                  <div class="floating-shape" style="position: absolute; width: 300px; height: 300px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(16,185,129,0.15)); border-radius: 50%; filter: blur(80px); animation: floatAnimation 8s ease-in-out infinite; top: 10%; left: 10%;"></div>
                  <div class="floating-shape" style="position: absolute; width: 250px; height: 250px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(59,130,246,0.15)); border-radius: 50%; filter: blur(70px); animation: floatAnimation 10s ease-in-out infinite reverse; top: 60%; right: 15%;"></div>
                  <div class="floating-shape" style="position: absolute; width: 200px; height: 200px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(139,92,246,0.15)); border-radius: 50%; filter: blur(60px); animation: floatAnimation 12s ease-in-out infinite; bottom: 20%; left: 20%;"></div>
                </div>
                
                <!-- 閃爍星星動畫 -->
                <div class="sparkle-container" style="position: absolute; inset: 0; pointer-events: none; z-index: 1;">
                  <div class="sparkle" style="position: absolute; width: 4px; height: 4px; background: #3B82F6; border-radius: 50%; animation: sparkleAnimation 3s ease-in-out infinite; top: 20%; left: 15%;"></div>
                  <div class="sparkle" style="position: absolute; width: 3px; height: 3px; background: #10B981; border-radius: 50%; animation: sparkleAnimation 2.5s ease-in-out infinite 0.5s; top: 40%; right: 20%;"></div>
                  <div class="sparkle" style="position: absolute; width: 5px; height: 5px; background: #8B5CF6; border-radius: 50%; animation: sparkleAnimation 3.5s ease-in-out infinite 1s; bottom: 30%; left: 25%;"></div>
                  <div class="sparkle" style="position: absolute; width: 4px; height: 4px; background: #3B82F6; border-radius: 50%; animation: sparkleAnimation 2.8s ease-in-out infinite 1.5s; top: 60%; left: 50%;"></div>
                </div>
                <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px; position: relative; z-index: 10;">
                  <div style="text-align: center; margin-bottom: 60px;">
                    <!-- FOMO 標籤：限時免費 -->
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; border-radius: 9999px; font-weight: 700; font-size: 0.9rem; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(239,68,68,0.4); animation: pulseGlow 2s ease-in-out infinite;">
                      <i class="fas fa-fire" style="animation: firePulse 1.5s ease-in-out infinite;"></i>
                      <span>限時免費體驗</span>
                    </div>
                    <h2 style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: #1E293B; margin-bottom: 16px; animation: fadeInUp 0.8s ease-out;">
                      <i class="fas fa-sparkles" style="margin-right: 10px; color: #3B82F6; animation: sparkleRotate 3s ease-in-out infinite;"></i>立即體驗 AI 短影音生成
                    </h2>
                    <p style="font-size: 1.1rem; color: #64748B; max-width: 700px; margin: 0 auto 24px; line-height: 1.7; animation: fadeInUp 0.8s ease-out 0.2s both;">
                      立即登入，體驗 ReelMind 的一鍵生成功能。填寫你的需求，AI 將為你生成帳號定位、選題建議和完整腳本。
                    </p>
                    <!-- FOMO 統計：增加緊迫感 -->
                    <div style="display: inline-flex; align-items: center; gap: 16px; padding: 12px 24px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2); margin-bottom: 24px; animation: fadeInUp 0.8s ease-out 0.4s both;">
                      <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #3B82F6; line-height: 1;">1,234+</div>
                        <div style="font-size: 0.75rem; color: #64748B;">今日體驗</div>
                      </div>
                      <div style="width: 1px; height: 30px; background: #E2E8F0;"></div>
                      <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #10B981; line-height: 1;">98%</div>
                        <div style="font-size: 0.75rem; color: #64748B;">滿意度</div>
                      </div>
                      <div style="width: 1px; height: 30px; background: #E2E8F0;"></div>
                      <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #8B5CF6; line-height: 1;">5分鐘</div>
                        <div style="font-size: 0.75rem; color: #64748B;">平均生成</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 體驗版卡片 -->
                  <div style="max-width: 800px; margin: 0 auto;">
                    <div style="background: white; border-radius: 24px; padding: 48px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid #E2E8F0; position: relative; overflow: hidden;">
                      <!-- 背景裝飾 -->
                      <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(16,185,129,0.1)); border-radius: 50%; filter: blur(60px);"></div>
                      <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border-radius: 50%; filter: blur(60px);"></div>
                      
                      <div style="position: relative; z-index: 10;">
                        <!-- 功能特色 -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 40px;">
                          <div style="text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 4px 12px rgba(59,130,246,0.3);">
                              <i class="fas fa-bullseye" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                            <h3 style="font-size: 1rem; font-weight: 700; color: #1E293B; margin-bottom: 8px;">帳號定位</h3>
                            <p style="font-size: 0.875rem; color: #64748B; line-height: 1.5;">AI 分析你的特質，打造專屬定位</p>
                      </div>
                          <div style="text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                              <i class="fas fa-lightbulb" style="font-size: 1.5rem; color: white;"></i>
                      </div>
                            <h3 style="font-size: 1rem; font-weight: 700; color: #1E293B; margin-bottom: 8px;">選題建議</h3>
                            <p style="font-size: 0.875rem; color: #64748B; line-height: 1.5;">基於知識庫生成高流量選題</p>
                      </div>
                          <div style="text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 4px 12px rgba(139,92,246,0.3);">
                              <i class="fas fa-file-alt" style="font-size: 1.5rem; color: white;"></i>
                    </div>
                            <h3 style="font-size: 1rem; font-weight: 700; color: #1E293B; margin-bottom: 8px;">完整腳本</h3>
                            <p style="font-size: 0.875rem; color: #64748B; line-height: 1.5;">Hook → Value → CTA 完整結構</p>
                        </div>
                      </div>
                        
                        <!-- CTA 按鈕（增強動畫和 FOMO） -->
                        <div style="text-align: center; position: relative;">
                          <a href="#" onclick="handleFreeTrialClick(event); return false;" class="experience-cta-btn" style="display: inline-flex; align-items: center; gap: 12px; padding: 18px 40px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); color: white; border-radius: 12px; font-weight: 700; text-decoration: none; font-size: 1.1rem; box-shadow: 0 4px 20px rgba(59,130,246,0.3), 0 0 0 0 rgba(59,130,246,0.5); transition: all 0.3s; transform: scale(1); animation: ctaPulse 2s ease-in-out infinite; position: relative; overflow: hidden; cursor: pointer;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 30px rgba(59,130,246,0.5), 0 0 0 4px rgba(59,130,246,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(59,130,246,0.3), 0 0 0 0 rgba(59,130,246,0.5)'">
                            <span style="position: relative; z-index: 2;">
                              <i class="fas fa-magic" style="font-size: 1.2rem; animation: magicSpin 2s ease-in-out infinite;"></i>
                            </span>
                            <span style="position: relative; z-index: 2;">立即免費體驗</span>
                            <span style="position: relative; z-index: 2;">
                              <i class="fas fa-arrow-right" style="font-size: 1rem; animation: arrowBounce 1.5s ease-in-out infinite;"></i>
                            </span>
                            <!-- 按鈕光暈效果 -->
                            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent); opacity: 0; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'"></div>
                          </a>
                          <!-- 緊迫感文字 -->
                          <p style="margin-top: 16px; font-size: 0.85rem; color: #EF4444; font-weight: 600; animation: fadeIn 1s ease-out 1s both;">
                            <i class="fas fa-clock" style="margin-right: 4px;"></i>限時免費，立即體驗後升級解鎖更多功能
                          </p>
                      </div>
                        
                        <!-- 提示文字 -->
                        <div style="margin-top: 32px; padding: 20px; background: #FEF3C7; border-radius: 12px; border: 1px solid #FCD34D; text-align: center;">
                          <p style="font-size: 0.9rem; color: #92400E; margin: 0; line-height: 1.6;">
                            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                            <strong>體驗版說明：</strong>此為免費體驗功能，生成結果可複製使用。升級完整版可解鎖 IP 人設規劃、創作者資料庫等更多功能。
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <!-- 訂閱 CTA 區（藍系漸層｜滿版｜桌機橫式｜手機直式） -->
              <section id="subscription-cta" class="rm-pricing" style="background: linear-gradient(to bottom right, #3B82F6 0%, #1D4ED8 100%); padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw; position: relative; overflow: hidden;">
                <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                  <div style="text-align: center; margin-bottom: 60px;">
                    <h2 class="subscription-title" style="font-size: clamp(2rem, 5vw, 3rem); font-weight: 800; color: white; margin-bottom: 20px; text-shadow: 0 2px 20px rgba(0,0,0,0.1);">
                      用 AI 智能體，打造你的爆款短影音
                    </h2>
                    <p class="subscription-subtitle" style="font-size: 1.1rem; color: rgba(255,255,255,0.9); max-width: 600px; margin: 0 auto;">
                      每天不到 NT$66，全年 AI 幫你帳號定位、生成靈感選題與爆款腳本
                    </p>
                  </div>
                  
                  <!-- 定價卡片（桌機橫式／手機直式） -->
                  <div class="rm-pricing-cards" style="display: flex; gap: 32px; justify-content: center; flex-wrap: wrap; margin-bottom: 60px; padding: 0 20px;">
                    <!-- 年費卡 -->
                    <div style="flex: 0 1 320px; max-width: 380px; padding: 40px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 24px; border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s; display: flex; flex-direction: column;">
                      <div style="font-size: 1rem; color: rgba(255,255,255,0.9); margin-bottom: 12px; font-weight: 600;">Script Lite 入門版</div>
                      <div style="display: flex; align-items: flex-end; flex-wrap: nowrap; gap: 4px; margin-bottom: 8px;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: white; line-height: 1;">NT$690元<span style="font-size: 0.6em;">/月</span></div>
                      </div>
                      <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 16px;">以年計費（一次付清）</div>
                      <a href="#" onclick="handleSubscriptionClick('yearly'); return false;" style="display: block; margin-top: auto; padding: 0 32px; background: white; color: #2563EB; border-radius: 12px; font-weight: 700; text-decoration: none; transition: all 0.3s; text-align: center; height: 56px; display: flex; align-items: center; justify-content: center;">
                        立即開通使用權
                      </a>
                    </div>
                    
                    <!-- Creator Pro 雙年方案（優先推廣） -->
                    <div style="flex: 0 1 320px; max-width: 380px; padding: 40px; background: rgba(255,255,255,0.95); border-radius: 24px; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; transition: all 0.3s; display: flex; flex-direction: column;">
                      <div style="position: absolute; top: -16px; left: 50%; right: auto; transform: translateX(-50%); padding: 8px 24px; background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%); color: white; border-radius: 20px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 4px 12px rgba(251,191,36,0.3); white-space: nowrap; display: inline-block;">🔥 最多人選擇</div>
                      <div style="font-size: 1rem; color: #64748B; margin-bottom: 12px; font-weight: 600; margin-top: 12px;">Creator Pro 雙年方案</div>
                      <div style="display: flex; align-items: flex-end; flex-wrap: nowrap; gap: 4px; margin-bottom: 8px;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: #2563EB; line-height: 1;">NT$9,900<span style="font-size: 0.5em;"> / 2 年</span></div>
                      </div>
                      <div style="font-size: 0.9rem; color: #94A3B8; margin-bottom: 16px;">全功能創作者方案｜限時加贈 IP 人設規劃</div>
                      <a href="#" onclick="handleSubscriptionClick('two_year'); return false;" style="display: block; margin-top: auto; padding: 0 32px; background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); color: white; border-radius: 12px; font-weight: 700; text-decoration: none; box-shadow: 0 4px 20px rgba(59,130,246,0.3); transition: all 0.3s; text-align: center; height: 56px; display: flex; align-items: center; justify-content: center;">
                        立即升級為 Pro
                      </a>
                    </div>
                    
                    <!-- 客製化卡 -->
                    <div style="flex: 0 1 320px; max-width: 380px; padding: 40px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 24px; border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s; display: flex; flex-direction: column;">
                      <div style="font-size: 1rem; color: rgba(255,255,255,0.9); margin-bottom: 12px; font-weight: 600; text-align: center;">客製化方案</div>
                      <div style="display: flex; align-items: flex-end; justify-content: center; flex-wrap: nowrap; gap: 4px; margin-bottom: 8px;">
                        <div style="font-size: 2rem; font-weight: 800; color: white; line-height: 1; text-align: center;">客製報價</div>
                      </div>
                      <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 16px; text-align: center;">品牌／團隊合作整合方案</div>
                      <a href="contact.html" style="display: block; margin-top: auto; padding: 0 32px; background: white; color: #2563EB; border-radius: 12px; font-weight: 700; text-decoration: none; transition: all 0.3s; text-align: center; height: 56px; display: flex; align-items: center; justify-content: center;">
                        聯繫我們
                      </a>
                    </div>
                  </div>
                  
                  <!-- 價值承諾 -->
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 32px; margin-top: 60px; padding: 0 20px;">
                    <div style="padding: 32px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); text-align: center;">
                      <div style="font-size: 3rem; margin-bottom: 16px;">⚡</div>
                      <div style="font-weight: 700; margin-bottom: 8px; color: white; font-size: 1.1rem;">產出時間減少 70%</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">AI 自動生成腳本，從小時縮短到分鐘</div>
                    </div>
                    <div style="padding: 32px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); text-align: center;">
                      <div style="font-size: 3rem; margin-bottom: 16px;">📈</div>
                      <div style="font-weight: 700; margin-bottom: 8px; color: white; font-size: 1.1rem;">上片頻率提升 200%</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">一鍵生成，不再為內容發愁</div>
                    </div>
                    <div style="padding: 32px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); text-align: center;">
                      <div style="font-size: 3rem; margin-bottom: 16px;">🧠</div>
                      <div style="font-weight: 700; margin-bottom: 8px; color: white; font-size: 1.1rem;">智能學習</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">AI 會記住你的內容風格並持續優化</div>
                    </div>
                  </div>
                </div>
              </section>
              
              <!-- Footer（GEO＋SEO） -->
              <section class="rm-footer" style="background: #EFF6FF; padding: 60px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                  <div style="font-size: 1.1rem; font-weight: 600; color: #1E293B; margin-bottom: 12px; text-align: center; width: 100%;">
                    AIJob 智能體 |  ReelMind |AIJob學院
                  </div>
                  <div style="font-size: 0.9rem; color: #94A3B8; font-weight: 500; text-align: center; width: 100%; margin-bottom: 16px;">
                    ReelMind — 為亞洲創作者打造的 AI 短影音智能體
                  </div>
                  
                </div>
              </section>

              </div>
              <!-- 已登入用戶（已訂閱）視圖 - 顯示 index_subscribed.html 的內容 -->
              <div id="homepage-subscribed" class="homepage-view" style="display: none;">
                <!-- Hero Section: 白＋藍冷系｜滿版全出血 -->
                <section class="rm-hero" style="position: relative; overflow: hidden; padding: 80px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                  <!-- 背景淡藍光暈（增強效果） -->
                  <div style="position: absolute; top: -100px; right: 0; width: 800px; height: 800px; background: radial-gradient(circle at 80% 20%, rgba(59,130,246,0.15), transparent 60%); pointer-events: none; z-index: 0;"></div>
                  
                  <div class="rm-hero-container" style="max-width: 1400px; margin: 0 auto; padding: 0 max(16px, env(safe-area-inset-left)) 0 max(16px, env(safe-area-inset-right)); position: relative; z-index: 1; width: 100%; box-sizing: border-box;">
                    <div class="rm-hero-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; width: 100%; max-width: 100%; box-sizing: border-box;">
                      
                      <!-- 左側：文案區 -->
                      <div style="padding: 20px 0; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                        <h1 id="hero-title-2" class="rm-hero-title typewriter-title" style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; color: white; margin-bottom: 20px; line-height: 1.2; letter-spacing: -0.02em; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; text-shadow: 0 2px 15px rgba(0,0,0,0.15);">
                          <span class="typewriter-text"></span><span class="typewriter-cursor">|</span>
                        </h1>
                        <p style="font-size: clamp(1rem, 2vw, 1.25rem); color: white; margin-bottom: 32px; line-height: 1.7; width: 100%; max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; text-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                          AI 生成腳本、AI 帳號定位，一次完成。<br/>
                          <span style="font-size: 0.9em; color: rgba(255,255,255,0.9);">開始你的創作之旅</span>
                        </p>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px;">
                          <a href="#mode-cards" onclick="smoothScrollTo('mode-cards'); return false;" style="padding: 16px 24px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border-radius: 12px; font-weight: 700; text-decoration: none; box-shadow: 0 4px 20px rgba(16,185,129,0.3); transition: all 0.3s; font-size: 0.9rem; min-height: 48px; display: inline-flex; align-items: center; justify-content: center; flex: 1; position: relative; overflow: hidden;">
                            開始使用
                          </a>
                          <a href="#introduction" onclick="smoothScrollTo('introduction'); return false;" style="padding: 16px 24px; background: rgba(255,255,255,0.95); color: #2563EB; border: 2px solid rgba(255,255,255,0.5); border-radius: 12px; font-weight: 600; text-decoration: none; transition: all 0.3s; font-size: 0.9rem; min-height: 48px; display: inline-flex; align-items: center; justify-content: center; flex: 1; position: relative; overflow: hidden; backdrop-filter: blur(10px);">
                            了解如何開始
                          </a>
                        </div>
                      </div>
                      
                      <!-- 右側：影片預覽 -->
                      <div style="position: relative;">
                        <div class="youtube-lazy-container" data-video-id="Pw1_MRIJ9GA" data-autoplay="0" style="aspect-ratio: 16/9; background: #E2E8F0; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); position: relative; cursor: pointer;">
                          <img src="https://img.youtube.com/vi/Pw1_MRIJ9GA/maxresdefault.jpg" alt="ReelMind AI 短影音智能體示範影片" style="width: 100%; height: 100%; object-fit: cover; display: block;" loading="lazy">
                          <div class="youtube-play-button" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background: rgba(255, 0, 0, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: all 0.3s;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="white" style="margin-left: 4px;">
                              <path d="M8 5v14l11-7z"/>
                            </svg>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </section>

                <!-- 介紹如何開始 -->
                <section id="introduction" style="background: white; padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                    <div style="text-align: center; margin-bottom: 60px;">
                      <h2 style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: #1E293B; margin-bottom: 16px;">
                        <i class="fas fa-rocket" style="margin-right: 10px; color: #3B82F6;"></i>介紹如何開始
                      </h2>
                      <p style="font-size: 1.1rem; color: #64748B; max-width: 600px; margin: 0 auto;">
                        四個簡單步驟，開始你的 AI 短影音創作之旅
                      </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; margin-top: 40px;">
                      <!-- 步驟 1：儲存自己的AI金鑰 -->
                      <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(17,24,39,0.06); border: 1px solid #E2E8F0; text-align: center; position: relative;">
                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(245,158,11,0.3);">
                          1
                        </div>
                        <div style="margin-top: 30px; margin-bottom: 24px;">
                          <i class="fas fa-key" style="font-size: 3rem; color: #F59E0B; margin-bottom: 16px;"></i>
                        </div>
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1E293B; margin-bottom: 16px;">儲存自己的AI金鑰</h3>
                        <p style="font-size: 1rem; color: #64748B; line-height: 1.7; margin-bottom: 20px;">
                          在「創作者資料庫」中儲存你的 LLM API 金鑰（支援 Gemini、GPT 等），讓 AI 使用你的金鑰進行生成，節省成本並提升使用體驗。
                        </p>
                        <a href="#" onclick="handleLlmKeyGuideButton(); return false;" style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.3s; box-shadow: 0 2px 8px rgba(245,158,11,0.3);">
                          如何拿到自己的LLM金鑰？
                        </a>
                      </div>
                      
                      <!-- 步驟 2：建立IP人設規劃 -->
                      <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(17,24,39,0.06); border: 1px solid #E2E8F0; text-align: center; position: relative;">
                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                          2
                        </div>
                        <div style="margin-top: 30px; margin-bottom: 24px;">
                          <i class="fas fa-user-tie" style="font-size: 3rem; color: #10B981; margin-bottom: 16px;"></i>
                        </div>
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1E293B; margin-bottom: 16px;">建立IP人設規劃</h3>
                        <p style="font-size: 1rem; color: #64748B; line-height: 1.7;">
                          使用「IP人設規劃模式」，透過聊天記錄你的人生曲線與品牌故事，AI 會協助建立專屬的 IP Profile 和 14 天內容規劃。你也可以深度與 AI 討論短影音矩陣策略，打造完整的內容架構。
                        </p>
                      </div>
                      
                      <!-- 步驟 3：一鍵生成模式 -->
                      <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(17,24,39,0.06); border: 1px solid #E2E8F0; text-align: center; position: relative;">
                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(59,130,246,0.3);">
                          3
                        </div>
                        <div style="margin-top: 30px; margin-bottom: 24px;">
                          <i class="fas fa-magic" style="font-size: 3rem; color: #3B82F6; margin-bottom: 16px;"></i>
                        </div>
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1E293B; margin-bottom: 16px;">一鍵生成模式</h3>
                        <p style="font-size: 1rem; color: #64748B; line-height: 1.7;">
                          針對你的需求「快速」產生帳號定位、選題和腳本。AI 會根據你過往的 IP 人設規劃和生成記錄，自動調整內容風格，讓每次生成都更符合你的品牌調性。
                        </p>
                      </div>
                      
                      <!-- 步驟 4：創作者資料庫 -->
                      <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(17,24,39,0.06); border: 1px solid #E2E8F0; text-align: center; position: relative;">
                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(139,92,246,0.3);">
                          4
                        </div>
                        <div style="margin-top: 30px; margin-bottom: 24px;">
                          <i class="fas fa-database" style="font-size: 3rem; color: #8B5CF6; margin-bottom: 16px;"></i>
                        </div>
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1E293B; margin-bottom: 16px;">創作者資料庫</h3>
                        <p style="font-size: 1rem; color: #64748B; line-height: 1.7;">
                          完成腳本後，可以儲存到「創作者資料庫」，隨時查看、下載或重新生成。AI 會記住你的內容風格，持續優化每次生成的品質。
                        </p>
                      </div>
                    </div>
                    
                    <!-- 建議使用順序提示 -->
                    <div style="margin-top: 60px; padding: 32px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 20px; border: 2px solid #FCD34D; text-align: center;">
                      <p style="font-size: 1.1rem; color: #92400E; line-height: 1.7;">
                        <i class="fas fa-lightbulb" style="margin-right: 8px; color: #F59E0B;"></i>
                        <strong style="font-weight: 700;">建議使用順序：</strong>先儲存 AI 金鑰 → 建立 IP 人設規劃 → 一鍵生成腳本 → 創作者資料庫管理。AI 會記住你之前的內容並持續優化。
                      </p>
                    </div>
                  </div>
                </section>

                <!-- 三大功能區塊卡片 -->
                <section id="mode-cards" style="background: #F8FAFC; padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                    <div style="text-align: center; margin-bottom: 60px;">
                      <h1 class="homepage-title" style="font-size: clamp(2rem, 4vw, 2.5rem); font-weight: 700; color: #1f2937; margin-bottom: 16px;">
                        歡迎使用AIJob<span class="mobile-break">短影音智能體</span>
                      </h1>
                      <p class="homepage-subtitle" style="font-size: clamp(1rem, 2vw, 1.1rem); color: #6b7280; margin-bottom: 48px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                        選擇您偏好的使用模式，開始創作精彩的短影音內容
                      </p>
                    </div>
                    
                    <div class="mode-cards" style="position: relative; display: flex; justify-content: center; margin: 0 auto; max-width: 1200px;">
                      <div class="mode-card" onclick="handleModeCardClick('mode1');">
                        <div class="mode-card-icon"><i class="fas fa-user-tie"></i></div>
                        <h3 class="mode-card-title">IP人設規劃模式</h3>
                        <p class="mode-card-desc">透過聊天記錄人生曲線，AI協助擬定個人化IP Profile、14天規劃和腳本</p>
                      </div>
                      <div class="mode-card" onclick="handleModeCardClick('mode3');">
                        <div class="mode-card-icon"><i class="fas fa-magic"></i></div>
                        <h3 class="mode-card-title">一鍵生成模式</h3>
                        <p class="mode-card-desc">快速設定需求，依序生成帳號定位、選題和腳本，適合效率導向的用戶</p>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- AI 短影音實戰指南 -->
                <section style="background: white; padding: 100px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                    <div style="text-align: center; margin-bottom: 60px;">
                      <h2 style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: #1E293B; margin-bottom: 16px;"><i class="fas fa-book-open" style="margin-right: 10px;"></i>AI 短影音實戰指南</h2>
                      <p style="font-size: 1.1rem; color: #64748B; max-width: 600px; margin: 0 auto;">學習如何用 AI 打造爆款短影音內容</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 32px; margin-top: 40px;">
                      <!-- 文章 1 -->
                      <a href="#" onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article1'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                          <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">三步生成 30 秒短影音腳本</div>
                            <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                              只需三步：設定平台與主題、AI 生成劇本大綱、確認並儲存。本教學將示範完整流程，幫你在 5 分鐘內產出 Instagram Reels 腳本...
                            </div>
                          </div>
                          <div style="padding: 20px 32px; background: #F8FAFC;">
                            <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                          </div>
                        </div>
                      </a>
                      
                      <!-- 文章 2 -->
                      <a href="#" onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article2'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                          <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">AI 帳號定位：內容支柱與 14 天計畫</div>
                            <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                              了解如何用 AI 分析你的內容定位，並自動生成 14 天發布計畫。包含內容支柱（教育、娛樂、啟發、成交）與排程建議...
                            </div>
                          </div>
                          <div style="padding: 20px 32px; background: #F8FAFC;">
                            <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                          </div>
                        </div>
                      </a>
                      
                      <!-- 文章 3 -->
                      <a href="#" onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article3'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                          <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">Reels / Shorts / TikTok<br>腳本差異</div>
                            <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                              每個平台的短影音都有不同特性：IG Reels 偏重品牌敘事，YouTube Shorts 強調快速爆點，TikTok 重視娛樂性。本指南解析 AI 如何自動調整...
                            </div>
                          </div>
                          <div style="padding: 20px 32px; background: #F8FAFC;">
                            <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                          </div>
                        </div>
                      </a>
                      
                      <!-- 文章 4 -->
                      <a href="#" onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article4'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                          <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">腳本結構選擇指南</div>
                            <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                              了解 ReelMind 提供的 5 種腳本結構（A/B/C/D/E），每種結構適合不同的內容類型和目標。本指南幫助你選擇最適合的腳本結構，提升內容效果...
                            </div>
                          </div>
                          <div style="padding: 20px 32px; background: #F8FAFC;">
                            <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                          </div>
                        </div>
                      </a>
                      
                      <!-- 文章 5：如何拿到自己的LLM金鑰 -->
                      <a href="#" onclick="window.location.href='guide.html'; setTimeout(() => { if (typeof showGuideArticle === 'function') showGuideArticle('article5'); }, 100); return false;" style="text-decoration: none; display: block; cursor: pointer;">
                        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(17,24,39,0.06); transition: all 0.3s; border: 1px solid #E2E8F0; display: flex; flex-direction: column; height: 100%;">
                          <div style="padding: 32px; border-bottom: 1px solid #F1F5F9; flex: 1 1 auto;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 12px;">如何拿到自己的LLM金鑰</div>
                            <div style="font-size: 0.95rem; color: #64748B; line-height: 1.6;">
                              詳細教學如何取得 Gemini、GPT 等 LLM API 金鑰，並在 ReelMind 中設定使用。使用自己的金鑰可以節省成本，並獲得更好的使用體驗...
                            </div>
                          </div>
                          <div style="padding: 20px 32px; background: #F8FAFC;">
                            <span style="color: #2563EB; font-weight: 600; font-size: 0.95rem;">閱讀更多 →</span>
                          </div>
                        </div>
                      </a>
                    </div>
                  </div>
                </section>

                <!-- 別人怎麼用 - 兩個區塊 -->
                <section class="user-story-section">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                    <div style="text-align: center; margin-bottom: 60px;">
                      <h2 style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: #1E293B; margin-bottom: 16px;">
                        <i class="fas fa-users" style="margin-right: 10px; color: #3B82F6;"></i>別人怎麼用
                      </h2>
                      <p style="font-size: 1.1rem; color: #64748B; max-width: 600px; margin: 0 auto;">
                        看看其他創作者如何用 ReelMind 打造爆款內容
                      </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 32px; margin-top: 40px;">
                      <!-- 使用案例 1 -->
                      <div class="user-story-card">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                          <img src="https://ui-avatars.com/api/?name=Nick+Wu&background=3B82F6&color=fff&size=128&bold=true" alt="Nick Wu" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #E5E7EB;" />
                          <div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #1E293B; margin-bottom: 4px;">Nick Wu｜行銷顧問</div>
                            <div style="font-size: 0.9rem; color: #64748B;">使用 ReelMind 3 個月</div>
                          </div>
                        </div>
                        <div style="font-size: 1rem; color: #475569; line-height: 1.8; margin-bottom: 20px;">
                          「之前每天要花 2-3 小時想腳本，現在用 ReelMind 一鍵生成，5 分鐘就搞定。最棒的是 AI 會記住我的品牌調性，每次生成的內容都很符合我的風格。上個月 IG Reels 的觀看次數提升了 180%！」
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                          <span style="padding: 6px 12px; background: #EFF6FF; color: #2563EB; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#一鍵生成</span>
                          <span style="padding: 6px 12px; background: #F0FDF4; color: #059669; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#IG Reels</span>
                          <span style="padding: 6px 12px; background: #FEF3C7; color: #D97706; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#觀看提升 180%</span>
                        </div>
                      </div>
                      
                      <!-- 使用案例 2 -->
                      <div class="user-story-card">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                          <img src="https://ui-avatars.com/api/?name=李美華&background=10B981&color=fff&size=128&bold=true" alt="李美華" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #E5E7EB;" />
                          <div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #1E293B; margin-bottom: 4px;">李美華｜內容創作者</div>
                            <div style="font-size: 0.9rem; color: #64748B;">使用 ReelMind 6 個月</div>
                          </div>
                        </div>
                        <div style="font-size: 1rem; color: #475569; line-height: 1.8; margin-bottom: 20px;">
                          「IP 人設規劃功能幫我建立了完整的內容策略，14 天規劃讓我知道每天要發什麼。現在每週固定上片 5-7 支，粉絲互動率提升了 3 倍。最喜歡的是 AI 顧問功能，可以隨時討論內容方向，就像有個專業顧問在身邊。」
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                          <span style="padding: 6px 12px; background: #F3E8FF; color: #7C3AED; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#IP人設規劃</span>
                          <span style="padding: 6px 12px; background: #EFF6FF; color: #2563EB; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#AI顧問</span>
                          <span style="padding: 6px 12px; background: #FEF3C7; color: #D97706; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">#互動率提升 3 倍</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- 到Discord論壇分享你的使用心得吧～ -->
                <section class="discord-share-section" style="background: linear-gradient(to bottom right, #8B5CF6 0%, #7C3AED 100%); padding: 100px 0; margin: 60px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw; position: relative; overflow: hidden;">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px; text-align: center; position: relative; z-index: 10;">
                    <div style="margin-bottom: 40px;">
                      <div style="font-size: 4rem; margin-bottom: 24px;">
                        💬
                      </div>
                      <h2 style="font-size: clamp(2rem, 4vw, 2.8rem); font-weight: 800; color: white; margin-bottom: 20px; text-shadow: 0 2px 20px rgba(0,0,0,0.1);">
                        到Discord論壇分享你的使用心得吧～
                      </h2>
                      <p style="font-size: 1.2rem; color: rgba(255,255,255,0.95); max-width: 700px; margin: 0 auto 40px; line-height: 1.7;">
                        加入我們的 Discord 社群，與其他創作者交流使用經驗、分享成功案例，一起打造爆款短影音內容！
                      </p>
                    </div>
                    
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; align-items: center;">
                      <a href="https://AIJobschool.short.gy/UUwpEG" target="_blank" style="display: inline-flex; align-items: center; gap: 12px; padding: 18px 32px; background: white; color: #5865F2; border-radius: 12px; font-weight: 700; text-decoration: none; font-size: 1.1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: all 0.3s; transform: scale(1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fab fa-discord" style="font-size: 1.5rem;"></i>
                        <span>立即加入 Discord 社群</span>
                      </a>
                    </div>
                    
                    <div style="margin-top: 50px; padding: 30px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); max-width: 800px; margin-left: auto; margin-right: auto;">
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; text-align: left;">
                        <div>
                          <div style="font-size: 1.5rem; margin-bottom: 8px;">🔥</div>
                          <div style="font-weight: 700; color: white; margin-bottom: 4px; font-size: 1rem;">#一鍵生成工作區</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">每天新貼文 30+</div>
                        </div>
                        <div>
                          <div style="font-size: 1.5rem; margin-bottom: 8px;">🧭</div>
                          <div style="font-weight: 700; color: white; margin-bottom: 4px; font-size: 1rem;">#IP人設規劃</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">真實案例交流</div>
                        </div>
                        <div>
                          <div style="font-size: 1.5rem; margin-bottom: 8px;">🤖</div>
                          <div style="font-weight: 700; color: white; margin-bottom: 4px; font-size: 1rem;">#AI顧問問答</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">節奏 / Hook / CTA</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
                
                <!-- Footer（GEO＋SEO） -->
                <section class="rm-footer" style="background: #EFF6FF; padding: 60px 0; margin: -20px calc(-50vw + 50%) 0 calc(-50vw + 50%); width: 100vw; max-width: 100vw;">
                  <div style="max-width: 1400px; margin: 0 auto; padding: 0 16px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #1E293B; margin-bottom: 12px; text-align: center; width: 100%;">
                      AIJob 智能體 |  ReelMind |AIJob學院
                    </div>
                    <div style="font-size: 0.9rem; color: #94A3B8; font-weight: 500; text-align: center; width: 100%; margin-bottom: 16px;">
                      ReelMind — 為亞洲創作者打造的 AI 短影音智能體
                    </div>
                    
                  </div>
                </section>

              </div>
            </div>
          </div>

          <!-- 模式1、模式2、模式3、userDB、guide 頁面已分離到獨立文件，已移除 -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h3 class="sidebar-title">功能選單</h3>
          <button class="sidebar-close" onclick="toggleSidebar()">×</button>
        </div>
        <div class="sidebar-menu">
          <button class="sidebar-item" onclick="showSidebarPage('profile')">👤 個人資料</button>
          <button class="sidebar-item" onclick="showSidebarPage('scripts')">📝 我的腳本</button>
          <button class="sidebar-item" onclick="showSidebarPage('positioning')">🎯 帳號定位</button>
          <button class="sidebar-item" onclick="showSidebarPage('topics')">💡 選題記錄</button>
          <button class="sidebar-item" onclick="showSidebarPage('settings')">⚙️ 設定</button>
          <button class="sidebar-item" onclick="showSidebarPage('statistics')">📊 使用統計</button>
          <button class="sidebar-item" onclick="showSidebarPage('help')">❓ 幫助中心</button>
        </div>
      </div>

      <!-- 側邊欄頁面容器 -->
      <div class="sidebar-page-overlay" id="sidebarPageOverlay" style="display: none;">
        <div class="sidebar-page-container">
          <div class="sidebar-page-header">
            <h2 id="sidebarPageTitle">頁面標題</h2>
            <button class="sidebar-page-close" onclick="closeSidebarPage()">×</button>
          </div>
          <div class="sidebar-page-content" id="sidebarPageContent">
            <!-- 頁面內容將動態載入到這裡 -->
          </div>
        </div>
      </div>

    </div>

      <!-- 用戶抽屜 -->
      <div id="userDrawerOverlay" class="user-drawer-overlay" onclick="closeUserDrawer()"></div>
      <div id="userDrawer" class="user-drawer">
        <!-- 標題欄 -->
        <div class="user-drawer-header">
          <div class="user-drawer-title">
            <div class="app-logo">AIJob</div>
            <span class="app-name">短影音顧問</span>
          </div>
          <button class="user-drawer-close" onclick="closeUserDrawer()">×</button>
        </div>
        
        <!-- 左右兩欄布局 -->
        <div class="user-drawer-body">
          <!-- 左側選單 -->
          <div class="user-drawer-sidebar">
            <div class="user-profile">
              <img id="drawerAvatar" class="user-drawer-avatar" src="" alt="用戶頭像" loading="lazy">
              <div class="user-drawer-info">
                <h3 id="drawerName">用戶名稱</h3>
                <p id="drawerEmail">user@example.com</p>
              </div>
            </div>
            
            <ul class="user-drawer-menu">
              <li><a href="#" class="active" data-section="personalInfo" onclick="switchDrawerContent('personalInfo')"><span class="icon">👤</span>個人資料</a></li>
              <li><a href="#" data-section="myScripts" onclick="switchDrawerContent('myScripts')"><span class="icon">💾</span>我的腳本</a></li>
              <li><a href="#" data-section="accountPositioning" onclick="switchDrawerContent('accountPositioning')"><span class="icon">🎯</span>帳號定位</a></li>
              <li><a href="#" data-section="topicHistory" onclick="switchDrawerContent('topicHistory')"><span class="icon">💡</span>選題記錄</a></li>
              <li><a href="#" data-section="settings" onclick="switchDrawerContent('settings')"><span class="icon">⚙️</span>設定</a></li>
              <li><a href="#" data-section="usageStats" onclick="switchDrawerContent('usageStats')"><span class="icon">📊</span>使用統計</a></li>
              <li><a href="#" data-section="helpCenter" onclick="switchDrawerContent('helpCenter')"><span class="icon">❓</span>幫助中心</a></li>
            </ul>
          </div>
          
          <!-- 右側內容區域 -->
          <div class="user-drawer-content">
            <!-- 個人資料 -->
            <div id="personalInfo" class="content-section active">
              <h2>個人資料</h2>
              <div class="user-info-detail">
                <div class="info-item">
                  <label>姓名：</label>
                  <span id="userNameDetail">-</span>
                </div>
                <div class="info-item">
                  <label>信箱：</label>
                  <span id="userEmailDetail">-</span>
                </div>
                <div class="info-item">
                  <label>用戶ID：</label>
                  <span id="userIdDetail">-</span>
                </div>
              </div>
            </div>
            
            <!-- 我的腳本 -->
            <div id="myScripts" class="content-section">
              <h2>我的腳本</h2>
              <div id="generationsList" class="generations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 帳號定位 -->
            <div id="accountPositioning" class="content-section">
              <h2>帳號定位記錄</h2>
              <div id="positioningHistoryContent" class="positioning-history-content">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 選題記錄 -->
            <div id="topicHistory" class="content-section">
              <h2>選題記錄</h2>
              <div id="conversationsList" class="conversations-list">
                <div class="loading-text">載入中...</div>
              </div>
            </div>
            
            <!-- 設定 -->
            <div id="settings" class="content-section">
              <h2>設定</h2>
              <div class="settings-content">
                <p>設定功能開發中...</p>
              </div>
            </div>
            
            <!-- 使用統計 -->
            <div id="usageStats" class="content-section">
              <h2>使用統計</h2>
              <div class="stats-content">
                <p>統計功能開發中...</p>
              </div>
            </div>
            
            <!-- 幫助中心 -->
            <div id="helpCenter" class="content-section">
              <h2>幫助中心</h2>
              <div class="help-content">
                <p>幫助功能開發中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 彈跳視窗登入覆蓋層 -->
      <div id="popupOverlay" class="popup-overlay">
        <div class="popup-content">
          <div id="popupSpinner" class="popup-spinner"></div>
          <div id="popupMessage" class="popup-message">正在開啟 Google 登入視窗...</div>
          <div id="popupButtons" style="display: none;">
            <button id="popupRetry" class="popup-btn">重試</button>
            <button id="popupCancel" class="popup-btn secondary">取消</button>
          </div>
        </div>
      </div>


      <div id="status" class="small"></div>
      
      <!-- 結果區塊 -->
      <div id="results" class="results-block">
        <h3>📝 短影音腳本結果</h3>
        <div class="result-item">
          <h4>🎯 主題</h4>
          <div id="result-title" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📜 腳本內容</h4>
          <div id="result-script" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>🎬 畫面感</h4>
          <div id="result-visual" class="content">尚未生成</div>
        </div>
        <div class="result-item">
          <h4>📱 文案</h4>
          <div id="result-copy" class="content">尚未生成</div>
        </div>
      </div>
      
      
    </div>

    <!-- 彈出提示框 -->
    <div id="toast" class="toast" style="display: none;"></div>
    <script>
      // ===== 提前定義 goToLogin 函數，確保按鈕可以使用 =====
      function goToLogin(showMessage = false) {
        // 優先使用 common.js 中的 goToLogin（直接跳轉到 Google OAuth）
        if (window.ReelMindCommon && typeof window.ReelMindCommon.goToLogin === 'function') {
          window.ReelMindCommon.goToLogin();
          return;
        }
        // 如果 common.js 還沒載入，直接跳轉到 Google OAuth URL（不等待）
        const fbParam = encodeURIComponent(window.location.origin);
        window.location.href = `https://api.aijob.com.tw/api/auth/google?fb=${fbParam}`;
      }
      // 確保 goToLogin 在全局作用域中可用
      window.goToLogin = goToLogin;
      
      // 智能處理實戰指南的「登入解鎖AI生成」按鈕
      // articleType: 'article1' (一鍵生成) | 'article2' (IP人設規劃) | 'article3' (一鍵生成)
      // 處理首頁"如何拿到自己的LLM金鑰？"按鈕
      async function handleLlmKeyGuideButton() {
        try {
          // 檢查是否已登入
          let isLoggedIn = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.isLoggedIn === 'function') {
            isLoggedIn = window.ReelMindCommon.isLoggedIn();
          } else if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
            isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
          } else {
            const token = sessionStorage.getItem('ipPlanningToken');
            isLoggedIn = !!token;
          }
          
          // 檢查是否已訂閱
          let isSubscribed = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.isSubscribed === 'function') {
            isSubscribed = window.ReelMindCommon.isSubscribed();
          } else {
            const backendSubscribed = document.body.dataset.subscribed === 'true';
            const localSubscriptionStatus = localStorage.getItem('subscriptionStatus');
            const localSubscribed = localSubscriptionStatus === 'active';
            const userStr = sessionStorage.getItem('ipPlanningUser');
            let userSubscribed = false;
            if (userStr) {
              try {
                const user = JSON.parse(userStr);
                userSubscribed = !!(user && (user.is_subscribed === true || user.is_subscribed === 1 || user.is_subscribed === '1'));
              } catch (e) {
                // 忽略解析錯誤
              }
            }
            isSubscribed = backendSubscribed || localSubscribed || userSubscribed;
          }
          
          // 如果已登入且已訂閱，直接導向實戰指南的"如何拿到自己的LLM金鑰"文章
          if (isLoggedIn && isSubscribed) {
            window.location.href = 'guide.html?article=article5';
            return;
          }
          
          // 否則使用原有邏輯（導向 guide.html）
          window.location.href = 'guide.html';
          setTimeout(() => { 
            if (typeof showGuideArticle === 'function') {
              showGuideArticle('article5');
            }
          }, 100);
        } catch (error) {
          console.error('處理 LLM 金鑰指南按鈕時出錯:', error);
          // 出錯時使用原有邏輯
          window.location.href = 'guide.html';
          setTimeout(() => { 
            if (typeof showGuideArticle === 'function') {
              showGuideArticle('article5');
            }
          }, 100);
        }
      }
      window.handleLlmKeyGuideButton = handleLlmKeyGuideButton;
      
      async function handleGuideUnlockButton(articleType = 'article1') {
        try {
          // 檢查登入狀態
          let isLoggedIn = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
            isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
          } else {
            // 降級處理：直接檢查 localStorage
            // 使用 checkLoginStatus 實際驗證登入狀態（會呼叫 /api/auth/me）
            if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
              isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
            } else {
              // 降級處理：檢查 localStorage 中的 user_id
              const userStr = localStorage.getItem('ipPlanningUser');
              if (userStr) {
                try {
                  const user = JSON.parse(userStr);
                  isLoggedIn = !!(user && user.user_id);
                } catch (e) {
                  isLoggedIn = false;
                }
              } else {
                isLoggedIn = false;
              }
            }
          }
          
          if (!isLoggedIn) {
            // 未登入，跳轉到登入頁面
            if (window.ReelMindCommon && typeof window.ReelMindCommon.goToLogin === 'function') {
              window.ReelMindCommon.goToLogin();
            } else {
              goToLogin();
            }
            return;
          }
          
          // 已登入，檢查訂閱狀態
          let isSubscribed = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.checkSubscriptionStatus === 'function') {
            await window.ReelMindCommon.checkSubscriptionStatus();
            if (window.ReelMindCommon && typeof window.ReelMindCommon.isSubscribed === 'function') {
              isSubscribed = window.ReelMindCommon.isSubscribed();
            }
          } else {
            // 降級處理：檢查 localStorage
            const subscriptionStatus = localStorage.getItem('subscriptionStatus');
            isSubscribed = subscriptionStatus === 'active';
          }
          
          if (!isSubscribed) {
            // 已登入但未訂閱，跳轉到訂閱頁面
            window.location.href = '/subscription.html';
            return;
          }
          
          // 已登入且已訂閱，根據文章類型跳轉到對應的功能頁面
          if (articleType === 'article1' || articleType === 'article3') {
            // 一鍵生成相關文章，跳轉到 mode3
            if (window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') {
              const canAccess = await window.ReelMindCommon.checkFeatureAccess();
              if (canAccess) {
                window.location.href = '/mode3.html';
              }
            } else {
              window.location.href = '/mode3.html';
            }
          } else if (articleType === 'article2') {
            // IP人設規劃相關文章，跳轉到 mode1
            if (window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') {
              const canAccess = await window.ReelMindCommon.checkFeatureAccess();
              if (canAccess) {
                window.location.href = '/mode1.html';
              }
            } else {
              window.location.href = '/mode1.html';
            }
          }
        } catch (error) {
          console.error('處理按鈕點擊失敗:', error);
          // 發生錯誤時，降級到登入頁面
          goToLogin();
        }
      }
      // 確保函數在全局作用域中可用
      window.handleGuideUnlockButton = handleGuideUnlockButton;
      
      // 更新實戰指南按鈕文字（僅針對已訂閱且已登入的用戶）
      async function updateGuideButtonTexts() {
        try {
          // 檢查登入狀態
          let isLoggedIn = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
            isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
          } else {
            const token = sessionStorage.getItem('ipPlanningToken');
            isLoggedIn = !!token;
          }
          
          if (!isLoggedIn) {
            return; // 未登入，不更新按鈕文字
          }
          
          // 檢查訂閱狀態
          let isSubscribed = false;
          if (window.ReelMindCommon && typeof window.ReelMindCommon.checkSubscriptionStatus === 'function') {
            await window.ReelMindCommon.checkSubscriptionStatus();
            if (window.ReelMindCommon && typeof window.ReelMindCommon.isSubscribed === 'function') {
              isSubscribed = window.ReelMindCommon.isSubscribed();
            }
          } else {
            const subscriptionStatus = localStorage.getItem('subscriptionStatus');
            isSubscribed = subscriptionStatus === 'active';
          }
          
          if (!isSubscribed) {
            return; // 未訂閱，不更新按鈕文字
          }
          
          // 已登入且已訂閱，更新按鈕文字
          // article1: 三步生成 30 秒短影音腳本 -> "使用一鍵生成功能"
          const article1Buttons = document.querySelectorAll('button[onclick*="handleGuideUnlockButton(\'article1\')"], a[onclick*="handleGuideUnlockButton(\'article1\')"]');
          article1Buttons.forEach(btn => {
            if (btn.textContent.includes('登入解鎖 AI 生成')) {
              btn.textContent = btn.textContent.replace('登入解鎖 AI 生成', '使用一鍵生成功能');
            }
          });
          
          // article2: AI 帳號定位：內容支柱與 14 天計畫 -> "使用IP人設規劃功能"
          const article2Buttons = document.querySelectorAll('button[onclick*="handleGuideUnlockButton(\'article2\')"], a[onclick*="handleGuideUnlockButton(\'article2\')"]');
          article2Buttons.forEach(btn => {
            if (btn.textContent.includes('登入解鎖 AI 生成')) {
              btn.textContent = btn.textContent.replace('登入解鎖 AI 生成', '使用IP人設規劃功能');
            }
          });
          
          // article3: Reels / Shorts / TikTok 腳本差異 -> "使用一鍵生成功能"
          const article3Buttons = document.querySelectorAll('button[onclick*="handleGuideUnlockButton(\'article3\')"], a[onclick*="handleGuideUnlockButton(\'article3\')"]');
          article3Buttons.forEach(btn => {
            if (btn.textContent.includes('登入解鎖 AI 生成')) {
              btn.textContent = btn.textContent.replace('登入解鎖 AI 生成', '使用一鍵生成功能');
            }
          });
          
          // article4: 腳本結構選擇指南 -> "使用一鍵生成功能"
          // 注意：article4 可能使用 article1 的按鈕，所以已經在上面處理了
          
        } catch (error) {
          console.error('更新按鈕文字失敗:', error);
        }
      }
      // 確保函數在全局作用域中可用
      window.updateGuideButtonTexts = updateGuideButtonTexts;
      
      // ===== 提前定義手機版抽屜函數，確保按鈕可以使用 =====
      function toggleMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          const isOpen = drawer.classList.contains('open');
          
          if (isOpen) {
            closeMobileDrawer();
          } else {
            openMobileDrawer();
          }
        }
      }
      
      function openMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          drawer.classList.add('open');
          overlay.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滾動
        }
      }
      
      function closeMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileDrawerOverlay');
        
        if (drawer && overlay) {
          drawer.classList.remove('open');
          overlay.style.display = 'none';
          document.body.style.overflow = ''; // 恢復背景滾動
        }
      }
      
      // 確保函數在全局作用域中可用
      window.toggleMobileDrawer = toggleMobileDrawer;
      window.openMobileDrawer = openMobileDrawer;
      window.closeMobileDrawer = closeMobileDrawer;
      
      // 頁面控制函數
      // ===== Cookie 和認證輔助函數 =====
      /**
       * 從 Cookie 中讀取指定名稱的值（用於讀取非 HttpOnly 的 Cookie，如 csrf_token）
       */
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
      
      /**
       * 檢查是否已登入（通過檢查 csrf_token Cookie，因為 access_token 是 HttpOnly 無法讀取）
       */
      function checkLoggedInFromCookie() {
        const csrfToken = getCookie('csrf_token');
        return !!csrfToken; // 如果有 csrf_token，通常表示已登入
      }
      
      // ===== XSS 防護函數 =====
      /**
       * 安全的 HTML 轉義函數
       * 防止 XSS 攻擊
       */
      function escapeHtml(text) {
        if (text == null || text === undefined) {
          return '';
        }
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      /**
       * 安全地設置元素內容（純文字）
       * 使用 textContent 代替 innerHTML
       */
      function safeSetText(element, text) {
        if (!element) return;
        if (text == null || text === undefined) {
          element.textContent = '';
          return;
        }
        element.textContent = String(text);
      }
      
      /**
       * 安全地設置元素 HTML（需要時使用）
       * 只允許信任的 HTML，否則轉義
       */
      function safeSetHtml(element, html, allowHtml = false) {
        if (!element) return;
        if (html == null || html === undefined) {
          element.innerHTML = '';
          return;
        }
        
        if (allowHtml) {
          // 如果允許 HTML，使用 DOMPurify（如果可用）或基本清理
          if (typeof DOMPurify !== 'undefined') {
            element.innerHTML = DOMPurify.sanitize(String(html));
          } else {
            // 基本清理：只允許安全的標籤
            const temp = document.createElement('div');
            temp.textContent = html;
            element.innerHTML = temp.innerHTML;
          }
        } else {
          // 不允許 HTML，直接轉義
          element.textContent = String(html);
        }
      }
      
      /**
       * 安全地渲染 Markdown（已清理）
       * 使用 marked 渲染後再清理
       */
      function safeRenderMarkdown(markdown) {
        if (!markdown || typeof markdown !== 'string') {
          return '';
        }
        
        try {
          if (typeof marked !== 'undefined') {
            const html = marked.parse(markdown);
            // 使用 DOMPurify 清理（如果可用）
            if (typeof DOMPurify !== 'undefined') {
              return DOMPurify.sanitize(html);
            }
            return html;
          }
          // 如果 marked 不可用，返回轉義的文字
          return escapeHtml(markdown);
        } catch (e) {
          console.error('Markdown 渲染錯誤:', e);
          return escapeHtml(markdown);
        }
      }
      
      async function switchPage(pageId) {
        
        // mode1/mode2/mode3 已分離到獨立頁面，不應通過 switchPage 訪問
        if (['mode1', 'mode2', 'mode3'].includes(pageId)) {
          console.warn('這些頁面已分離到獨立文件，請直接跳轉');
          // 可以選擇直接跳轉或返回
          const pageMap = {
            'mode1': 'mode1.html',  // IP人設規劃 → mode1.html
            'mode2': 'mode2.html',  // AI顧問 → mode2.html
            'mode3': 'mode3.html'   // 一鍵生成 → mode3.html
          };
          if (pageMap[pageId]) {
            window.location.href = pageMap[pageId];
          }
          return;
        }
        
        // 需要訂閱才能訪問的頁面列表（只保留 userDB，因為 mode1/mode2/mode3 已分離）
        const protectedPages = ['userDB'];
        
        // 檢查是否為受保護的頁面
        if (protectedPages.includes(pageId)) {
          // 使用 checkFeatureAccess 檢查登入和訂閱狀態
          if (window.ReelMindCommon && window.ReelMindCommon.checkFeatureAccess) {
            // userDB 允許未訂閱用戶訪問（至少可查看個人資訊和登出）
            const featureType = pageId === 'userDB' ? 'userDB' : null;
            const canAccess = await window.ReelMindCommon.checkFeatureAccess(featureType);
            if (!canAccess) {
              // 需要登入或訂閱，已由 checkFeatureAccess 處理
              // 保持首頁顯示並顯示提示訊息
              const homepage = document.getElementById('homepage');
              if (homepage) {
                homepage.classList.add('active');
              }
              // 顯示狀態提示
              if (typeof showToast === 'function') {
                const isLoggedIn = ipPlanningToken && ipPlanningUser;
                if (!isLoggedIn) {
                  showToast('⚠️ 請先登入以使用此功能', 3000);
                } else {
                  showToast('⚠️ 請先訂閱以使用此功能', 3000);
                }
              }
              return;
            }
          } else {
            // 降級處理：使用原有邏輯
            const isSubscribed = document.body.dataset.subscribed === 'true';
            const isLoggedIn = ipPlanningToken && ipPlanningUser;
            
            // userDB 允許未訂閱用戶訪問（至少可查看個人資訊和登出）
            if (pageId === 'userDB') {
              if (!isLoggedIn) {
                // 未登入，導向登入
                if (typeof goToLogin === 'function') {
                  goToLogin();
                }
                return;
              }
              // 已登入即可訪問 userDB，不需要訂閱檢查
            }
          }
        }
        
        // 移除所有頁面的 mode2-active 和 mode3-active 類（防止 body 滾動被鎖定）
        // 注意：mode2 和 mode3 已分離到獨立頁面，這裡只處理 index.html 中的頁面
        document.body.classList.remove('mode2-active', 'mode3-active');
        document.documentElement.classList.remove('mode2-active', 'mode3-active');
        
        // 隱藏所有頁面
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // 顯示選中的頁面
        const targetPage = document.getElementById(pageId);
        const homepage = document.getElementById('homepage');
        
        if (targetPage) {
          // 先隱藏所有頁面
          document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
          });
          
          // 顯示選中的頁面
          targetPage.classList.add('active');
          
          // 滾動到頁面頂部（確保從其他頁面跳轉時能正確顯示）
          window.scrollTo({ top: 0, behavior: 'instant' });
          
          // 如果切換到首頁，更新首頁視圖（確保訂閱狀態正確顯示）
          if (pageId === 'homepage') {
            setTimeout(() => {
              updateHomepageView();
            }, 100);
          }
          
          // 如果是 userDB，自動顯示個人資料分區
          if (pageId === 'userDB') {
            // 延遲執行，確保 DOM 已完全渲染
            setTimeout(() => {
              if (typeof showDbSection === 'function') {
                showDbSection('personalInfo');
              }
            }, 100);
          }
          
          // 如果是 forum 或 guide，確保頁面正確顯示
          if (pageId === 'forum' || pageId === 'guide') {
            // 滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
          
          // 如果是實戰指南文章頁面，更新按鈕文字
          if (pageId && pageId.startsWith('guide-article')) {
            setTimeout(() => {
              updateGuideButtonTexts();
            }, 100);
          }
        } else {
          console.error('❌ Page not found:', pageId);
          // 如果找不到頁面，檢查是否是 forum 或 guide
          if (pageId === 'forum' || pageId === 'guide') {
            // forum 和 guide 頁面存在，但可能被隱藏了，強制顯示
            const forumPage = document.getElementById('forum');
            const guidePage = document.getElementById('guide');
            
            // 先隱藏所有頁面
            document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
            });
            
            if (pageId === 'forum' && forumPage) {
              forumPage.classList.add('active');
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (pageId === 'guide' && guidePage) {
              guidePage.classList.add('active');
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              console.error('❌ 找不到頁面元素:', pageId, 'forum:', !!forumPage, 'guide:', !!guidePage);
              // 如果還是找不到，顯示首頁
              if (homepage) {
                homepage.classList.add('active');
                console.warn('⚠️ 無法找到頁面，顯示首頁');
              }
            }
          } else {
            console.error('❌ 未知的頁面ID:', pageId);
            // 如果找不到頁面，顯示首頁
            if (homepage) {
              homepage.classList.add('active');
              console.warn('⚠️ 無法找到頁面，顯示首頁');
            }
          }
        }
        
        // 更新導航標籤狀態
        document.querySelectorAll('.navbar-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 根據頁面ID設置對應標籤為active
        // 注意：導航欄順序為：首頁(0) | IP人設規劃(外部連結) | 一鍵生成(外部連結) | 論壇介紹(3) | 實戰指南(4) | 創作者資料庫(5, 動態顯示)
        const tabMap = {
          'homepage': 0,
          'mode1': null,  // 外部連結，不在導航欄中
          'mode2': null,  // 已移除
          'mode3': null,  // 外部連結，不在導航欄中
          'forum': 3,     // 論壇介紹是第4個標籤（索引3）
          'guide': 4,     // 實戰指南是第5個標籤（索引4）
          'userDB': null, // 動態顯示，需要特殊處理
          'guide-article1': 4,  // 文章頁面顯示實戰指南為 active
          'guide-article2': 4,
          'guide-article3': 4
        };
        
        // 更新導航標籤狀態
        if (tabMap[pageId] !== undefined && tabMap[pageId] !== null) {
          const tabs = document.querySelectorAll('.navbar-tab');
          if (tabs[tabMap[pageId]]) {
            tabs[tabMap[pageId]].classList.add('active');
          } else {
            console.warn(`[導航] 找不到索引 ${tabMap[pageId]} 的導航標籤，總共有 ${tabs.length} 個標籤`);
          }
        } else if (pageId === 'userDB') {
          // 創作者資料庫標籤需要特殊處理（動態顯示）
          const userDBTab = document.getElementById('userDBTab');
          if (userDBTab) {
            userDBTab.classList.add('active');
          }
        }
      }
      
      
      // AI說明區塊控制函數（舊版，保留以防需要）
      function toggleInstructions() {
        const instructionList = document.querySelector('.instruction-list');
        const toggleIcon = document.querySelector('.instructions-toggle');
        const chatMessages = document.getElementById('chatMessages');
        
        if (instructionList && toggleIcon) {
          instructionList.classList.toggle('show');
          
          if (instructionList.classList.contains('show')) {
            toggleIcon.textContent = '▼';
            // 顯示時恢復原始高度
            if (chatMessages) chatMessages.style.minHeight = '600px';
          } else {
            toggleIcon.textContent = '▶';
            // 隱藏時延長聊天訊息區高度
            if (chatMessages) chatMessages.style.minHeight = '800px';
          }
        }
      }
      
      // 抽屜式說明欄位控制函數
      function toggleInstructionsDrawer() {
        const drawer = document.getElementById('instructionsDrawer');
        const overlay = document.getElementById('drawerOverlay');
        
        if (drawer && overlay) {
          const isOpen = drawer.classList.contains('open');
          
          if (isOpen) {
            // 關閉抽屜
            drawer.classList.remove('open');
            overlay.classList.remove('show');
          } else {
            // 打開抽屜
            drawer.classList.add('open');
            overlay.classList.add('show');
          }
        }
      }
      
      // 側邊欄頁面顯示函數
      function showSidebarPage(pageType) {
        const overlay = document.getElementById('sidebarPageOverlay');
        const title = document.getElementById('sidebarPageTitle');
        const content = document.getElementById('sidebarPageContent');
        
        // 設置頁面標題
        const pageTitles = {
          'profile': '個人資料',
          'scripts': '我的腳本',
          'positioning': '帳號定位記錄',
          'topics': '選題記錄',
          'settings': '系統設定',
          'statistics': '使用統計',
          'help': '幫助中心'
        };
        
        title.textContent = pageTitles[pageType] || '功能頁面';
        
        // 根據頁面類型載入相應內容
        switch(pageType) {
          case 'profile':
            loadProfilePage(content);
            break;
          case 'scripts':
            loadScriptsPage(content);
            break;
          case 'positioning':
            loadPositioningPage(content);
            break;
          case 'topics':
            loadTopicsPage(content);
            break;
          case 'settings':
            loadSettingsPage(content);
            break;
          case 'statistics':
            loadStatisticsPage(content);
            break;
          case 'help':
            loadHelpPage(content);
            break;
          default:
            content.innerHTML = '<p>功能開發中...</p>';
        }
        
        // 顯示頁面
        overlay.style.display = 'flex';
        
        // 關閉側邊欄
        toggleSidebar();
      }
      
      // 關閉側邊欄頁面
      function closeSidebarPage() {
        document.getElementById('sidebarPageOverlay').style.display = 'none';
      }
      
      // 載入個人資料頁面
      function loadProfilePage(container) {
        // 格式化注册时间
        let registrationTime = '未知';
        if (ipPlanningUser?.created_at) {
          try {
            const date = new Date(ipPlanningUser.created_at);
            if (!isNaN(date.getTime())) {
              registrationTime = date.toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          } catch (e) {
            registrationTime = ipPlanningUser.created_at;
          }
        }
        
        // 使用安全的 HTML 設置方式
        const profileName = escapeHtml(ipPlanningUser?.name || '未設定');
        const profileEmail = escapeHtml(ipPlanningUser?.email || '未設定');
        const profileDate = escapeHtml(registrationTime);
        const scriptCount = getLocalScripts().length;
        
        const safeProfileName = escapeHtml(profileName || '');
        const safeProfileEmail = escapeHtml(profileEmail || '');
        const safeProfileDate = escapeHtml(profileDate || '');
        container.innerHTML = `
          <div class="profile-content">
            <div class="profile-section">
              <h3>用戶資訊</h3>
              <div class="user-details">
                <div class="detail-item">
                  <label>姓名：</label>
                  <span id="profileName">${safeProfileName}</span>
                </div>
                <div class="detail-item">
                  <label>Email：</label>
                  <span id="profileEmail">${safeProfileEmail}</span>
                </div>
                <div class="detail-item">
                  <label>註冊時間：</label>
                  <span id="profileDate">${safeProfileDate}</span>
                </div>
              </div>
            </div>
            <div class="profile-section">
              <h3>使用統計</h3>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number">${scriptCount}</div>
                  <div class="stat-label">已生成腳本</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${getLocalPositioning().length}</div>
                  <div class="stat-label">帳號定位</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${getLocalTopics().length}</div>
                  <div class="stat-label">選題記錄</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 載入我的腳本頁面
      function loadScriptsPage(container) {
        const scripts = getLocalScripts();
        if (scripts.length === 0) {
          container.innerHTML = '<p>尚未生成任何腳本</p>';
          return;
        }
        
        let html = '<div class="scripts-list">';
        scripts.forEach(script => {
          const date = formatTaiwanTime(script.created_at).split(' ')[0]; // 只取日期部分
          const safeName = escapeHtml(script.name || '未命名腳本');
          const safeContent = script.content ? escapeHtml(script.content.substring(0, 100) + '...') : '無內容';
          html += `
            <div class="script-item">
              <div class="script-header">
                <h4>${safeName}</h4>
                <span class="script-date">${date}</span>
              </div>
              <div class="script-preview">${safeContent}</div>
              <div class="script-actions">
                <button onclick="viewScript(${script.id})" class="btn-primary">查看</button>
                <button onclick="deleteScript(${script.id})" class="btn-danger">刪除</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      }
      
      // 載入帳號定位頁面
      function loadPositioningPage(container) {
        container.innerHTML = '<p>帳號定位記錄功能開發中...</p>';
      }
      
      // 載入選題記錄頁面
      function loadTopicsPage(container) {
        container.innerHTML = '<p>選題記錄功能開發中...</p>';
      }
      
      // 載入設定頁面
      function loadSettingsPage(container) {
        container.innerHTML = '<p>系統設定功能開發中...</p>';
      }
      
      // 載入統計頁面
      function loadStatisticsPage(container) {
        container.innerHTML = '<p>使用統計功能開發中...</p>';
      }
      
      // 載入幫助頁面
      function loadHelpPage(container) {
        container.innerHTML = `
          <div class="help-content">
            <h3>使用指南</h3>
            <div class="help-section">
              <h4>一鍵生成模式</h4>
              <p>1. 在左側設定您的需求（平台、主題、秒數、帳號定位）</p>
              <p>2. 點擊「套用設定」</p>
              <p>3. 在右側依序點擊生成按鈕</p>
              <p>4. 儲存或重新生成</p>
            </div>
            <div class="help-section">
              <h4>AI顧問對話模式</h4>
              <p>1. 直接與AI進行對話</p>
              <p>2. 討論內容策略和創意</p>
              <p>3. AI協助生成腳本</p>
            </div>
            <div class="help-section">
              <h4>常見問題</h4>
              <p><strong>Q: 如何儲存腳本？</strong></p>
              <p>A: 生成完成後點擊「儲存」按鈕即可</p>
              <p><strong>Q: 如何查看已儲存的腳本？</strong></p>
              <p>A: 點擊右側功能按鈕，選擇「我的腳本」</p>
            </div>
          </div>
        `;
      }
      
      // 定期檢查 token 狀態（每分鐘檢查一次）
      function startTokenMonitor() {
        setInterval(() => {
          const token = sessionStorage.getItem('ipPlanningToken');
          if (token) {
            // 檢查是否過期
            if (isTokenExpired(token)) {
              // Token 已過期，嘗試刷新（會自動登出如果刷新失敗）
              tryRefreshTokenSafe().catch(err => {
                console.error('自動刷新 Token 失敗:', err);
              });
            }
          }
        }, 60000); // 每分鐘檢查一次
      }

      // 統一的安全 fetch 函數（用於需要認證的 API 呼叫）
      async function safeFetch(url, options = {}) {
        const token = sessionStorage.getItem('ipPlanningToken');
        
        // 檢查 token 是否存在
        if (!token) {
          // 如果沒有 token，但用戶認為已登入，可能需要登出
          if (ipPlanningUser) {
            forceLogout('請先登入');
          }
          throw new Error('需要登入');
        }
        
        // 檢查 token 是否過期
        if (isTokenExpired(token)) {
          // Token 已過期，嘗試刷新
          const refreshed = await tryRefreshTokenSafe();
          if (!refreshed) {
            // 刷新失敗，已自動登出
            throw new Error('Token 已過期且無法刷新');
          }
        }
        
        // 準備 headers
        const headers = {
          ...options.headers,
          'Authorization': `Bearer ${sessionStorage.getItem('ipPlanningToken')}`
        };
        
        try {
          const response = await fetch(url, { ...options, headers });
          
          // 如果收到 401 或 403，嘗試刷新或登出
          if (response.status === 401) {
            const refreshed = await tryRefreshTokenSafe();
            if (refreshed) {
              // 刷新成功，使用新 token 重試
              headers['Authorization'] = `Bearer ${sessionStorage.getItem('ipPlanningToken')}`;
              return await fetch(url, { ...options, headers });
            }
            // 刷新失敗，已自動登出
            throw new Error('認證失敗');
          }
          
          if (response.status === 403) {
            let errorMessage = '認證失敗，請重新登入';
            try {
              const errorData = await response.clone().json();
              if (errorData.detail) {
                errorMessage = errorData.detail;
              }
            } catch (e) {
              // 如果無法解析 JSON，使用預設訊息
            }
            forceLogout(errorMessage);
            throw new Error(errorMessage);
          }
          
          return response;
        } catch (error) {
          // 如果是網路錯誤，不要登出（可能是暫時的網路問題）
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw error;
          }
          
          // 其他錯誤（包括我們自己拋出的）繼續傳播
          throw error;
        }
      }

      // 處理授權連結驗證
      async function handleActivationToken(token) {
        if (!token) return;
        
        const currentToken = sessionStorage.getItem('ipPlanningToken');
        
        if (!currentToken) {
          // 未登入，導向登入頁（帶上 activation_token）
          // 確保在 index.html 頁面處理，而不是 subscription.html
          if (window.location.pathname.includes('subscription.html')) {
            // 如果在 subscription.html，先跳轉到 index.html
            window.location.href = `/#login?activation_token=${token}`;
          } else {
            const hash = window.location.hash;
            const separator = hash.includes('?') ? '&' : '?';
            window.location.href = `/#login${separator}activation_token=${token}`;
          }
          return;
        }
        
        // 已登入，直接驗證授權
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/license/verify?token=${token}`, {
            headers: {
              'Authorization': `Bearer ${currentToken}`
            },
            redirect: 'manual'  // 不自動跟隨 redirect
          });
          
          // 記錄響應狀態以便調試
          
          // 檢查響應類型
          const contentType = response.headers.get('content-type') || '';
          const isJson = contentType.includes('application/json');
          const isRedirect = response.status === 302 || response.status === 301;
          
          if (response.ok || isRedirect) {
            // 驗證成功
            // 如果是 JSON 響應，嘗試解析
            let responseData = null;
            if (isJson && response.ok) {
              try {
                responseData = await response.json();
            } catch (e) {
                console.warn('無法解析 JSON 響應:', e);
              }
            }
            
            // 獲取方案類型（從後端響應或預設為 yearly）
            let planType = 'yearly';
            if (responseData && responseData.plan_type) {
              planType = responseData.plan_type;
            } else {
              // 如果響應中沒有方案資訊，嘗試從 URL 參數獲取（後端 redirect 會帶上 plan 參數）
              const urlParams = new URLSearchParams(window.location.search);
              const hashParams = new URLSearchParams(window.location.hash.slice(1));
              const planFromUrl = urlParams.get('plan') || hashParams.get('plan');
              if (planFromUrl) {
                planType = planFromUrl;
              }
            }
            
            // 等待一小段時間確保後端完成資料庫更新
            await new Promise(resolve => setTimeout(resolve, 1000)); // 增加到 1 秒
            
            // 重試檢查訂閱狀態（最多重試 5 次，增加重試次數）
            let retryCount = 0;
            let subscriptionActive = false;
            
            while (retryCount < 5 && !subscriptionActive) {
            await checkSubscriptionStatus();
              // 檢查訂閱狀態
              const isSubscribed = document.body.dataset.subscribed === 'true' || 
                                  localStorage.getItem('subscriptionStatus') === 'active';
              
              if (isSubscribed) {
                subscriptionActive = true;
                break;
              }
              
              // 如果還沒生效，等待後重試
              if (retryCount < 4) {
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
              retryCount++;
            }
            
            // 強制刷新用戶資訊（確保獲取最新的訂閱狀態）
            const currentToken = sessionStorage.getItem('ipPlanningToken');
            if (currentToken) {
              try {
                const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                  method: 'GET',
                  credentials: 'include', // 重要：包含 Cookie
                  headers: {
                    'Authorization': `Bearer ${currentToken}`
                  }
                });
                if (userResponse.ok) {
                  const userInfo = await userResponse.json();
                  // 更新本地用戶資訊
                  if (userInfo.is_subscribed) {
                    document.body.dataset.subscribed = 'true';
                    localStorage.setItem('subscriptionStatus', 'active');
                    // 更新全局用戶資訊
                    if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                      ipPlanningUser.is_subscribed = userInfo.is_subscribed;
                      sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                    }
                  }
                }
              } catch (e) {
                console.warn('刷新用戶資訊失敗:', e);
              }
            }
            
            // 確保顯示主應用程式（而不是訂閱頁面）
            if (window.location.pathname.includes('subscription.html')) {
              // 如果在 subscription.html，跳轉到 index.html
              window.location.href = '/';
            } else {
              // 顯示主應用程式
              showMainApp();
              // 更新首頁視圖（確保顯示已訂閱視圖）
              updateHomepageView();
            }
            
            // 再次確認訂閱狀態（確保顯示正確）
            // 先強制刷新一次用戶資訊
            let finalUserInfo = null;
            try {
              const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                headers: {
                  'Authorization': `Bearer ${currentToken}`
                }
              });
              if (userResponse.ok) {
                finalUserInfo = await userResponse.json();
                if (finalUserInfo.is_subscribed) {
                  document.body.dataset.subscribed = 'true';
                  localStorage.setItem('subscriptionStatus', 'active');
                  if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                    ipPlanningUser.is_subscribed = finalUserInfo.is_subscribed;
                    sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                  }
                }
              }
            } catch (e) {
              console.warn('最終檢查用戶資訊失敗:', e);
            }
            
            const finalCheck = document.body.dataset.subscribed === 'true' || 
                              localStorage.getItem('subscriptionStatus') === 'active' ||
                              (finalUserInfo && finalUserInfo.is_subscribed);
            
            if (finalCheck) {
            const planName = planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'lifetime' ? '永久使用' : '年費'));
              const planDays = planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'lifetime' ? '永久' : '1年'));
              showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
            } else {
              // 如果最終檢查還是沒有訂閱，可能是後端更新延遲，顯示提示而不是錯誤
              console.warn('授權驗證成功，但訂閱狀態尚未更新，繼續等待...');
              showToast('✅ 授權啟用成功！正在更新訂閱狀態...', 5000);
              // 再次嘗試刷新訂閱狀態（增加重試次數和延遲）
              setTimeout(async () => {
                // 再次強制刷新用戶資訊
                try {
                  const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                    headers: {
                      'Authorization': `Bearer ${currentToken}`
                    }
                  });
                  if (userResponse.ok) {
                    const latestUserInfo = await userResponse.json();
                    if (latestUserInfo.is_subscribed) {
                      document.body.dataset.subscribed = 'true';
                      localStorage.setItem('subscriptionStatus', 'active');
                      if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                        ipPlanningUser.is_subscribed = latestUserInfo.is_subscribed;
                        sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                      }
                      const planName = planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'lifetime' ? '永久使用' : '年費'));
                      const planDays = planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'lifetime' ? '永久' : '1年'));
                      showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                      return;
                    }
                  }
                } catch (e) {
                  console.warn('再次刷新用戶資訊失敗:', e);
                }
                
                await checkSubscriptionStatus();
                const recheck = document.body.dataset.subscribed === 'true' || 
                               localStorage.getItem('subscriptionStatus') === 'active';
                if (recheck) {
                  const planName = planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'lifetime' ? '永久使用' : '年費'));
                  const planDays = planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'lifetime' ? '永久' : '1年'));
                  showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                } else {
                  // 如果還是沒有，但後端已經授權成功（response.ok），顯示成功訊息而不是錯誤
                  console.warn('授權驗證成功，但訂閱狀態更新較慢，請稍後重新整理頁面');
                  showToast('✅ 授權啟用成功！如果未看到訂閱狀態，請重新整理頁面', 8000);
                }
              }, 3000); // 增加到 3 秒
            }
            
            // 清除 URL 參數
            window.history.replaceState({}, document.title, window.location.pathname);
          } else {
            // 嘗試獲取詳細錯誤訊息
            let errorMessage = '啟用失敗，請稍後再試';
            let errorDetails = '';
            let isAlreadyActivated = false;
            try {
              const errorData = await response.json();
              
              // 檢查是否為「已經啟用」的成功訊息（同一個帳戶）
              if (errorData.status === 'already_activated' && errorData.message) {
                // 更新本地狀態
                document.body.dataset.subscribed = 'true';
                localStorage.setItem('subscriptionStatus', 'active');
                if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                  ipPlanningUser.is_subscribed = true;
                  sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                }
                // 顯示友好訊息
                // 使用台灣時區格式化時間
                const activatedDate = errorData.activated_at ? 
                  new Date(errorData.activated_at).toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                  }) : '';
                const message = activatedDate ? 
                  `✅ ${errorData.message}（啟用時間：${activatedDate}）` : 
                  `✅ ${errorData.message}`;
                showToast(message, 5000);
                return; // 提前返回，不顯示錯誤訊息
              }
              
              errorMessage = errorData.error || errorData.message || errorMessage;
              
              // 如果有詳細資訊，顯示給用戶
              if (errorData.activated_at) {
                isAlreadyActivated = true;
                // 使用台灣時區格式化時間
                const activatedDate = new Date(errorData.activated_at).toLocaleString('zh-TW', {
                  timeZone: 'Asia/Taipei',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: false
                });
                errorDetails = `此連結已於 ${activatedDate} 使用`;
                
                // 如果連結已使用，檢查用戶當前的訂閱狀態
                // 如果用戶已經有訂閱，這可能是成功的（用戶之前已經啟用過）
                const currentToken = sessionStorage.getItem('ipPlanningToken');
                if (currentToken) {
                  try {
                    const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                      headers: {
                        'Authorization': `Bearer ${currentToken}`
                      }
                    });
                    if (userResponse.ok) {
                      const userInfo = await userResponse.json();
                      if (userInfo.is_subscribed) {
                        // 用戶已經有訂閱，這表示之前已經成功啟用過
                        // 更新本地狀態
                        document.body.dataset.subscribed = 'true';
                        localStorage.setItem('subscriptionStatus', 'active');
                        if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                          ipPlanningUser.is_subscribed = userInfo.is_subscribed;
                          sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                        }
                        // 顯示成功訊息而不是錯誤
                        // 使用台灣時區格式化時間
                        const activatedDateTW = new Date(errorData.activated_at).toLocaleString('zh-TW', {
                          timeZone: 'Asia/Taipei',
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit',
                          hour: '2-digit',
                          minute: '2-digit',
                          second: '2-digit',
                          hour12: false
                        });
                        showToast(`✅ 您已擁有授權！此連結已於 ${activatedDateTW} 啟用`, 5000);
                        return; // 提前返回，不顯示錯誤訊息
                      }
                    }
                  } catch (e) {
                    console.warn('檢查訂閱狀態失敗:', e);
                    // 如果檢查失敗，繼續顯示錯誤訊息
                  }
                }
              } else if (errorData.expired_at) {
                // 使用台灣時區格式化時間
                const expiredDate = new Date(errorData.expired_at).toLocaleString('zh-TW', {
                  timeZone: 'Asia/Taipei',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: false
                });
                errorDetails = `此連結已於 ${expiredDate} 過期`;
              }
              if (errorData.contact) {
                errorDetails += (errorDetails ? '\n' : '') + errorData.contact;
              }
              if (errorData.suggestion) {
                errorDetails += (errorDetails ? '\n' : '') + errorData.suggestion;
              }
            } catch (e) {
              // 如果無法解析 JSON，使用預設錯誤訊息
            }
            
            // 在顯示錯誤訊息之前，先檢查用戶的實際訂閱狀態（可能後端已經成功授權）
            // 不僅檢查 is_subscribed，還要檢查 licenses 表中的有效授權（包括 trial）
            let hasSubscription = false;
            let planType = null;
            const currentToken = sessionStorage.getItem('ipPlanningToken');
            if (currentToken) {
              // 先檢查訂閱狀態 API（會返回 tier 資訊，包括 trial）
              try {
                const subResponse = await fetch(`https://api.aijob.com.tw/api/user/subscription`, {
                  headers: {
                    'Authorization': `Bearer ${currentToken}`
                  }
                });
                if (subResponse.ok) {
                  const subData = await subResponse.json();
                  // 如果有有效的 tier（包括 trial），表示授權成功
                  if (subData.tier && subData.tier !== 'none' && subData.status === 'active') {
                    hasSubscription = true;
                    planType = subData.tier;
                    // 更新本地狀態
                    document.body.dataset.subscribed = 'true';
                    localStorage.setItem('subscriptionStatus', 'active');
                    if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                      ipPlanningUser.is_subscribed = true; // 即使 trial 也視為已授權
                      sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                    }
                    const planName = planType === 'lifetime' ? '永久使用' : (planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'trial' ? '7天體驗' : '年費')));
                    const planDays = planType === 'lifetime' ? '永久' : (planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'trial' ? '7天' : '1年')));
                    showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                    return; // 提前返回，不顯示錯誤訊息
                  }
                }
              } catch (e) {
                console.warn('無法獲取訂閱詳情:', e);
              }
              
              // 如果訂閱 API 沒有返回有效授權，再檢查用戶基本資訊
              try {
                const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                  method: 'GET',
                  credentials: 'include', // 重要：包含 Cookie
                  headers: {
                    'Authorization': `Bearer ${currentToken}`
                  }
                });
                if (userResponse.ok) {
                  const userInfo = await userResponse.json();
                  if (userInfo.is_subscribed) {
                    hasSubscription = true;
                    // 更新本地狀態
                    document.body.dataset.subscribed = 'true';
                    localStorage.setItem('subscriptionStatus', 'active');
                    if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                      ipPlanningUser.is_subscribed = userInfo.is_subscribed;
                      sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                    }
                    // 再次嘗試獲取方案類型
                    if (!planType) {
                      try {
                        const subResponse = await fetch(`https://api.aijob.com.tw/api/user/subscription`, {
                          headers: {
                            'Authorization': `Bearer ${currentToken}`
                          }
                        });
                        if (subResponse.ok) {
                          const subData = await subResponse.json();
                          if (subData.tier) {
                            planType = subData.tier;
                          }
                        }
                      } catch (e) {
                        console.warn('無法獲取訂閱詳情:', e);
                      }
                    }
                    const planName = planType === 'lifetime' ? '永久使用' : (planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'trial' ? '7天體驗' : '年費')));
                    const planDays = planType === 'lifetime' ? '永久' : (planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'trial' ? '7天' : '1年')));
                    showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                    return; // 提前返回，不顯示錯誤訊息
                  }
                }
              } catch (e) {
                console.warn('檢查訂閱狀態失敗:', e);
              }
            }
            
            // 只有在確認用戶沒有訂閱時才顯示錯誤訊息
            if (!isAlreadyActivated && !hasSubscription) {
              // 顯示詳細錯誤訊息（支援多行）
              if (errorDetails) {
                showToast(`${errorMessage}\n${errorDetails}`, 8000);
              } else {
                showToast(errorMessage, 5000);
              }
            }
          }
        } catch (error) {
          console.error('啟用失敗:', error);
          
          // 即使發生錯誤，也檢查一下用戶的訂閱狀態（可能後端已經授權成功）
          // 不僅檢查 is_subscribed，還要檢查 licenses 表中的有效授權（包括 trial）
          const currentToken = sessionStorage.getItem('ipPlanningToken');
          if (currentToken) {
            // 先檢查訂閱狀態 API（會返回 tier 資訊，包括 trial）
            let planType = null;
            try {
              const subResponse = await fetch(`https://api.aijob.com.tw/api/user/subscription`, {
                headers: {
                  'Authorization': `Bearer ${currentToken}`
                }
              });
              if (subResponse.ok) {
                const subData = await subResponse.json();
                // 如果有有效的 tier（包括 trial），表示授權成功
                if (subData.tier && subData.tier !== 'none' && subData.status === 'active') {
                  planType = subData.tier;
                  // 更新本地狀態
                  document.body.dataset.subscribed = 'true';
                  localStorage.setItem('subscriptionStatus', 'active');
                  if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                    ipPlanningUser.is_subscribed = true; // 即使 trial 也視為已授權
                    sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                  }
                  const planName = planType === 'lifetime' ? '永久使用' : (planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'trial' ? '7天體驗' : '年費')));
                  const planDays = planType === 'lifetime' ? '永久' : (planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'trial' ? '7天' : '1年')));
                  showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                  return; // 提前返回，不顯示錯誤
                }
              }
            } catch (e) {
              console.warn('無法獲取訂閱詳情:', e);
            }
            
            // 如果訂閱 API 沒有返回有效授權，再檢查用戶基本資訊
            try {
              const userResponse = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
                headers: {
                  'Authorization': `Bearer ${currentToken}`
                }
              });
              if (userResponse.ok) {
                const userInfo = await userResponse.json();
                if (userInfo.is_subscribed) {
                  // 用戶已經有訂閱，表示授權成功
                  document.body.dataset.subscribed = 'true';
                  localStorage.setItem('subscriptionStatus', 'active');
                  if (typeof ipPlanningUser !== 'undefined' && ipPlanningUser) {
                    ipPlanningUser.is_subscribed = userInfo.is_subscribed;
                    sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                  }
                  // 再次嘗試獲取方案類型
                  if (!planType) {
                    try {
                      const subResponse = await fetch(`https://api.aijob.com.tw/api/user/subscription`, {
                        headers: {
                          'Authorization': `Bearer ${currentToken}`
                        }
                      });
                      if (subResponse.ok) {
                        const subData = await subResponse.json();
                        if (subData.tier) {
                          planType = subData.tier;
                        }
                      }
                    } catch (e) {
                      console.warn('無法獲取訂閱詳情:', e);
                    }
                  }
                  const planName = planType === 'lifetime' ? '永久使用' : (planType === 'two_year' ? 'Creator Pro 雙年' : (planType === 'yearly' ? 'Script Lite 入門' : (planType === 'trial' ? '7天體驗' : '年費')));
                  const planDays = planType === 'lifetime' ? '永久' : (planType === 'two_year' ? '2年' : (planType === 'yearly' ? '1年' : (planType === 'trial' ? '7天' : '1年')));
                  showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
                  return; // 提前返回，不顯示錯誤
                }
              }
            } catch (e) {
              console.warn('檢查訂閱狀態失敗:', e);
            }
          }
          
          // 只有在確認用戶沒有訂閱時才顯示錯誤訊息
          // 再次檢查本地狀態（可能在其他地方已經更新）
          const finalCheck = document.body.dataset.subscribed === 'true' || 
                            localStorage.getItem('subscriptionStatus') === 'active';
          if (!finalCheck) {
            showToast('⚠️ 啟用失敗，請稍後再試', 5000);
          } else {
            // 如果本地狀態顯示已訂閱，顯示成功訊息
            showToast('✅ 授權啟用成功！', 5000);
          }
        }
      }
      
      // 初始化頁面
      document.addEventListener('DOMContentLoaded', function() {
        // 標記頁面已載入，顯示內容
        document.body.classList.add('page-loaded');
        
        // ⚠️ 優先處理授權連結（必須在其他初始化之前）
        // 檢查 URL 參數中是否有 activation_token（授權連結）
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.slice(1));
        let activationToken = urlParams.get('token') || hashParams.get('token');
        const activationSuccess = urlParams.get('activation') || hashParams.get('activation');
        
        // 處理授權成功頁面（從後端 redirect 回來）
        if (activationSuccess === 'success') {
          const plan = urlParams.get('plan') || hashParams.get('plan') || 'yearly';
          const planName = plan === 'two_year' ? 'Creator Pro 雙年' : (plan === 'yearly' ? 'Script Lite 入門' : (plan === 'lifetime' ? '永久使用' : '年費'));
          const planDays = plan === 'two_year' ? '2年' : (plan === 'yearly' ? '1年' : (plan === 'lifetime' ? '永久' : '1年'));
          showToast(`✅ 您已開通${planDays}授權！方案：${planName}`, 8000);
          // 重新檢查訂閱狀態
          checkSubscriptionStatus().then(() => {
            // 清除 URL 參數
            window.history.replaceState({}, document.title, window.location.pathname);
          });
        }
        
        // 處理授權連結（/activate?token=xxx 或根路徑 ?token=xxx）
        // 優先檢查 sessionStorage 中的待處理授權（來自立即執行的腳本）
        const pendingToken = sessionStorage.getItem('pendingActivationToken');
        if (pendingToken) {
          sessionStorage.removeItem('pendingActivationToken');
          activationToken = pendingToken;
        }
        
        if (activationToken) {
          // 檢查是否為授權連結（路徑是 /activate 或根路徑有 token 參數）
          const isActivatePath = window.location.pathname === '/activate' || 
                                 window.location.pathname === '/activate.html' ||
                                 window.location.pathname === '/' ||
                                 window.location.pathname === '';
          
          // 如果是授權連結，立即處理（優先於其他初始化邏輯）
          if (isActivatePath) {
            // 檢查是否已登入
            const currentToken = sessionStorage.getItem('ipPlanningToken');
            if (!currentToken) {
              // 未登入，立即跳轉到登入頁（不執行其他初始化）
              // 使用 replace 而不是 href，避免歷史記錄問題
              window.location.replace(`/#login?activation_token=${activationToken}`);
              return; // 停止執行後續初始化
            } else {
              // 已登入，處理授權
              if (typeof handleActivationToken === 'function') {
              handleActivationToken(activationToken);
              } else {
                console.error('❌ handleActivationToken 函數未定義，等待 common.js 載入...');
                // 等待 common.js 載入
                let retryCount = 0;
                const checkFunction = setInterval(function() {
                  if (typeof handleActivationToken === 'function') {
                    clearInterval(checkFunction);
                    handleActivationToken(activationToken);
                  } else if (retryCount++ > 10) {
                    clearInterval(checkFunction);
                    console.error('❌ handleActivationToken 函數載入超時');
                    showToast('⚠️ 授權處理失敗，請重新整理頁面', 5000);
                  }
                }, 200);
              }
            }
          }
        }
        
        // 啟動打字機動畫（延遲執行，確保首頁已顯示）
        // 等待 common.js 載入完成後再執行
        setTimeout(() => {
          // 確保元素存在且函數可用
          const heroTitle1 = document.getElementById('hero-title-1');
          if (heroTitle1 && typeof initTypewriterAnimation === 'function') {
            initTypewriterAnimation();
          } else {
            // 如果元素還不存在，再延遲執行
            setTimeout(() => {
              if (typeof initTypewriterAnimation === 'function') {
                initTypewriterAnimation();
              }
            }, 500);
          }
        }, 500);
        
        // 監聽登入事件（從 common.js 或 auth.js 觸發）
        window.addEventListener('auth:logged-in', async function() {
          
          // 重新載入用戶資訊
          const storedToken = sessionStorage.getItem('ipPlanningToken');
          const storedUserStr = sessionStorage.getItem('ipPlanningUser');
          
          
          if (storedToken) {
            ipPlanningToken = storedToken;
          }
          if (storedUserStr) {
            try {
              ipPlanningUser = JSON.parse(storedUserStr);
            } catch (e) {
              console.warn('❌ 無法解析用戶資料:', e);
            }
          }
          
          // 更新用戶資訊顯示
          await updateUserInfo();
          
        });
        
        // 啟動 token 監控（每分鐘檢查一次）
        startTokenMonitor();
        
        // 處理 hash 導航（例如從其他頁面跳轉過來的 #forum 或 #guide）
        // 必須在更新首頁視圖之前處理，避免先顯示首頁
        const handleHashNavigation = () => {
          const hash = window.location.hash;
          if (hash) {
            const pageId = hash.replace('#', '');
            // 只處理已知的頁面 ID
            const validPages = ['homepage', 'forum', 'guide', 'userDB', 'guide-article1', 'guide-article2', 'guide-article3'];
            if (validPages.includes(pageId)) {
              // 立即執行，避免先顯示首頁
              // 先隱藏所有頁面
              document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
              });
              // 立即切換到目標頁面（確保 switchPage 函數已定義）
              if (typeof switchPage === 'function') {
              switchPage(pageId);
              return true; // 表示已處理 hash 導航
              } else {
                // 如果 switchPage 還未定義，等待它定義後再執行
                let retryCount = 0;
                const maxRetries = 50; // 最多重試 50 次（約 5 秒）
                const checkInterval = setInterval(() => {
                  if (typeof switchPage === 'function') {
                    clearInterval(checkInterval);
                    switchPage(pageId);
                  } else if (retryCount++ >= maxRetries) {
                    clearInterval(checkInterval);
                    console.warn('⚠️ switchPage 函數載入超時');
                  }
                }, 100);
                return true; // 表示已處理 hash 導航（正在等待）
              }
            }
          }
          return false; // 表示沒有 hash 導航
        };
        
        // 頁面載入時先處理 hash（優先處理）
        // 立即檢查 hash，避免先顯示首頁
        let hasHashNavigation = false;
        
        // 立即檢查 hash（不等待 DOM 載入）
        const currentHash = window.location.hash;
        if (currentHash) {
          const pageId = currentHash.replace('#', '');
          const validPages = ['homepage', 'forum', 'guide', 'userDB', 'guide-article1', 'guide-article2', 'guide-article3'];
          if (validPages.includes(pageId)) {
            // 立即隱藏所有頁面（如果 DOM 已準備好）
            if (document.readyState !== 'loading') {
              document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
              });
            }
            hasHashNavigation = true; // 標記有 hash 導航，稍後處理
          }
        }
        
        // 如果 DOM 已準備好，立即處理 hash
        if (document.readyState !== 'loading') {
          hasHashNavigation = handleHashNavigation() || hasHashNavigation;
        }
        
        // 在 DOMContentLoaded 時再次處理 hash（確保處理從其他頁面跳轉過來的情況）
        // 使用 setTimeout 確保所有腳本都已載入
        setTimeout(() => {
        if (!hasHashNavigation) {
            hasHashNavigation = handleHashNavigation();
          }
          // 如果仍然沒有處理，再次嘗試（處理從外部頁面跳轉的情況）
          if (!hasHashNavigation && window.location.hash) {
            const pageId = window.location.hash.replace('#', '');
            const validPages = ['homepage', 'forum', 'guide', 'userDB', 'guide-article1', 'guide-article2', 'guide-article3'];
            if (validPages.includes(pageId) && typeof switchPage === 'function') {
              document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
              });
              switchPage(pageId);
              hasHashNavigation = true;
            }
          }
        }, 100);
        
        // 監聽 hashchange 事件（處理從其他頁面跳轉過來的情況）
        window.addEventListener('hashchange', function() {
          const hash = window.location.hash;
          if (hash) {
            const pageId = hash.replace('#', '');
            const validPages = ['homepage', 'forum', 'guide', 'userDB', 'guide-article1', 'guide-article2', 'guide-article3'];
            if (validPages.includes(pageId) && typeof switchPage === 'function') {
              document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
              });
              switchPage(pageId);
            }
          }
        });
        
        // 如果沒有 hash 導航，才顯示首頁並更新首頁視圖
        if (!hasHashNavigation) {
          const homepage = document.getElementById('homepage');
          if (homepage) {
            homepage.classList.add('active');
          }
          setTimeout(() => {
            updateHomepageView();
            // 檢查 LLM Key 綁定狀態並顯示通知
            checkAndShowLlmKeyNotification();
            // 更新實戰指南按鈕文字（僅針對已訂閱且已登入的用戶）
            updateGuideButtonTexts();
          }, 500);
        } else {
          // 即使有 hash 導航，也要更新按鈕文字
          setTimeout(() => {
            updateGuideButtonTexts();
          }, 500);
        }
        
        // 檢查並顯示 LLM Key 綁定通知
        async function checkAndShowLlmKeyNotification() {
          try {
            const token = sessionStorage.getItem('ipPlanningToken');
            if (!token) {
              return; // 未登入，不顯示通知
            }
            
            const API_URL = window.APP_CONFIG?.API_BASE || 'https://api.aijob.com.tw';
            const response = await fetch(`${API_URL}/api/user/llm-keys/check`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              if (!data.has_key) {
                // 用戶未綁定 LLM Key，顯示通知
                showLlmKeyNotification();
              }
            }
          } catch (error) {
            console.error('檢查 LLM Key 狀態失敗:', error);
          }
        }
        
        // 顯示 LLM Key 綁定通知
        function showLlmKeyNotification() {
          // 檢查是否已經顯示過通知（避免重複顯示）
          if (document.getElementById('llm-key-notification')) {
            return;
          }
          
          const notification = document.createElement('div');
          notification.id = 'llm-key-notification';
          notification.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            z-index: 10000;
            max-width: 90%;
            width: 500px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            animation: slideDown 0.3s ease-out;
          `;
          
          notification.innerHTML = `
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 4px; font-size: 16px;">🔑 建議綁定您的 LLM API 金鑰</div>
              <div style="font-size: 14px; opacity: 0.9;">綁定後可獲得更高的使用額度和更穩定的服務</div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button onclick="window.location.href='userDB.html#settings'; return false;" style="
                padding: 8px 16px;
                background: white;
                color: #d97706;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                font-size: 14px;
                white-space: nowrap;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
              ">立即綁定</button>
              <button onclick="this.closest('#llm-key-notification').remove()" style="
                padding: 8px;
                background: transparent;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
                opacity: 0.8;
              ">×</button>
            </div>
          `;
          
          // 添加動畫樣式
          if (!document.getElementById('llm-key-notification-style')) {
            const style = document.createElement('style');
            style.id = 'llm-key-notification-style';
            style.textContent = `
              @keyframes slideDown {
                from {
                  opacity: 0;
                  transform: translateX(-50%) translateY(-20px);
                }
                to {
                  opacity: 1;
                  transform: translateX(-50%) translateY(0);
                }
              }
            `;
            document.head.appendChild(style);
          }
          
          document.body.appendChild(notification);
          
          // 5 秒後自動隱藏（可選）
          setTimeout(() => {
            if (notification && notification.parentNode) {
              notification.style.opacity = '0';
              notification.style.transition = 'opacity 0.3s ease-out';
              setTimeout(() => {
                if (notification && notification.parentNode) {
                  notification.remove();
                }
              }, 300);
            }
          }, 10000); // 10 秒後自動隱藏
        }
        
        // 監聽 hash 變化（當用戶在同一個頁面內點擊 hash 連結時）
        window.addEventListener('hashchange', handleHashNavigation);
        
        // 檢查 URL 參數中是否有 token（OAuth callback fallback）
        const tokenParam = urlParams.get('token');
        if (tokenParam && !activationToken) {  // 避免與授權 token 衝突
          const userId = urlParams.get('user_id');
          const email = urlParams.get('email');
          const name = urlParams.get('name');
          const picture = urlParams.get('picture');
          
          if (tokenParam && userId) {
            ipPlanningToken = tokenParam;
            ipPlanningUser = {
              user_id: userId,
              email: email || '',
              name: name || '',
              picture: picture || ''
            };
            sessionStorage.setItem('ipPlanningToken', ipPlanningToken);
            sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
            
            // 清除 URL 參數
            window.history.replaceState({}, document.title, window.location.pathname);
            
            updateAuthUI(true);
            showMainApp();
            // 立即更新用戶資訊顯示
            updateUserInfo().catch(err => {
              console.error('❌ 更新用戶資訊失敗:', err);
            });
          }
        }
        
        // 檢查 localStorage 中是否有新的 token（手機版跳轉回來後的處理）
        // 如果發現 ipPlanningTokenUpdated 標記，表示剛剛完成登入
        const tokenUpdatedFlag = localStorage.getItem('ipPlanningTokenUpdated');
        const storedToken = sessionStorage.getItem('ipPlanningToken');
        const storedUserStr = sessionStorage.getItem('ipPlanningUser');
        
        if (tokenUpdatedFlag && storedToken) {
          // 檢查這個 token 是否是新的（與當前全域變數不同）
          // 注意：此時全域變數可能還沒從 localStorage 載入（checkLoginStatus 尚未執行）
          // 所以只要有 tokenUpdatedFlag，就表示是新的登入
          const currentToken = ipPlanningToken || sessionStorage.getItem('ipPlanningToken');
          const isNewToken = !currentToken || storedToken !== currentToken;
          
          if (isNewToken) {
            
            // 更新全域變數
            ipPlanningToken = storedToken;
            if (storedUserStr) {
              try {
                ipPlanningUser = JSON.parse(storedUserStr);
              } catch (e) {
                console.warn('DEBUG: Failed to parse stored user data:', e);
              }
            }
            
            // 清除標記（避免重複處理）
            localStorage.removeItem('ipPlanningTokenUpdated');
            
            // 更新 UI
            updateAuthUI(true);
            // 立即更新用戶資訊顯示
            updateUserInfo().then(async () => {
              await checkSubscriptionStatus();
              
              // 檢查是否有待處理的訂閱方案
              const pendingPlan = sessionStorage.getItem('pendingSubscriptionPlan');
              if (pendingPlan) {
                // 清除待處理方案
                sessionStorage.removeItem('pendingSubscriptionPlan');
                // 導向到訂閱頁面
                window.location.href = `subscription.html?plan=${pendingPlan}`;
                return;
              }
              
              showMainApp();
            }).catch(err => {
              console.error('❌ 更新用戶資訊失敗:', err);
            });
          }
        }
        
        // 檢查是否已經登入
        checkLoginStatus().then(() => {
          
          // 注意：updateUserInfo() 中已經調用了 checkSubscriptionStatus() 和 updateHomepageView()
          // 這裡不需要重複調用，避免重複執行
          // 如果已登入，確保載入用戶歷史資訊（updateUserInfo 中已有，但這裡作為備用）
          if (ipPlanningToken && ipPlanningUser && ipPlanningUser.user_id) {
            // 延遲執行，確保訂閱狀態已更新
            setTimeout(() => {
              loadUserHistory();
            }, 1000);
          }
        });
        
        // 確保 Highlight.js 載入後初始化（因為使用了 defer）
        function initializeHighlightJS() {
          if (typeof hljs !== 'undefined') {
            try {
              hljs.highlightAll();
              // 初始化 Markdown 渲染器
              initMarkdownRenderer();
            } catch (e) {
              console.warn('DEBUG: Highlight.js initialization error:', e);
            }
          } else {
            // 如果還沒載入，延遲重試
            setTimeout(initializeHighlightJS, 100);
          }
        }
        initializeHighlightJS();
        
        // 移動原有內容到新容器
        moveExistingContent();
        
        // 初始化手機版一鍵生成標籤切換
        initializeMode1MobileTabs();
        
        // 調試AI顧問模式元素
        setTimeout(debugAIConsultantElements, 2000);
        
        // 控制訂閱鎖定浮層顯示
        updateSubscriptionLock();
      });

      // ===== 訂閱封鎖與導購：未訂閱使用者禁止進入三大模式 =====
      function isSubscribed() {
        try {
          // 優先檢查 document.body.dataset.subscribed（從後端 API 獲取的狀態，最準確）
          const backendSubscribed = document.body.dataset.subscribed === 'true';
          if (backendSubscribed) {
            return true;
          }
          
          // 檢查 localStorage 中的 subscriptionStatus
          const subscriptionStatus = localStorage.getItem('subscriptionStatus');
          if (subscriptionStatus === 'active') {
            return true;
          }
          
          // 最後檢查 localStorage 中的用戶資料
          const userStr = sessionStorage.getItem('ipPlanningUser');
          if (userStr) {
          const user = JSON.parse(userStr);
          // 後端/前端一率以 falsy 視為未訂閱
            const userSubscribed = !!(user && (user.is_subscribed === true || user.is_subscribed === 1 || user.is_subscribed === '1'));
            if (userSubscribed) {
              return true;
            }
          }
          
          return false;
        } catch (_) {
          return false;
        }
      }

      function showSubscriptionPaywall(plan) {
        // 若傳入方案，將參數附在導購頁面
        const planParam = plan ? `?plan=${encodeURIComponent(plan)}` : '';
        // 顯示導購提示（輕量作法：提示 + 導向）
        try { showToast('此功能需訂閱才能使用，將前往購買頁面', 3000); } catch (_) {}
        setTimeout(() => {
          window.location.href = `subscription.html${planParam}`;
        }, 300);
      }

      // 包裝頁面切換，對三大模式進行封鎖
      const originalSwitchPage = typeof switchPage === 'function' ? switchPage : null;
      window.switchPage = async function(page) {
        // 三大模式代稱：mode1(一鍵生成)、mode2(AI顧問)、mode3(IP人設規劃)
        const isModePage = page === 'mode1' || page === 'mode2' || page === 'mode3';
        if (isModePage) {
          // 使用 checkFeatureAccess 檢查登入和訂閱狀態
          if (window.ReelMindCommon && window.ReelMindCommon.checkFeatureAccess) {
            const canAccess = await window.ReelMindCommon.checkFeatureAccess();
            if (!canAccess) {
              // 需要登入或訂閱，已由 checkFeatureAccess 處理
              return;
            }
          } else {
            // 降級處理：使用原有邏輯
            if (!isSubscribed()) {
              // 預設導到訂閱頁（不帶方案；如需可改 'yearly' 或 'two_year'）
              return showSubscriptionPaywall();
            }
          }
        }
        // 其他頁面正常切換
        if (originalSwitchPage) {
          return originalSwitchPage(page);
        }
      };

      // 處理 mode-card 點擊
      async function handleModeCardClick(modeId) {
        
        // 先檢查登入狀態（使用實際 API 驗證）
        let isLoggedIn = false;
        if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
          isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
        } else {
          // 降級處理：檢查 localStorage 中的 user_id
          const userStr = localStorage.getItem('ipPlanningUser');
          if (userStr) {
            try {
              const user = JSON.parse(userStr);
              isLoggedIn = !!(user && user.user_id);
            } catch (e) {
              isLoggedIn = false;
            }
          }
        }
        
        if (!isLoggedIn) {
          // 未登入，先顯示提示訊息，再跳轉登入
          if (typeof showToast === 'function') {
            showToast('⚠️ 請先登入以使用此功能', 3000);
          }
          // 使用 goToLogin(true) 顯示提示訊息後再跳轉
          setTimeout(() => {
            if (typeof goToLogin === 'function') {
              goToLogin(false); // false 表示不重複顯示提示訊息
            }
          }, 1500);
          return;
        }
        
        // 已登入，檢查訂閱狀態
        const isSubscribed = document.body.dataset.subscribed === 'true';
        
        if (!isSubscribed && modeId !== 'userDB') {
          // 未訂閱，顯示提示
          if (typeof showToast === 'function') {
            showToast('⚠️ 請先訂閱以使用此功能', 3000);
          }
          return;
        }
        
        // 可以訪問，跳轉到對應的獨立頁面
        // 注意：映射關係與導航欄標籤一致
        const pageMap = {
          'mode1': 'mode1.html',  // IP人設規劃 → mode1.html
          'mode2': 'mode2.html',  // AI顧問 → mode2.html
          'mode3': 'mode3.html',  // 一鍵生成 → mode3.html
          'userDB': 'userDB.html'
        };
        
        const targetPage = pageMap[modeId];
        if (targetPage) {
          window.location.href = targetPage;
        } else {
          switchPage(modeId);
        }
      }
      
      // 處理創作者資料庫點擊
      async function handleUserDBClick() {
        // 使用 checkFeatureAccess 檢查登入狀態（創作者資料庫允許未訂閱用戶訪問）
        if (window.ReelMindCommon && window.ReelMindCommon.checkFeatureAccess) {
          const canAccess = await window.ReelMindCommon.checkFeatureAccess('userDB');
          if (canAccess) {
            // 可以訪問，跳轉到創作者資料庫
            window.location.href = 'userDB.html';
          }
          // 如果無法訪問（未登入），checkFeatureAccess 已經處理了登入流程
        } else {
          // 降級處理：直接跳轉
          window.location.href = 'userDB.html';
        }
      }
      
      // 處理訂閱按鈕點擊
      // 處理免費體驗按鈕點擊
      async function handleFreeTrialClick(event) {
        event.preventDefault();
        
        // 檢查登入狀態
        let isLoggedIn = false;
        let isSubscribed = false;
        
        if (window.ReelMindCommon) {
          if (typeof window.ReelMindCommon.isLoggedIn === 'function') {
            isLoggedIn = window.ReelMindCommon.isLoggedIn();
          }
          if (typeof window.ReelMindCommon.isSubscribed === 'function') {
            isSubscribed = window.ReelMindCommon.isSubscribed();
          }
        } else {
          // 降級處理：直接檢查 localStorage
          const token = sessionStorage.getItem('ipPlanningToken');
          const userStr = sessionStorage.getItem('ipPlanningUser');
          isLoggedIn = !!(token && userStr);
          if (isLoggedIn && userStr) {
            try {
              const user = JSON.parse(userStr);
              isSubscribed = !!(user && (user.is_subscribed === true || user.is_subscribed === 1 || user.is_subscribed === '1' || user.is_subscribed === 'true'));
            } catch (e) {
              console.warn('無法解析用戶資料:', e);
            }
          }
        }
        
        // 如果未登入，直接跳轉到 Google 登入
        if (!isLoggedIn) {
          // 直接調用 goToLogin，跳轉到 Google OAuth
          if (window.ReelMindCommon && typeof window.ReelMindCommon.goToLogin === 'function') {
            window.ReelMindCommon.goToLogin();
          } else if (typeof window.goToLogin === 'function') {
            window.goToLogin();
          } else {
            // 降級處理：直接跳轉到 Google OAuth URL
            const fbParam = encodeURIComponent(window.location.origin);
            window.location.href = `https://api.aijob.com.tw/api/auth/google?fb=${fbParam}`;
          }
          return;
        }
        
        // 如果已登入但未訂閱，檢查使用次數
        if (!isSubscribed) {
          const usageCount = getFreeTrialUsageCount();
          if (usageCount >= 3) {
            // 超過3次，顯示升級提示
            if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
              window.ReelMindCommon.showToast('您已使用完3次免費體驗，升級訂閱可享有更多生成福利和完整功能', 5000);
            } else {
              alert('您已使用完3次免費體驗，升級訂閱可享有更多生成福利和完整功能');
            }
            // 跳轉到訂閱頁面
            setTimeout(() => {
              window.location.href = 'subscription.html';
            }, 2000);
            return;
          }
        }
        
        // 允許使用，跳轉到體驗頁面
        window.location.href = 'experience.html';
      }
      
      // 獲取免費體驗使用次數
      function getFreeTrialUsageCount() {
        try {
          const countStr = localStorage.getItem('freeTrialUsageCount');
          return countStr ? parseInt(countStr, 10) : 0;
        } catch (e) {
          return 0;
        }
      }
      
      // 增加免費體驗使用次數
      function incrementFreeTrialUsageCount() {
        try {
          const currentCount = getFreeTrialUsageCount();
          localStorage.setItem('freeTrialUsageCount', (currentCount + 1).toString());
        } catch (e) {
          console.error('無法更新使用次數:', e);
        }
      }
      
      // 將函數導出到全局作用域
      window.handleFreeTrialClick = handleFreeTrialClick;
      window.getFreeTrialUsageCount = getFreeTrialUsageCount;
      window.incrementFreeTrialUsageCount = incrementFreeTrialUsageCount;
      
      async function handleSubscriptionClick(plan) {
        
        // 檢查登入狀態
        let loggedIn = false;
        if (window.ReelMindCommon && window.ReelMindCommon.checkLoginStatus) {
          loggedIn = await window.ReelMindCommon.checkLoginStatus();
        } else {
          // 備用檢查方式
          // 使用 checkLoginStatus 實際驗證登入狀態（會呼叫 /api/auth/me）
          if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
            loggedIn = await window.ReelMindCommon.checkLoginStatus();
          } else {
            // 降級處理：檢查 localStorage 中的 user_id
            const userStr = localStorage.getItem('ipPlanningUser');
            if (userStr) {
              try {
                const user = JSON.parse(userStr);
                loggedIn = !!(user && user.user_id);
              } catch (e) {
                loggedIn = false;
              }
            } else {
              loggedIn = false;
            }
          }
        }
        
        if (!loggedIn) {
          // 未登入：必須先登入才能訂閱
          alert('請先登入後再訂閱服務！');
          if (typeof goToLogin === 'function') {
            // 保存目標方案到 sessionStorage，登入成功後使用
            sessionStorage.setItem('pendingSubscriptionPlan', plan);
            goToLogin();
          } else {
            // 如果沒有 goToLogin 函數，導向首頁登入區塊
            window.location.href = 'index.html#login';
          }
          return;
        }
        
        // 已登入：先跳轉到訂閱頁面，讓用戶選擇方案
        // subscription.html 會處理後續的 checkout 流程
        window.location.href = `subscription.html?plan=${plan}`;
      }
      
      // 在登入成功後與訂閱狀態載入時，同步本地 user.is_subscribed 欄位
      function markUnsubscribedByDefault() {
        try {
          const userStr = sessionStorage.getItem('ipPlanningUser');
          if (!userStr) return;
          const user = JSON.parse(userStr);
          if (!('is_subscribed' in user)) {
            user.is_subscribed = false;
            localStorage.setItem('ipPlanningUser', JSON.stringify(user));
          }
        } catch (_) {}
      }
      // 立即執行一次，確保目前瀏覽使用者為未訂閱預設（後端亦會預設未訂閱）
      markUnsubscribedByDefault();
      
      // 控制訂閱鎖定浮層顯示
      function updateSubscriptionLock() {
        const overlay = document.getElementById('subscription-lock-overlay');
        
        // 檢查訂閱狀態和登入狀態
        const isSubscribed = document.body.dataset.subscribed === 'true';
        const isLoggedIn = ipPlanningToken && ipPlanningUser;
        
        if (overlay) {
          if (isSubscribed && isLoggedIn) {
            // 已登入且有訂閱，隱藏浮層
            overlay.style.display = 'none';
          } else {
            // 未登入或未訂閱，顯示浮層
            overlay.style.display = 'flex';
            
            // 根據登入狀態更新按鈕文字
            const loginButton = overlay.querySelector('a[href="/login"]');
            if (loginButton) {
              if (isLoggedIn) {
                // 已登入但未訂閱，顯示訂閱提示
                overlay.querySelector('h3').textContent = '🔒 解鎖完整功能';
                overlay.querySelector('p').textContent = '立即訂閱即可使用所有 AI 短影音功能';
                // 隱藏登入按鈕，因為已經登入了
                loginButton.style.display = 'none';
              } else {
                // 未登入，保持原來的提示
                overlay.querySelector('h3').textContent = '🔒 解鎖完整功能';
                overlay.querySelector('p').textContent = '請先登入並訂閱即可使用所有 AI 短影音功能';
                loginButton.style.display = 'block';
              }
            }
          }
        }
      }
      
      // 初始化手機版一鍵生成標籤切換功能
      function initializeMode1MobileTabs() {
        const tabs = document.querySelectorAll('.mode1-mobile-tab');
        const panels = document.querySelectorAll('.mode1-mobile-panel');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');
            
            // 移除所有active類
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('show'));
            
            // 添加active類到點擊的標籤
            tab.classList.add('active');
            
            // 顯示對應的面板
            const targetPanel = document.getElementById(`mode1-mobile-${targetTab}`);
            if (targetPanel) {
              targetPanel.classList.add('show');
            }
          });
        });
      }
      
      // 全域變數
      let ipPlanningUser = null;
      let ipPlanningToken = null;
      let isRefreshingToken = false; // 防止重複刷新
      let lastRefreshAttempt = 0; // 上次刷新嘗試的時間
      let handleAuthMessage = null; // 認證訊息處理函數（在 login() 中動態創建）
      
      // 檢查登入狀態
      async function checkLoginStatus() {
        // 從 localStorage 獲取最新的 token 和用戶資訊
        const storedToken = sessionStorage.getItem('ipPlanningToken');
        const storedUserStr = sessionStorage.getItem('ipPlanningUser');
        
        // 更新全局變數（確保使用最新的資料）
        if (storedToken) {
          ipPlanningToken = storedToken;
        }
        if (storedUserStr) {
          try {
            ipPlanningUser = JSON.parse(storedUserStr);
          } catch (e) {
            console.warn('無法解析用戶資料:', e);
            ipPlanningUser = null;
          }
        }
        
        // 無論是否登入，都先顯示首頁
        showMainApp();
        
        // 根據登入狀態更新 UI
        if (ipPlanningToken && ipPlanningUser) {
          // 檢查 token 是否已過期
          if (isTokenExpired(ipPlanningToken)) {
            // Token 已過期，嘗試刷新
            const refreshed = await tryRefreshTokenSafe();
            if (!refreshed) {
              // 刷新失敗，已自動登出（在 tryRefreshTokenSafe 中處理）
              return;
            }
            // 刷新成功後，重新從 localStorage 獲取最新的 token
            const newToken = sessionStorage.getItem('ipPlanningToken');
            if (newToken) {
              ipPlanningToken = newToken;
            }
          } else if (isTokenExpiringSoon(ipPlanningToken)) {
            // Token 即將過期，主動刷新
            await proactiveRefreshToken();
            // 刷新後重新獲取最新的 token
            const newToken = sessionStorage.getItem('ipPlanningToken');
            if (newToken) {
              ipPlanningToken = newToken;
            }
          }
          await updateUserInfo(); // 修復：添加 await 確保異步操作完成
        } else {
          // 未登入時顯示登入按鈕
          showLoginButton();
        }
      }
      
      // 顯示登入頁面
      function showLoginPage() {
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
      }
      
      // 顯示主應用程式
      function showMainApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        
        // 設置默認頁面為首頁
        switchPage('homepage');
      }
      
      // 顯示登入按鈕
      function showLoginButton() {
        const authButtons = document.querySelector('.auth-buttons');
        const userInfo = document.getElementById('userInfo');
        if (authButtons) authButtons.style.display = 'flex';
        if (userInfo) userInfo.style.display = 'none';
      }
      
      // 顯示用戶資訊
      async function updateUserInfo() {
        
        const authButtons = document.querySelector('.auth-buttons');
        const userInfo = document.getElementById('userInfo');
        const loginBtn = document.getElementById('loginBtn');
        
        // 檢查登入狀態
        const isLoggedIn = !!(ipPlanningToken && ipPlanningUser);
        
        if (isLoggedIn) {
          // 已登入：顯示用戶資訊，隱藏登入按鈕
          if (authButtons) authButtons.style.display = 'none';
          if (userInfo) {
            userInfo.style.display = 'flex';
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            if (userNameEl) {
              userNameEl.textContent = ipPlanningUser.name || ipPlanningUser.displayName || '用戶';
            }
            if (userAvatarEl) {
              if (ipPlanningUser.picture || ipPlanningUser.avatar) {
                userAvatarEl.src = ipPlanningUser.picture || ipPlanningUser.avatar;
                userAvatarEl.alt = ipPlanningUser.name || '用戶';
              } else {
                // 如果沒有頭像，使用預設頭像或首字母
                userAvatarEl.src = 'https://via.placeholder.com/32';
                userAvatarEl.alt = ipPlanningUser.name || '用戶';
              }
            }
            // 確保點擊用戶資訊可以打開創作者資料庫
            if (userInfo.onclick !== 'handleUserDBClick()') {
              userInfo.setAttribute('onclick', 'handleUserDBClick()');
              userInfo.style.cursor = 'pointer';
            }
          }
        } else {
          // 未登入：顯示登入按鈕，隱藏用戶資訊
          if (userInfo) userInfo.style.display = 'none';
          if (authButtons) authButtons.style.display = 'flex';
          if (loginBtn) loginBtn.style.display = 'block';
        }
        // 更新用戶資訊後，檢查訂閱狀態
        await checkSubscriptionStatus();
        // 注意：checkSubscriptionStatus() 中已經調用了 updateHomepageView()
        // 但為了確保訂閱狀態已完全更新，再次調用 updateHomepageView()
        setTimeout(() => {
          updateHomepageView();
        }, 200);
        
        // 如果已登入，載入用戶歷史資訊（對話記錄、生成記錄、記憶等）
        if (isLoggedIn && ipPlanningUser && ipPlanningUser.user_id) {
          // 延遲執行，確保訂閱狀態和首頁視圖已更新
          setTimeout(() => {
            if (typeof loadUserHistory === 'function') {
              loadUserHistory();
            } else {
              console.error('❌ loadUserHistory 函數不存在');
            }
          }, 1000);
        } else {
          console.warn('⚠️ 未登入或缺少用戶資訊，跳過載入歷史');
        }
      }
      
      // 跳過登入
      function skipLogin() {
        showMainApp();
        showLoginButton();
      }
      
      // goToLogin 函數已在頁面頂部定義，這裡不需要重複定義
      
      // 檢查訂閱狀態並更新浮層
      async function checkSubscriptionStatus() {
        
        // 如果有登入資訊，從後端 API 獲取訂閱狀態
        if (ipPlanningToken && ipPlanningUser && ipPlanningUser.user_id) {
          try {
            let response = await fetch('https://api.aijob.com.tw/api/auth/me', {
              method: 'GET',
              credentials: 'include', // 重要：包含 Cookie
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`
              }
            });
            
            
            // 如果收到 401，嘗試刷新 token 後重試
            if (response.status === 401) {
              const refreshed = await tryRefreshTokenSafe();
              if (refreshed) {
                // Token 刷新成功，使用新 token 重試
                // 重新獲取最新的 token（刷新後可能已更新）
                const refreshedToken = sessionStorage.getItem('ipPlanningToken');
                if (refreshedToken) {
                  ipPlanningToken = refreshedToken;
                }
                response = await fetch('https://api.aijob.com.tw/api/auth/me', {
                  method: 'GET',
                  credentials: 'include', // 重要：包含 Cookie
                  headers: {
                    'Authorization': `Bearer ${ipPlanningToken}`
                  }
                });
              }
            }
            
            if (response.ok) {
              const userInfo = await response.json();
              
              // 更新全局用戶資訊（從 API 獲取的最新資訊）
              if (userInfo.user_id) {
                // 先更新訂閱狀態判斷
                const isSubscribed = userInfo.is_subscribed === true || 
                                    userInfo.is_subscribed === 1 || 
                                    userInfo.is_subscribed === 'true' ||
                                    userInfo.is_subscribed === '1';
                
                ipPlanningUser = {
                  ...ipPlanningUser,
                  ...userInfo,
                  user_id: userInfo.user_id,
                  name: userInfo.name || userInfo.displayName || ipPlanningUser?.name,
                  picture: userInfo.picture || userInfo.avatar || ipPlanningUser?.picture,
                  email: userInfo.email || ipPlanningUser?.email,
                  is_subscribed: isSubscribed // 確保訂閱狀態被正確設置
                };
                sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                
                // 立即更新 UI 顯示（用戶頭像和名稱）
                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');
                const authButtons = document.querySelector('.auth-buttons');
                const userInfoEl = document.getElementById('userInfo'); // 修復：避免與 API 返回的 userInfo 變數衝突
                
                // 確保顯示用戶資訊，隱藏登入按鈕
                if (authButtons) authButtons.style.display = 'none';
                if (userInfoEl) {
                  userInfoEl.style.display = 'flex';
                }
                
                if (userNameEl) {
                  userNameEl.textContent = ipPlanningUser.name || ipPlanningUser.displayName || '用戶';
                }
                if (userAvatarEl) {
                  if (ipPlanningUser.picture || ipPlanningUser.avatar) {
                    userAvatarEl.src = ipPlanningUser.picture || ipPlanningUser.avatar;
                    userAvatarEl.alt = ipPlanningUser.name || '用戶';
                  } else {
                    // 如果沒有頭像，使用 Google 預設頭像生成器
                    const name = ipPlanningUser.name || ipPlanningUser.displayName || 'User';
                    userAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff&size=32&bold=true`;
                    userAvatarEl.alt = name;
                  }
                }
              }
              
              // 更新訂閱狀態（使用從 API 返回的 userInfo.is_subscribed）
              // 注意：ipPlanningUser.is_subscribed 已在上面更新時設置，這裡使用原始 API 數據判斷
              const isSubscribed = userInfo.is_subscribed === true || 
                                  userInfo.is_subscribed === 1 || 
                                  userInfo.is_subscribed === 'true' ||
                                  userInfo.is_subscribed === '1';
              
              if (isSubscribed) {
                document.body.dataset.subscribed = 'true';
                localStorage.setItem('subscriptionStatus', 'active');
                
                // 確保用戶資料中的訂閱狀態正確（已在上面設置，這裡再次確認）
                if (ipPlanningUser) {
                  ipPlanningUser.is_subscribed = true;
                  sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                }
                
                // 立即更新首頁視圖
                updateHomepageView();
              } else {
                document.body.dataset.subscribed = 'false';
                localStorage.setItem('subscriptionStatus', 'inactive');
                
                // 更新用戶資料中的訂閱狀態
                if (ipPlanningUser) {
                  ipPlanningUser.is_subscribed = false;
                  sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                }
                
                // 立即更新首頁視圖
                updateHomepageView();
              }
            } else {
              // API 失敗（包括 401 刷新失敗），使用本地儲存或預設已訂閱
              const localSubscriptionStatus = localStorage.getItem('subscriptionStatus');
              const localIsSubscribed = ipPlanningUser && ipPlanningUser.is_subscribed !== false; // 預設為已訂閱
              
              if (localSubscriptionStatus === 'active' || localIsSubscribed) {
                document.body.dataset.subscribed = 'true';
                localStorage.setItem('subscriptionStatus', 'active');
                
                // 更新用戶資料中的訂閱狀態
                if (ipPlanningUser) {
                  ipPlanningUser.is_subscribed = true;
                  sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                }
                
                // 立即更新首頁視圖
                updateHomepageView();
              } else {
                document.body.dataset.subscribed = 'false';
                localStorage.setItem('subscriptionStatus', 'inactive');
                
                // 更新用戶資料中的訂閱狀態
                if (ipPlanningUser) {
                  ipPlanningUser.is_subscribed = false;
                  sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
                }
                
                // 立即更新首頁視圖
                updateHomepageView();
              }
            }
          } catch (error) {
            // 網路錯誤等異常，使用本地儲存或預設已訂閱
            console.error('❌ 檢查訂閱狀態時發生錯誤:', error);
            const localSubscriptionStatus = localStorage.getItem('subscriptionStatus');
            const localIsSubscribed = ipPlanningUser && ipPlanningUser.is_subscribed !== false;
            
            if (localSubscriptionStatus === 'active' || localIsSubscribed) {
              document.body.dataset.subscribed = 'true';
              localStorage.setItem('subscriptionStatus', 'active');
              
              // 更新用戶資料中的訂閱狀態
              if (ipPlanningUser) {
                ipPlanningUser.is_subscribed = true;
                sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
              }
              
              // 立即更新首頁視圖
              updateHomepageView();
            } else {
              document.body.dataset.subscribed = 'false';
              localStorage.setItem('subscriptionStatus', 'inactive');
              
              // 更新用戶資料中的訂閱狀態
              if (ipPlanningUser) {
                ipPlanningUser.is_subscribed = false;
                sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
              }
              
              // 立即更新首頁視圖
              updateHomepageView();
            }
          }
        } else {
          // 未登入，從本地存儲檢查訂閱狀態
          const subscriptionStatus = localStorage.getItem('subscriptionStatus');
          
          if (subscriptionStatus === 'active') {
            document.body.dataset.subscribed = 'true';
          } else {
            document.body.dataset.subscribed = 'false';
          }
        }
        
        
        // 更新鎖定浮層
        updateSubscriptionLock();
        
        // 更新首頁視圖
        updateHomepageView();
      }
      
      // 根據用戶權限顯示對應的首頁視圖
      function updateHomepageView() {
        
        // 檢查登入狀態（優先使用全局變數，如果沒有則從 localStorage 讀取）
        const isLoggedIn = !!(ipPlanningToken && ipPlanningUser) || !!(sessionStorage.getItem('ipPlanningToken') && sessionStorage.getItem('ipPlanningUser'));
        
        // 檢查訂閱狀態（多個來源，優先使用全局變數）
        let userSubscribed = false;
        
        // 優先使用全局變數 ipPlanningUser（最新狀態）
        if (ipPlanningUser && ipPlanningUser.is_subscribed !== undefined) {
          userSubscribed = !!(ipPlanningUser.is_subscribed === true || 
                             ipPlanningUser.is_subscribed === 1 || 
                             ipPlanningUser.is_subscribed === '1' ||
                             ipPlanningUser.is_subscribed === 'true');
        }
        
        // 如果全局變數沒有，再從 localStorage 讀取
        if (!userSubscribed && isLoggedIn) {
          const userStr = sessionStorage.getItem('ipPlanningUser');
          if (userStr) {
            try {
              const user = JSON.parse(userStr);
              userSubscribed = !!(user && (
                user.is_subscribed === true || 
                user.is_subscribed === 1 || 
                user.is_subscribed === '1' ||
                user.is_subscribed === 'true'
              ));
            } catch (e) {
              console.warn('❌ 無法解析用戶資料:', e);
            }
          }
        }
        
        // 檢查 document.body.dataset.subscribed（從後端 API 獲取的狀態）
        const backendSubscribed = document.body.dataset.subscribed === 'true';
        
        // 檢查 localStorage 中的訂閱狀態
        const localSubscriptionStatus = localStorage.getItem('subscriptionStatus');
        const localSubscribed = localSubscriptionStatus === 'active';
        
        // 綜合判斷訂閱狀態（任一為 true 即視為已訂閱）
        const isSubscribed = userSubscribed || backendSubscribed || localSubscribed;
        
        // 獲取視圖元素
        const unsubscribedView = document.getElementById('homepage-unsubscribed');
        const subscribedView = document.getElementById('homepage-subscribed');
        
        if (!unsubscribedView || !subscribedView) {
          console.warn('❌ 首頁視圖元素未找到');
          return;
        }
        
        // 隱藏所有視圖
        unsubscribedView.style.display = 'none';
        subscribedView.style.display = 'none';
        
        // 根據權限顯示對應視圖
        if (!isLoggedIn) {
          // 未登入用戶 → 顯示未訂閱視圖
          unsubscribedView.style.display = 'block';
          subscribedView.style.display = 'none';
        } else if (isLoggedIn && !isSubscribed) {
          // 已登入但未訂閱 → 顯示未訂閱視圖
          unsubscribedView.style.display = 'block';
          subscribedView.style.display = 'none';
        } else if (isLoggedIn && isSubscribed) {
          // 已登入且已訂閱 → 顯示已訂閱視圖（包含「介紹如何開始」等區塊）
          unsubscribedView.style.display = 'none';
          subscribedView.style.display = 'block';
          // 驗證視圖是否真的顯示
          setTimeout(() => {
            const computedDisplay = window.getComputedStyle(subscribedView).display;
            if (computedDisplay === 'none') {
              console.error('❌ 錯誤：subscribedView 的 computed display 仍然是 none！');
            }
          }, 100);
        } else {
          // 預設情況：顯示未訂閱視圖
          unsubscribedView.style.display = 'block';
          subscribedView.style.display = 'none';
          console.warn('⚠️ 未匹配到任何條件，顯示未訂閱視圖。isLoggedIn:', isLoggedIn, 'isSubscribed:', isSubscribed);
        }
        
        
        // 首頁顯示後，重新啟動打字機動畫（確保視圖已顯示）
        setTimeout(() => {
          // 檢查當前顯示的視圖
          const currentView = unsubscribedView.style.display === 'block' ? unsubscribedView : subscribedView;
          if (currentView && currentView.style.display === 'block') {
            if (typeof initTypewriterAnimation === 'function') {
              initTypewriterAnimation();
            } else {
              console.warn('⚠️ initTypewriterAnimation 函數不存在');
            }
          } else {
            console.warn('⚠️ 沒有顯示的視圖，跳過打字機動畫');
          }
        }, 500);
      }
      
      // 設置語言
      function setLanguage(lang) {
        // 更新語言按鈕狀態
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 這裡可以添加語言切換邏輯
      }
      
      // 調試函數：檢查AI顧問模式元素狀態
      function debugAIConsultantElements() {
        
        const quickButtons = document.querySelector('.quick-buttons');
        const inputRow = document.querySelector('.input-row');
        const chatContainer = document.querySelector('#chatContainer');
        
        
        // quickButtons 和 inputRow 的樣式檢查已移除（原為調試用）
        
        // chatContainer 樣式檢查已移除（原為調試用）
      }
      
      // 移動現有內容到新容器
      function moveExistingContent() {
        // 移動用戶需求設定內容
        const settingsBlock = document.querySelector('.settings-block');
        if (settingsBlock) {
          const container = document.getElementById('userSettingsContainer');
          if (container) {
            container.appendChild(settingsBlock);
            
            // 設置使用說明顯示控制
            setupInstructionsToggle();
          }
          
          // 複製到手機版容器
          const mobileSettingsContainer = document.querySelector('#mode1-mobile-setup #userSettingsContainer');
          if (mobileSettingsContainer) {
            const mobileSettingsBlock = settingsBlock.cloneNode(true);
            mobileSettingsContainer.appendChild(mobileSettingsBlock);
          }
        }
        
        // 移動一鍵生成內容
        const resultTabs = document.querySelector('.result-tabs');
        const resultsContainer = document.querySelector('.results-container');
        if (resultTabs && resultsContainer) {
          const container = document.getElementById('oneClickGenerationContainer');
          if (container) {
            container.appendChild(resultTabs);
            container.appendChild(resultsContainer);
          }
          
          // 複製到手機版容器
          const mobileContainer = document.getElementById('oneClickGenerationContainerMobile');
          if (mobileContainer) {
            const mobileResultTabs = resultTabs.cloneNode(true);
            const mobileResultsContainer = resultsContainer.cloneNode(true);
            
            // 修正手機版按鈕的onclick事件
            const mobileButtons = mobileResultsContainer.querySelectorAll('.generate-btn');
            mobileButtons.forEach(btn => {
              const text = btn.textContent.trim();
              if (text.includes('帳號定位')) {
                btn.setAttribute('onclick', 'generatePositioning()');
              } else if (text.includes('選題')) {
                btn.setAttribute('onclick', 'generateTopics()');
              } else if (text.includes('腳本')) {
                btn.setAttribute('onclick', 'generateScript()');
              }
            });
            
            mobileContainer.appendChild(mobileResultTabs);
            mobileContainer.appendChild(mobileResultsContainer);
          }
        }
        
        // 聊天內容已經在正確位置，不需要移動
        // 只需要確保快速按鈕功能正常
        setupQuickButtons();
      }
      
      // 設置使用說明顯示控制
      function setupInstructionsToggle() {
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const instructions = document.getElementById('oneClickInstructions');
        
        if (settingsToggle && settingsContent && instructions) {
          // 監聽設定區塊的展開/收合
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const isExpanded = settingsContent.style.display !== 'none';
                instructions.style.display = isExpanded ? 'block' : 'none';
              }
            });
          });
          
          observer.observe(settingsContent, { attributes: true });
          
          // 初始狀態檢查
          const isExpanded = settingsContent.style.display !== 'none';
          instructions.style.display = isExpanded ? 'block' : 'none';
        }
      }
      
      // 設置快速按鈕功能
      function setupQuickButtons() {
        // 快速按鈕功能
        document.querySelectorAll('.quick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text) {
              const messageInput = document.getElementById('messageInput');
              if (messageInput) {
                messageInput.value = text;
                messageInput.focus();
                
                // 添加視覺反饋
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                  btn.style.transform = 'scale(1)';
                }, 150);
              }
            }
          });
        });
      }

      // 新的元素引用
      const chatEl = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const applyBtn = document.getElementById('applyBtn');
      const platformSelect = document.getElementById('platformSelect');
      const topicInput = document.getElementById('topicInput');
      const durationInput = document.getElementById('durationInput');
      const positioningInput = document.getElementById('positioningInput');
      
      // 結果區塊元素
      const resultsEl = document.getElementById('results');
      const resultTitleEl = document.getElementById('result-title');
      const resultScriptEl = document.getElementById('result-script');
      const resultVisualEl = document.getElementById('result-visual');
      const resultCopyEl = document.getElementById('result-copy');
      const scriptResult = document.getElementById('scriptResult');
      const positioningResult = document.getElementById('positioningResult');
      const topicSelectionResult = document.getElementById('topicSelectionResult');
      
      // 控制按鈕（已移除，功能整合到快速按鈕中）
      
      // 用戶抽屜元素
      const userDrawer = document.getElementById('userDrawer');
      const userDrawerOverlay = document.getElementById('userDrawerOverlay');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerEmail = document.getElementById('drawerEmail');
      
      // 認證相關元素
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // 彈跳視窗元素
      const popupOverlay = document.getElementById('popupOverlay');
      const popupSpinner = document.getElementById('popupSpinner');
      const popupMessage = document.getElementById('popupMessage');
      const popupButtons = document.getElementById('popupButtons');
      const popupRetry = document.getElementById('popupRetry');
      const popupCancel = document.getElementById('popupCancel');
      
      // 提示框
      const toastEl = document.getElementById('toast');
      
      // 設定區塊元素
      const settingsToggleEl = document.getElementById('settingsToggle');
      const settingsContentEl = document.getElementById('settingsContent');
      
      // 全局變數
      let currentPlatform = null;
      let currentTopic = null;
      let currentProfile = null;
      const styleInstruction = '格式要求：分段清楚，短句，每段換行，適度加入表情符號（如：✅✨🔥📌），避免口頭禪。絕對不要使用 ** 或任何 Markdown 格式符號，所有內容必須是純文字格式。';
      
      // 生成隨機用戶ID
      function generateUserId() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return `user_${timestamp}_${randomStr}`;
      }
      
      // 用戶抽屜功能
      function toggleUserDrawer() {
        userDrawer.classList.toggle('open');
        userDrawerOverlay.classList.toggle('open');
        
        // 如果抽屜打開，載入用戶歷史資訊
        if (userDrawer.classList.contains('open') && ipPlanningUser) {
          loadUserHistory();
        }
      }
      
      function closeUserDrawer() {
        userDrawer.classList.remove('open');
        userDrawerOverlay.classList.remove('open');
      }
      
      // 更新用戶抽屜資訊
      function updateUserDrawer(user) {
        if (user) {
          // 確保用戶有ID
          if (!user.user_id) {
            user.user_id = generateUserId();
            ipPlanningUser = user; // 更新當前用戶
            localStorage.setItem('ipPlanningUser', JSON.stringify(user));
          }
          
          // 更新抽屜內的資訊
          drawerAvatar.src = user.picture || 'https://via.placeholder.com/50';
          drawerName.textContent = user.name || '用戶';
          drawerEmail.textContent = user.email || '';
          
          // 更新頂部 header 中的用戶資訊
          userAvatar.src = user.picture || 'https://via.placeholder.com/32';
          userName.textContent = user.name || '用戶';
          
          // 更新個人資料顯示
          updatePersonalInfo();
          
          // 載入用戶的過往資訊
          loadUserHistory();
        }
      }

      // 載入用戶歷史資訊
      async function loadUserHistory() {
        
        // 確保用戶有ID
        if (!ipPlanningUser?.user_id) {
          console.warn('⚠️ 沒有用戶ID，嘗試生成...');
          if (ipPlanningUser) {
            ipPlanningUser.user_id = generateUserId();
            sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
          } else {
            console.error('❌ 沒有當前用戶，跳過載入歷史');
            return;
          }
        }
        
        
        try {
          // 載入對話記錄
          const conversationsResponse = await fetch(`https://api.aijob.com.tw/api/user/conversations/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          if (conversationsResponse.ok) {
            const conversationsData = await conversationsResponse.json();
            updateConversationsDisplay(conversationsData.conversations);
          } else {
            console.error('❌ 載入對話記錄失敗:', conversationsResponse.status, conversationsResponse.statusText);
          }
          
          // 載入生成記錄
          const generationsResponse = await fetch(`https://api.aijob.com.tw/api/user/generations/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          if (generationsResponse.ok) {
            const generationsData = await generationsResponse.json();
            updateGenerationsDisplay(generationsData.generations);
          } else {
            console.error('❌ 載入生成記錄失敗:', generationsResponse.status, generationsResponse.statusText);
          }
          
          // 載入帳號定位記錄
          await loadPositioningRecords();
          
          // 載入用戶記憶
          const memoryResponse = await fetch(`https://api.aijob.com.tw/api/user/memory/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          if (memoryResponse.ok) {
            const memoryData = await memoryResponse.json();
            updateMemoryDisplay(memoryData.memory);
          } else {
            console.error('❌ 載入用戶記憶失敗:', memoryResponse.status, memoryResponse.statusText);
          }
          
        } catch (error) {
          console.error('❌ 載入用戶歷史資訊時出錯:', error);
        }
      }

      // 更新對話記錄顯示
      function updateConversationsDisplay(conversations) {
        const conversationsList = document.getElementById('conversationsList');
        if (!conversationsList) return;
        
        conversationsList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          item.className = 'conversation-item';
          const safeSummary = escapeHtml(conv.summary || '');
          item.innerHTML = `
            <div class="conversation-summary">${safeSummary}</div>
            <div class="conversation-date">${formatTaiwanTime(conv.created_at).split(' ')[0]}</div>
          `;
          conversationsList.appendChild(item);
        });
      }

      // 更新生成記錄顯示
      function updateGenerationsDisplay(generations) {
        const generationsList = document.getElementById('generationsList');
        if (!generationsList) return;
        
        generationsList.innerHTML = '';
        generations.forEach(gen => {
          const item = document.createElement('div');
          item.className = 'generation-item';
          item.innerHTML = `
            <div class="generation-header">
              <span class="generation-platform">${gen.platform}</span>
              <span class="generation-topic">${gen.topic}</span>
            </div>
            <div class="generation-content">${gen.content}</div>
            <div class="generation-date">${formatTaiwanTime(gen.created_at).split(' ')[0]}</div>
          `;
          generationsList.appendChild(item);
        });
      }

      // 更新記憶顯示
      function updateMemoryDisplay(memory) {
        const memoryContent = document.getElementById('memoryContent');
        if (!memoryContent) return;
        
        memoryContent.innerHTML = memory ? escapeHtml(memory) : '暫無記憶資訊';
      }
      
      // 載入帳號定位記錄
      async function loadPositioningRecords() {
        if (!ipPlanningUser?.user_id) return;
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            updatePositioningDisplay(data.records || []);
          }
        } catch (error) {
          console.error('載入帳號定位記錄失敗:', error);
        }
      }
      
      // 更新帳號定位顯示
      function updatePositioningDisplay(records) {
        const positioningContent = document.getElementById('positioningHistoryContent');
        if (!positioningContent) return;
        
        if (records.length === 0) {
          positioningContent.innerHTML = '<p style="color: #666;">尚無帳號定位記錄</p>';
          return;
        }
        
        let html = '<div class="positioning-records">';
        records.forEach(record => {
          const date = new Date(record.created_at).toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const preview = record.content.substring(0, 50) + (record.content.length > 50 ? '...' : '');
          
          html += `
            <div class="positioning-record-item">
              <div class="record-header">
                <span class="record-number">編號 ${record.record_number}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="view-btn" onclick="viewPositioningDetail(${record.id}, '${record.record_number}')">查看完整結果</button>
                <button class="delete-btn" onclick="deletePositioningRecord(${record.id})">刪除</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        positioningContent.innerHTML = html;
      }
      
      // 查看帳號定位詳細內容
      async function viewPositioningDetail(recordId, recordNumber) {
        if (!ipPlanningUser?.user_id) return;
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // 顯示詳細內容在彈出視窗
              showDetailModal(recordNumber, record.created_at, record.content);
            }
          }
        } catch (error) {
          console.error('載入詳細內容失敗:', error);
          showToast('載入失敗', 3000);
        }
      }
      
      // 顯示詳細內容彈出視窗
      function showDetailModal(recordNumber, createdAt, content) {
        const date = formatTaiwanTime(createdAt);
        const modal = document.createElement('div');
        modal.className = 'detail-modal-overlay';
        modal.innerHTML = `
          <div class="detail-modal">
            <div class="detail-modal-header">
              <h3>帳號定位詳細內容</h3>
              <button class="close-detail-btn" onclick="this.closest('.detail-modal-overlay').remove()">✕</button>
            </div>
            <div class="detail-modal-body">
              <div class="detail-info">
                <span><strong>編號：</strong>${recordNumber}</span>
                <span><strong>生成日期：</strong>${date}</span>
              </div>
              <div class="detail-content">
                ${content.replace(/\n/g, '<br>')}
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // 刪除帳號定位記錄
      async function deletePositioningRecord(recordId) {
        if (!confirm('確定要刪除這筆記錄嗎？')) return;
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/positioning/${recordId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            showToast('記錄已刪除', 2000);
            await loadPositioningRecords();
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('刪除錯誤:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }

      // 切換抽屜內容區域
      function switchDrawerContent(sectionId) {
        // 隱藏所有內容區域
        const allSections = document.querySelectorAll('.content-section');
        allSections.forEach(section => {
          section.classList.remove('active');
        });
        
        // 移除所有按鈕的 active 狀態
        const allMenuItems = document.querySelectorAll('.user-drawer-menu a');
        allMenuItems.forEach(item => {
          item.classList.remove('active');
        });
        
        // 顯示選中的內容區域
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // 添加對應按鈕的 active 狀態
        const targetMenuItem = document.querySelector(`[data-section="${sectionId}"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
        
        // 根據不同的區域載入相應的數據
        switch(sectionId) {
          case 'myScripts':
            loadMyScripts();
            break;
          case 'accountPositioning':
            loadPositioningRecords();
            break;
          case 'topicHistory':
            loadTopicHistory();
            break;
        }
      }

      // 更新個人資料顯示
      function updatePersonalInfo() {
        if (ipPlanningUser) {
          // 確保用戶有ID，如果沒有則生成一個
          if (!ipPlanningUser.user_id) {
            ipPlanningUser.user_id = generateUserId();
            sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
          }
          
          const userNameDetail = document.getElementById('userNameDetail');
          const userEmailDetail = document.getElementById('userEmailDetail');
          const userIdDetail = document.getElementById('userIdDetail');
          
          if (userNameDetail) userNameDetail.textContent = ipPlanningUser.name || ipPlanningUser.displayName || '未設定';
          if (userEmailDetail) userEmailDetail.textContent = ipPlanningUser.email || '未設定';
          if (userIdDetail) userIdDetail.textContent = ipPlanningUser.user_id || '未生成';
        }
      }
      
      // 更新用戶資訊顯示
      function updateUserInfo() {
        if (ipPlanningUser) {
          // 更新頭像
          if (userAvatar) {
            userAvatar.src = ipPlanningUser.picture || 'https://via.placeholder.com/32';
          }
          // 更新用戶名
          if (userName) {
            userName.textContent = ipPlanningUser.name || ipPlanningUser.displayName || '用戶';
          }
          // 顯示用戶資訊區域
          if (userInfo) {
            userInfo.style.display = 'flex';
          }
        }
      }
      
      // 更新認證 UI
      async function updateAuthUI(isLoggedIn) {
        const authButtons = document.querySelector('.auth-buttons');
        const userInfoEl = document.getElementById('userInfo');
        const loginBtnEl = document.getElementById('loginBtn');
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        
        if (isLoggedIn && ipPlanningToken && ipPlanningUser) {
          // 已登入：顯示用戶資訊，隱藏登入按鈕
          if (authButtons) authButtons.style.display = 'none';
          if (loginBtnEl) loginBtnEl.style.display = 'none';
          
          if (userInfoEl) {
            userInfoEl.style.display = 'flex';
            // 更新用戶名稱
            if (userNameEl) {
              userNameEl.textContent = ipPlanningUser.name || ipPlanningUser.displayName || '用戶';
            }
            // 更新用戶頭像
            if (userAvatarEl) {
              if (ipPlanningUser.picture || ipPlanningUser.avatar) {
                userAvatarEl.src = ipPlanningUser.picture || ipPlanningUser.avatar;
                userAvatarEl.alt = ipPlanningUser.name || '用戶';
              } else {
                // 如果沒有頭像，使用 Google 預設頭像生成器
                const name = ipPlanningUser.name || ipPlanningUser.displayName || 'User';
                userAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff&size=32&bold=true`;
                userAvatarEl.alt = name;
              }
            }
            // 確保點擊用戶資訊可以打開創作者資料庫
            userInfoEl.setAttribute('onclick', 'handleUserDBClick()');
            userInfoEl.style.cursor = 'pointer';
          }
          
          // 更新用戶抽屜
          if (typeof updateUserDrawer === 'function') {
            updateUserDrawer(ipPlanningUser);
          }
          
          // 顯示個人資料庫分頁
          const userDBTab = document.getElementById('userDBTab');
          if (userDBTab) {
            userDBTab.style.display = 'inline-block';
          }
          // 同時更新底部導航欄
          const bottomUserDBTab = document.getElementById('bottomUserDBTab');
          if (bottomUserDBTab) {
            bottomUserDBTab.style.display = 'flex';
          }
          // 更新個人資料庫用戶資訊
          if (typeof updateDbUserInfo === 'function') {
            updateDbUserInfo();
          }
          
          // 調用完整的 updateUserInfo 函數（async 版本）
          if (typeof updateUserInfo === 'function') {
            await updateUserInfo();
          }
        } else {
          // 未登入：顯示登入按鈕，隱藏用戶資訊
          if (userInfoEl) userInfoEl.style.display = 'none';
          if (authButtons) authButtons.style.display = 'flex';
          if (loginBtnEl) loginBtnEl.style.display = 'block';
          
          if (typeof closeUserDrawer === 'function') {
            closeUserDrawer();
          }
          
          // 隱藏個人資料庫分頁
          const userDBTab = document.getElementById('userDBTab');
          if (userDBTab) {
            userDBTab.style.display = 'none';
          }
          // 同時隱藏底部導航欄
          const bottomUserDBTab = document.getElementById('bottomUserDBTab');
          if (bottomUserDBTab) {
            bottomUserDBTab.style.display = 'none';
          }
        }
      }
      
      // 取消訂閱功能
      async function cancelSubscription() {
        if (!confirm('確定要取消自動續費嗎？取消後將在當期結束時停止服務。')) {
          return;
        }
        
        if (!ipPlanningToken || !ipPlanningUser) {
          showToast('請先登入', 3000);
          return;
        }
        
        try {
          // 調用後端API取消訂閱
          const response = await fetch(`https://api.aijob.com.tw/api/auth/me`, {
            method: 'PUT',
            credentials: 'include', // 重要：包含 Cookie
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              is_subscribed: false
            })
          });
          
          if (response.ok) {
            // 更新本地狀態
            ipPlanningUser.is_subscribed = false;
            sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
            document.body.dataset.subscribed = 'false';
            
            showToast('已取消自動續費', 3000);
            
            // 重新載入個人資料
            setTimeout(() => {
              loadPersonalInfoForUserDB();
              closeUserDrawer();
            }, 1000);
          } else {
            showToast('操作失敗，請稍後再試', 3000);
          }
        } catch (error) {
          console.error('取消訂閱失敗:', error);
          showToast('操作失敗，請稍後再試', 3000);
        }
      }
      
      // 登出功能
      async function logout() {
        
        // 如果有 token，先調用後端登出 API
        if (ipPlanningToken) {
          try {
            const response = await fetch('https://api.aijob.com.tw/api/auth/logout', {
              method: 'POST',
              credentials: 'include', // 重要：包含 Cookie
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
            } else {
              console.warn('⚠️ 後端登出失敗，但繼續本地登出:', response.status);
            }
          } catch (error) {
            console.warn('⚠️ 後端登出 API 調用失敗，但繼續本地登出:', error);
          }
        }
        
        // 登出時更新首頁視圖
        updateHomepageView();
        ipPlanningToken = null;
        ipPlanningUser = null;
        sessionStorage.removeItem('ipPlanningToken');
        sessionStorage.removeItem('ipPlanningUser');
        localStorage.removeItem('subscriptionStatus');
        localStorage.removeItem('ipPlanningTokenUpdated');
        
        // 清空聊天記錄（但後端長期記憶會保留）
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          chatMessages.innerHTML = '';
        }
        const mode3ChatMessages = document.getElementById('mode3-chatMessages');
        if (mode3ChatMessages) {
          mode3ChatMessages.innerHTML = '';
        }
        
        updateAuthUI(false);
        showToast('已登出', 3000);
        closeUserDrawer();
        
        // 顯示首頁（不跳轉到登入頁面）
        showMainApp();
        
        // 顯示登入按鈕
        showLoginButton();
        
        // 更新訂閱狀態為未訂閱
        document.body.dataset.subscribed = 'false';
        updateSubscriptionLock();
        
        // 更新首頁視圖（在清理狀態後）
        setTimeout(() => {
          updateHomepageView();
        }, 100);
        
      }
      // 更新個人資料庫用戶資訊
      function updateDbUserInfo() {
        if (ipPlanningUser) {
          const dbUserAvatar = document.getElementById('dbUserAvatar');
          const dbUserName = document.getElementById('dbUserName');
          const dbUserEmail = document.getElementById('dbUserEmail');
          
          if (dbUserAvatar) dbUserAvatar.src = ipPlanningUser.picture || 'https://via.placeholder.com/48';
          if (dbUserName) dbUserName.textContent = ipPlanningUser.name || '用戶';
          if (dbUserEmail) dbUserEmail.textContent = ipPlanningUser.email || 'user@example.com';
        }
      }
      
      // 顯示個人資料庫分區
      function showDbSection(sectionName) {
        // 隱藏所有分區
        document.querySelectorAll('.db-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // 移除所有選單項的active狀態
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // 顯示選中的分區
        const targetSection = document.getElementById(`db-${sectionName}`);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // 添加對應選單項的active狀態
        const targetMenuItem = document.querySelector(`[onclick="showDbSection('${sectionName}')"]`);
        if (targetMenuItem) {
          targetMenuItem.classList.add('active');
        }
        
        // 根據分區載入相應數據
        switch(sectionName) {
          case 'personalInfo':
            loadPersonalInfoForUserDB();
            break;
          case 'myScripts':
            loadMyScriptsForUserDB();
            break;
          case 'settings':
            loadSavedApiKey();
            loadDisplayPreferences();
            // 清除測試結果顯示
            const testResultDiv = document.getElementById('testKeyResult');
            if (testResultDiv) {
              testResultDiv.style.display = 'none';
            }
            break;
          case 'accountPositioning':
            loadPositioningRecordsForUserDB();
            break;
          case 'topicRecords':
            loadTopicHistoryForUserDB();
            break;
          case 'ipPlanning':
            loadIpPlanningResultsForUserDB();
            break;
          case 'myOrders':
            loadMyOrdersForUserDB();
            break;
          case 'settings':
            // 設定頁面內容已在HTML中定義，無需動態載入
            break;
          case 'usageStats':
            loadUsageStatsForUserDB();
            break;
          case 'helpCenter':
            // 幫助中心內容已在HTML中定義，無需動態載入
            break;
        }
      }
      
      // 統一的載入動畫函數
      function showLoadingAnimation(container, message = '載入中...') {
        if (!container) return;
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; padding: 40px; gap: 12px; flex-direction: column;">
            <div class="spinner" style="width: 24px; height: 24px; border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px;"></div>
            <span style="color: #6b7280; font-size: 14px;">${message}</span>
          </div>
        `;
      }
      
      // 渲染個人資料內容（獨立函數，避免遞迴問題）
      async function renderPersonalInfoContent() {
        const content = document.querySelector('#db-personalInfo .section-content');
        if (!content || !ipPlanningUser) return;
        
        // 如果有本地儲存的用戶資訊，直接使用（即使 API 失敗也能顯示）
          // 格式化日期顯示
          let registrationTime = '未知';
          if (ipPlanningUser.created_at) {
            try {
              const date = new Date(ipPlanningUser.created_at);
              if (!isNaN(date.getTime())) {
                registrationTime = date.toLocaleString('zh-TW', {
                  timeZone: 'Asia/Taipei',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              }
            } catch (e) {
              // 如果格式化失敗，使用原始值
              registrationTime = ipPlanningUser.created_at;
            }
          }
          
          // 訂閱狀態（預設為已訂閱，除非明確設為 false）
          const isSubscribed = ipPlanningUser.is_subscribed !== false; // 預設為已訂閱
          const subscriptionStatus = isSubscribed ? 
            '<span style="color: #10b981; font-weight: bold;">✅ 已訂閱</span>' : 
            '<span style="color: #ef4444; font-weight: bold;">❌ 未訂閱</span>';
          
          // 載入詳細訂閱資訊（使用新的 API）
          let expiresAt = null;
          let daysLeft = null;
          let expiresAtText = '未知';
          let daysLeftText = '';
          let expirationWarning = '';
          
          // 嘗試從 API 獲取詳細訂閱資訊
          if (ipPlanningToken && ipPlanningUser?.user_id) {
            try {
              const subResponse = await fetch('https://api.aijob.com.tw/api/user/subscription', {
                headers: {
                  'Authorization': `Bearer ${ipPlanningToken}`
                }
              });
              
              if (subResponse.ok) {
                const subData = await subResponse.json();
                if (subData.expires_at) {
                  expiresAt = new Date(subData.expires_at);
                  const now = new Date();
                  daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                  
                  expiresAtText = expiresAt.toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  });
                  
                  if (daysLeft < 0) {
                    daysLeftText = `<span style="color: #ef4444; font-weight: bold;">（已過期 ${Math.abs(daysLeft)} 天）</span>`;
                    expirationWarning = '<div style="margin-top: 12px; padding: 12px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; color: #991b1b;"><strong>⚠️ 訂閱已過期</strong><br>請前往訂閱頁面續費以繼續使用服務。</div>';
                  } else if (daysLeft <= 3) {
                    daysLeftText = `<span style="color: #ef4444; font-weight: bold;">（剩餘 ${daysLeft} 天）</span>`;
                    expirationWarning = '<div style="margin-top: 12px; padding: 12px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; color: #92400e;"><strong>⚠️ 訂閱即將到期</strong><br>請盡快前往訂閱頁面續費。</div>';
                  } else if (daysLeft <= 7) {
                    daysLeftText = `<span style="color: #f59e0b; font-weight: bold;">（剩餘 ${daysLeft} 天）</span>`;
                    expirationWarning = '<div style="margin-top: 12px; padding: 12px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; color: #92400e;"><strong>提醒</strong><br>您的訂閱將在 7 天內到期，請記得續費。</div>';
                  } else {
                    daysLeftText = `<span style="color: #10b981;">（剩餘 ${daysLeft} 天）</span>`;
                  }
                }
              }
            } catch (e) {
              console.warn('載入訂閱詳情失敗:', e);
              // 如果 API 失敗，使用舊的計算方式
              if (ipPlanningUser.created_at && isSubscribed) {
                try {
                  const createdDate = new Date(ipPlanningUser.created_at);
                  const renewal = new Date(createdDate);
                  renewal.setMonth(renewal.getMonth() + 1);
                  expiresAtText = renewal.toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  });
                } catch (e2) {
                  expiresAtText = '未知';
                }
              }
            }
          }
          
          content.innerHTML = `
            <div class="profile-details">
              <div class="detail-item">
                <label>姓名：</label>
                <span>${ipPlanningUser.name || '未設定'}</span>
              </div>
              <div class="detail-item">
                <label>Email：</label>
                <span>${ipPlanningUser.email || '未設定'}</span>
              </div>
              <div class="detail-item">
                <label>用戶ID：</label>
                <span>${ipPlanningUser.user_id || '未生成'}</span>
              </div>
              <div class="detail-item">
                <label>註冊時間：</label>
                <span>${registrationTime}</span>
              </div>
              <div class="detail-item">
                <label>訂閱狀態：</label>
                <span>${subscriptionStatus}</span>
              </div>
              ${isSubscribed ? `
              <div class="detail-item">
                <label>到期日期：</label>
                <span>${expiresAtText} ${daysLeftText}</span>
              </div>
              ${expirationWarning}
              <div class="detail-actions" style="margin-top: 16px;">
                <a href="/subscription.html" style="display: inline-block; padding: 8px 16px; background: #3B82F6; color: white; border-radius: 6px; text-decoration: none; font-weight: 500; margin-right: 8px;">
                  💳 續費訂閱
                </a>
                <button class="btn btn-danger" onclick="cancelSubscription()" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: #ef4444; color: white;">
                  🔴 取消自動續費
                </button>
              </div>
              ` : `
              <div class="detail-actions">
                <button class="btn btn-success" onclick="window.open('https://reelmind.aijob.com.tw/', '_blank')" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: #10b981; color: white;">
                  ✨ 啟用訂閱
                </button>
              </div>
              `}
            </div>
          `;
      }
      
      // 載入個人資料庫的個人資料
      async function loadPersonalInfoForUserDB() {
        const content = document.querySelector('#db-personalInfo .section-content');
        if (!content) return;
        
        // 如果沒有本地用戶資訊，顯示提示
        if (!ipPlanningUser) {
          content.innerHTML = '<div class="loading-text">請先登入以查看個人資料</div>';
          return;
        }
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入個人資料中...');
        
        // 如果有本地資訊，先立即渲染（確保頁面有內容）
        if (ipPlanningUser && (ipPlanningUser.name || ipPlanningUser.email)) {
          // 短暫延遲後顯示內容，讓用戶看到載入動畫
          setTimeout(async () => {
            await renderPersonalInfoContent();
          }, 300);
        }
        
        // 如果有 token 但缺少 created_at 等關鍵資訊，在背景中嘗試更新
        if (ipPlanningToken && !ipPlanningUser.created_at) {
            try {
              await fetchUserInfo();
            // 如果更新成功，重新渲染
              if (ipPlanningUser && ipPlanningUser.created_at) {
                renderPersonalInfoContent();
              }
            } catch (error) {
            // 如果 API 失敗，仍然顯示本地資訊（已在上面的 setTimeout 中渲染）
            console.warn('無法從伺服器獲取最新資訊，使用本地資料');
            }
        }
      }
      
      // 載入創作者資料庫的我的腳本
      async function loadMyScriptsForUserDB() {
        const content = document.querySelector('#db-myScripts .section-content');
        
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看腳本記錄</div>';
          return;
        }
        
        // 標題已改為固定「我的腳本」，不再需要編輯功能
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入腳本記錄中...');
        
        // 先檢查本地儲存的腳本（僅用於快速顯示，仍會從後端獲取最新資料）
        const localScripts = getLocalScripts();
        
        // 如果有本地腳本，短暫延遲後顯示，讓用戶看到載入動畫
        if (localScripts.length > 0) {
          setTimeout(() => {
          displayScriptsForUserDB(localScripts);
          }, 300);
          // 繼續執行 API 調用以獲取最新資料
        }
        
        // 從後端 API 獲取腳本列表
        try {
          const response = await fetch('https://api.aijob.com.tw/api/scripts/my', {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          
          if (response.ok) {
            const data = await response.json();
            const serverScripts = data.scripts || [];
            
            // 合併本地和後端腳本，避免覆蓋
            // 使用 Map 來去重（根據 ID），保留最新的版本
            const scriptMap = new Map();
            
            // 先添加本地腳本
            localScripts.forEach(script => {
              if (script.id) {
                scriptMap.set(script.id, script);
              }
            });
            
            // 再添加後端腳本（會覆蓋同 ID 的本地腳本，確保使用最新的）
            serverScripts.forEach(script => {
              if (script.id) {
                scriptMap.set(script.id, script);
              } else {
                // 如果後端腳本沒有 ID，使用 created_at 作為唯一標識
                const uniqueKey = script.created_at || Date.now();
                scriptMap.set(uniqueKey, script);
              }
            });
            
            // 轉換為陣列並顯示
            const mergedScripts = Array.from(scriptMap.values());
            
            if (mergedScripts.length > 0) {
              displayScriptsForUserDB(mergedScripts);
            } else {
              content.innerHTML = '<div class="loading-text">還沒有儲存的腳本，請先使用一鍵生成功能創建腳本</div>';
            }
          } else if (response.status === 401) {
            // 如果沒有本地腳本，顯示錯誤；否則保持顯示本地腳本
            if (localScripts.length === 0) {
              // 嘗試刷新 token 後重試
              const refreshed = await tryRefreshTokenSafe();
              if (refreshed) {
                // Token 刷新成功，重試一次
                return loadMyScriptsForUserDB();
              }
              content.innerHTML = '<div class="loading-text">請先登入</div>';
            } else {
              console.warn('API 認證失敗，但已有本地腳本，繼續使用本地腳本');
            }
          } else if (response.status === 404) {
            // 如果沒有本地腳本，顯示錯誤；否則保持顯示本地腳本
            if (localScripts.length === 0) {
              content.innerHTML = '<div class="loading-text">腳本功能即將上線，請稍後再試</div>';
            } else {
              console.warn('API 不存在，但已有本地腳本，繼續使用本地腳本');
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            // 如果沒有本地腳本，顯示錯誤；否則保持顯示本地腳本
            if (localScripts.length === 0) {
              content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
            } else {
              console.warn('API 載入失敗，但已有本地腳本，繼續使用本地腳本');
            }
          }
        } catch (error) {
          console.error('Load scripts error:', error);
          // 如果沒有本地腳本，顯示錯誤；否則保持顯示本地腳本
          if (localScripts.length === 0) {
            content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
          } else {
            console.warn('API 調用異常，但已有本地腳本，繼續使用本地腳本');
          }
        }
      }
      
      // ===== ChatGPT 風格功能函數 =====
      
      // 初始化 Markdown 渲染器
      function initMarkdownRenderer() {
        if (typeof marked !== 'undefined') {
          marked.setOptions({
            highlight: function(code, lang) {
              if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return code;
            },
            breaks: true,
            gfm: true
          });
        }
      }
      
      // Markdown 渲染函數
      function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
          return marked.parse(text);
        }
        return text.replace(/\n/g, '<br>');
      }
      
      // 創建 ChatGPT 風格的訊息元素
      function createChatGPTMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (role === 'user') {
          // 載入Google用戶頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          avatarDiv.textContent = '🤖';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (role === 'assistant') {
          // 使用安全的 Markdown 渲染
          contentDiv.innerHTML = safeRenderMarkdown(content);
        } else {
          // 用戶輸入使用 textContent（更安全）
          safeSetText(contentDiv, content);
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }
      
      // 創建載入動畫
      function createTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = '🤖';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = `
          <div class="typing-indicator">
            <span>AI正在思考中</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }
      
      // 串流顯示文字
      function streamText(element, text, speed = 30) {
        return new Promise((resolve) => {
          let index = 0;
          element.innerHTML = '';
          
          const stream = () => {
            if (index < text.length) {
              element.innerHTML += text[index];
              index++;
              setTimeout(stream, speed);
            } else {
              // 添加閃爍游標
              const cursor = document.createElement('span');
              cursor.className = 'streaming-cursor';
              element.appendChild(cursor);
              resolve();
            }
          };
          
          stream();
        });
      }
      
      // 自動調整輸入框高度
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
      }
      
      // 發送訊息函數（ChatGPT 風格，兼容現有後端）
      async function sendMessageChatGPT(message) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        // 添加用戶訊息
        const userMessage = createChatGPTMessage('user', message);
        chatMessages.appendChild(userMessage);
        // 記錄長期記憶
        try { 
          await recordConversationMessage('ip_planning', 'user', message); 
        } catch (error) {
          console.error('❌ 長期記憶儲存異常 (IP 人設規劃 - user):', error);
        }
        
        // 添加載入動畫
        const typingIndicator = createTypingIndicator();
        chatMessages.appendChild(typingIndicator);
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          // 使用現有的後端API端點和參數
          const endpoint = 'https://api.aijob.com.tw/api/chat/stream';
          const headers = { 'Content-Type': 'application/json' };
          if (ipPlanningToken) {
            headers['Authorization'] = `Bearer ${ipPlanningToken}`;
          }
          
          // 安全地獲取設定值，避免未定義變數錯誤
          const safeSettingsApplied = typeof settingsApplied !== 'undefined' ? settingsApplied : false;
          const safeAppliedSettings = typeof appliedSettings !== 'undefined' ? appliedSettings : {};
          const safeStyleInstruction = typeof styleInstruction !== 'undefined' ? styleInstruction : null;
          
          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message: message,
              platform: safeSettingsApplied ? safeAppliedSettings.platform : null,
              topic: safeSettingsApplied ? safeAppliedSettings.topic : null,
              duration: safeSettingsApplied ? safeAppliedSettings.duration : null,
              style: safeStyleInstruction,
              profile: safeSettingsApplied ? safeAppliedSettings.positioning : null,
              history: [], // 保持現有的歷史記錄格式
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // 移除載入動畫
          chatMessages.removeChild(typingIndicator);
          
          // 創建AI回應容器
          const aiMessage = createChatGPTMessage('assistant', '');
          chatMessages.appendChild(aiMessage);
          
          const contentDiv = aiMessage.querySelector('.message-content');
          
          // 處理串流回應
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let fullContent = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop(); // 保留最後一行（可能不完整）
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') {
                  // 移除閃爍游標
                  const cursor = contentDiv.querySelector('.streaming-cursor');
                  if (cursor) cursor.remove();
                  
                  // 檢查是否需要顯示結果區塊
                  if (fullContent) {
                    checkIfScriptRequest(fullContent);
                  }
                  // 記錄長期記憶
                  try { 
                    await recordConversationMessage('ip_planning', 'assistant', fullContent); 
                  } catch (error) {
                    console.error('❌ 長期記憶儲存異常 (IP 人設規劃 - assistant):', error);
                  }
                  return;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.content) {
                    fullContent += parsed.content;
                    contentDiv.innerHTML = renderMarkdown(fullContent);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                } catch (e) {
                  // 忽略解析錯誤
                }
              }
            }
          }
          
        } catch (error) {
          console.error('發送訊息錯誤:', error);
          
          // 移除載入動畫
          if (chatMessages.contains(typingIndicator)) {
            chatMessages.removeChild(typingIndicator);
          }
          
          // 顯示錯誤訊息
          const errorMessage = createChatGPTMessage('assistant', `抱歉，發生了錯誤：${error.message}`);
          chatMessages.appendChild(errorMessage);
        }
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // 強制清除快取並重新載入樣式
      function forceReloadStyles() {
        // 強制重新載入CSS
        const links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach(link => {
          const href = link.href;
          link.href = href + '?v=' + Date.now();
        });
        
        // 強制重新載入內聯樣式
        const style = document.querySelector('style');
        if (style) {
          style.innerHTML = style.innerHTML;
        }
      }
      
      // ===== ChatGPT 風格 AI 顧問功能 =====
      
      // 初始化 Markdown 渲染器
      function initMarkdownRenderer() {
        if (typeof marked !== 'undefined') {
          marked.setOptions({
            renderer: new marked.Renderer(),
            gfm: true,
            breaks: true,
            sanitize: false,
            langPrefix: 'hljs language-',
            highlight: function(code, lang) {
              if (typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return code;
            }
          });
        }
      }

      // 渲染 Markdown 內容
      function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
          return marked.parse(text);
        }
        return text.replace(/\n/g, '<br>');
      }

      // 創建聊天訊息元素
      function createMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (role === 'user') {
          // 嘗試載入Google用戶頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          avatarDiv.textContent = '🤖';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (role === 'assistant' && content) {
          contentDiv.innerHTML = safeRenderMarkdown(content);
          // 對代碼塊進行語法高亮
          if (typeof hljs !== 'undefined') {
            contentDiv.querySelectorAll('pre code').forEach((block) => {
              hljs.highlightElement(block);
            });
          }
        } else if (role === 'user') {
          contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }

      // 創建載入動畫
      function createTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = '🤖';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = `
          <div class="typing-indicator">
            <span>AI正在思考中</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        return messageDiv;
      }

      // 自動調整輸入框高度
      function autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
          
          // 更新發送按鈕狀態
          const sendBtn = document.getElementById('sendBtn');
          if (sendBtn) {
            sendBtn.disabled = textarea.value.trim() === '';
          }
        }
      }

      // 發送訊息（整合原有後端和LLM設定）
      async function sendMessage(message) {
        if (!message || !message.trim()) return;
        
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const quickButtons = document.getElementById('quickButtons');
        
        // 添加用戶訊息
        const userMessage = createMessage('user', message);
        chatMessages.appendChild(userMessage);
        
        // 記錄長期記憶（用戶訊息）
        try { 
          await recordConversationMessage('ai_advisor', 'user', message); 
        } catch (error) {
          console.error('❌❌❌ 長期記憶儲存異常 (AI 顧問 - user) ❌❌❌', error);
          console.error('錯誤堆疊:', error.stack);
        }
        
        // 隱藏快速按鈕
        if (quickButtons) {
          quickButtons.style.display = 'none';
        }
        
        // 清空輸入框並禁用
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        autoResizeTextarea();
        
        // 添加載入動畫
        const typingIndicator = createTypingIndicator();
        chatMessages.appendChild(typingIndicator);
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          // 使用原有的後端API和LLM設定
          const endpoint = 'https://api.aijob.com.tw/api/chat/stream';
          const headers = { 'Content-Type': 'application/json' };
          if (ipPlanningToken) {
            headers['Authorization'] = `Bearer ${ipPlanningToken}`;
          }
          
          // 安全地獲取設定值
          const safeSettingsApplied = typeof settingsApplied !== 'undefined' ? settingsApplied : false;
          const safeAppliedSettings = typeof appliedSettings !== 'undefined' ? appliedSettings : {};
          const safeStyleInstruction = typeof styleInstruction !== 'undefined' ? styleInstruction : null;
          
          const response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message: message,
              platform: safeSettingsApplied ? safeAppliedSettings.platform : null,
              topic: safeSettingsApplied ? safeAppliedSettings.topic : null,
              duration: safeSettingsApplied ? safeAppliedSettings.duration : null,
              style: safeStyleInstruction,
              profile: safeSettingsApplied ? safeAppliedSettings.positioning : null,
              history: [], // 保持現有的歷史記錄格式
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // 移除載入動畫
          chatMessages.removeChild(typingIndicator);
          
          // 創建AI回應容器
          const aiMessage = createMessage('assistant', '');
          chatMessages.appendChild(aiMessage);
          
          const contentDiv = aiMessage.querySelector('.message-content');
          
          // 處理串流回應
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let fullContent = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') {
                  // 記錄長期記憶（AI 回覆）
                  try { 
                    await recordConversationMessage('ai_advisor', 'assistant', fullContent); 
                  } catch (error) {
                    console.error('❌❌❌ 長期記憶儲存異常 (AI 顧問 - assistant) ❌❌❌', error);
                    console.error('錯誤堆疊:', error.stack);
                  }
                  
                  // 檢查是否需要顯示結果區塊
                  if (fullContent) {
                    checkIfScriptRequest(fullContent);
                  }
                  break;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.content) {
                    fullContent += parsed.content;
                    contentDiv.innerHTML = renderMarkdown(fullContent);
                    
                    // 對代碼塊進行語法高亮
                    if (typeof hljs !== 'undefined') {
                      contentDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                          hljs.highlightElement(block);
                        }
                      });
                    }
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                } catch (e) {
                  // 忽略解析錯誤
                }
              }
            }
          }
          
        } catch (error) {
          console.error('發送訊息錯誤:', error);
          
          // 移除載入動畫
          if (chatMessages.contains(typingIndicator)) {
            chatMessages.removeChild(typingIndicator);
          }
          
          // 顯示錯誤訊息
          const errorMessage = createMessage('assistant', `抱歉，發生了錯誤：${error.message}`);
          chatMessages.appendChild(errorMessage);
        }
        
        // 恢復輸入框和按鈕
        if (messageInput) {
        messageInput.disabled = false;
          messageInput.value = ''; // 確保輸入框是空的
          messageInput.style.height = 'auto'; // 重置高度
          autoResizeTextarea(); // 重新調整高度
        }
        if (sendBtn) {
        sendBtn.disabled = false;
        }
        
        // 滾動到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 初始化 ChatGPT 風格功能
      function initChatGPTFeatures() {
        try {
          // 只在AI顧問模式頁面才初始化
          const currentPage = document.querySelector('.page.active');
          if (!currentPage || currentPage.id !== 'mode2') {
            return;
          }
          
          
          // 強制清除快取
          forceReloadStyles();
          
          // 初始化 Markdown 渲染器
          initMarkdownRenderer();
        
          // 設置輸入框事件監聽器
          const messageInput = document.getElementById('messageInput');
          const sendBtn = document.getElementById('sendBtn');
          
          if (messageInput) {
            // 自動調整高度
            messageInput.addEventListener('input', autoResizeTextarea);
            
            // 鍵盤事件：Enter發送，Shift+Enter換行
            messageInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止默認的換行行為
                const message = messageInput.value.trim();
                if (message) {
                  sendMessage(message);
                }
              }
              // Shift+Enter 會讓默認換行行為生效，不需要特別處理
            });
          }
          
          // 設置發送按鈕事件
          if (sendBtn) {
            sendBtn.addEventListener('click', () => {
              const message = messageInput.value.trim();
              if (message) {
                sendMessage(message);
              }
            });
          }
          
          // 不自動載入歷史對話記錄（重新整理時已清空，用戶可通過按鈕主動載入）
          // loadMode2History();
          
          // 設置快速按鈕事件 - 只綁定到 mode2 的快速按鈕容器
          const quickButtons = document.getElementById('quickButtons');
          if (quickButtons && quickButtons.closest('#mode2')) {
            const quickBtns = quickButtons.querySelectorAll('.quick-btn');
            quickBtns.forEach(btn => {
              // 創建新的事件處理函數，確保只處理 mode2 的按鈕
              const handler = (e) => {
                e.stopPropagation(); // 防止事件冒泡
                const text = btn.getAttribute('data-text');
                if (text) {
                  sendMessage(text);
                }
              };
              // 移除舊的事件監聽器（如果存在）
              btn.removeEventListener('click', handler);
              btn.addEventListener('click', handler);
            });
          }
        } catch (error) {
          console.error('ChatGPT功能初始化錯誤:', error);
        }
      }
      
      // 顯示腳本列表（創作者資料庫版本）
      function displayScriptsForUserDB(scripts) {
        const container = document.querySelector('#db-myScripts .section-content');
        
        if (scripts.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有儲存的腳本</div>';
          return;
        }
        
        // 按時間排序：由舊到新（最早的為編號01，最新的編號最大）
        const sortedScripts = [...scripts].sort((a, b) => {
          const timeA = new Date(a.created_at || a.id || 0).getTime();
          const timeB = new Date(b.created_at || b.id || 0).getTime();
          return timeA - timeB; // 升序：小的（舊的）在前，編號01是最早的
        });
        
        container.innerHTML = sortedScripts.map((script, index) => `
          <div class="script-item" data-script-id="${script.id}">
            <div class="script-header" onclick="toggleScriptForUserDB(${script.id})">
              <div class="script-info">
                <span class="script-number">編號${String(index + 1).padStart(2, '0')}</span>
                <span class="script-name" onclick="editScriptNameForUserDB(${script.id}, event)">${script.name || script.title || '未命名腳本'}</span>
                <span class="script-date">${formatTaiwanTime(script.created_at)}</span>
              </div>
              <div class="script-toggle">
                <span class="toggle-icon">▼</span>
              </div>
            </div>
            <div class="script-content" id="script-${script.id}" style="display: none;">
              <div class="script-details">
                <div class="script-table">
                  <table>
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>段落</th>
                        <th>鏡頭/畫面</th>
                        <th>台詞 (演員口白)</th>
                        <th>字幕文字 (可動畫)</th>
                        <th>音效與轉場</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${generateScriptTable(script.script_data || script.content || script)}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="script-actions" id="actions-${script.id}" style="display: none;">
              <button class="action-btn view-btn" onclick="viewFullScriptForUserDB(${script.id})">查看完整結果</button>
              <button class="action-btn download-pdf-btn" onclick="downloadScriptPDF(${script.id})">下載PDF檔案</button>
              <button class="action-btn download-csv-btn" onclick="downloadScriptCSV(${script.id})">下載CSV檔案</button>
              <button class="action-btn delete-btn" onclick="deleteScriptForUserDB(${script.id})">刪除</button>
            </div>
          </div>
        `).join('');
      }
      
      // 切換腳本顯示（創作者資料庫版本）
      window.toggleScriptForUserDB = function(scriptId) {
        const scriptContent = document.getElementById(`script-${scriptId}`);
        const scriptActions = document.getElementById(`actions-${scriptId}`);
        const toggleIcon = document.querySelector(`[data-script-id="${scriptId}"] .toggle-icon`);
        const scriptHeader = document.querySelector(`[data-script-id="${scriptId}"] .script-header`);
        const scriptNumber = document.querySelector(`[data-script-id="${scriptId}"] .script-number`);
        
        if (!scriptContent || !scriptActions) {
          console.error('找不到腳本元素:', scriptId);
          return;
        }
        
        // 切換顯示狀態
        if (scriptContent.style.display === 'none' || !scriptContent.style.display) {
          scriptContent.style.display = 'block';
          scriptActions.style.display = 'flex';
          if (toggleIcon) toggleIcon.textContent = '▲';
          // 添加激活狀態樣式
          if (scriptHeader) scriptHeader.style.background = '#f0f9ff';
          if (scriptNumber) scriptNumber.style.background = '#2563eb';
        } else {
          scriptContent.style.display = 'none';
          scriptActions.style.display = 'none';
          if (toggleIcon) toggleIcon.textContent = '▼';
          // 移除激活狀態樣式
          if (scriptHeader) scriptHeader.style.background = '';
          if (scriptNumber) scriptNumber.style.background = '#3b82f6';
        }
      }
      
      // 編輯腳本名稱（創作者資料庫版本）
      window.editScriptNameForUserDB = function(scriptId, event) {
        if (event) event.stopPropagation();
        const scriptNameElement = document.querySelector(`[data-script-id="${scriptId}"] .script-name`);
        if (!scriptNameElement) {
          console.error('找不到腳本名稱元素:', scriptId);
          return;
        }
        const currentName = scriptNameElement.textContent;
        
        const newName = prompt('請輸入新的腳本名稱:', currentName);
        if (newName && newName.trim() !== '' && newName !== currentName) {
          updateScriptNameForUserDB(scriptId, newName.trim());
        }
      }
      
      // 更新腳本名稱（創作者資料庫版本）
      async function updateScriptNameForUserDB(scriptId, newName) {
        try {
          // 先更新本地顯示
          const scriptNameElement = document.querySelector(`[data-script-id="${scriptId}"] .script-name`);
          scriptNameElement.textContent = newName;
          
          // 更新本地儲存
          const localScripts = getLocalScripts();
          const scriptIndex = localScripts.findIndex(script => script.id == scriptId);
          if (scriptIndex !== -1) {
            localScripts[scriptIndex].name = newName;
            localStorage.setItem('user_scripts', JSON.stringify(localScripts));
          }
          
          // 嘗試更新後端（如果API存在）
          try {
            const response = await fetch(`https://api.aijob.com.tw/api/scripts/${scriptId}/name`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ name: newName })
            });
            
            if (response.ok) {
              showToast('腳本名稱已更新', 3000);
            } else {
              showToast('腳本名稱已更新（本地）', 3000);
            }
          } catch (apiError) {
            showToast('腳本名稱已更新（本地）', 3000);
          }
          
        } catch (error) {
          console.error('Update script name error:', error);
          showToast('更新失敗，請稍後再試', 3000);
        }
      }
      
      // 查看完整腳本（創作者資料庫版本）
      window.viewFullScriptForUserDB = function(scriptId) {
        // 獲取腳本數據（從本地或伺服器）
        const scripts = getLocalScripts();
        let script = scripts.find(s => s.id == scriptId);
        
        // 如果本地找不到，嘗試從 DOM 獲取
        if (!script) {
          const scriptItem = document.querySelector(`[data-script-id="${scriptId}"]`);
          if (scriptItem) {
            const scriptName = scriptItem.querySelector('.script-name')?.textContent || '未命名腳本';
            const scriptDate = scriptItem.querySelector('.script-date')?.textContent || '';
            const scriptTable = scriptItem.querySelector('table');
            
            // 從表格中提取數據
            if (scriptTable) {
              const rows = Array.from(scriptTable.querySelectorAll('tbody tr'));
              const scriptData = {
                rows: rows.map(row => {
                  const cells = row.querySelectorAll('td');
                  return {
                    time: cells[0]?.textContent || '-',
                    section: cells[1]?.textContent || '-',
                    shot_desc: cells[2]?.textContent || '-',
                    dialogue: cells[3]?.textContent || '-',
                    subtitle: cells[4]?.textContent || '-',
                    sfx: cells[5]?.textContent || '-'
                  };
                })
              };
              
              script = {
                id: scriptId,
                name: scriptName,
                created_at: scriptDate,
                script_data: scriptData
              };
            }
          }
        }
        
        if (!script) {
          showToast('找不到腳本數據', 3000);
          return;
        }
        
        // 創建彈出視窗
        const modal = document.createElement('div');
        modal.className = 'script-modal-overlay';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          padding: 20px;
          box-sizing: border-box;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 24px;
          max-width: 95%;
          max-height: 95%;
          overflow-y: auto;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
          position: relative;
        `;
        
        // 生成完整腳本內容
        let fullContent = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; flex-wrap: wrap; gap: 12px;">
            <div>
              <h2 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: 600;">${script.name || '未命名腳本'}</h2>
              ${script.created_at ? `<p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">${script.created_at}</p>` : ''}
            </div>
            <button onclick="this.closest('.script-modal-overlay').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">×</button>
          </div>
        `;
        
        // 處理新格式（有rows欄位）
        if (script.script_data && script.script_data.rows && script.script_data.rows.length > 0) {
          fullContent += `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                <thead>
                  <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; white-space: nowrap;">時間</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">段落</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">鏡頭/畫面</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">台詞 (演員口白)</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">字幕文字 (可動畫)</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">音效與轉場</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          script.script_data.rows.forEach((row, index) => {
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';
            // 正確處理時間欄位：優先使用 time，其次使用 start_sec-end_sec，最後使用 DOM 提取的 time
            let timeDisplay = '-';
            if (row.time && row.time !== 'undefined-undefineds' && row.time !== '-') {
              timeDisplay = row.time;
            } else if (row.start_sec !== undefined && row.end_sec !== undefined) {
              timeDisplay = `${row.start_sec}-${row.end_sec}s`;
            } else if (row.time && typeof row.time === 'string' && row.time.includes('-') && row.time.includes('s')) {
              timeDisplay = row.time;
            }
            fullContent += `
              <tr style="background: ${bgColor}; border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px; color: #1f2937; white-space: nowrap; font-weight: 500;">${timeDisplay}</td>
                <td style="padding: 12px; color: #4b5563;">${row.section || '-'}</td>
                <td style="padding: 12px; color: #4b5563; max-width: 200px;">${row.shot_desc || '-'}</td>
                <td style="padding: 12px; color: #4b5563; max-width: 300px;">${row.dialogue || '-'}</td>
                <td style="padding: 12px; color: #4b5563; max-width: 300px;">${row.subtitle || '-'}</td>
                <td style="padding: 12px; color: #4b5563;">${row.sfx || '-'}</td>
              </tr>
            `;
          });
          
          fullContent += `
                </tbody>
              </table>
            </div>
          `;
        } else if (script.script_data && script.script_data.sections && script.script_data.sections.length > 0) {
          // 處理舊格式（有sections欄位）
          fullContent += '<div style="margin-top: 16px;">';
          script.script_data.sections.forEach((section, index) => {
            fullContent += `
              <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <h3 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">${section.type || '內容段落'}</h3>
                <div style="color: #4b5563; line-height: 1.8;">
                  ${section.content ? section.content.map(content => `<p style="margin: 8px 0;">${content}</p>`).join('') : '<p>無內容</p>'}
                </div>
              </div>
            `;
          });
          fullContent += '</div>';
        } else {
          // 如果沒有結構化數據，顯示原始內容
          fullContent += `
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; color: #4b5563; margin-top: 16px;">
              ${script.content || script.script_data || '無內容'}
            </div>
          `;
        }
        
        modalContent.innerHTML = fullContent;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
        
        // ESC 鍵關閉
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      }
      
      // 刪除腳本（創作者資料庫版本）
      window.deleteScriptForUserDB = async function(scriptId) {
        if (!confirm('確定要刪除這個腳本嗎？此操作無法復原。')) {
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/scripts/${scriptId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
        
          if (response.ok) {
            // 從本地儲存中移除
        const localScripts = getLocalScripts();
        const updatedScripts = localScripts.filter(script => script.id != scriptId);
        localStorage.setItem('user_scripts', JSON.stringify(updatedScripts));
        
        // 重新載入腳本列表
        loadMyScriptsForUserDB();
            showToast('腳本已刪除', 3000);
          } else {
            throw new Error('刪除失敗');
          }
        } catch (error) {
          console.error('Delete script error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 載入個人資料庫的帳號定位記錄
      async function loadPositioningRecordsForUserDB() {
        const content = document.querySelector('#db-accountPositioning .section-content');
        
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看帳號定位記錄</div>';
          return;
        }
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入帳號定位記錄中...');
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            displayPositioningRecordsForUserDB(data.records || []);
          } else if (response.status === 401) {
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else if (response.status === 404) {
            content.innerHTML = '<div class="loading-text">帳號定位功能即將上線，請稍後再試</div>';
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load positioning records error:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 顯示帳號定位記錄（創作者資料庫版本）
      function displayPositioningRecordsForUserDB(records) {
        const container = document.querySelector('#db-accountPositioning .section-content');
        
        if (records.length === 0) {
          container.innerHTML = '<div class="loading-text">尚無帳號定位記錄</div>';
          return;
        }
        
        // 按時間排序：由新到舊（最新的在最上面）
        const sortedRecords = [...records].sort((a, b) => {
          const timeA = new Date(a.created_at || 0).getTime();
          const timeB = new Date(b.created_at || 0).getTime();
          return timeB - timeA; // 降序：大的（新的）在前
        });
        
        container.innerHTML = sortedRecords.map((record, index) => {
          // 編號從1開始（最新的為編號01）
          const recordNumber = String(index + 1).padStart(2, '0');
          const date = new Date(record.created_at).toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const preview = record.content.substring(0, 100) + (record.content.length > 100 ? '...' : '');
          
          return `
            <div class="positioning-record-item" data-record-id="${record.id}">
              <div class="record-header">
                <span class="record-number">編號 ${recordNumber}</span>
                <span class="record-date">${date}</span>
              </div>
              <div class="record-preview">${preview}</div>
              <div class="record-actions">
                <button class="action-btn view-btn" onclick="viewPositioningDetailForUserDB(${record.id}, '${recordNumber}')">查看完整結果</button>
                <button class="action-btn delete-btn" onclick="deletePositioningRecordForUserDB(${record.id})">刪除</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 查看帳號定位詳細內容（創作者資料庫版本）
      async function viewPositioningDetailForUserDB(recordId, recordNumber) {
        if (!ipPlanningUser?.user_id) return;
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const record = data.records.find(r => r.id === recordId);
            
            if (record) {
              // 創建彈出視窗顯示完整內容
              const modal = document.createElement('div');
              modal.className = 'modal-overlay';
              modal.innerHTML = `
                <div class="modal-content">
                  <div class="modal-header">
                    <h3>帳號定位詳細內容 - 編號 ${recordNumber}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                  </div>
                  <div class="modal-body">
                    <div class="record-detail">
                      <div class="detail-meta">
                        <span class="detail-label">建立時間：</span>
                        <span class="detail-value">${new Date(record.created_at).toLocaleString('zh-TW', {
                          timeZone: 'Asia/Taipei',
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}</span>
                      </div>
                      <div class="detail-content">
                        <div class="content-text">${record.content.replace(/\n/g, '<br>')}</div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="action-btn" onclick="this.closest('.modal-overlay').remove()">關閉</button>
                  </div>
                </div>
              `;
              
              document.body.appendChild(modal);
            } else {
              showToast('找不到該記錄', 3000);
            }
          } else {
            throw new Error('載入失敗');
          }
        } catch (error) {
          console.error('View positioning detail error:', error);
          showToast('載入失敗，請稍後再試', 3000);
        }
      }
      
      // 刪除帳號定位記錄（創作者資料庫版本）
      async function deletePositioningRecordForUserDB(recordId) {
        if (!confirm('確定要刪除這筆帳號定位記錄嗎？')) return;
        
        // 清理 recordId，移除可能的額外字符（如 :1 等）
        const cleanRecordId = String(recordId).split(':')[0].trim();
        
        if (!cleanRecordId) {
          console.error('無效的記錄ID:', recordId);
          showToast('刪除失敗：無效的記錄ID', 3000);
          return;
        }
        
        try {
          // 使用正確的 API 端點：/api/user/positioning/{recordId}
          const url = `https://api.aijob.com.tw/api/user/positioning/${cleanRecordId}`;
          
          const response = await fetch(url, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            showToast('記錄已刪除', 2000);
            // 重新載入列表
            await loadPositioningRecordsForUserDB();
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('刪除失敗，狀態碼:', response.status, 'URL:', url, '錯誤:', errorData);
            throw new Error(errorData.error || `刪除失敗 (${response.status})`);
          }
        } catch (error) {
          console.error('Delete positioning record error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 載入個人資料庫的選題內容（從 generations 表獲取實際選題內容）
      async function loadTopicHistoryForUserDB() {
        const content = document.querySelector('#db-topicRecords .section-content');
        
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看選題內容</div>';
          return;
        }
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入選題內容中...');
        
        try {
          // 從後端獲取選題生成記錄（generations 表）
          const response = await fetch(`https://api.aijob.com.tw/api/generations/${ipPlanningUser.user_id}?limit=100`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            // 過濾出選題相關的生成內容（根據 topic 欄位或 content 內容判斷）
            const topicGenerations = (data.generations || []).filter(gen => {
              // 如果 topic 欄位有值，或者 content 包含選題相關關鍵字
              return gen.topic || 
                     (gen.content && (
                       gen.content.includes('選題') || 
                       gen.content.includes('主題') ||
                       gen.content.includes('推薦') ||
                       gen.content.includes('熱門')
                     ));
            });
            displayTopicRecordsForUserDB(topicGenerations);
          } else if (response.status === 401) {
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else {
            content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
          }
        } catch (error) {
          console.error('載入選題內容錯誤:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 載入 IP 人設規劃結果
      async function loadIpPlanningResultsForUserDB() {
        const content = document.getElementById('ip-planning-content');
        
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看 IP 人設規劃結果</div>';
          return;
        }
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入 IP 人設規劃結果中...');
        
        try {
          // 先獲取帳號定位名稱
          let positioningName = '帳號定位';
          try {
            const positioningResponse = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`,
                'Content-Type': 'application/json'
              }
            });
            if (positioningResponse.ok) {
              const positioningData = await positioningResponse.json();
              if (positioningData.records && positioningData.records.length > 0) {
                // 從最新的帳號定位記錄中提取名稱
                const latestRecord = positioningData.records[0];
                const contentText = latestRecord.content || '';
                // 嘗試提取帳號定位名稱（通常在內容開頭或標題中）
                const nameMatch = contentText.match(/(?:帳號定位|定位名稱|IP定位)[：:]\s*([^\n]+)/i) || 
                                 contentText.match(/(?:^|\n)([^：:\n]+)[：:]\s*帳號定位/i) ||
                                 contentText.match(/^([^：:\n]+)/);
                if (nameMatch && nameMatch[1]) {
                  positioningName = nameMatch[1].trim().substring(0, 30);
                }
              }
            }
          } catch (e) {
          }
          
          // 主標題已改為固定「IP人設規劃」，不再需要編輯功能
          
          // 獲取 IP 人設規劃結果
          const response = await fetch('https://api.aijob.com.tw/api/ip-planning/my', {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.results) {
              // 保存結果供匯出使用
              window.currentIpPlanningResults = data.results;
              displayIpPlanningResultsForUserDB(data.results);
            } else {
              content.innerHTML = '<div class="loading-text">尚無 IP 人設規劃結果</div>';
            }
          } else if (response.status === 401) {
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else {
            content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
          }
        } catch (error) {
          console.error('載入 IP 人設規劃結果錯誤:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 主標題已改為固定「IP人設規劃」，不再需要編輯功能
      // editIpPlanningTitle 和 saveIpPlanningTitle 函數已移除
      
      // 編輯 IP 人設規劃項目標題（每個欄位的標題）
      window.editIpPlanningItemTitle = function(resultId, event) {
        if (event) event.stopPropagation();
        
        const titleElement = document.querySelector(`.ip-planning-item-title[data-result-id="${resultId}"]`);
        const inputElement = document.querySelector(`.ip-planning-item-title-input[data-result-id="${resultId}"]`);
        const editIcon = document.querySelector(`.ip-planning-item-edit-icon[data-result-id="${resultId}"]`);
        
        if (titleElement && inputElement) {
          // 獲取當前標題
          const currentTitle = titleElement.textContent.trim();
          inputElement.value = currentTitle;
          
          // 切換顯示
          titleElement.style.display = 'none';
          if (editIcon) editIcon.style.display = 'none';
          inputElement.style.display = 'block';
          
          // 聚焦並選中文字
          inputElement.focus();
          inputElement.select();
        }
      }
      
      // 保存 IP 人設規劃項目標題
      window.saveIpPlanningItemTitle = function(resultId) {
        const titleElement = document.querySelector(`.ip-planning-item-title[data-result-id="${resultId}"]`);
        const inputElement = document.querySelector(`.ip-planning-item-title-input[data-result-id="${resultId}"]`);
        const editIcon = document.querySelector(`.ip-planning-item-edit-icon[data-result-id="${resultId}"]`);
        
        if (titleElement && inputElement) {
          const newTitle = inputElement.value.trim();
          
          // 如果為空，使用預設標題（根據類型）
          const item = document.querySelector(`.ip-planning-item[data-result-id="${resultId}"]`);
          let defaultTitle = 'IP Profile';
          if (item) {
            const activeTab = document.querySelector('.ip-planning-tab.active');
            if (activeTab) {
              if (activeTab.textContent.includes('規劃')) {
                defaultTitle = '14天規劃';
              } else if (activeTab.textContent.includes('腳本')) {
                defaultTitle = '今日腳本';
              }
            }
          }
          
          const finalTitle = newTitle || defaultTitle;
          
          // 更新標題顯示
          titleElement.textContent = finalTitle;
          
          // 保存到 localStorage
          if (ipPlanningUser && ipPlanningUser.user_id) {
            localStorage.setItem(`ip-planning-item-title-${ipPlanningUser.user_id}-${resultId}`, finalTitle);
          }
          
          if (newTitle) {
            showToast('✅ 標題已更新', 2000);
          }
          
          // 切換顯示
          titleElement.style.display = '';
          if (editIcon) {
            editIcon.style.display = 'none';
            editIcon.style.opacity = '0.6';
          }
          inputElement.style.display = 'none';
        }
      }
      
      // 編輯我的腳本標題
      function editMyScriptsTitle() {
        const titleElement = document.getElementById('my-scripts-title');
        const inputElement = document.getElementById('my-scripts-title-input');
        const editIcon = document.getElementById('my-scripts-edit-icon');
        
        if (titleElement && inputElement) {
          // 獲取當前標題（去除 emoji）
          const currentTitle = titleElement.textContent.replace(/^💾\s*/, '');
          inputElement.value = currentTitle;
          
          // 切換顯示
          titleElement.style.display = 'none';
          editIcon.style.display = 'none';
          inputElement.style.display = 'block';
          
          // 聚焦並選中文字
          inputElement.focus();
          inputElement.select();
        }
      }
      
      // 保存我的腳本標題
      function saveMyScriptsTitle() {
        const titleElement = document.getElementById('my-scripts-title');
        const inputElement = document.getElementById('my-scripts-title-input');
        const editIcon = document.getElementById('my-scripts-edit-icon');
        
        if (titleElement && inputElement) {
          const newTitle = inputElement.value.trim();
          
          // 如果為空，使用預設標題
          const finalTitle = newTitle || '在此輸入你的標題';
          
            // 更新標題顯示
          titleElement.textContent = `💾 ${finalTitle}`;
            
            // 保存到 localStorage
            if (ipPlanningUser && ipPlanningUser.user_id) {
            localStorage.setItem(`my-scripts-title-${ipPlanningUser.user_id}`, finalTitle);
            }
            
          if (newTitle) {
            showToast('✅ 標題已更新', 2000);
          }
          
          // 切換顯示
          titleElement.style.display = '';
          editIcon.style.display = '';
          inputElement.style.display = 'none';
        }
      }
      
      // 匯出 IP 人設規劃結果
      function exportIpPlanningResults() {
        if (!window.currentIpPlanningResults || window.currentIpPlanningResults.length === 0) {
          showToast('沒有可匯出的內容', 3000);
          return;
        }
        
        try {
          // 獲取當前選中的類型
          const activeTab = document.querySelector('.ip-planning-tab.active');
          let currentType = 'all';
          if (activeTab) {
            if (activeTab.textContent.includes('Profile')) {
              currentType = 'profile';
            } else if (activeTab.textContent.includes('規劃')) {
              currentType = 'plan';
            } else if (activeTab.textContent.includes('腳本')) {
              currentType = 'scripts';
            }
          }
          
          // 篩選當前類型的結果
          const filteredResults = currentType === 'all' 
            ? window.currentIpPlanningResults 
            : window.currentIpPlanningResults.filter(r => r.result_type === currentType);
          
          if (filteredResults.length === 0) {
            showToast('當前類型沒有可匯出的內容', 3000);
            return;
          }
          
          // 生成 CSV 內容
          let csvContent = '類型,標題,內容,創建時間\n';
          filteredResults.forEach(result => {
            const typeName = result.result_type === 'profile' ? 'IP Profile' : 
                           result.result_type === 'plan' ? '14天規劃' : '今日腳本';
            const textContent = (result.content || '').replace(/<[^>]*>/g, '').replace(/"/g, '""').replace(/\n/g, ' ');
            const title = (result.title || typeName).replace(/"/g, '""');
            const date = result.created_at ? new Date(result.created_at).toLocaleString('zh-TW', {
              timeZone: 'Asia/Taipei',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            }) : '';
            csvContent += `"${typeName}","${title}","${textContent}","${date}"\n`;
          });
          
          // 創建 CSV 檔案
          const csvBlob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const csvUrl = URL.createObjectURL(csvBlob);
          const csvLink = document.createElement('a');
          csvLink.href = csvUrl;
          csvLink.download = `ip-planning-${currentType}-${Date.now()}.csv`;
          csvLink.click();
          URL.revokeObjectURL(csvUrl);
          
          showToast('✅ 結果已匯出為 CSV 檔案', 3000);
        } catch (error) {
          console.error('匯出失敗:', error);
          showToast('❌ 匯出失敗，請稍後再試', 3000);
        }
      }
      
      // 顯示 IP 人設規劃結果
      function displayIpPlanningResultsForUserDB(results) {
        const content = document.getElementById('ip-planning-content');
        
        if (results.length === 0) {
          content.innerHTML = '<div class="loading-text">尚無 IP 人設規劃結果</div>';
          return;
        }
        
        // 先按時間排序：由新到舊（最新的在最上面）
        const sortedResults = [...results].sort((a, b) => {
          const timeA = new Date(a.created_at || 0).getTime();
          const timeB = new Date(b.created_at || 0).getTime();
          return timeB - timeA; // 降序：大的（新的）在前
        });
        
        // 按類型分組（已排序）
        const groupedResults = {
          profile: sortedResults.filter(r => r.result_type === 'profile'),
          plan: sortedResults.filter(r => r.result_type === 'plan'),
          scripts: sortedResults.filter(r => r.result_type === 'scripts')
        };
        
        // 顯示當前選中的類型
        const activeTab = document.querySelector('.ip-planning-tab.active');
        let currentType = 'profile';
        if (activeTab) {
          if (activeTab.textContent.includes('Profile')) {
            currentType = 'profile';
          } else if (activeTab.textContent.includes('規劃')) {
            currentType = 'plan';
          } else if (activeTab.textContent.includes('腳本')) {
            currentType = 'scripts';
          }
        }
        
        const currentResults = groupedResults[currentType] || [];
        
        if (currentResults.length === 0) {
          const typeText = currentType === 'profile' ? 'IP Profile' : currentType === 'plan' ? '14天規劃' : '今日腳本';
          const safeTypeText = escapeHtml(typeText);
          content.innerHTML = `<div class="loading-text">尚無${safeTypeText}記錄</div>`;
          return;
        }
        
        content.innerHTML = currentResults.map((result, index) => {
          const date = formatTaiwanTime(result.created_at);
          // 檢查是否有保存的自定義標題
          let savedTitle = '';
          if (ipPlanningUser && ipPlanningUser.user_id) {
            savedTitle = localStorage.getItem(`ip-planning-item-title-${ipPlanningUser.user_id}-${result.id}`);
          }
          const defaultTitle = currentType === 'profile' ? 'IP Profile' : currentType === 'plan' ? '14天規劃' : '今日腳本';
          const title = savedTitle || result.title || defaultTitle;
          // 轉義用戶輸入防止 XSS
          const safeTitle = escapeHtml(title);
          const safeDate = escapeHtml(date);
          // result.content 可能包含 HTML（來自 AI 生成），需要安全處理
          let safeContent = '';
          if (result.content) {
            const contentStr = String(result.content);
            // 如果包含 HTML 標籤，使用 safeRenderMarkdown 或轉義
            if (/<[^>]+>/.test(contentStr)) {
              // 包含 HTML，使用安全渲染
              if (typeof safeRenderMarkdown !== 'undefined') {
                safeContent = safeRenderMarkdown(contentStr);
              } else {
                // 降級：轉義所有 HTML
                safeContent = escapeHtml(contentStr).replace(/\n/g, '<br>');
              }
            } else {
              // 純文字，轉義並保留換行
              safeContent = escapeHtml(contentStr).replace(/\n/g, '<br>');
            }
          }
          return `
            <div class="ip-planning-item" data-result-id="${result.id}" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="ip-planning-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                  <h4 class="ip-planning-item-title" data-result-id="${result.id}" style="margin: 0; color: #1F2937; font-size: 1.1rem; cursor: pointer; position: relative; padding-right: 24px;" onclick="editIpPlanningItemTitle(${result.id}, event)" title="點擊編輯標題">${safeTitle}</h4>
                  <span class="ip-planning-item-edit-icon" data-result-id="${result.id}" style="cursor: pointer; color: #6B7280; font-size: 0.9rem; opacity: 0.6; transition: opacity 0.2s; display: none;" onclick="editIpPlanningItemTitle(${result.id}, event)" title="編輯標題" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">✏️</span>
                  <input type="text" class="ip-planning-item-title-input" data-result-id="${result.id}" style="display: none; flex: 1; padding: 6px 12px; border: 2px solid #3B82F6; border-radius: 6px; font-size: 1.1rem; font-weight: 600; outline: none; max-width: 300px;" onblur="saveIpPlanningItemTitle(${result.id})" onkeypress="if(event.key === 'Enter') saveIpPlanningItemTitle(${result.id})">
                </div>
                <span style="color: #6B7280; font-size: 0.9rem;">${safeDate}</span>
              </div>
              <div class="ip-planning-content-item" style="color: #374151; line-height: 1.6; max-height: 300px; overflow-y: auto;">
                ${safeContent}
              </div>
            </div>
          `;
        }).join('');
        
        // 為每個項目添加 hover 效果顯示編輯圖標
        document.querySelectorAll('.ip-planning-item').forEach(item => {
          const titleEl = item.querySelector('.ip-planning-item-title');
          const editIcon = item.querySelector('.ip-planning-item-edit-icon');
          if (titleEl && editIcon) {
            item.addEventListener('mouseenter', () => {
              editIcon.style.display = 'inline-block';
            });
            item.addEventListener('mouseleave', () => {
              const inputEl = item.querySelector('.ip-planning-item-title-input');
              if (!inputEl || inputEl.style.display === 'none') {
                editIcon.style.display = 'none';
              }
            });
          }
        });
      }
      
      // 切換 IP 人設規劃類型
      function showIpPlanningType(type) {
        // 更新標籤狀態
        document.querySelectorAll('.ip-planning-tab').forEach(tab => {
          tab.classList.remove('active');
          tab.style.borderBottom = 'none';
          tab.style.color = '#6B7280';
          tab.style.fontWeight = 'normal';
        });
        
        // 找到對應的標籤
        const tabs = document.querySelectorAll('.ip-planning-tab');
        let targetTab = null;
        if (type === 'profile') {
          targetTab = Array.from(tabs).find(tab => tab.textContent.includes('Profile'));
        } else if (type === 'plan') {
          targetTab = Array.from(tabs).find(tab => tab.textContent.includes('規劃'));
        } else if (type === 'scripts') {
          targetTab = Array.from(tabs).find(tab => tab.textContent.includes('腳本'));
        }
        
        if (targetTab) {
          targetTab.classList.add('active');
          targetTab.style.borderBottom = '2px solid #3B82F6';
          targetTab.style.color = '#3B82F6';
          targetTab.style.fontWeight = '600';
        }
        
        // 重新載入並顯示該類型的結果
        loadIpPlanningResultsForUserDB();
      }
      
      // 解析選題內容為5個欄位
      function parseTopicContent(content) {
        if (!content) {
          return {
            hotTopics: '',
            specificSuggestions: '',
            strategies: '',
            contentPlanning: '',
            timeline: ''
          };
        }
        
        const sections = {
          hotTopics: '',
          specificSuggestions: '',
          strategies: '',
          contentPlanning: '',
          timeline: ''
        };
        
        // 使用正則表達式匹配各個欄位
        const patterns = {
          hotTopics: /(熱門選題方向|選題方向|熱門話題|熱門選題)[:：]?\s*([\s\S]*?)(?=(選題的具體建議|選題策略|內容規劃|執行時程|$))/i,
          specificSuggestions: /(選題的具體建議|具體建議|每個選題的具體建議|選題建議)[:：]?\s*([\s\S]*?)(?=(選題策略|內容規劃|執行時程|$))/i,
          strategies: /(選題策略和技巧|選題策略|策略和技巧|選題技巧)[:：]?\s*([\s\S]*?)(?=(內容規劃|執行時程|$))/i,
          contentPlanning: /(內容規劃建議|內容規劃|規劃建議)[:：]?\s*([\s\S]*?)(?=(執行時程|時程建議|$))/i,
          timeline: /(執行時程建議|時程建議|執行時程|時程)[:：]?\s*([\s\S]*?)$/i
        };
        
        // 嘗試匹配各個欄位
        for (const [key, pattern] of Object.entries(patterns)) {
          const match = content.match(pattern);
          if (match && match[2]) {
            let extracted = match[2].trim();
            
            // 清理提取的內容：移除開頭的標題重複和格式符號
            // 移除可能重複的標題（如 "1. 熱門選題方向："）
            extracted = extracted.replace(/^(1|一)[\.、]?\s*(熱門選題方向|選題方向|熱門話題|熱門選題)[:：]?\s*/i, '');
            extracted = extracted.replace(/^(2|二)[\.、]?\s*(具體建議|選題的具體建議|選題建議)[:：]?\s*/i, '');
            extracted = extracted.replace(/^(3|三)[\.、]?\s*(策略|選題策略|技巧)[:：]?\s*/i, '');
            extracted = extracted.replace(/^(4|四)[\.、]?\s*(內容規劃)[:：]?\s*/i, '');
            extracted = extracted.replace(/^(5|五)[\.、]?\s*(時程|執行時程)[:：]?\s*/i, '');
            
            // 移除開頭的數字標記（如 "1. "、"2. "）
            extracted = extracted.replace(/^\d+[\.、]\s*/, '');
            
            // 移除多餘的空白行
            extracted = extracted.replace(/\n{3,}/g, '\n\n');
            
            // 移除開頭和結尾的空白
            extracted = extracted.trim();
            
            sections[key] = extracted;
          }
        }
        
        // 如果沒有匹配到，嘗試按數字標記分割（1. 2. 3. 等）
        if (!sections.hotTopics && !sections.specificSuggestions) {
          const lines = content.split(/\n/);
          let currentSection = '';
          let currentKey = '';
          
          for (const line of lines) {
            if (/^(1|一)[\.、]?\s*(熱門選題|選題方向)/i.test(line)) {
              currentKey = 'hotTopics';
              currentSection = line.replace(/^(1|一)[\.、]?\s*(熱門選題|選題方向)[:：]?\s*/i, '').trim() + '\n';
            } else if (/^(2|二)[\.、]?\s*(具體建議|選題的具體)/i.test(line)) {
              currentKey = 'specificSuggestions';
              currentSection = line.replace(/^(2|二)[\.、]?\s*(具體建議|選題的具體)[:：]?\s*/i, '').trim() + '\n';
            } else if (/^(3|三)[\.、]?\s*(策略|技巧)/i.test(line)) {
              currentKey = 'strategies';
              currentSection = line.replace(/^(3|三)[\.、]?\s*(策略|技巧)[:：]?\s*/i, '').trim() + '\n';
            } else if (/^(4|四)[\.、]?\s*(內容規劃)/i.test(line)) {
              currentKey = 'contentPlanning';
              currentSection = line.replace(/^(4|四)[\.、]?\s*(內容規劃)[:：]?\s*/i, '').trim() + '\n';
            } else if (/^(5|五)[\.、]?\s*(時程|執行)/i.test(line)) {
              currentKey = 'timeline';
              currentSection = line.replace(/^(5|五)[\.、]?\s*(時程|執行)[:：]?\s*/i, '').trim() + '\n';
            } else if (currentKey && line.trim()) {
              currentSection += line + '\n';
            }
            
            if (currentKey && currentSection) {
              sections[currentKey] = currentSection.trim();
            }
          }
        }
        
        // 如果還是沒有匹配到，就將全部內容放在第一個欄位
        if (!sections.hotTopics && !sections.specificSuggestions && !sections.strategies && !sections.contentPlanning && !sections.timeline) {
          sections.hotTopics = content;
        }
        
        return sections;
      }
      
      // 顯示選題內容（創作者資料庫版本）- 按照5個欄位分類顯示
      function displayTopicRecordsForUserDB(generations) {
        const container = document.querySelector('#db-topicRecords .section-content');
        
        if (generations.length === 0) {
          container.innerHTML = '<div class="loading-text">尚無選題內容</div>';
          return;
        }
        
        // 按時間排序：由新到舊（最新的在最上面）
        const sortedGenerations = [...generations].sort((a, b) => {
          const timeA = new Date(a.created_at || 0).getTime();
          const timeB = new Date(b.created_at || 0).getTime();
          return timeB - timeA; // 降序：大的（新的）在前
        });
        
        container.innerHTML = sortedGenerations.map((gen, index) => {
          const date = formatTaiwanTime(gen.created_at);
          const platform = gen.platform || '';
          const topic = gen.topic || '';
          
          // 解析選題內容為5個欄位
          const sections = parseTopicContent(gen.content);
          
          // 獲取該項目的標題（從localStorage或使用預設）
          const itemTitleKey = `topic-item-title-${gen.id || gen.created_at || index}`;
          const savedItemTitle = localStorage.getItem(itemTitleKey);
          const itemTitle = savedItemTitle || '在此輸入你的標題';
          
          // 格式化內容顯示（清理 Markdown 和格式符號）
          const formatText = (text) => {
            if (!text) return '無內容';
            
            // 清理內容：移除多餘的格式符號和標記
            let cleaned = text;
            
            // 1. 移除多餘的空白行（3個以上連續換行）
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
            
            // 2. 清理 Markdown 格式
            // 移除單獨的 ** 或 * 符號（但保留用於強調的）
            cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>'); // **文字** → <strong>文字</strong>
            cleaned = cleaned.replace(/\*([^*\n]+)\*/g, '<em>$1</em>'); // *文字* → <em>文字</em>
            cleaned = cleaned.replace(/`([^`]+)`/g, '<code>$1</code>'); // `文字` → <code>文字</code>
            
            // 3. 清理 Markdown 標題格式
            cleaned = cleaned.replace(/^#{1,6}\s*(.+)$/gm, '<strong>$1</strong>'); // # 標題 → <strong>標題</strong>
            
            // 4. 清理列表格式，統一為有序列表
            // 處理數字列表（1. 2. 3.）
            cleaned = cleaned.replace(/^(\d+)[\.、]\s*(.+)$/gm, '<div style="margin: 6px 0; padding-left: 8px;">$1. $2</div>');
            // 處理項目符號列表（- * •）
            cleaned = cleaned.replace(/^[-*•]\s*(.+)$/gm, '<div style="margin: 6px 0; padding-left: 8px;">• $1</div>');
            
            // 5. 清理多餘的標記符號和分隔線
            cleaned = cleaned.replace(/^[-=*]{3,}$/gm, ''); // 移除分隔線
            cleaned = cleaned.replace(/^[●○■□]\s*/gm, ''); // 移除開頭的項目符號（如果已經處理過）
            
            // 6. 清理多餘的空白
            cleaned = cleaned.replace(/[ \t]+/g, ' '); // 多個空白變一個
            cleaned = cleaned.trim();
            
            // 7. 處理換行：保留段落結構
            cleaned = cleaned.replace(/\n\n+/g, '</p><p style="margin: 8px 0;">'); // 多個換行 → 段落分隔
            cleaned = cleaned.replace(/\n/g, '<br>'); // 單換行 → 換行標籤
            
            // 8. 包裝在段落標籤中
            if (cleaned && !cleaned.startsWith('<')) {
              cleaned = '<p style="margin: 4px 0;">' + cleaned + '</p>';
            }
            
            return cleaned;
          };
          
          return `
            <div class="topic-item" data-topic-id="${gen.id || gen.created_at || index}" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="topic-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                  <span class="topic-number" style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; width: 60px; min-width: 60px; max-width: 60px; text-align: center; white-space: nowrap; display: inline-block; box-sizing: border-box;">編號${String(index + 1).padStart(2, '0')}</span>
                  <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <h4 class="topic-item-title" data-title-key="${itemTitleKey}" style="margin: 0; color: #1f2937; font-size: 1rem; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onclick="editTopicItemTitle(this, '${itemTitleKey}')" title="點擊編輯標題">${itemTitle}</h4>
                    <span class="topic-edit-icon" style="cursor: pointer; color: #6B7280; font-size: 0.8rem; opacity: 0.6; transition: opacity 0.2s;" onclick="editTopicItemTitle(this.previousElementSibling, '${itemTitleKey}')" title="編輯標題" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">✏️</span>
              </div>
                </div>
                <span class="topic-date" style="color: #6b7280; font-size: 14px;">${date}</span>
              </div>
              ${platform || topic ? `
              <div class="topic-meta" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                ${platform ? `<span style="background: #f3f4f6; color: #374151; padding: 4px 12px; border-radius: 4px; font-size: 12px;">平台：${platform}</span>` : ''}
                ${topic ? `<span style="background: #f3f4f6; color: #374151; padding: 4px 12px; border-radius: 4px; font-size: 12px;">主題：${topic}</span>` : ''}
              </div>
              ` : ''}
              <div class="topic-content-sections" style="display: flex; flex-direction: column; gap: 16px;">
                ${sections.hotTopics ? `
                <div class="topic-section" data-section-id="hotTopics-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #3b82f6; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('hotTopics-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">🔥 熱門選題方向</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="hotTopics-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(sections.hotTopics)}</div>
                </div>
                ` : ''}
                ${sections.specificSuggestions ? `
                <div class="topic-section" data-section-id="specificSuggestions-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #10b981; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('specificSuggestions-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">💡 選題的具體建議</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="specificSuggestions-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(sections.specificSuggestions)}</div>
                </div>
                ` : ''}
                ${sections.strategies ? `
                <div class="topic-section" data-section-id="strategies-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #f59e0b; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('strategies-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">📋 選題策略和技巧</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="strategies-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(sections.strategies)}</div>
                </div>
                ` : ''}
                ${sections.contentPlanning ? `
                <div class="topic-section" data-section-id="contentPlanning-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #8b5cf6; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('contentPlanning-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">📅 內容規劃建議</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="contentPlanning-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(sections.contentPlanning)}</div>
                </div>
                ` : ''}
                ${sections.timeline ? `
                <div class="topic-section" data-section-id="timeline-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #ef4444; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('timeline-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">⏰ 執行時程建議</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="timeline-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(sections.timeline)}</div>
                </div>
                ` : ''}
                ${!sections.hotTopics && !sections.specificSuggestions && !sections.strategies && !sections.contentPlanning && !sections.timeline ? `
                <div class="topic-section" data-section-id="default-${gen.id || index}" style="background: #f9fafb; border-left: 3px solid #6b7280; border-radius: 4px; overflow: hidden;">
                  <div class="topic-section-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; user-select: none;" onclick="toggleTopicSection('default-${gen.id || index}')">
                    <h5 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">📄 內容</h5>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="topic-section-toggle" style="font-size: 12px; color: #6b7280;">▼</span>
                    </div>
                  </div>
                  <div class="topic-section-content" id="default-${gen.id || index}-content" style="padding: 0 12px 12px 12px; color: #374151; line-height: 1.6; font-size: 14px; display: block;">${formatText(gen.content)}</div>
                </div>
                ` : ''}
              </div>
              <div class="topic-item-actions" style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <button class="action-btn delete-btn" onclick="deleteTopicRecordForUserDB('${gen.id || gen.created_at || index}', '${itemTitle}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">🗑️ 刪除</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 編輯選題項目標題
      window.editTopicItemTitle = function(titleElement, titleKey) {
        if (!titleElement || !titleKey) return;
        
        const currentTitle = titleElement.textContent.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.style.cssText = 'padding: 4px 8px; border: 2px solid #3B82F6; border-radius: 4px; font-size: 1rem; font-weight: 600; outline: none; width: 100%; max-width: 300px;';
        
        const saveTitle = () => {
          const newTitle = input.value.trim() || '在此輸入你的標題';
          titleElement.textContent = newTitle;
          localStorage.setItem(titleKey, newTitle);
          input.replaceWith(titleElement);
          if (input.value.trim()) {
            showToast('✅ 標題已更新', 2000);
          }
        };
        
        input.addEventListener('blur', saveTitle);
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            saveTitle();
          }
        });
        
        titleElement.replaceWith(input);
        input.focus();
        input.select();
      };
      
      // 切換選題欄位的展開/收起狀態
      window.toggleTopicSection = function(sectionId) {
        const contentElement = document.getElementById(`${sectionId}-content`);
        const toggleElement = document.querySelector(`[data-section-id="${sectionId}"] .topic-section-toggle`);
        
        if (!contentElement || !toggleElement) return;
        
        const isExpanded = contentElement.style.display !== 'none';
        
        if (isExpanded) {
          contentElement.style.display = 'none';
          toggleElement.textContent = '▶';
        } else {
          contentElement.style.display = 'block';
          toggleElement.textContent = '▼';
        }
      };
      
      // 刪除選題記錄（創作者資料庫版本）
      window.deleteTopicRecordForUserDB = async function(genId, itemTitle) {
        const confirmMessage = `確定要刪除「${itemTitle}」這個選題記錄嗎？此操作無法復原。`;
        if (!confirm(confirmMessage)) {
          return;
        }
        
        try {
          // 嘗試從後端刪除（如果後端有API）
          if (ipPlanningToken && ipPlanningUser && ipPlanningUser.user_id) {
            const response = await fetch(`https://api.aijob.com.tw/api/generations/${genId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
              showToast('選題記錄已刪除', 3000);
              // 重新載入選題列表
              await loadTopicHistoryForUserDB();
              return;
            } else if (response.status !== 404) {
              // 如果後端沒有這個API，則只從前端移除
              console.warn('後端刪除API不存在或失敗，僅從前端移除');
            }
          }
          
          // 如果後端沒有API或刪除失敗，僅從前端移除該項目
          const topicItem = document.querySelector(`[data-topic-id="${genId}"]`) || 
                           document.querySelector(`.topic-item:has([onclick*="${genId}"])`);
          
          if (topicItem) {
            topicItem.remove();
            showToast('選題記錄已從列表中移除', 3000);
          } else {
            // 如果找不到元素，重新載入列表
            await loadTopicHistoryForUserDB();
            showToast('選題記錄已刪除', 3000);
          }
        } catch (error) {
          console.error('Delete topic record error:', error);
          // 即使出錯，也嘗試從前端移除
          const topicItem = document.querySelector(`[data-topic-id="${genId}"]`) || 
                           document.querySelector(`.topic-item:has([onclick*="${genId}"])`);
          if (topicItem) {
            topicItem.remove();
            showToast('選題記錄已從列表中移除', 3000);
          } else {
            showToast('刪除失敗，請稍後再試', 3000);
          }
        }
      };
      
      // 載入使用統計
      async function loadUsageStatsForUserDB() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          return;
        }
        
        try {
          // 獲取腳本數
          const scripts = getLocalScripts();
          document.getElementById('totalScripts').textContent = scripts.length;
          
          // 獲取帳號定位數
          const positioningResponse = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
            headers: {'Authorization': `Bearer ${ipPlanningToken}`}
          });
          if (positioningResponse.ok) {
            const positioningData = await positioningResponse.json();
            document.getElementById('totalPositioning').textContent = positioningData.records?.length || 0;
          }
          
          // 獲取對話數
          const convResponse = await fetch(`https://api.aijob.com.tw/api/user/conversations/${ipPlanningUser.user_id}`, {
            headers: {'Authorization': `Bearer ${ipPlanningToken}`}
          });
          if (convResponse.ok) {
            const convData = await convResponse.json();
            const topicRecords = convData.conversations?.filter(c => c.mode?.includes('選題') || c.conversation_type === 'topic_selection') || [];
            document.getElementById('totalTopics').textContent = topicRecords.length;
            document.getElementById('totalConversations').textContent = convData.conversations?.length || 0;
          }
        } catch (error) {
          console.error('載入統計失敗:', error);
        }
      }
      
      // 載入我的訂單（創作者資料庫版本）
      async function loadMyOrdersForUserDB() {
        const content = document.querySelector('#myOrdersContent');
        if (!content) return;
        
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          content.innerHTML = '<div class="loading-text">請先登入以查看訂單記錄</div>';
          return;
        }
        
        // 顯示載入動畫
        showLoadingAnimation(content, '載入訂單記錄中...');
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/user/orders', {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const orders = data.orders || [];
            displayOrdersForUserDB(orders);
          } else if (response.status === 401) {
            content.innerHTML = '<div class="loading-text">請先登入</div>';
          } else {
            const errorData = await response.json().catch(() => ({ error: '載入失敗' }));
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('載入訂單失敗:', error);
          content.innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 顯示訂單列表（創作者資料庫版本）
      function displayOrdersForUserDB(orders) {
        const container = document.querySelector('#myOrdersContent');
        if (!container) return;
        
        if (orders.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
              <p style="color: #6b7280; font-size: 16px; margin-bottom: 24px;">尚無訂單記錄</p>
              <a href="/subscription.html" style="display: inline-block; padding: 12px 24px; background: #3B82F6; color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                前往訂閱
              </a>
            </div>
          `;
          return;
        }
        
        // 按時間排序：由新到舊
        const sortedOrders = [...orders].sort((a, b) => {
          const timeA = new Date(a.created_at || 0).getTime();
          const timeB = new Date(b.created_at || 0).getTime();
          return timeB - timeA; // 降序：新的在前
        });
        
        container.innerHTML = `
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
              <thead>
                <tr style="background: #f3f4f6;">
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">訂單編號</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">方案</th>
                  <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">金額</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">狀態</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">付款時間</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">到期日期</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">發票號碼</th>
                </tr>
              </thead>
              <tbody>
                ${sortedOrders.map(order => {
                  const orderDate = order.created_at ? new Date(order.created_at).toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  }) : '-';
                  
                  const paidDate = order.paid_at ? new Date(order.paid_at).toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  }) : '-';
                  
                  const expiresDate = order.expires_at ? new Date(order.expires_at).toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                  }) : '-';
                  
                  const statusBadge = order.payment_status === 'paid' 
                    ? '<span style="display: inline-block; padding: 4px 12px; background: #d1fae5; color: #065f46; border-radius: 12px; font-size: 12px; font-weight: 600;">✅ 已付款</span>'
                    : '<span style="display: inline-block; padding: 4px 12px; background: #fee2e2; color: #991b1b; border-radius: 12px; font-size: 12px; font-weight: 600;">⏳ 待付款</span>';
                  
                  const planText = order.plan_type === 'two_year' ? 'Creator Pro 雙年方案' : (order.plan_type === 'yearly' ? 'Script Lite 入門版' : (order.plan_type === 'lifetime' ? '永久使用方案' : order.plan_type || '-'));
                  
                  return `
                    <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; cursor: pointer;" onclick="showOrderDetail('${order.order_id || order.id}')" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='transparent'">
                      <td style="padding: 12px; color: #1f2937; font-weight: 500;">${order.order_id || order.id || '-'}</td>
                      <td style="padding: 12px; color: #4b5563;">${planText}</td>
                      <td style="padding: 12px; text-align: right; color: #1f2937; font-weight: 600;">NT$${order.amount?.toLocaleString() || 0}</td>
                      <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                      <td style="padding: 12px; color: #6b7280; font-size: 14px;">${paidDate}</td>
                      <td style="padding: 12px; color: #6b7280; font-size: 14px;">${expiresDate}</td>
                      <td style="padding: 12px; color: #6b7280; font-size: 14px;">${order.invoice_number || '-'}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      // 顯示訂單詳情
      async function showOrderDetail(orderId) {
        if (!ipPlanningToken || !orderId) {
          showToast('無法載入訂單詳情', 3000);
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/orders/${orderId}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: '載入失敗' }));
            throw new Error(errorData.error || '載入訂單詳情失敗');
          }
          
          const data = await response.json();
          const order = data.order;
          
          if (!order) {
            showToast('訂單不存在', 3000);
            return;
          }
          
          // 格式化日期
          const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            try {
              return new Date(dateStr).toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              });
            } catch (e) {
              return dateStr;
            }
          };
          
          const formatDateOnly = (dateStr) => {
            if (!dateStr) return '-';
            try {
              return new Date(dateStr).toLocaleDateString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
              });
            } catch (e) {
              return dateStr;
            }
          };
          
          // 付款方式顯示
          const paymentMethodText = {
            'ecpay': 'ECPay 綠界',
            'credit': '信用卡',
            'atm': 'ATM 轉帳',
            'cvs': '超商代碼',
            'barcode': '超商條碼'
          }[order.payment_method] || order.payment_method || '-';
          
          // 方案顯示
          const planText = order.plan_type === 'two_year' ? 'Creator Pro 雙年方案' : 
                          (order.plan_type === 'yearly' ? 'Script Lite 入門版' : 
                          (order.plan_type === 'lifetime' ? '永久使用方案' : 
                          order.plan_type)) || '-';
          
          // 狀態顯示
          const statusText = order.payment_status === 'paid' ? '✅ 已付款' : 
                            order.payment_status === 'pending' ? '⏳ 待付款' : 
                            order.payment_status || '-';
          
          const statusColor = order.payment_status === 'paid' ? '#065f46' : 
                             order.payment_status === 'pending' ? '#991b1b' : '#6b7280';
          
          // 發票類型顯示
          const invoiceTypeText = order.invoice_type === 'personal' ? '個人' : 
                                 order.invoice_type === 'company' ? '公司' : 
                                 order.invoice_type || '-';
          
          // 建立詳情 HTML
          const detailHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeOrderDetail(event)">
              <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                  <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: #1f2937;">📋 訂單詳情</h2>
                  <button onclick="closeOrderDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">×</button>
                </div>
                <div style="padding: 24px;">
                  <div style="display: grid; gap: 20px;">
                    <!-- 訂單基本資訊 -->
                    <div>
                      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">訂單資訊</h3>
                      <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">訂單編號：</span>
                          <span style="color: #1f2937; font-weight: 600;">${order.order_id || '-'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">方案類型：</span>
                          <span style="color: #1f2937; font-weight: 600;">${planText}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">金額：</span>
                          <span style="color: #1f2937; font-weight: 700; font-size: 18px;">NT$${order.amount?.toLocaleString() || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">付款狀態：</span>
                          <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">付款方式：</span>
                          <span style="color: #1f2937;">${paymentMethodText}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">建立時間：</span>
                          <span style="color: #1f2937;">${formatDate(order.created_at)}</span>
                        </div>
                        ${order.paid_at ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">付款時間：</span>
                          <span style="color: #1f2937;">${formatDate(order.paid_at)}</span>
                        </div>
                        ` : ''}
                        ${order.expires_at ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">到期日期：</span>
                          <span style="color: #1f2937;">${formatDateOnly(order.expires_at)}</span>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                    
                    <!-- 帳務資訊 -->
                    ${order.name || order.email || order.phone ? `
                    <div>
                      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">帳務資訊</h3>
                      <div style="display: grid; gap: 12px;">
                        ${order.name ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">姓名：</span>
                          <span style="color: #1f2937;">${order.name}</span>
                        </div>
                        ` : ''}
                        ${order.email ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">Email：</span>
                          <span style="color: #1f2937;">${order.email}</span>
                        </div>
                        ` : ''}
                        ${order.phone ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">電話：</span>
                          <span style="color: #1f2937;">${order.phone}</span>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                    ` : ''}
                    
                    <!-- 發票資訊 -->
                    ${order.invoice_number || order.invoice_type || order.vat_number ? `
                    <div>
                      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">發票資訊</h3>
                      <div style="display: grid; gap: 12px;">
                        ${order.invoice_type ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">發票類型：</span>
                          <span style="color: #1f2937;">${invoiceTypeText}</span>
                        </div>
                        ` : ''}
                        ${order.vat_number ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">統一編號：</span>
                          <span style="color: #1f2937; font-weight: 600;">${order.vat_number}</span>
                        </div>
                        ` : ''}
                        ${order.invoice_number ? `
                        <div style="display: flex; justify-content: space-between;">
                          <span style="color: #6b7280;">發票號碼：</span>
                          <span style="color: #1f2937; font-weight: 600;">${order.invoice_number}</span>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                    ` : ''}
                    
                    <!-- 備註 -->
                    ${order.note ? `
                    <div>
                      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">備註</h3>
                      <p style="margin: 0; color: #1f2937; padding: 12px; background: #f9fafb; border-radius: 8px; white-space: pre-wrap;">${order.note}</p>
                    </div>
                    ` : ''}
                  </div>
                  
                  <!-- 操作按鈕 -->
                  <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeOrderDetail()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">關閉</button>
                    ${order.payment_status === 'pending' ? `
                    <a href="/subscription.html" style="padding: 10px 20px; background: #3B82F6; color: white; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">前往付款</a>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // 顯示詳情彈窗
          document.body.insertAdjacentHTML('beforeend', detailHTML);
        } catch (error) {
          console.error('載入訂單詳情失敗:', error);
          showToast(error.message || '載入訂單詳情失敗', 3000);
        }
      }
      
      // 關閉訂單詳情
      function closeOrderDetail(event) {
        if (event && event.target !== event.currentTarget) {
          return; // 點擊內容區域不關閉
        }
        const modal = document.querySelector('[style*="z-index: 10000"]');
        if (modal) {
          modal.remove();
        }
      }
      
      // 匯出用戶資料（CSV 格式）
      async function exportUserData() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        // 用戶確認和警告
        const confirmed = confirm(
          '⚠️ 安全警告\n\n' +
          '您即將匯出包含以下敏感信息的數據：\n' +
          '• 腳本內容\n' +
          '• 帳號定位分析\n' +
          '• 選題內容\n' +
          '• 對話記錄\n\n' +
          '請確保：\n' +
          '1. 在安全的地方保存此文件\n' +
          '2. 不要分享給他人\n' +
          '3. 妥善保管匯出的文件\n\n' +
          '確定要匯出嗎？'
        );
        
        if (!confirmed) {
          return;
        }
        
        try {
          showToast('正在匯出資料...', 3000);
          
          // 記錄匯出操作到後端（安全審計日誌）
          try {
            await fetch(`https://api.aijob.com.tw/api/user/data-export-log`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${ipPlanningToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                user_id: ipPlanningUser.user_id,
                export_type: 'user_data',
                timestamp: new Date().toISOString()
              })
            });
          } catch (logError) {
            console.warn('記錄匯出日誌失敗:', logError);
            // 不阻止匯出，即使日誌記錄失敗
          }
          
          // 收集所有用戶數據
          const allData = {
            scripts: [],
            positioning: [],
            topics: [],
            conversations: []
          };
          
          // 1. 獲取腳本數據
          try {
            const scriptsResponse = await fetch(`https://api.aijob.com.tw/api/scripts/my`, {
              headers: { 'Authorization': `Bearer ${ipPlanningToken}` }
            });
            if (scriptsResponse.ok) {
              const scriptsData = await scriptsResponse.json();
              allData.scripts = scriptsData.scripts || [];
            }
          } catch (e) {
            console.warn('獲取腳本失敗:', e);
          }
          
          // 2. 獲取帳號定位數據
          try {
            const positioningResponse = await fetch(`https://api.aijob.com.tw/api/user/positioning/${ipPlanningUser.user_id}`, {
              headers: { 'Authorization': `Bearer ${ipPlanningToken}` }
            });
            if (positioningResponse.ok) {
              const positioningData = await positioningResponse.json();
              allData.positioning = positioningData.records || [];
            }
          } catch (e) {
            console.warn('獲取帳號定位失敗:', e);
          }
          
          // 3. 獲取選題數據
          try {
            const generationsResponse = await fetch(`https://api.aijob.com.tw/api/generations/${ipPlanningUser.user_id}`, {
              headers: { 'Authorization': `Bearer ${ipPlanningToken}` }
            });
            if (generationsResponse.ok) {
              const generationsData = await generationsResponse.json();
              allData.topics = generationsData.generations || [];
            }
          } catch (e) {
            console.warn('獲取選題數據失敗:', e);
          }
          
          // 4. 獲取對話數據
          try {
            const convResponse = await fetch(`https://api.aijob.com.tw/api/user/conversations/${ipPlanningUser.user_id}`, {
              headers: { 'Authorization': `Bearer ${ipPlanningToken}` }
            });
            if (convResponse.ok) {
              const convData = await convResponse.json();
              allData.conversations = convData.conversations || [];
            }
          } catch (e) {
            console.warn('獲取對話數據失敗:', e);
          }
          
          // 生成 CSV 內容
          const csvContent = generateUserDataCSV(allData, ipPlanningUser);
          
          // 下載 CSV
          const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
          const timestamp = new Date().toISOString().split('T')[0];
          a.download = `aijob_user_data_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
          showToast('資料已匯出為 CSV 檔案', 3000);
        } catch (error) {
          console.error('匯出資料失敗:', error);
          showToast('匯出失敗，請稍後再試', 3000);
        }
      }
      
      // 生成用戶數據 CSV
      function generateUserDataCSV(data, userInfo) {
        const rows = [];
        
        // CSV 標題行
        rows.push('資料類型,ID,編號,標題/主題,內容預覽,平台,創建時間\n');
        
        // 腳本數據
        data.scripts.forEach(script => {
          const title = (script.title || script.script_name || '未命名').replace(/"/g, '""');
          const content = (script.content || '').substring(0, 100).replace(/"/g, '""').replace(/\n/g, ' ');
          const platform = (script.platform || '').replace(/"/g, '""');
          const createdAt = formatTaiwanTime(script.created_at || '').split(' ')[0];
          rows.push(`腳本,${script.id || ''},${script.id || ''},"${title}","${content}","${platform}",${createdAt}\n`);
        });
        
        // 帳號定位數據
        data.positioning.forEach(record => {
          const content = (record.content || '').substring(0, 100).replace(/"/g, '""').replace(/\n/g, ' ');
          const createdAt = formatTaiwanTime(record.created_at || '').split(' ')[0];
          rows.push(`帳號定位,${record.id || ''},${record.record_number || ''},"","${content}","",${createdAt}\n`);
        });
        
        // 選題數據
        data.topics.forEach(topic => {
          const topicName = (topic.topic || '').replace(/"/g, '""');
          const content = (topic.content || '').substring(0, 100).replace(/"/g, '""').replace(/\n/g, ' ');
          const platform = (topic.platform || '').replace(/"/g, '""');
          const createdAt = formatTaiwanTime(topic.created_at || '').split(' ')[0];
          rows.push(`選題,${topic.id || ''},${topic.id || ''},"${topicName}","${content}","${platform}",${createdAt}\n`);
        });
        
        // 對話數據
        data.conversations.forEach(conv => {
          const summary = (conv.summary || '').substring(0, 100).replace(/"/g, '""').replace(/\n/g, ' ');
          const createdAt = formatTaiwanTime(conv.created_at || '').split(' ')[0];
          rows.push(`對話,${conv.id || ''},${conv.id || ''},"${conv.conversation_type || ''}","${summary}","",${createdAt}\n`);
        });
        
        return rows.join('');
      }
      
      // 清除本地快取
      function clearUserData() {
        if (!confirm('確定要清除本地快取嗎？此操作無法復原。')) {
          return;
        }
        
        // 清除本地存儲（保留登入信息）
        const token = sessionStorage.getItem('ipPlanningToken');
        const user = sessionStorage.getItem('ipPlanningUser');
        
        localStorage.clear();
        
        // 恢復登入信息
        if (token) sessionStorage.setItem('ipPlanningToken', token);
        if (user) sessionStorage.setItem('ipPlanningUser', user);
        
        showToast('本地快取已清除', 3000);
        
        // 重新載入頁面
        setTimeout(() => {
          location.reload();
        }, 1000);
      }
      
      // ===== 顯示偏好功能 =====
      
      // 載入顯示偏好
      function loadDisplayPreferences() {
        try {
          const theme = localStorage.getItem('user_theme') || 'light';
          const language = localStorage.getItem('user_language') || 'zh-TW';
          
          const themeSelect = document.getElementById('theme');
          const languageSelect = document.getElementById('language');
          
          if (themeSelect) {
            themeSelect.value = theme;
            applyTheme(theme);
          }
          if (languageSelect) {
            languageSelect.value = language;
            applyLanguage(language);
          }
        } catch (error) {
          console.error('載入顯示偏好失敗:', error);
        }
      }
      
      // 保存顯示偏好
      function saveDisplayPreferences() {
        try {
          const themeSelect = document.getElementById('theme');
          const languageSelect = document.getElementById('language');
          
          if (themeSelect) {
            const theme = themeSelect.value;
            localStorage.setItem('user_theme', theme);
            applyTheme(theme);
          }
          if (languageSelect) {
            const language = languageSelect.value;
            localStorage.setItem('user_language', language);
            applyLanguage(language);
          }
          
          const currentLang = localStorage.getItem('user_language') || 'zh-TW';
          const messages = getLanguageMessages(currentLang);
          showToast(messages.preferencesSaved || '顯示偏好已保存', 2000);
        } catch (error) {
          console.error('保存顯示偏好失敗:', error);
          showToast('保存失敗，請稍後再試', 2000);
        }
      }
      
      // 套用主題
      function applyTheme(theme) {
        try {
          const root = document.documentElement;
          
          // 移除現有主題類別
          root.classList.remove('theme-light', 'theme-dark');
          
          if (theme === 'dark') {
            root.classList.add('theme-dark');
            root.style.colorScheme = 'dark';
          } else if (theme === 'auto') {
            // 自動模式：根據系統設定（但預設使用淺色模式）
            // 為了統一兩個網域的顯示，暫時禁用自動模式，強制使用淺色模式
            // if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            //   root.classList.add('theme-dark');
            //   root.style.colorScheme = 'dark';
            // } else {
            //   root.classList.add('theme-light');
            //   root.style.colorScheme = 'light';
            // }
            // 強制使用淺色模式
            root.classList.add('theme-light');
            root.style.colorScheme = 'light';
          } else {
            root.classList.add('theme-light');
            root.style.colorScheme = 'light';
          }
        } catch (error) {
          console.error('套用主題失敗:', error);
        }
      }
      
      // ===== 多語言功能 =====
      
      // 語言包
      const languagePack = {
        'zh-TW': {
          // 設定頁面
          settingsTitle: '設定',
          displayPreferences: '顯示偏好',
          theme: '主題',
          lightMode: '淺色模式',
          darkMode: '深色模式',
          autoMode: '自動',
          language: '語言',
          traditionalChinese: '繁體中文',
          simplifiedChinese: '简体中文',
          english: 'English',
          switchTheme: '切換淺色/深色主題模式',
          selectLanguage: '選擇介面顯示語言',
          preferencesSaved: '顯示偏好已保存',
          saveFailed: '保存失敗，請稍後再試',
          // 通用
          loading: '載入中...',
          save: '保存',
          cancel: '取消',
          confirm: '確定',
          // 導航欄
          home: '首頁',
          mode1: '一鍵生成',
          mode2: 'AI 顧問',
          mode3: 'IP人設規劃',
          userDB: '創作者資料庫',
          // BYOK
          byokTitle: '大型語言模型(LLM) API 金鑰管理',
          byokDescription: '使用您自己的 API 金鑰可以獲得更高的使用額度和更穩定的服務',
          selectProvider: '選擇大型語言模型(LLM) 提供商',
          apiKey: 'API 金鑰',
          enterApiKey: '輸入您的 API 金鑰',
          saveKey: '保存金鑰',
          testKey: '測試金鑰',
          // 數據管理
          dataManagement: '數據管理',
          exportData: '匯出我的資料',
          exportDataDesc: '匯出所有腳本、對話、定位記錄為 CSV 檔案',
          clearCache: '清除本地快取',
          clearCacheDesc: '清除本地暫存數據'
        },
        'zh-CN': {
          settingsTitle: '设置',
          displayPreferences: '显示偏好',
          theme: '主题',
          lightMode: '浅色模式',
          darkMode: '深色模式',
          autoMode: '自动',
          language: '语言',
          traditionalChinese: '繁體中文',
          simplifiedChinese: '简体中文',
          english: 'English',
          switchTheme: '切换浅色/深色主题模式',
          selectLanguage: '选择界面显示语言',
          preferencesSaved: '显示偏好已保存',
          saveFailed: '保存失败，请稍后再试',
          loading: '加载中...',
          save: '保存',
          cancel: '取消',
          confirm: '确定',
          home: '首页',
          mode1: '一键生成',
          mode2: 'AI 顾问',
          mode3: 'IP人设规划',
          userDB: '创作者数据库',
          byokTitle: '大型語言模型(LLM) API 密钥管理',
          byokDescription: '使用您自己的 API 密钥可以获得更高的使用额度和更稳定的服务',
          selectProvider: '选择大型語言模型(LLM) 提供商',
          apiKey: 'API 密钥',
          enterApiKey: '输入您的 API 密钥',
          saveKey: '保存密钥',
          testKey: '测试密钥',
          dataManagement: '数据管理',
          exportData: '导出我的资料',
          exportDataDesc: '导出所有脚本、对话、定位记录为 CSV 文件',
          clearCache: '清除本地缓存',
          clearCacheDesc: '清除本地暂存数据'
        },
        'en': {
          settingsTitle: 'Settings',
          displayPreferences: 'Display Preferences',
          theme: 'Theme',
          lightMode: 'Light Mode',
          darkMode: 'Dark Mode',
          autoMode: 'Auto',
          language: 'Language',
          traditionalChinese: '繁體中文',
          simplifiedChinese: '简体中文',
          english: 'English',
          switchTheme: 'Switch Light/Dark Theme Mode',
          selectLanguage: 'Select Interface Display Language',
          preferencesSaved: 'Display preferences saved',
          saveFailed: 'Save failed, please try again later',
          loading: 'Loading...',
          save: 'Save',
          cancel: 'Cancel',
          confirm: 'Confirm',
          home: 'Home',
          mode1: 'One-Click Generate',
          mode2: 'AI Advisor',
          mode3: 'IP Persona Planning',
          userDB: 'Creator Database',
          byokTitle: 'Large Language Model(LLM) API Key Management',
          byokDescription: 'Using your own API key can get higher usage quotas and more stable services',
          selectProvider: 'Select Large Language Model(LLM) Provider',
          apiKey: 'API Key',
          enterApiKey: 'Enter your API key',
          saveKey: 'Save Key',
          testKey: 'Test Key',
          dataManagement: 'Data Management',
          exportData: 'Export My Data',
          exportDataDesc: 'Export all scripts, conversations, and positioning records as CSV file',
          clearCache: 'Clear Local Cache',
          clearCacheDesc: 'Clear local temporary data'
        }
      };
      
      // 獲取語言訊息
      function getLanguageMessages(lang) {
        return languagePack[lang] || languagePack['zh-TW'];
      }
      
      // 套用語言
      function applyLanguage(language) {
        try {
          const messages = getLanguageMessages(language);
          
          // 更新設定頁面文字
          const settingsTitle = document.querySelector('#db-settings .section-title');
          if (settingsTitle) {
            settingsTitle.textContent = `⚙️ ${messages.settingsTitle}`;
          }
          
          // 更新顯示偏好標題
          const allH4s = document.querySelectorAll('#db-settings h4');
          allH4s.forEach(h4 => {
            const text = h4.textContent;
            if (text.includes('顯示偏好') || text.includes('显示偏好') || text.includes('Display Preferences')) {
              h4.textContent = `🎨 ${messages.displayPreferences}`;
            }
          });
          
          // 更新主題選項
          const themeSelect = document.getElementById('theme');
          if (themeSelect) {
            themeSelect.options[0].text = messages.lightMode;
            themeSelect.options[1].text = messages.darkMode;
            themeSelect.options[2].text = messages.autoMode;
            
            // 查找label（在setting-item的第一個子元素）
            const themeItem = themeSelect.closest('.setting-item');
            if (themeItem) {
              const themeLabel = themeItem.querySelector('label[for="theme"]');
              if (themeLabel) {
                themeLabel.textContent = messages.theme;
              }
              
              // 查找說明文字（在label之後，select之前）
              const themeDesc = themeSelect.previousElementSibling;
              if (themeDesc && themeDesc.classList.contains('setting-desc')) {
                themeDesc.textContent = messages.switchTheme;
              }
            }
          }
          
          // 更新語言選項
          const langSelect = document.getElementById('language');
          if (langSelect) {
            langSelect.options[0].text = messages.traditionalChinese;
            langSelect.options[1].text = messages.simplifiedChinese;
            langSelect.options[2].text = messages.english;
            
            // 查找label（在setting-item的第一個子元素）
            const langItem = langSelect.closest('.setting-item');
            if (langItem) {
              const langLabel = langItem.querySelector('label[for="language"]');
              if (langLabel) {
                langLabel.textContent = messages.language;
              }
              
              // 查找說明文字（在label之後，select之前）
              const langDesc = langSelect.previousElementSibling;
              if (langDesc && langDesc.classList.contains('setting-desc')) {
                langDesc.textContent = messages.selectLanguage;
              }
            }
          }
          
          // 更新 BYOK 說明
          const byokTitles = document.querySelectorAll('#db-settings h4');
          byokTitles.forEach(title => {
            const text = title.textContent;
            if (text.includes('大型語言模型') || text.includes('大型语言模型') || text.includes('Large Language Model') || 
                text.includes('LLM API') || text.includes('金鑰管理') || text.includes('密钥管理') || text.includes('Key Management')) {
              title.textContent = `🔑 ${messages.byokTitle}`;
            }
          });
          
          const byokDesc = document.querySelector('#db-settings p');
          if (byokDesc && (byokDesc.textContent.includes('使用您自己的') || byokDesc.textContent.includes('使用你自己的') || byokDesc.textContent.includes('Using your own'))) {
            byokDesc.textContent = messages.byokDescription;
          }
          
          // 更新其他元素
          updatePageLanguage(messages);
          
        } catch (error) {
          console.error('套用語言失敗:', error);
        }
      }
      
      // 更新頁面語言
      function updatePageLanguage(messages) {
        // 更新所有帶有 data-i18n 屬性的元素
        document.querySelectorAll('[data-i18n]').forEach(element => {
          const key = element.getAttribute('data-i18n');
          if (messages[key]) {
            element.textContent = messages[key];
          }
        });
      }
      
      // 監聽系統主題變化（自動模式）
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          const theme = localStorage.getItem('user_theme') || 'light';
          if (theme === 'auto') {
            applyTheme('auto');
          }
        });
      }
      
      // 頁面載入時套用主題和語言
      function initializeDisplayPreferences() {
        // 統一使用淺色模式作為預設（兩個網域都使用相同的主題）
        // 強制使用淺色模式，確保兩個網域顯示一致
        const theme = 'light'; // 強制使用淺色模式
        localStorage.setItem('user_theme', 'light'); // 更新 localStorage，確保一致性
        
        const language = localStorage.getItem('user_language') || 'zh-TW';
        applyTheme(theme);
        applyLanguage(language);
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDisplayPreferences);
      } else {
        initializeDisplayPreferences();
      }
      
      // ===== BYOK (Bring Your Own Key) 功能 =====
      
      // 載入已保存的 API Key（僅顯示最後4位）
      async function loadSavedApiKey() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/llm-keys/${ipPlanningUser.user_id}`, {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const savedKeyDisplay = document.getElementById('savedKeyDisplay');
            const savedKeyLast4 = document.getElementById('savedKeyLast4');
            const llmProvider = document.getElementById('llmProvider');
            
            if (data.keys && data.keys.length > 0) {
              // 顯示已保存的金鑰（只顯示最後4位）
              const key = data.keys[0]; // 假設每個提供商只有一個金鑰
              if (key.provider) {
                llmProvider.value = key.provider;
              }
              if (key.last4) {
                savedKeyLast4.textContent = `****${key.last4}`;
                savedKeyDisplay.style.display = 'block';
              }
            }
          }
        } catch (error) {
          console.error('載入已保存的 API Key 失敗:', error);
          // 不顯示錯誤，因為可能是首次使用
        }
      }
      
      // 保存 API Key
      async function saveApiKey() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        const apiKey = document.getElementById('llmApiKey').value.trim();
        const provider = document.getElementById('llmProvider').value;
        
        if (!apiKey) {
          showToast('請輸入 API 金鑰', 3000);
          return;
        }
        
        // 基本驗證
        if (provider === 'gemini' && !apiKey.startsWith('AI')) {
          if (!confirm('Gemini API Key 通常以 "AI" 開頭，您確定要繼續嗎？')) {
            return;
          }
        }
        
        if (provider === 'openai' && !apiKey.startsWith('sk-')) {
          if (!confirm('OpenAI API Key 通常以 "sk-" 開頭，您確定要繼續嗎？')) {
            return;
          }
        }
        
        try {
          showToast('正在保存金鑰...', 2000);
          
          const response = await fetch('https://api.aijob.com.tw/api/user/llm-keys', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              user_id: ipPlanningUser.user_id,
              provider: provider,
              api_key: apiKey
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            showToast('✅ API 金鑰已安全保存', 3000);
            
            // 清空輸入框
            document.getElementById('llmApiKey').value = '';
            
            // 更新顯示
            await loadSavedApiKey();
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else {
            const errorData = await response.json();
            showToast(`保存失敗: ${errorData.error || '未知錯誤'}`, 3000);
          }
        } catch (error) {
          console.error('保存 API Key 錯誤:', error);
          showToast('保存失敗，請稍後再試', 3000);
        }
      }
      
      // 測試 API Key
      async function testApiKey() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        const apiKey = document.getElementById('llmApiKey').value.trim();
        const provider = document.getElementById('llmProvider').value;
        const testResultDiv = document.getElementById('testKeyResult');
        
        if (!apiKey) {
          showToast('請先輸入 API 金鑰', 3000);
          testResultDiv.style.display = 'none';
          return;
        }
        
        // 顯示載入狀態
        testResultDiv.style.display = 'block';
        testResultDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="color: #6b7280;">正在測試金鑰...</span>
          </div>
        `;
        testResultDiv.style.background = '#f3f4f6';
        testResultDiv.style.border = '1px solid #e5e7eb';
        testResultDiv.style.color = '#6b7280';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/user/llm-keys/test', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              provider: provider,
              api_key: apiKey
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.valid) {
              // 測試成功
              testResultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: #10b981; font-size: 18px;">✅</span>
                  <div>
                    <div style="font-weight: 500; color: #10b981; margin-bottom: 4px;">API 金鑰測試成功</div>
                    <div style="color: #6b7280; font-size: 13px;">${result.message || '金鑰有效，可以使用'}</div>
                  </div>
                </div>
              `;
              testResultDiv.style.background = '#ecfdf5';
              testResultDiv.style.border = '1px solid #10b981';
              showToast('✅ API 金鑰測試成功，金鑰有效！', 3000);
            } else {
              // 測試失敗
              testResultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: #ef4444; font-size: 18px;">❌</span>
                  <div>
                    <div style="font-weight: 500; color: #ef4444; margin-bottom: 4px;">API 金鑰測試失敗</div>
                    <div style="color: #6b7280; font-size: 13px;">${result.error || '金鑰無效，請檢查是否正確'}</div>
                  </div>
                </div>
              `;
              testResultDiv.style.background = '#fef2f2';
              testResultDiv.style.border = '1px solid #ef4444';
              showToast('❌ API 金鑰測試失敗: ' + (result.error || '金鑰無效'), 3000);
            }
          } else {
            const errorData = await response.json();
            testResultDiv.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: #ef4444; font-size: 18px;">❌</span>
                <div>
                  <div style="font-weight: 500; color: #ef4444; margin-bottom: 4px;">測試失敗</div>
                  <div style="color: #6b7280; font-size: 13px;">${errorData.error || '未知錯誤，請稍後再試'}</div>
                </div>
              </div>
            `;
            testResultDiv.style.background = '#fef2f2';
            testResultDiv.style.border = '1px solid #ef4444';
            showToast(`測試失敗: ${errorData.error || '未知錯誤'}`, 3000);
          }
        } catch (error) {
          console.error('測試 API Key 錯誤:', error);
          testResultDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #ef4444; font-size: 18px;">❌</span>
              <div>
                <div style="font-weight: 500; color: #ef4444; margin-bottom: 4px;">測試失敗</div>
                <div style="color: #6b7280; font-size: 13px;">網路錯誤，請檢查連線後再試</div>
              </div>
            </div>
          `;
          testResultDiv.style.background = '#fef2f2';
          testResultDiv.style.border = '1px solid #ef4444';
          showToast('測試失敗，請稍後再試', 3000);
        }
      }
      
      // 切換 API Key 顯示/隱藏
      function toggleApiKeyVisibility() {
        const apiKeyInput = document.getElementById('llmApiKey');
        const toggleIcon = document.getElementById('toggleKeyIcon');
        
        if (apiKeyInput.type === 'password') {
          apiKeyInput.type = 'text';
          toggleIcon.textContent = '🙈';
        } else {
          apiKeyInput.type = 'password';
          toggleIcon.textContent = '👁️';
        }
      }
      
      // 清除已保存的 API Key
      async function clearSavedApiKey() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        const provider = document.getElementById('llmProvider').value;
        
        if (!confirm(`確定要清除 ${provider === 'gemini' ? 'Google Gemini' : 'OpenAI'} 的 API 金鑰嗎？`)) {
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/user/llm-keys/${ipPlanningUser.user_id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              provider: provider
            })
          });
          
          if (response.ok) {
            showToast('✅ API 金鑰已清除', 3000);
            
            // 更新顯示
            document.getElementById('savedKeyDisplay').style.display = 'none';
            document.getElementById('llmApiKey').value = '';
          } else {
            const errorData = await response.json();
            showToast(`清除失敗: ${errorData.error || '未知錯誤'}`, 3000);
          }
        } catch (error) {
          console.error('清除 API Key 錯誤:', error);
          showToast('清除失敗，請稍後再試', 3000);
        }
      }
      
      // 結果區塊功能
      function updateResultBlock(blockId, content, hasContent = true) {
        const block = document.getElementById(blockId);
        if (block) {
          block.textContent = content;
          if (hasContent) {
            block.classList.add('has-content');
          } else {
            block.classList.remove('has-content');
          }
        }
      }
      
      // 標籤切換功能
      function switchTab(tabName) {
        // 移除所有標籤的 active 類別
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 隱藏所有結果內容
        document.querySelectorAll('.result-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // 激活選中的標籤
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
        }
        
        // 顯示對應的結果內容
        let contentId = '';
        if (tabName === 'positioning') {
          contentId = 'positioningResult';
        } else if (tabName === 'topics') {
          contentId = 'topicSelectionResult';
        } else if (tabName === 'script') {
          contentId = 'scriptResult';
        }
        
        const activeContent = document.getElementById(contentId);
        if (activeContent) {
          activeContent.style.display = 'block';
        }
      }
      
      // 添加聊天訊息（套用IP模式設計）
      function addMessage(content, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        
        // 添加頭像
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        
        if (isUser) {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatar.appendChild(img);
          } else {
            avatar.textContent = '👤';
          }
        } else {
          // AI 頭像：使用表情符號
          avatar.textContent = '🤖';
        }
        
        messageDiv.appendChild(avatar);
        
        // 添加訊息內容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (!isUser) {
          const cleanText = cleanMarkdownFormat(content);
          messageContent.innerHTML = cleanText;
        } else {
          messageContent.textContent = content;
        }
        
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        
        // 確保滾動到底部，考慮到底部固定元素的高度
        setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
          // 再次滾動確保到達正確位置
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 50);
        }, 10);
        
        // 通用滾動處理：確保滾動到完全可見的位置（電腦版和手機版都適用）
        setTimeout(() => {
          // 直接滾動到底部，讓CSS的padding-bottom處理底部空間
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // 再次確保滾動到正確位置
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 50);
          
          // 最終確保滾動到底部
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 150);
        }, 100);
      }
      
      // 發送聊天訊息
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // 添加用戶訊息
        addMessage(message, true);
        messageInput.value = '';
        
        // 顯示 AI 回覆中的載入狀態
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'message ai';
        thinkingDiv.id = 'thinking-message';
        
        // 添加 AI 頭像
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = '🤖';
        thinkingDiv.appendChild(avatar);
        
        // 添加載入動畫內容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AI正在思考中</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        messageContent.appendChild(loadingDiv);
        thinkingDiv.appendChild(messageContent);
        
        document.getElementById('chatMessages').appendChild(thinkingDiv);
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: message,
              platform: platformSelect.value || null,
              topic: topicInput.value || null,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioningInput.value || null,
              history: [],
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('發送失敗');
          }
          
          // 準備接收 AI 回應
          const reader = response.body.getReader();
          let aiResponse = '';
          let aiDiv = null;
          let bubble = null;
          
          let buffer = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += new TextDecoder().decode(value, { stream: true });
            
            // 處理完整的 JSON 行
            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              
              if (!frame.startsWith('data:')) continue;
              
              try {
                const jsonStr = frame.slice(5).trim();
                const data = JSON.parse(jsonStr);
                
                if (data.type === 'token' && data.content) {
                  // 如果是第一次收到 token，創建 AI 回應 div 並移除載入動畫
                  if (!aiDiv) {
                    const thinkingMsg = document.getElementById('thinking-message');
                    if (thinkingMsg) {
                      thinkingMsg.remove();
                    }
                    
                    // 創建 AI 回應 div
                    aiDiv = document.createElement('div');
                    aiDiv.className = 'msg assistant';
                    aiDiv.id = 'ai-response';
                    
                    // 添加 AI 頭像
                    const aiAvatar = document.createElement('div');
                    aiAvatar.className = 'msg-avatar';
                    aiAvatar.textContent = '🤖';
                    aiDiv.appendChild(aiAvatar);
                    
                    // 添加氣泡
                    bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    aiDiv.appendChild(bubble);
                    
                    document.getElementById('chatMessages').appendChild(aiDiv);
                  }
                  
                  aiResponse += data.content;
                  bubble.innerHTML = cleanMarkdownFormat(aiResponse);
                } else if (data.type === 'end') {
                  // 回應結束
                  // 新增：智能判斷 AI 回應類型並顯示到結果區塊
                  if (aiResponse && ipPlanningUser?.user_id) {
                    detectAndDisplayResult(message, aiResponse);
                  }
                  break;
                }
              } catch (e) {
                // 忽略解析錯誤
                continue;
              }
            }
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
        } catch (error) {
          // 移除載入動畫，顯示錯誤訊息
          const thinkingMsg = document.getElementById('thinking-message');
          if (thinkingMsg) {
            thinkingMsg.remove();
          }
          
          addMessage('抱歉，發送失敗，請稍後再試', false);
        }
      }
      
      // 生成腳本功能
      async function generateScript() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        // 檢查是否已完成帳號定位和選題（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const topicContent = document.getElementById('topicContent').textContent.trim();
        
        const isPositioningDefault = positioningContent.includes('請點選「一鍵生成帳號定位」按鈕開始') || 
                                     positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                                     positioningContent.includes('開始分析');
        const isTopicDefault = topicContent.includes('請點選「一鍵生成選題」按鈕開始') ||
                              topicContent.includes('完成帳號定位') || 
                              topicContent.includes('進行選題') ||
                              topicContent.includes('點擊「一鍵生成選題」');
        
        if (!positioningContent || isPositioningDefault) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        if (!topicContent || isTopicDefault) {
          showToast('請先完成選題推薦', 3000);
          return;
        }
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('scriptContent', '正在生成腳本...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('scriptActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/generate/script', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請幫我生成完整腳本',
              platform: platform,
              topic: topic,
              duration: durationInput.value || '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('scriptContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 自動切換到腳本標籤
          switchTab('script');
          
        } catch (error) {
          updateResultBlock('scriptContent', '生成失敗，請稍後再試', false);
          showToast('生成腳本失敗', 3000);
        }
      }
      // 一鍵生成帳號定位
      async function generatePositioning() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('positioningContent', '正在分析帳號定位...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('positioningActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/generate/positioning', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請幫我進行帳號定位分析',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('positioningContent', result, true);
                  } else if (data.type === 'end') {
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
          }
          
          // 自動切換到帳號定位標籤
          switchTab('positioning');
          
          // 自動保存帳號定位到後端
          if (result && ipPlanningToken && ipPlanningUser) {
            try {
              const saveResponse = await fetch('https://api.aijob.com.tw/api/user/positioning/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${ipPlanningToken}`
                },
                body: JSON.stringify({
                  user_id: ipPlanningUser.user_id,
                  content: result
                })
              });
              
              if (saveResponse.ok) {
                const saveData = await saveResponse.json();
                showToast(`帳號定位已自動儲存（編號：${saveData.record_number}）`, 2000);
              }
            } catch (saveError) {
              console.error('自動儲存失敗:', saveError);
            }
          }
          
        } catch (error) {
          updateResultBlock('positioningContent', '生成失敗，請稍後再試', false);
          showToast('生成帳號定位失敗', 3000);
        }
      }
      
      // 智能判斷 AI 回應類型並顯示到結果區塊
      function detectAndDisplayResult(userMessage, aiResponse) {
        // 判斷是否為明確的帳號定位總結
        const isPositioningSummary = aiResponse.includes('📌 你的帳號定位建議') ||
                                     aiResponse.includes('帳號定位建議：') ||
                                     aiResponse.includes('定位總結：') ||
                                     (aiResponse.includes('定位建議') && aiResponse.length > 200);
        
        // 判斷是否為明確的選題推薦結果
        const isTopicsSummary = aiResponse.includes('📌 選題推薦') ||
                               aiResponse.includes('選題建議：') ||
                               aiResponse.includes('推薦選題：') ||
                               (aiResponse.includes('選題') && 
                                (aiResponse.includes('1.') || aiResponse.includes('一、')) &&
                                aiResponse.length > 200);
        
        // 判斷是否為完整腳本（必須包含結構化內容）
        const isCompletScript = (aiResponse.includes('Hook') || aiResponse.includes('開場')) && 
                               (aiResponse.includes('Value') || aiResponse.includes('核心')) && 
                               (aiResponse.includes('CTA') || aiResponse.includes('行動呼籲')) &&
                               aiResponse.length > 300;
        
        // 根據判斷結果顯示到對應區塊（只顯示明確的總結/結果）
        if (isCompletScript) {
          // 完整腳本：顯示到腳本區塊
          updateResultBlock('scriptContent', aiResponse, true);
          document.getElementById('scriptActions').style.display = 'flex';
          switchTab('script');
        } else if (isTopicsSummary) {
          // 選題推薦：顯示到選題區塊
          updateResultBlock('topicContent', aiResponse, true);
          document.getElementById('topicActions').style.display = 'flex';
          switchTab('topics');
        } else if (isPositioningSummary) {
          // 帳號定位總結：顯示到定位區塊
          updateResultBlock('positioningContent', aiResponse, true);
          document.getElementById('positioningActions').style.display = 'flex';
          switchTab('positioning');
        }
        // 如果都不符合（一般討論、問答），就不顯示到結果區（保留在對話框中）
      }
      
      // 一鍵生成選題
      async function generateTopics() {
        // 動態查找輸入元素，優先使用手機版
        const platformEl = document.querySelector('#mode1-mobile-setup #platformSelect') || document.getElementById('platformSelect');
        const topicEl = document.querySelector('#mode1-mobile-setup #topicInput') || document.getElementById('topicInput');
        const positioningEl = document.querySelector('#mode1-mobile-setup #positioningInput') || document.getElementById('positioningInput');
        
        const platform = platformEl ? platformEl.value : '';
        const topic = topicEl ? topicEl.value : '';
        const positioning = positioningEl ? positioningEl.value : '';
        
        // 檢查是否已完成帳號定位（只檢查是否為預設提示文字）
        const positioningContent = document.getElementById('positioningContent').textContent.trim();
        const isDefaultText = positioningContent.includes('請點選「一鍵生成帳號定位」按鈕開始') ||
                             positioningContent.includes('點擊「一鍵生成帳號定位」') || 
                             positioningContent.includes('開始分析');
        
        if (!positioningContent || isDefaultText) {
          showToast('請先完成帳號定位', 3000);
          return;
        }
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicContent', '正在推薦選題...', false);
        
        // 立即顯示操作按鈕
        document.getElementById('topicActions').style.display = 'flex';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/generate/topics', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請幫我推薦選題',
              platform: platform,
              topic: topic,
              duration: '30',
              style: styleInstruction,
              profile: positioning,
              history: [],
              user_id: ipPlanningUser?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error('生成失敗');
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let result = '';
          let generationEnded = false;
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'token' && data.content) {
                    result += data.content;
                    updateResultBlock('topicContent', result, true);
                  } else if (data.type === 'end') {
                    generationEnded = true;
                    break;
                  } else if (data.type === 'error') {
                    throw new Error(data.message || '生成失敗');
                  }
                } catch (e) {
                  console.error('解析錯誤:', e);
                }
              }
            }
            
            if (generationEnded) break;
          }
          
          // 自動切換到選題標籤
          switchTab('topics');
          
          // 自動保存選題內容到 generations 表（生成完成後）
          if (generationEnded && result && result.trim() && ipPlanningToken && ipPlanningUser && ipPlanningUser.user_id) {
            try {
              const saveResponse = await fetch('https://api.aijob.com.tw/api/generations', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${ipPlanningToken}`
                },
                body: JSON.stringify({
                  user_id: ipPlanningUser.user_id,
                  content: result,
                  platform: platform,
                  topic: topic || '選題推薦'
                })
              });
              
              if (saveResponse.ok) {
                const saveData = await saveResponse.json();
                // 重新載入選題內容列表（如果用戶在創作者資料庫頁面）
                const topicRecordsSection = document.querySelector('#db-topicRecords');
                if (topicRecordsSection && topicRecordsSection.style.display !== 'none') {
                  loadTopicHistoryForUserDB();
                }
              } else {
                console.warn('選題保存失敗，但不影響使用');
              }
            } catch (saveError) {
              console.error('自動儲存選題失敗:', saveError);
              // 靜默失敗，不影響用戶體驗
            }
          }
          
        } catch (error) {
          updateResultBlock('topicContent', '生成失敗，請稍後再試', false);
          showToast('生成選題失敗', 3000);
        }
      }
      
      // 儲存結果
      async function saveResult(type) {
        if (!ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        let content = '';
        let contentElement = null;
        
        switch(type) {
          case 'positioning':
            contentElement = document.getElementById('positioningContent');
            break;
          case 'topics':
            contentElement = document.getElementById('topicContent');
            break;
          case 'script':
            contentElement = document.getElementById('scriptContent');
            break;
        }
        
        if (contentElement) {
          content = contentElement.textContent;
          
          // 只有帳號定位需要保存到資料庫
          if (type === 'positioning') {
            try {
              const response = await fetch('https://api.aijob.com.tw/api/user/positioning/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${ipPlanningToken}`
                },
                body: JSON.stringify({
                  user_id: ipPlanningUser.user_id,
                  content: content
                })
              });
              
              if (response.ok) {
                const data = await response.json();
                showToast(`帳號定位已儲存（編號：${data.record_number}）`, 3000);
                // 重新載入帳號定位列表
                await loadPositioningRecords();
              } else {
                throw new Error('儲存失敗');
              }
            } catch (error) {
              console.error('儲存錯誤:', error);
              showToast('儲存失敗，請稍後再試', 3000);
            }
          } else {
            // 其他類型暫時儲存到 localStorage
            localStorage.setItem(`saved_${type}`, content);
            showToast(`${type === 'topics' ? '選題' : '腳本'}已儲存`, 2000);
          }
        }
      }
      
      // 腳本儲存功能
      async function saveScript() {
        if (!ipPlanningUser || !ipPlanningUser.user_id || !ipPlanningToken) {
          showToast('請先登入', 3000);
          return;
        }
        
        const content = document.getElementById('scriptContent').textContent;
        if (!content || content.includes('請點選「一鍵生成腳本」按鈕開始') || content.includes('請先完成')) {
          showToast('沒有可儲存的內容', 3000);
          return;
        }
        
        try {
          // 提取腳本內容的結構化數據
          const scriptData = extractScriptData(content);
          
          const response = await fetch('https://api.aijob.com.tw/api/scripts/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              user_id: ipPlanningUser.user_id,
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            })
          });
          
          
          if (response.ok) {
            const result = await response.json();
            
            // 同時儲存到本地
            const localScriptData = {
              name: scriptData.title || '未命名腳本',
              title: scriptData.title || '',
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            };
            saveScriptToLocal(localScriptData);
            
            showToast('腳本儲存成功！', 3000);
            // 延遲一下再載入腳本列表，確保後端處理完成
            setTimeout(() => {
              loadMyScripts();
              loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
            }, 1000);
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else if (response.status === 404) {
            // 後端API不存在時，使用本地儲存
            const localScriptData = {
              name: scriptData.title || '未命名腳本',
              title: scriptData.title || '',
              content: content,
              script_data: scriptData,
              platform: currentPlatform || '未設定',
              topic: currentTopic || '未設定',
              profile: currentProfile || '未設定'
            };
            saveScriptToLocal(localScriptData);
            showToast('腳本已儲存到本地！', 3000);
            setTimeout(() => {
              loadMyScripts();
              loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
            }, 500);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '儲存失敗');
          }
        } catch (error) {
          console.error('Save script error:', error);
          // 網路錯誤時，也使用本地儲存
          const localScriptData = {
            name: scriptData.title || '未命名腳本',
            title: scriptData.title || '',
            content: content,
            script_data: scriptData,
            platform: currentPlatform || '未設定',
            topic: currentTopic || '未設定',
            profile: currentProfile || '未設定'
          };
          saveScriptToLocal(localScriptData);
          showToast('腳本已儲存到本地！', 3000);
          setTimeout(() => {
            loadMyScripts();
            loadMyScriptsForUserDB(); // 同時載入資料庫頁面的腳本
          }, 500);
        }
      }
      
      // 提取腳本數據 - 按照規範格式解析
      function extractScriptData(content) {
        
        try {
          // 清理內容，移除HTML標籤
          const cleanContent = content.replace(/<[^>]*>/g, '').trim();
          
          // 按照規範解析腳本
          const scriptData = parseScriptToJSON(cleanContent);
          return scriptData;
          
        } catch (error) {
          console.error('腳本解析失敗:', error);
          return {
            error: "PARSE_FAILED",
            message: "腳本格式解析失敗，請檢查內容格式"
          };
        }
      }
      
      // 按照規範將腳本解析為JSON格式
      function parseScriptToJSON(content) {
        const lines = content.split('\n').map(line => line.trim()).filter(line => line);
        
        // 1. 提取主題標題
        let title = '';
        for (let line of lines) {
          if (line.includes('主題') || line.includes('標題') || line.match(/^[1-9]\.?\s*[^0-9]/)) {
            title = line.replace(/^[1-9]\.?\s*/, '').replace(/[：:]\s*/, '').trim();
            break;
          }
        }
        
        // 如果沒找到主題，使用第一行
        if (!title && lines.length > 0) {
          title = lines[0].replace(/^[1-9]\.?\s*/, '').replace(/[：:]\s*/, '').trim();
        }
        
        // 2. 解析腳本分段
        const rows = [];
        let currentSegment = null;
        let valueCount = 0;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // 檢查時間模式
          const timeMatch = line.match(/(\d+)-(\d+)s?/i);
          if (timeMatch) {
            // 保存上一個段落
            if (currentSegment) {
              rows.push(currentSegment);
            }
            
            // 開始新段落
            const startSec = parseInt(timeMatch[1]);
            const endSec = parseInt(timeMatch[2]);
            
            // 確定段落類型
            let section = '';
            if (line.toLowerCase().includes('hook')) {
              section = 'Hook';
            } else if (line.toLowerCase().includes('value') || line.toLowerCase().includes('價值')) {
              valueCount++;
              section = `Value ${valueCount}`;
            } else if (line.toLowerCase().includes('cta') || line.toLowerCase().includes('行動呼籲')) {
              section = 'CTA';
            } else {
              // 根據時間推測段落類型
              if (startSec === 0) {
                section = 'Hook';
              } else if (valueCount < 3) {
                valueCount++;
                section = `Value ${valueCount}`;
              } else {
                section = 'CTA';
              }
            }
            
            currentSegment = {
              start_sec: startSec,
              end_sec: endSec,
              section: section,
              shot_desc: '',
              dialogue: '',
              subtitle: '',
              sfx: ''
            };
            
            continue;
          }
          
          // 解析段落內容
          if (currentSegment) {
            // 檢查是否為台詞
            if (line.includes('台詞') || line.includes('口白') || line.match(/^「.*」$/) || line.match(/^".*"$/)) {
              currentSegment.dialogue = line.replace(/^[台詞口白：:]\s*/, '').replace(/^["「]|["」]$/g, '').trim();
            }
            // 檢查是否為鏡頭描述
            else if (line.includes('鏡頭') || line.includes('畫面') || line.includes('CU') || line.includes('MS') || line.includes('LS')) {
              currentSegment.shot_desc = line.replace(/^[鏡頭畫面：:]\s*/, '').trim();
            }
            // 檢查是否為字幕
            else if (line.includes('字幕') || line.includes('大字卡')) {
              currentSegment.subtitle = line.replace(/^[字幕大字卡：:]\s*/, '').trim();
            }
            // 檢查是否為音效
            else if (line.includes('音效') || line.includes('轉場') || line.includes('音樂')) {
              currentSegment.sfx = line.replace(/^[音效轉場音樂：:]\s*/, '').trim();
            }
            // 如果沒有標籤，根據內容推測
            else if (line.length > 0) {
              // 如果台詞為空，可能是台詞
              if (!currentSegment.dialogue) {
                currentSegment.dialogue = line;
              }
              // 如果鏡頭描述為空，可能是鏡頭描述
              else if (!currentSegment.shot_desc) {
                currentSegment.shot_desc = line;
              }
            }
          }
        }
        
        // 保存最後一個段落
        if (currentSegment) {
          rows.push(currentSegment);
        }
        
        // 3. 排序並確保時間正確
        rows.sort((a, b) => a.start_sec - b.start_sec);
        
        // 4. 清理數據
        rows.forEach(row => {
          // 移除末尾空白和標點符號（保留表情符號）
          row.dialogue = cleanText(row.dialogue);
          row.shot_desc = cleanText(row.shot_desc);
          row.subtitle = cleanText(row.subtitle);
          row.sfx = cleanText(row.sfx);
          
          // 確保end_sec > start_sec
          if (row.end_sec <= row.start_sec) {
            row.end_sec = row.start_sec + 1;
          }
        });
        
        // 5. 構建最終JSON
        const result = {
          creator_id: ipPlanningUser ? ipPlanningUser.user_id : 'unknown',
          project_id: null,
          title: title,
          rows: rows
        };
        
        return result;
      }
      
      // 清理文本數據
      function cleanText(text) {
        if (!text) return '';
        
        // 移除末尾空白和標點符號（保留表情符號）
        return text.replace(/\s+$/, '').replace(/[。，、；：！？]$/, '');
      }
      
      // 載入我的腳本
      async function loadMyScripts() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          return;
        }
        
        // 先檢查本地儲存的腳本
        const localScripts = getLocalScripts();
        if (localScripts.length > 0) {
          displayScripts(localScripts);
          return;
        }
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/scripts/my', {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          
          if (response.ok) {
            const data = await response.json();
            displayScripts(data.scripts || []);
          } else if (response.status === 401) {
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          } else if (response.status === 404) {
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">腳本功能即將上線，請稍後再試</div>';
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load scripts error:', error);
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 獲取本地儲存的腳本
      function getLocalScripts() {
        try {
          const scripts = localStorage.getItem('user_scripts');
          return scripts ? JSON.parse(scripts) : [];
        } catch (error) {
          console.error('Error loading local scripts:', error);
          return [];
        }
      }
      
      // 儲存腳本到本地
      function saveScriptToLocal(scriptData) {
        try {
          const scripts = getLocalScripts();
          
          // 確保每個腳本都有唯一的 ID
          // 使用時間戳 + 隨機數來確保唯一性
          const uniqueId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          
          const newScript = {
            id: uniqueId,
            ...scriptData,
            created_at: new Date().toISOString()
          };
          
          // 檢查是否已存在相同 ID 的腳本（避免重複）
          const existingIndex = scripts.findIndex(s => s.id === uniqueId);
          if (existingIndex === -1) {
            // 新腳本，添加到開頭
          scripts.unshift(newScript);
          } else {
            // 如果已存在（不太可能），更新它
            scripts[existingIndex] = newScript;
          }
          
          localStorage.setItem('user_scripts', JSON.stringify(scripts));
        } catch (error) {
          console.error('Error saving script locally:', error);
        }
      }
      
      // 載入選題記錄
      async function loadTopicHistory() {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          return;
        }
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/generations', {
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            displayTopicHistory(data.generations || []);
          } else if (response.status === 401) {
            document.getElementById('generationsList').innerHTML = '<div class="loading-text">請先登入</div>';
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '載入失敗');
          }
        } catch (error) {
          console.error('Load topic history error:', error);
          document.getElementById('generationsList').innerHTML = '<div class="loading-text">載入失敗，請稍後再試</div>';
        }
      }
      
      // 顯示選題記錄
      function displayTopicHistory(topics) {
        const container = document.getElementById('generationsList');
        
        if (topics.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有選題記錄</div>';
          return;
        }
        
        container.innerHTML = topics.map((topic, index) => `
          <div class="generation-item">
            <div class="generation-header">
              <span class="generation-number">記錄 ${index + 1}</span>
              <span class="generation-date">${formatTaiwanTime(topic.created_at)}</span>
            </div>
            <div class="generation-content">${topic.content}</div>
          </div>
        `).join('');
      }
      
      // 顯示腳本列表
      function displayScripts(scripts) {
        const container = document.getElementById('generationsList');
        
        if (scripts.length === 0) {
          container.innerHTML = '<div class="loading-text">還沒有儲存的腳本</div>';
          return;
        }
        
        container.innerHTML = scripts.map((script, index) => `
          <div class="script-item" data-script-id="${script.id}">
            <div class="script-header" onclick="toggleScript(${script.id})">
              <div class="script-info">
                <span class="script-number">編號${String(index + 1).padStart(2, '0')}</span>
                <span class="script-name" onclick="editScriptName(${script.id}, event)">${script.name || script.title || '未命名腳本'}</span>
                <span class="script-date">${formatTaiwanTime(script.created_at)}</span>
              </div>
              <div class="script-toggle">
                <span class="toggle-icon">▼</span>
              </div>
            </div>
            <div class="script-content" id="script-${script.id}" style="display: none;">
              <div class="script-details">
                <div class="script-table">
                  <table>
                    <thead>
                      <tr>
                        <th>時間</th>
                        <th>段落</th>
                        <th>鏡頭/畫面</th>
                        <th>台詞 (演員口白)</th>
                        <th>字幕文字 (可動畫)</th>
                        <th>音效與轉場</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${generateScriptTable(script.script_data)}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="script-actions" id="actions-${script.id}" style="display: none;">
              <button class="action-btn view-btn" onclick="viewFullScript(${script.id})">查看完整結果</button>
              <button class="action-btn download-pdf-btn" onclick="downloadScriptPDF(${script.id})">下載PDF檔案</button>
              <button class="action-btn download-csv-btn" onclick="downloadScriptCSV(${script.id})">下載CSV檔案</button>
              <button class="action-btn delete-btn" onclick="deleteScript(${script.id})">刪除</button>
            </div>
          </div>
        `).join('');
      }
      // 根據台詞內容生成畫面描述
      function generateVisualDescription(dialogue) {
        if (!dialogue || dialogue.trim() === '') return '-';
        
        const content = dialogue.toLowerCase();
        
        // 時間相關
        if (content.includes('時間') || content.includes('⏳') || content.includes('時鐘')) {
          return '時鐘特寫，指針快速轉動';
        }
        
        // 工作/加班相關
        if (content.includes('加班') || content.includes('工作') || content.includes('疲憊')) {
          return '疲憊的上班族在辦公室加班';
        }
        
        // AI/科技相關
        if (content.includes('ai') || content.includes('智能') || content.includes('✨')) {
          return '高效工作者使用AI工具，螢幕發光';
        }
        
        // 驚訝/震驚相關
        if (content.includes('😲') || content.includes('不知道') || content.includes('out')) {
          return '驚訝表情特寫';
        }
        
        // 決策/思考相關
        if (content.includes('決策') || content.includes('聰明') || content.includes('🧠')) {
          return '大腦圖案與數據分析圖表結合';
        }
        
        // 機會/目標相關
        if (content.includes('機會') || content.includes('抓住') || content.includes('🎯')) {
          return '箭頭射中靶心';
        }
        
        // 競爭相關
        if (content.includes('競爭') || content.includes('超車') || content.includes('🔥')) {
          return '賽車超越對手，火焰特效';
        }
        
        // 未來/趨勢相關
        if (content.includes('未來') || content.includes('趨勢') || content.includes('入場券')) {
          return '一張通往未來世界的門票';
        }
        
        // 成功/成就相關
        if (content.includes('成功') || content.includes('掌握') || content.includes('🏆')) {
          return '一人自信地操作AI工具，獎盃特寫';
        }
        
        // 角色相關
        if (content.includes('學生') || content.includes('上班族') || content.includes('創業者')) {
          return '學生、上班族、創業者三種不同角色的蒙太奇畫面';
        }
        
        // 上升/進步相關
        if (content.includes('上升') || content.includes('搭上') || content.includes('列車')) {
          return '一人登上快速行駛的列車或電梯';
        }
        
        // 金錢相關
        if (content.includes('金錢') || content.includes('💰') || content.includes('省下')) {
          return '時鐘與金錢符號的疊加動畫';
        }
        
        // 文件/資料相關
        if (content.includes('文件') || content.includes('資料') || content.includes('分析')) {
          return '動畫展示文件自動歸類、數據圖表自動生成';
        }
        
        // 操作相關
        if (content.includes('指令') || content.includes('下指令') || content.includes('💡')) {
          return '手指輕點螢幕，任務快速完成的進度條';
        }
        
        // 問題/疑問相關
        if (content.includes('?') || content.includes('？') || content.includes('如何') || content.includes('什麼')) {
          return '疑問表情特寫，思考狀態';
        }
        
        // 強調/重要相關
        if (content.includes('重要') || content.includes('關鍵') || content.includes('注意')) {
          return '重要資訊高亮顯示，強調效果';
        }
        
        // 對比相關
        if (content.includes('vs') || content.includes('對比') || content.includes('比較')) {
          return '左右分屏對比畫面';
        }
        
        // 步驟/流程相關
        if (content.includes('步驟') || content.includes('流程') || content.includes('第一') || content.includes('第二')) {
          return '步驟指示圖，流程動畫';
        }
        
        // 預設描述
        return '根據台詞內容的相關畫面';
      }
      
      // 生成腳本表格
      function generateScriptTable(scriptData) {
        
        // 檢查是否有錯誤
        if (scriptData && scriptData.error) {
          return `<tr><td colspan="6">解析失敗: ${scriptData.message}</td></tr>`;
        }
        
        // 處理新格式（有rows欄位）
        if (scriptData && scriptData.rows && scriptData.rows.length > 0) {
          let tableRows = '';
          
          // 按照規範格式生成表格行
          scriptData.rows.forEach((row, index) => {
            const timeRange = `${row.start_sec}-${row.end_sec}s`;
            const section = row.section || '-';
            const shotDesc = row.shot_desc || '-';
            const dialogue = row.dialogue || '-';
            const subtitle = row.subtitle || '-';
            const sfx = row.sfx || '-';
            
            tableRows += `
              <tr>
                <td>${timeRange}</td>
                <td>${section}</td>
                <td title="${shotDesc}">${shotDesc}</td>
                <td title="${dialogue}">${dialogue}</td>
                <td title="${subtitle}">${subtitle}</td>
                <td title="${sfx}">${sfx}</td>
              </tr>
            `;
          });
          
          return tableRows || '<tr><td colspan="6">無數據</td></tr>';
        }
        
        // 處理舊格式（有sections欄位）
        if (scriptData && scriptData.sections && scriptData.sections.length > 0) {
        let tableRows = '';
        let timeIndex = 0;
        const timeRanges = ['0-3s', '3-7s', '7-15s', '15-25s', '25-30s'];
        
          // 檢查是否有畫面感資料
          const hasVisualData = scriptData.visual && scriptData.visual.trim() !== '';
          let visualLines = [];
          
          if (hasVisualData) {
            // 解析畫面感內容，按行分割
            visualLines = scriptData.visual.split('\n').map(line => line.trim()).filter(line => line);
          }
          
          scriptData.sections.forEach((section, sectionIndex) => {
            
            // 如果段落有內容
            if (section.content && section.content.length > 0) {
          section.content.forEach((content, contentIndex) => {
            const timeRange = timeRanges[timeIndex] || '-';
            const sectionType = section.type || '內容段落';
                
                // 清理內容，移除多餘的空白
                const cleanContent = content.trim();
                
                // 限制顯示長度，超過30個字符就截斷並加上省略號
                const displayContent = cleanContent.length > 30 ? 
                  cleanContent.substring(0, 30) + '...' : cleanContent;
              
                // 獲取對應的畫面描述
                let visualDescription = '-';
                if (hasVisualData && visualLines[timeIndex]) {
                  // 使用實際的畫面感內容
                  visualDescription = visualLines[timeIndex].length > 50 ? 
                    visualLines[timeIndex].substring(0, 50) + '...' : visualLines[timeIndex];
                } else {
                  // 如果沒有畫面感資料，使用智能生成
                  visualDescription = generateVisualDescription(cleanContent);
                }
            
            tableRows += `
              <tr>
                <td>${timeRange}</td>
                <td>${sectionType}</td>
                    <td title="${hasVisualData && visualLines[timeIndex] ? visualLines[timeIndex] : visualDescription}">${visualDescription}</td>
                    <td title="${cleanContent}">${displayContent}</td>
                <td>-</td>
                    <td>-</td>
                  </tr>
                `;
                timeIndex++;
              });
            } else {
              // 如果段落沒有內容，但段落類型存在
              const timeRange = timeRanges[timeIndex] || '-';
              const sectionType = section.type || '內容段落';
              
              // 獲取對應的畫面描述
              let visualDescription = '-';
              if (hasVisualData && visualLines[timeIndex]) {
                visualDescription = visualLines[timeIndex].length > 50 ? 
                  visualLines[timeIndex].substring(0, 50) + '...' : visualLines[timeIndex];
              }
              
              tableRows += `
                <tr>
                  <td>${timeRange}</td>
                  <td>${sectionType}</td>
                  <td title="${hasVisualData && visualLines[timeIndex] ? visualLines[timeIndex] : ''}">${visualDescription}</td>
                  <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
            `;
            timeIndex++;
            }
        });
        
        return tableRows || '<tr><td colspan="6">無數據</td></tr>';
        }
        
        // 如果都沒有，返回無數據
        return '<tr><td colspan="6">無數據</td></tr>';
      }
      
      // 切換腳本展開/收起
      function toggleScript(scriptId) {
        const content = document.getElementById(`script-${scriptId}`);
        const actions = document.getElementById(`actions-${scriptId}`);
        const toggleIcon = document.querySelector(`[data-script-id="${scriptId}"] .toggle-icon`);
        
        if (content.style.display === 'none') {
          content.style.display = 'block';
          actions.style.display = 'flex';
          toggleIcon.textContent = '▲';
        } else {
          content.style.display = 'none';
          actions.style.display = 'none';
          toggleIcon.textContent = '▼';
        }
      }
      
      // 編輯腳本名稱
      function editScriptName(scriptId, event) {
        event.stopPropagation();
        const nameElement = event.target;
        const currentName = nameElement.textContent;
        
        const newName = prompt('請輸入新的腳本名稱:', currentName);
        if (newName && newName !== currentName) {
          updateScriptName(scriptId, newName);
        }
      }
      
      // 更新腳本名稱
      async function updateScriptName(scriptId, newName) {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/scripts/${scriptId}/name`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({ name: newName })
          });
          
          if (response.ok) {
            showToast('腳本名稱更新成功！', 3000);
            loadMyScripts(); // 重新載入列表
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '更新失敗');
          }
        } catch (error) {
          console.error('Update script name error:', error);
          showToast('更新失敗，請稍後再試', 3000);
        }
      }
      
      // 查看完整腳本
      function viewFullScript(scriptId) {
        // 找到對應的腳本數據
        const scripts = getLocalScripts();
        const script = scripts.find(s => s.id == scriptId);
        
        if (!script) {
          showToast('找不到腳本數據', 3000);
          return;
        }
        
        // 創建彈出視窗
        const modal = document.createElement('div');
        modal.className = 'script-modal-overlay';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 24px;
          max-width: 90%;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        `;
        
        // 生成完整腳本內容
        let fullContent = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
            <h2 style="margin: 0; color: #1f2937; font-size: 20px;">${script.name || '未命名腳本'}</h2>
            <button onclick="this.closest('.script-modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
          </div>
        `;
        
        if (script.script_data && script.script_data.sections) {
          fullContent += '<div style="margin-bottom: 20px;">';
          script.script_data.sections.forEach((section, index) => {
            fullContent += `
              <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                <h3 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">${section.type || '內容段落'}</h3>
                <div style="color: #4b5563; line-height: 1.6;">
                  ${section.content ? section.content.map(content => `<p style="margin: 8px 0;">${content}</p>`).join('') : '<p>無內容</p>'}
                </div>
              </div>
            `;
          });
          fullContent += '</div>';
        } else {
          // 如果沒有結構化數據，顯示原始內容
          fullContent += `
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #4b5563;">
              ${script.content || '無內容'}
            </div>
          `;
        }
        
        modalContent.innerHTML = fullContent;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // 點擊背景關閉
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }
      
      // 下載PDF（創作者資料庫版本）
      window.downloadScriptPDF = function(scriptId) {
        // 獲取腳本數據
        const scripts = getLocalScripts();
        let script = scripts.find(s => s.id == scriptId);
        
        // 如果本地找不到，嘗試從 DOM 獲取
        if (!script) {
          const scriptItem = document.querySelector(`[data-script-id="${scriptId}"]`);
          if (scriptItem) {
            const scriptName = scriptItem.querySelector('.script-name')?.textContent || '未命名腳本';
            const scriptDate = scriptItem.querySelector('.script-date')?.textContent || '';
            const scriptTable = scriptItem.querySelector('table');
            
            if (scriptTable) {
              const rows = Array.from(scriptTable.querySelectorAll('tbody tr'));
              const scriptData = {
                rows: rows.map(row => {
                  const cells = row.querySelectorAll('td');
                  return {
                    time: cells[0]?.textContent || '-',
                    section: cells[1]?.textContent || '-',
                    shot_desc: cells[2]?.textContent || '-',
                    dialogue: cells[3]?.textContent || '-',
                    subtitle: cells[4]?.textContent || '-',
                    sfx: cells[5]?.textContent || '-'
                  };
                })
              };
              
              script = {
                id: scriptId,
                name: scriptName,
                created_at: scriptDate,
                script_data: scriptData
              };
            }
          }
        }
        
        if (!script) {
          showToast('找不到腳本數據', 3000);
          return;
        }
        
        // 創建可列印的 HTML 內容
        let printContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>${script.name || '未命名腳本'}</title>
            <style>
              @media print {
                body { margin: 0; padding: 20px; }
                .no-print { display: none; }
              }
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { color: #1f2937; margin-bottom: 10px; }
              .meta { color: #6b7280; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
              td { padding: 10px; border-bottom: 1px solid #e5e7eb; color: #4b5563; }
              tr:nth-child(even) { background: #f9fafb; }
            </style>
          </head>
          <body>
            <h1>${script.name || '未命名腳本'}</h1>
            ${script.created_at ? `<div class="meta">建立時間：${script.created_at}</div>` : ''}
        `;
        
        // 生成表格內容
        if (script.script_data && script.script_data.rows && script.script_data.rows.length > 0) {
          printContent += `
            <table>
              <thead>
                <tr>
                  <th>時間</th>
                  <th>段落</th>
                  <th>鏡頭/畫面</th>
                  <th>台詞 (演員口白)</th>
                  <th>字幕文字 (可動畫)</th>
                  <th>音效與轉場</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          script.script_data.rows.forEach(row => {
            // 正確處理時間欄位
            let timeDisplay = '-';
            if (row.time && row.time !== 'undefined-undefineds' && row.time !== '-') {
              timeDisplay = row.time;
            } else if (row.start_sec !== undefined && row.end_sec !== undefined) {
              timeDisplay = `${row.start_sec}-${row.end_sec}s`;
            } else if (row.time && typeof row.time === 'string' && row.time.includes('-') && row.time.includes('s')) {
              timeDisplay = row.time;
            }
            printContent += `
              <tr>
                <td>${timeDisplay}</td>
                <td>${row.section || '-'}</td>
                <td>${row.shot_desc || '-'}</td>
                <td>${row.dialogue || '-'}</td>
                <td>${row.subtitle || '-'}</td>
                <td>${row.sfx || '-'}</td>
              </tr>
            `;
          });
          
          printContent += `
              </tbody>
            </table>
          `;
        } else if (script.script_data && script.script_data.sections) {
          script.script_data.sections.forEach(section => {
            printContent += `
              <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 4px solid #3b82f6;">
                <h3 style="margin: 0 0 12px 0; color: #374151;">${section.type || '內容段落'}</h3>
                <div style="color: #4b5563; line-height: 1.8;">
                  ${section.content ? section.content.map(content => `<p style="margin: 8px 0;">${content}</p>`).join('') : '<p>無內容</p>'}
                </div>
              </div>
            `;
          });
        } else {
          printContent += `<div style="padding: 16px; background: #f8fafc; white-space: pre-wrap;">${script.content || '無內容'}</div>`;
        }
        
        printContent += `
          </body>
          </html>
        `;
        
        // 創建新窗口並列印
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // 等待內容載入後列印
        printWindow.onload = () => {
          setTimeout(() => {
            printWindow.print();
            showToast('PDF 準備就緒，請使用瀏覽器的列印功能儲存為 PDF', 3000);
          }, 250);
        };
      }
      
      // 下載CSV（創作者資料庫版本）
      window.downloadScriptCSV = function(scriptId) {
        // 獲取腳本數據
        const scripts = getLocalScripts();
        let script = scripts.find(s => s.id == scriptId);
        
        // 如果本地找不到，嘗試從 DOM 獲取
        if (!script) {
          const scriptItem = document.querySelector(`[data-script-id="${scriptId}"]`);
          if (scriptItem) {
            const scriptName = scriptItem.querySelector('.script-name')?.textContent || '未命名腳本';
            const scriptDate = scriptItem.querySelector('.script-date')?.textContent || '';
            const scriptTable = scriptItem.querySelector('table');
            
            if (scriptTable) {
              const rows = Array.from(scriptTable.querySelectorAll('tbody tr'));
              const scriptData = {
                rows: rows.map(row => {
                  const cells = row.querySelectorAll('td');
                  return {
                    time: cells[0]?.textContent || '-',
                    section: cells[1]?.textContent || '-',
                    shot_desc: cells[2]?.textContent || '-',
                    dialogue: cells[3]?.textContent || '-',
                    subtitle: cells[4]?.textContent || '-',
                    sfx: cells[5]?.textContent || '-'
                  };
                })
              };
              
              script = {
                id: scriptId,
                name: scriptName,
                created_at: scriptDate,
                script_data: scriptData
              };
            }
          }
        }
        
        if (!script) {
          showToast('找不到腳本數據', 3000);
          return;
        }
        
        // 生成 CSV 內容
        let csvContent = '\uFEFF'; // BOM for Excel UTF-8 support
        csvContent += `腳本名稱,${script.name || '未命名腳本'}\n`;
        csvContent += `建立時間,${script.created_at || '-'}\n`;
        csvContent += '\n';
        csvContent += '時間,段落,鏡頭/畫面,台詞 (演員口白),字幕文字 (可動畫),音效與轉場\n';
        
        // 處理 CSV 中的特殊字符（逗號、引號、換行）
        const escapeCSV = (str) => {
          if (!str) return '-';
          const s = String(str);
          if (s.includes(',') || s.includes('"') || s.includes('\n')) {
            return `"${s.replace(/"/g, '""')}"`;
          }
          return s;
        };
        
        if (script.script_data && script.script_data.rows && script.script_data.rows.length > 0) {
          script.script_data.rows.forEach(row => {
            // 正確處理時間欄位
            let timeDisplay = '-';
            if (row.time && row.time !== 'undefined-undefineds' && row.time !== '-') {
              timeDisplay = row.time;
            } else if (row.start_sec !== undefined && row.end_sec !== undefined) {
              timeDisplay = `${row.start_sec}-${row.end_sec}s`;
            } else if (row.time && typeof row.time === 'string' && row.time.includes('-') && row.time.includes('s')) {
              timeDisplay = row.time;
            }
            csvContent += `${escapeCSV(timeDisplay)},${escapeCSV(row.section)},${escapeCSV(row.shot_desc)},${escapeCSV(row.dialogue)},${escapeCSV(row.subtitle)},${escapeCSV(row.sfx)}\n`;
          });
        } else if (script.script_data && script.script_data.sections) {
          script.script_data.sections.forEach(section => {
            if (section.content && section.content.length > 0) {
              section.content.forEach(content => {
                csvContent += `-,${escapeCSV(section.type || '內容段落')},-,${escapeCSV(content)},-,-\n`;
              });
            }
          });
        } else {
          csvContent += `-,全部內容,,-,${escapeCSV(script.content || '無內容')},-\n`;
        }
        
        // 創建下載連結
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${script.name || '腳本'}_${Date.now()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('CSV 檔案下載成功！', 2000);
      }
      
      // 刪除腳本
      async function deleteScript(scriptId) {
        if (!ipPlanningToken || !ipPlanningUser || !ipPlanningUser.user_id) {
          showToast('請先登入', 3000);
          return;
        }
        
        if (!confirm('確定要刪除這個腳本嗎？')) {
          return;
        }
        
        try {
          const response = await fetch(`https://api.aijob.com.tw/api/scripts/${scriptId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${ipPlanningToken}`
            }
          });
          
          if (response.ok) {
            showToast('腳本刪除成功！', 3000);
            loadMyScripts(); // 重新載入列表
          } else if (response.status === 401) {
            showToast('請先登入', 3000);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '刪除失敗');
          }
        } catch (error) {
          console.error('Delete script error:', error);
          showToast('刪除失敗，請稍後再試', 3000);
        }
      }
      
      // 格式化台灣時間
      function formatTaiwanTime(dateString) {
        if (!dateString) return '-';
        try {
        const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString; // 如果日期無效，返回原始字符串
          }
        return date.toLocaleString('zh-TW', {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        } catch (error) {
          console.error('格式化台灣時區時間錯誤:', error);
          return dateString; // 發生錯誤時返回原始字符串
        }
      }
      
      // 重新生成結果
      async function regenerateResult(type) {
        switch(type) {
          case 'positioning':
            await generatePositioning();
            break;
          case 'topics':
            await generateTopics();
            break;
          case 'script':
            await generateScript();
            break;
        }
      }
      
      // 更新結果區塊內容
      function updateResultBlock(elementId, content, hasContent) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (hasContent) {
            element.classList.add('has-content');
          } else {
            element.classList.remove('has-content');
          }
        }
      }
      
      // 帳號定位功能
      async function analyzePositioning() {
        const positioning = positioningInput.value;
        
        if (!positioning) {
          showToast('請先輸入帳號定位', 3000);
          return;
        }
        
        updateResultBlock('positioningResult', '正在分析帳號定位...', false);
        
        try {
          // 這裡可以調用後端 API 進行帳號定位分析
          // 暫時使用模擬數據
          setTimeout(() => {
            const analysis = `根據您的帳號定位"${positioning}"，建議：\n\n1. 內容風格：輕鬆幽默\n2. 目標受眾：健康愛好者\n3. 內容主題：加密貨幣與健康結合\n4. 發布時間：晚上8-10點\n5. 互動策略：多使用問答形式`;
            updateResultBlock('positioningResult', analysis, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('positioningResult', '分析失敗，請稍後再試', false);
          showToast('分析失敗', 3000);
        }
      }
      
      // 腳本選題功能
      async function selectTopics() {
        const platform = platformSelect.value;
        const topic = topicInput.value;
        
        if (!platform) {
          showToast('請先選擇平台', 3000);
          return;
        }
        
        updateResultBlock('topicSelectionResult', '正在為您選題...', false);
        
        try {
          // 這裡可以調用後端 API 進行選題
          // 暫時使用模擬數據
          setTimeout(() => {
            const topics = `為${platform}平台推薦以下選題${topic ? `（基於"${topic}"主題）` : ''}：\n\n1. 夏季美白保養的5個小技巧\n2. 30天美白挑戰實測\n3. 美白產品成分大解析\n4. 天然美白方法分享\n5. 美白誤區你中了幾個？`;
            updateResultBlock('topicSelectionResult', topics, true);
          }, 2000);
        } catch (error) {
          updateResultBlock('topicSelectionResult', '選題失敗，請稍後再試', false);
          showToast('選題失敗', 3000);
        }
      }
      
      // 事件監聽器
      document.addEventListener('DOMContentLoaded', async () => {
        // 頁面重新整理時，清空聊天區域（但後端長期記憶會保留）
        const chatMessages = document.getElementById('chatMessages');
        const mode3ChatMessages = document.getElementById('mode3-chatMessages');
        if (chatMessages) {
          chatMessages.innerHTML = '';
        }
        if (mode3ChatMessages) {
          mode3ChatMessages.innerHTML = '';
        }
        
        // 確保抽屜初始狀態為關閉
        closeUserDrawer();
        
        // 檢查是否有認證回調
        await handleAuthCallback();
        
        // 檢查本地存儲的認證資訊
        ipPlanningToken = sessionStorage.getItem('ipPlanningToken');
        ipPlanningUser = JSON.parse(sessionStorage.getItem('ipPlanningUser') || 'null');
        
        if (ipPlanningToken && ipPlanningUser) {
          updateAuthUI(true);
        } else {
          updateAuthUI(false);
        }
        
        // 按鈕功能已整合到快速按鈕中
        
        // 標籤切換事件
        document.querySelectorAll('.result-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
        
        // 設定區塊摺疊/展開功能（檢查元素是否存在）
        const settingsToggleEl = document.getElementById('settingsToggle') || document.querySelector('.settings-toggle');
        const settingsContentEl = document.getElementById('settingsContent') || document.querySelector('.settings-content');
        if (settingsToggleEl && settingsContentEl) {
          settingsToggleEl.addEventListener('click', () => {
            const isCollapsed = settingsContentEl.classList.contains('collapsed');
            const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
            
            if (isCollapsed) {
              settingsContentEl.classList.remove('collapsed');
              if (toggleIcon) toggleIcon.textContent = '▼';
            } else {
              settingsContentEl.classList.add('collapsed');
              if (toggleIcon) toggleIcon.textContent = '▶';
            }
          });
        }
        
        // 登入按鈕功能 - 已經在 HTML 中設定 onclick="goToLogin()"，不需要再次綁定
        // loginBtn.addEventListener('click', login);
        
        // 聊天功能（檢查元素是否存在）
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        
        if (sendBtn && typeof sendMessage === 'function') {
          sendBtn.addEventListener('click', sendMessage);
        }
        
        // 輸入框事件監聽器（檢查元素是否存在）
        if (messageInput && typeof autoResizeTextarea === 'function') {
          messageInput.addEventListener('input', autoResizeTextarea);
          // 初始化發送按鈕狀態
          autoResizeTextarea();
        }
        
        // 快速按鈕功能 - 只綁定到 mode1 的快速按鈕（如果存在的話）
        // 注意：mode2 和 mode3 的快速按鈕有各自獨立的事件監聽器
        // 只處理 mode1 或沒有特定容器標記的快速按鈕
        const mode1QuickButtons = document.querySelectorAll('#mode1 .quick-btn, .mode1-container .quick-btn');
        mode1QuickButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            if (text && messageInput && sendMessage) {
              messageInput.value = text;
              messageInput.focus();
              
              // 添加視覺反饋
              btn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                btn.style.transform = '';
              }, 150);
              
              // 根據按鈕類型切換到對應的結果標籤
              if (text.includes('生成腳本')) {
                switchTab('script');
              } else if (text.includes('腳本選題')) {
                switchTab('topics');
              } else if (text.includes('帳號定位')) {
                switchTab('positioning');
              }
              
              // 自動發送訊息
              setTimeout(() => {
                sendMessage();
              }, 500);
            }
          });
        });
        
        // 設定已套用的標記
        let settingsApplied = false;
        let appliedSettings = {
          platform: null,
          topic: null,
          duration: null,
          positioning: null
        };

        // 檢查 applyBtn 是否存在（避免 null 錯誤）
        if (applyBtn) {
          applyBtn.addEventListener('click', () => {
          const platform = platformSelect.value;
          const topic = topicInput.value;
          const positioning = positioningInput.value;
          const duration = durationInput.value;
          
          if (platform) {
            // 記錄已套用的設定
            settingsApplied = true;
            appliedSettings = {
              platform: platform,
              topic: topic,
              duration: duration,
              positioning: positioning
            };
            
            showToast('設定已套用', 2000);
            
            // 自動收合設定區塊
            settingsContentEl.classList.add('collapsed');
            const toggleIcon = settingsToggleEl.querySelector('.settings-toggle');
            toggleIcon.textContent = '▶';
          } else {
            showToast('請選擇平台', 3000);
          }
          });
        } // 結束 if (applyBtn) 檢查
        
        // 測試連線和顯示結果功能已整合到其他按鈕中
        
        // 綁定彈跳視窗按鈕事件
        popupRetry.addEventListener('click', () => {
          hidePopupOverlay();
          login();
        });
        
        popupCancel.addEventListener('click', () => {
          hidePopupOverlay();
        });
        
        // 鍵盤快捷鍵 - 已移至 initChatGPTFeatures 中處理
      });
      
      // 登入功能
      async function login() {
        try {
          
          // 從後端取得 Google 認證 URL（需要後端 CORS 允許 http://localhost:5173）
          let authUrl = null;
          const fbParam = encodeURIComponent(window.location.origin);
          try {
            const response = await fetch(`https://api.aijob.com.tw/api/auth/google?fb=${fbParam}`);
            const data = await response.json();
            authUrl = data && data.auth_url;
          } catch (corsErr) {
            console.warn('DEBUG: Fetch auth_url failed (likely CORS). Fallback to direct navigate.', corsErr);
            authUrl = `https://api.aijob.com.tw/api/auth/google?fb=${fbParam}`;
          }
          
          // 檢測是否為手機版
          const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          // 一律採用主視窗跳轉（避免彈窗被擋與體驗不一致）
          window.location.href = authUrl;
          return;

          // 以下舊的彈窗流程保留於歷史，不再執行
          let popup = null;
          let popupTimeout = null;
          
          // 定義認證訊息處理函數
          const authMessageHandler = function(event) {
            // 先記錄所有收到的訊息（用於調試）- 已移除調試日誌
            
            // 檢查訊息類型是否為認證相關
            const isAuthMessage = event.data && typeof event.data === 'object' && (
              event.data.type === 'GOOGLE_AUTH_SUCCESS' || 
              event.data.type === 'GOOGLE_AUTH_ERROR'
            );
            
            if (!isAuthMessage) {
              return;
            }
            
            
            // 接受來自所有 origin 的認證訊息（因為使用 '*' targetOrigin）
            // 但記錄 origin 以調試
            const allowedOrigins = [
              'https://api.aijob.com.tw',
              'https://api.aijob.com.tw',
              'https://reelmind.aijob.com.tw',
              'https://reelmind.aijob.com.tw',
              window.location.origin,
              window.location.protocol + '//' + window.location.host,
              'null'  // 某些情況下 origin 可能是 'null'
            ];
            
            if (!allowedOrigins.includes(event.origin) && event.origin !== 'null') {
              console.warn('DEBUG: ⚠️ Message from unexpected origin:', event.origin);
              console.warn('DEBUG: Allowed origins:', allowedOrigins);
              console.warn('DEBUG: But processing anyway since it is auth message with targetOrigin "*"');
            } else {
            }
            
            // 清除逾時
            if (popupTimeout) {
              clearTimeout(popupTimeout);
              popupTimeout = null;
            }
            
            // postMessage 已成功處理
            
            // 關閉彈跳視窗（多策略 + 重試）
            function tryClosePopupNow(){
              try { if (popup) popup.close(); } catch(_) {}
              try { window.open('', 'googleAuth').close(); } catch(_) {}
            }
            tryClosePopupNow();
            let closeRetry = 0;
            const closeTimer = setInterval(() => {
              closeRetry++;
              tryClosePopupNow();
              if (closeRetry >= 6) clearInterval(closeTimer);
            }, 300);
            
              // 清除定期檢查和移除事件監聽器
              if (typeof localStorageCheckInterval !== 'undefined') {
                clearInterval(localStorageCheckInterval);
              }
              window.removeEventListener('message', authMessageHandler);
              window.removeEventListener('storage', storageHandler);
            
            if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
              
              // 認證成功，更新 UI
              // 後端發送的是 accessToken，需要映射到 ipPlanningToken
              ipPlanningToken = event.data.accessToken || event.data.ipPlanningToken;
              
              // 處理 user 對象
              if (event.data.user) {
                ipPlanningUser = {
                  user_id: event.data.user.id || event.data.user.user_id,
                  email: event.data.user.email || '',
                  name: event.data.user.name || '',
                  picture: event.data.user.picture || ''
                };
              } else {
                // 如果沒有 user 對象，嘗試從其他字段構建
                ipPlanningUser = {
                  user_id: event.data.user_id || event.data.user?.id,
                  email: event.data.email || event.data.user?.email || '',
                  name: event.data.name || event.data.user?.name || '',
                  picture: event.data.picture || event.data.user?.picture || ''
                };
              }
              
              
              // 保存到本地存儲
              if (ipPlanningToken) {
                sessionStorage.setItem('ipPlanningToken', ipPlanningToken);
              }
              if (ipPlanningUser) {
                sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
              }
              
              // 隱藏彈窗覆蓋層
              hidePopupOverlay();
              
              // 更新認證 UI（強制更新）
              updateAuthUI(true);
              
              // 重新檢查登入狀態（確保全域變數同步）
              ipPlanningToken = sessionStorage.getItem('ipPlanningToken');
              ipPlanningUser = JSON.parse(sessionStorage.getItem('ipPlanningUser') || 'null');
              
              // 檢查並更新訂閱狀態（先更新訂閱狀態，再顯示主應用程式）
              checkSubscriptionStatus().then(async () => {
                // 檢查是否有 activation_token（授權連結）
                const hashParams = new URLSearchParams(window.location.hash.slice(1));
                const activationToken = hashParams.get('activation_token');
                if (activationToken) {
                  // 登入成功後，自動驗證授權（等待完成）
                  await handleActivationToken(activationToken);
                  // 清除 hash 中的 activation_token
                  const newHash = window.location.hash.replace(/[?&]activation_token=[^&]*/, '').replace(/^#/, '');
                  window.history.replaceState({}, document.title, window.location.pathname + (newHash ? '#' + newHash : ''));
                  // 授權處理完成後，再次檢查訂閱狀態並顯示主應用程式
                  await checkSubscriptionStatus();
                  
                  // 檢查是否有待處理的訂閱方案
                  const pendingPlan = sessionStorage.getItem('pendingSubscriptionPlan');
                  if (pendingPlan) {
                    // 清除待處理方案
                    sessionStorage.removeItem('pendingSubscriptionPlan');
                    // 導向到訂閱頁面
                    window.location.href = `subscription.html?plan=${pendingPlan}`;
                    return;
                  }
                  
                  showMainApp();
                  updateHomepageView();
                } else {
                  // 沒有授權連結，檢查是否有待處理的訂閱方案
                  const pendingPlan = sessionStorage.getItem('pendingSubscriptionPlan');
                  if (pendingPlan) {
                    // 清除待處理方案
                    sessionStorage.removeItem('pendingSubscriptionPlan');
                    // 導向到訂閱頁面
                    window.location.href = `subscription.html?plan=${pendingPlan}`;
                    return;
                  }
                  
                  // 直接顯示主應用程式
                  showMainApp();
                  updateHomepageView();
                }
              });
              
              // 顯示成功提示
              showToast('登入成功！', 2000);
            } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
              hidePopupOverlay();
              showToast('認證失敗：' + (event.data.error || '未知錯誤'), 5000);
            }
          };
          
          // 處理 localStorage 更新的函數（作為 postMessage 的備用方案）
          const storageHandler = function(event) {
            // 調試日誌已移除
            
            // 檢查是否是 token 更新
            if (event.key === 'ipPlanningTokenUpdated' && event.newValue) {
              
              // 從 localStorage 讀取 token 和用戶資訊
              const newToken = sessionStorage.getItem('ipPlanningToken');
              const newUserStr = sessionStorage.getItem('ipPlanningUser');
              
              if (newToken && newToken !== ipPlanningToken) {
                
                // 清除逾時
                if (popupTimeout) {
                  clearTimeout(popupTimeout);
                  popupTimeout = null;
                }
                
                // 更新全域變數
                ipPlanningToken = newToken;
                if (newUserStr) {
                  try {
                    ipPlanningUser = JSON.parse(newUserStr);
                  } catch (e) {
                    console.warn('DEBUG: Failed to parse user data:', e);
                  }
                }
                
                // 關閉彈窗：避免在 storage 事件中觸發 COOP 錯誤，改由 message handler 主責
                // 這裡不再嘗試關閉，以減少 "Cross-Origin-Opener-Policy would block window.close" 的警告
                
                // 清除定期檢查和移除監聽器
                if (typeof localStorageCheckInterval !== 'undefined') {
                  clearInterval(localStorageCheckInterval);
                }
                window.removeEventListener('storage', storageHandler);
                window.removeEventListener('message', authMessageHandler);
                
                // 隱藏彈窗覆蓋層
                hidePopupOverlay();
                
                // 更新認證 UI
                updateAuthUI(true);
                
                // 顯示主應用程式
                showMainApp();
                
              // 先強制 refresh 一次，確保服務端與前端 token 完全同步，再讀取 me
              (async () => {
                try {
                  const t0 = sessionStorage.getItem('ipPlanningToken') || '';
                  await fetch('https://api.aijob.com.tw/api/auth/refresh', { method: 'POST', headers: t0 ? { 'Authorization': `Bearer ${t0}` } : {} });
                } catch (e) { console.warn('DEBUG: refresh after login failed (can ignore if CORS):', e); }
                try {
                  const currentToken = sessionStorage.getItem('ipPlanningToken') || '';
                  const meRes = await fetch('https://api.aijob.com.tw/api/auth/me', {
                    headers: {
                      'Authorization': `Bearer ${currentToken}`
                    }
                  });
                } catch (e) { console.warn('DEBUG: me probe failed:', e); }
                // 檢查並更新訂閱狀態（再略微延遲）
                setTimeout(() => { 
                  try { 
                    checkSubscriptionStatus().then(async () => {
                      // 檢查是否有 activation_token（授權連結）
                      const hashParams = new URLSearchParams(window.location.hash.slice(1));
                      const activationToken = hashParams.get('activation_token');
                      if (activationToken) {
                        // 登入成功後，自動驗證授權（等待完成）
                        await handleActivationToken(activationToken);
                        // 清除 hash 中的 activation_token
                        const newHash = window.location.hash.replace(/[?&]activation_token=[^&]*/, '').replace(/^#/, '');
                        window.history.replaceState({}, document.title, window.location.pathname + (newHash ? '#' + newHash : ''));
                        // 授權處理完成後，再次檢查訂閱狀態並顯示主應用程式
                        await checkSubscriptionStatus();
                        showMainApp();
                        updateHomepageView();
                      } else {
                        // 沒有授權連結，直接顯示主應用程式
                        showMainApp();
                        updateHomepageView();
                      }
                    }); 
                  } catch(_){} 
                }, 150);
              })();
                
                // 檢查是否有待處理的訂閱方案
                const pendingPlan = sessionStorage.getItem('pendingSubscriptionPlan');
                if (pendingPlan) {
                  // 清除待處理方案
                  sessionStorage.removeItem('pendingSubscriptionPlan');
                  // 導向到訂閱頁面
                  window.location.href = `subscription.html?plan=${pendingPlan}`;
                  return;
                }
                
                // 顯示成功提示
                showToast('登入成功！', 2000);
              }
            }
          };
          
          // 先註冊監聽器（關鍵：在開彈窗前註冊，確保不會遺漏訊息）
          window.addEventListener('message', authMessageHandler, false);
          window.addEventListener('storage', storageHandler, false);
          
          // 額外的定期檢查機制（每 500ms 檢查一次 localStorage，作為 storage 事件的備用）
          let localStorageCheckInterval = setInterval(function() {
            const checkToken = sessionStorage.getItem('ipPlanningToken');
            const checkUpdatedFlag = localStorage.getItem('ipPlanningTokenUpdated');
            
            if (checkToken && checkUpdatedFlag && checkToken !== ipPlanningToken) {
              clearInterval(localStorageCheckInterval);
              
              // 觸發與 storageHandler 相同的處理邏輯
              const checkUserStr = sessionStorage.getItem('ipPlanningUser');
              
              if (popupTimeout) {
                clearTimeout(popupTimeout);
                popupTimeout = null;
              }
              
              ipPlanningToken = checkToken;
              if (checkUserStr) {
                try {
                  ipPlanningUser = JSON.parse(checkUserStr);
                } catch (e) {
                  console.warn('DEBUG: Failed to parse user data:', e);
                }
              }
              
              try {
                if (popup) {
                  popup.close();
                }
              } catch (e) {
                console.warn('DEBUG: Error closing popup:', e);
              }
              
              window.removeEventListener('message', authMessageHandler);
              window.removeEventListener('storage', storageHandler);
              
              hidePopupOverlay();
              updateAuthUI(true);
              showMainApp();
              checkSubscriptionStatus();
              showToast('登入成功！', 2000);
            }
          }, 500);
          
          // 設定逾時處理（90秒）
          popupTimeout = setTimeout(() => {
            console.warn('DEBUG: Popup timeout after 90 seconds');
            
            // 清除定期檢查
            clearInterval(localStorageCheckInterval);
            
            // 檢查 localStorage 中是否有 token（最後的備用檢查）
            const finalToken = sessionStorage.getItem('ipPlanningToken');
            const finalUserStr = sessionStorage.getItem('ipPlanningUser');
            
            if (finalToken && finalToken !== ipPlanningToken) {
              
              // 處理 token（與 storageHandler 相同的邏輯）
              ipPlanningToken = finalToken;
              if (finalUserStr) {
                try {
                  ipPlanningUser = JSON.parse(finalUserStr);
                } catch (e) {
                  console.warn('DEBUG: Failed to parse user data:', e);
                }
              }
              
              hidePopupOverlay();
              updateAuthUI(true);
              showMainApp();
              checkSubscriptionStatus();
              showToast('登入成功！', 2000);
            } else {
              showPopupError('登入逾時，請重試', true);
            }
            
            try {
              if (popup) {
                popup.close();
              }
            } catch (e) {
              console.warn('DEBUG: Error closing popup:', e);
            }
            window.removeEventListener('message', authMessageHandler);
            window.removeEventListener('storage', storageHandler);
            popupTimeout = null;
          }, 90000);
          
          // 現在才打開彈窗
          popup = window.open(
            authUrl,
            'googleAuth',
            'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
          );
          window.__loginWindow = popup;
          
          
          if (!popup) {
            console.error('DEBUG: Popup window blocked or failed to open');
            hidePopupOverlay();
            showPopupError('請允許彈跳視窗以完成登入', true);
            window.removeEventListener('message', authMessageHandler);
            window.removeEventListener('storage', storageHandler);
            if (popupTimeout) {
              clearTimeout(popupTimeout);
            }
            return;
          }
          
          
          // 更新覆蓋層訊息
          updatePopupMessage('請在彈跳視窗中完成 Google 登入...');
        } catch (error) {
          console.error('Login error:', error);
          hidePopupOverlay();
          showToast('登入失敗，請稍後再試', 5000);
        }
      }
      
      function showPopupOverlay(message) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'block';
        popupButtons.style.display = 'none';
        popupOverlay.style.display = 'flex';
      }
      
      function updatePopupMessage(message) {
        popupMessage.textContent = message;
      }
      
      function showPopupError(message, showRetry = false) {
        popupMessage.textContent = message;
        popupSpinner.style.display = 'none';
        if (showRetry) {
          popupButtons.style.display = 'block';
        } else {
          popupButtons.style.display = 'none';
        }
        popupOverlay.style.display = 'flex';
      }
      
      function hidePopupOverlay() {
        popupOverlay.style.display = 'none';
      }
      
      // handleAuthMessage 現在在 login() 函數中動態創建，以便訪問 popup 和 timeout 引用
      
      async function checkAuthResult() {
        // 檢查本地存儲中是否有新的認證資訊
        const storedToken = sessionStorage.getItem('ipPlanningToken');
        const storedUser = sessionStorage.getItem('ipPlanningUser');
        
        if (storedToken && storedUser && storedToken !== ipPlanningToken) {
          ipPlanningToken = storedToken;
          ipPlanningUser = JSON.parse(storedUser);
          
          // 為用戶生成隨機ID（如果沒有）
          if (!ipPlanningUser.user_id) {
            ipPlanningUser.user_id = generateUserId();
            sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
          }
          
          updateAuthUI(true);
          updatePersonalInfo();
        }
      }
      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('user_id');
        const email = urlParams.get('email');
        const name = urlParams.get('name');
        const picture = urlParams.get('picture');
        const error = urlParams.get('error');
        // 調試日誌已移除
        
        // 處理錯誤
        if (error) {
          console.error('DEBUG: Auth error received:', error);
          showToast('認證失敗：' + decodeURIComponent(error), 5000);
          updateAuthUI(false);
          // 清除 URL 中的錯誤參數
          window.history.replaceState({}, document.title, window.location.pathname);
          return;
        }
        
        // 處理成功認證
        if (token && userId && email && name) {
          
          // 構建用戶物件
          ipPlanningUser = {
            id: userId,
            email: email,
            name: name,
            picture: picture || ''
          };
          ipPlanningToken = token;
          
          // 保存到本地存儲
          sessionStorage.setItem('ipPlanningToken', ipPlanningToken);
          sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
          
          updateAuthUI(true);
          
          // 檢查並更新訂閱狀態
          await checkSubscriptionStatus();
          
          // 檢查是否有待處理的訂閱方案
          const pendingPlan = sessionStorage.getItem('pendingSubscriptionPlan');
          if (pendingPlan) {
            // 清除待處理方案
            sessionStorage.removeItem('pendingSubscriptionPlan');
            // 導向到訂閱頁面
            window.location.href = `subscription.html?plan=${pendingPlan}`;
            return;
          }
          
          // 顯示主應用程式（會隱藏登入頁面、顯示首頁）
          showMainApp();
          
          // 清除 guestMode 標記（如果有）
          localStorage.removeItem('guestMode');
          
          // 清除 URL 中的認證參數
          window.history.replaceState({}, document.title, window.location.pathname);
          
        }
      }

      async function fetchUserInfo() {
        try {
          // 呼叫 /api/auth/me 驗證登入狀態（使用 Cookie 認證）
          const response = await fetch('https://api.aijob.com.tw/api/auth/me', {
            method: 'GET',
            credentials: 'include', // 重要：包含 Cookie
            headers: {
              'Accept': 'application/json'
            }
          });
          
          // 判斷規則：只要 response.ok 且 data.user_id 存在，就視為已登入
          if (response.ok) {
            const data = await response.json();
            
            // 檢查 data 和 data.user_id 是否存在
            if (data && data.user_id) {
              // 已登入：直接使用後端回傳的整包資料
              ipPlanningUser = data;
              sessionStorage.setItem('ipPlanningUser', JSON.stringify(ipPlanningUser));
              updateAuthUI(true);
              updatePersonalInfo();
              return;
            }
          }
          
          // 未登入：跳轉回首頁
          window.location.href = '/';
        } catch (error) {
          // 網路錯誤等異常，視為未登入，跳轉回首頁
          console.warn('獲取用戶資訊時發生錯誤:', error);
          window.location.href = '/';
        }
      }

      // 彈出提示框函數
      function showToast(message, duration = 3000) {
        toastEl.textContent = message;
        toastEl.style.display = 'block';
        toastEl.className = 'toast show';
        
        setTimeout(() => {
          toastEl.className = 'toast hide';
          setTimeout(() => {
            toastEl.style.display = 'none';
          }, 300);
        }, duration);
      }

      // 這個事件監聽器已經合併到上面的 DOMContentLoaded 中

      // 滾動到底部的函數
      function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 使用 requestAnimationFrame 確保 DOM 更新後再滾動
          requestAnimationFrame(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // 強制滾動到最底部
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
          });
        }
      }

      // 強制滾動到底部的函數
      function forceScrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 立即滾動到底部
          chatMessages.scrollTop = chatMessages.scrollHeight;
          // 延遲再次滾動確保到達底部
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 50);
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 200);
        }
      }

      // 初始化聊天滾動功能
      function initChatScroll() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          // 確保聊天區域可以滾動
          chatMessages.style.overflowY = 'auto';
          chatMessages.style.scrollBehavior = 'smooth';
          
          // 添加滾動事件監聽器
          chatMessages.addEventListener('scroll', function() {
            // 可以添加滾動相關的邏輯，比如顯示/隱藏滾動到底部按鈕
          });
          
          // 確保初始狀態滾動到底部
          forceScrollToBottom();
          
          // 延遲再次滾動確保到達底部
          setTimeout(() => {
            forceScrollToBottom();
          }, 500);
        }
      }

      function append(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        
        // 創建頭像元素
        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        
        if (role === 'user') {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            avatar.innerHTML = `<img src="${userAvatarImg.src}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="用戶頭像">`;
          } else {
            avatar.textContent = '你';
          }
        } else {
          avatar.textContent = '🤖';
        }
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        
        // 如果是 AI 回覆，清理 Markdown 格式
        if (role === 'assistant') {
          const cleanText = cleanMarkdownFormat(text);
          // 使用安全的 HTML 設置
          const safeText = escapeHtml(cleanText);
          bubble.innerHTML = `<p>${safeText}</p>`;
        } else {
          // 使用安全的 HTML 設置
          const safeText = escapeHtml(text);
          bubble.innerHTML = `<p>${safeText}</p>`;
        }
        
        div.appendChild(avatar);
        div.appendChild(bubble);
        chatEl.appendChild(div);
        
        // 確保滾動到底部
        scrollToBottom();
        return { container: div, bubble: bubble };
      }

      // 清理 Markdown 格式並轉換為 HTML
      function cleanMarkdownFormat(text) {
        if (!text) return '';
        
        // 處理 Markdown 標題格式
        text = text.replace(/^###\s*(.+)$/gm, '<strong>$1</strong>'); // ### 標題 → **標題**
        text = text.replace(/^##\s*(.+)$/gm, '<strong>$1</strong>');  // ## 標題 → **標題**
        text = text.replace(/^#\s*(.+)$/gm, '<strong>$1</strong>');   // # 標題 → **標題**
        
        // 將 **文字** 轉換為 <strong>文字</strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // 處理其他常見的 Markdown 格式
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');           // *斜體* → 斜體
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');         // `代碼` → 代碼
        
        // 移除單獨的 Markdown 符號
        text = text.replace(/\*\*/g, '');                             // 移除單獨的 **
        text = text.replace(/^#{1,6}\s*/gm, '');                      // 移除行首的 # 符號
        
        // 處理列表格式
        text = text.replace(/^\d+\.\s*(.+)$/gm, '<div style="margin: 4px 0; padding-left: 16px;">$1</div>'); // 數字列表
        text = text.replace(/^[-*]\s*(.+)$/gm, '<div style="margin: 4px 0; padding-left: 16px;">• $1</div>'); // 項目符號列表
        
        // 處理換行符號，保持段落結構
        text = text.replace(/\n\n+/g, '</p><p>');                     // 多個換行 → 段落分隔
        text = text.replace(/\n/g, '<br>');                           // 單換行 → 換行標籤
        
        // 包裝在段落標籤中
        if (text && !text.startsWith('<p>')) {
          text = '<p>' + text + '</p>';
        }
        
        return text;
      }

      function updateAssistantNode(nodeObj, text) {
        // 清理 Markdown 格式
        const cleanText = cleanMarkdownFormat(text);
        
        if (nodeObj.bubble) {
          // 使用 innerHTML 來支援 HTML 標籤（如 <strong>）
          nodeObj.bubble.innerHTML = cleanText;
        } else {
          nodeObj.innerHTML = cleanText;
        }
        
        // 確保滾動到底部
        scrollToBottom();
      }

      function canSubmit() {
        if (isSending) return false;
        const now = Date.now();
        if (now - lastSubmitAt < 600) return false; // 600ms 節流
        lastSubmitAt = now;
        return true;
      }

      async function send(message) {
        if (!message) return;
        if (!canSubmit()) return;
        lastMessage = message;
        const userNode = append('user', message);
        // 記錄長期記憶
        try { 
          await recordConversationMessage('ai_advisor', 'user', message); 
        } catch (error) {
          console.error('❌❌❌ 長期記憶儲存異常 (AI 顧問 - user) ❌❌❌', error);
          console.error('錯誤堆疊:', error.stack);
        }
        const assistantNode = append('assistant', '');

        // 顯示 AI 回覆中的載入狀態
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'ai-loading';
        loadingDiv.innerHTML = `
          <span>AI正在思考中</span>
          <div class="ai-loading-dots">
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
            <div class="ai-loading-dot"></div>
          </div>
        `;
        assistantNode.bubble.appendChild(loadingDiv);

        sendBtn.disabled = true;
        isSending = true;
        statusEl.textContent = '正在送出…';

        try {
          // 自動偵測環境，開發時使用 localhost，部署時使用環境變數或預設後端網域
          const isDevelopment = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname === '0.0.0.0';
          
          // 如果是開發環境，使用 localhost:8000；部署環境使用正確的後端網域
          let endpoint;
          if (isDevelopment) {
            endpoint = 'https://api.aijob.com.tw/api/chat/stream';
          } else {
            // 部署環境：使用您提供的正確後端網域
            endpoint = 'https://api.aijob.com.tw/api/chat/stream';
          }
          // 添加調試信息
          
          // 準備請求頭
          const headers = { 'Content-Type': 'application/json' };
          if (ipPlanningToken) {
            headers['Authorization'] = `Bearer ${ipPlanningToken}`;
          }
          
          const res = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              message,
              platform: settingsApplied ? appliedSettings.platform : null,
              topic: settingsApplied ? appliedSettings.topic : null,
              duration: settingsApplied ? appliedSettings.duration : null,
              style: styleInstruction,
              profile: settingsApplied ? appliedSettings.positioning : null,
              history,
              user_id: ipPlanningUser?.user_id || null
            })
          });

          if (!res.ok) {
            const text = await res.text().catch(() => '');
            console.error('API 請求失敗:', res.status, text);
            
            let errorMessage = `[請求失敗 ${res.status}] `;
            try {
              const errorData = JSON.parse(text);
              if (errorData.error) {
                errorMessage += errorData.error;
                if (errorData.error.includes('GEMINI_API_KEY')) {
                  errorMessage += '\n\n💡 解決方案：請在 Zeabur 後端服務的環境變數中設定 GEMINI_API_KEY';
                }
              } else {
                errorMessage += text || '無回應內容';
              }
            } catch {
              errorMessage += text || '無回應內容';
            }
            
            updateAssistantNode(assistantNode, errorMessage);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let aiText = '';
          let buffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const frame = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 2);
              if (!frame.startsWith('data:')) continue;
              try {
                const jsonStr = frame.slice(5).trim();
                const evt = JSON.parse(jsonStr);
                if (evt.type === 'token') {
                  // 移除載入動畫，開始顯示 AI 回覆
                  const loadingDiv = assistantNode.bubble.querySelector('.loading');
                  if (loadingDiv) {
                    loadingDiv.remove();
                  }
                  aiText += evt.content;
                  updateAssistantNode(assistantNode, aiText);
                } else if (evt.type === 'end') {
                  history.push({ role: 'user', content: message });
                  history.push({ role: 'assistant', content: aiText });
                  // 記錄長期記憶
                  try { 
                    await recordConversationMessage('ai_advisor', 'assistant', aiText); 
                  } catch (error) {
                    console.error('❌❌❌ 長期記憶儲存異常 (AI 顧問 - assistant) ❌❌❌', error);
                    console.error('錯誤堆疊:', error.stack);
                  }
                  
                  // 檢查是否包含腳本結果，自動顯示結果區塊
                  checkAndUpdateResults(aiText);
                }
              } catch (e) { /* ignore parse errors */ }
            }
          }
        } catch (e) {
          // 移除載入動畫，顯示錯誤訊息
          const loadingDiv = assistantNode.bubble.querySelector('.loading');
          if (loadingDiv) {
            loadingDiv.remove();
          }
          console.error('請求錯誤:', e);
          console.error('錯誤詳情:', {
            message: e?.message,
            name: e?.name,
            stack: e?.stack,
            endpoint: endpoint,
            location: window.location.href
          });
          
          // 提供更詳細的錯誤訊息
          let errorMsg = `[錯誤] ${e?.message || e}`;
          if (e?.name === 'TypeError' && e?.message.includes('fetch')) {
            errorMsg = '[連線錯誤] 無法連接到伺服器，請檢查網路連線或稍後再試';
          } else if (e?.name === 'TypeError' && e?.message.includes('Failed to fetch')) {
            errorMsg = '[網路錯誤] 請檢查網路連線或重新整理頁面';
          } else if (e?.message?.includes('CORS')) {
            errorMsg = '[跨域錯誤] 請嘗試重新整理頁面';
          }
          
          // 添加更多調試信息
          errorMsg += `\n\n調試信息：\n端點: ${endpoint}\n位置: ${window.location.href}`;
          updateAssistantNode(assistantNode, errorMsg);
        } finally {
          sendBtn.disabled = false;
          isSending = false;
          statusEl.textContent = '';
        }
      }

      // 這些事件監聽器已經在新的 DOMContentLoaded 中處理

      // 設定區塊摺疊/展開功能
      // 設定區塊摺疊/展開功能已移除

      // 這個事件監聽器已經在新的 DOMContentLoaded 中處理

      function updateBadge(badgeEl, label, value) {
        if (value) {
          badgeEl.style.display = 'inline-block';
          badgeEl.textContent = label + '：' + value;
        } else {
          badgeEl.style.display = 'none';
          badgeEl.textContent = '';
        }
      }

      // 測試連線功能
      async function testConnection() {
        const testNode = append('assistant', '🔧 正在測試連線...');
        
        try {
          // 測試後端根路徑
          const rootResponse = await fetch('https://api.aijob.com.tw/');
          const rootText = await rootResponse.text();
          
          let testResult = `🔍 連線測試結果：\n\n`;
          testResult += `1️⃣ 後端根路徑：${rootResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${rootResponse.status})\n`;
          
          // 測試健康檢查
          try {
            const healthResponse = await fetch('https://api.aijob.com.tw/api/health');
            const healthData = await healthResponse.json();
            
            testResult += `2️⃣ 健康檢查：${healthResponse.ok ? '✅ 正常' : '❌ 異常'}\n`;
            testResult += `   - 知識庫：${healthData.kb_status}\n`;
            testResult += `   - Gemini配置：${healthData.gemini_configured ? '✅ 已配置' : '❌ 未配置'}\n`;
            testResult += `   - Gemini測試：${healthData.gemini_test}\n`;
            testResult += `   - 模型：${healthData.model_name}\n`;
            
            if (!healthData.gemini_configured) {
              testResult += `\n⚠️ 問題：Gemini API Key 未配置\n`;
              testResult += `💡 解決方案：請在 Zeabur 後端環境變數中設定 GEMINI_API_KEY\n`;
            } else if (healthData.gemini_test !== 'working') {
              testResult += `\n⚠️ 問題：Gemini API 連線異常\n`;
              testResult += `💡 錯誤：${healthData.gemini_test}\n`;
            }
            
          } catch (healthError) {
            testResult += `2️⃣ 健康檢查：❌ 無法連線 (${healthError.message})\n`;
          }
          
          // 測試聊天API
          try {
            const chatResponse = await fetch('https://api.aijob.com.tw/api/chat/stream', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'test', platform: null, topic: null, duration: '30' })
            });
            
            testResult += `3️⃣ 聊天API：${chatResponse.ok ? '✅ 正常' : '❌ 異常'} (狀態碼: ${chatResponse.status})\n`;
            
            if (!chatResponse.ok) {
              const errorText = await chatResponse.text();
              testResult += `   錯誤：${errorText}\n`;
            }
            
          } catch (chatError) {
            testResult += `3️⃣ 聊天API：❌ 無法連線 (${chatError.message})\n`;
          }
          
          updateAssistantNode(testNode, testResult);
          
        } catch (error) {
          updateAssistantNode(testNode, `❌ 連線測試失敗：${error.message}`);
        }
      }

      // 測試連線按鈕已移除

      // 添加全局測試函數（用於調試）
      window.testDOM = function() {
        
        if (resultTitleEl) {
          resultTitleEl.innerHTML = '測試標題';
        }
        if (resultScriptEl) {
          resultScriptEl.innerHTML = '測試腳本內容';
        }
        if (resultVisualEl) {
          resultVisualEl.innerHTML = '測試畫面感';
        }
        if (resultCopyEl) {
          resultCopyEl.innerHTML = '測試發佈文案';
        }
      };
      
      // 添加AI內容測試函數
      window.testAIContent = function(aiText) {
        
        const isScript = detectScriptContent(aiText);
        
        if (isScript) {
          const sections = parseAIContent(aiText);
          
          // 更新DOM元素
          if (sections.title && resultTitleEl) {
            resultTitleEl.innerHTML = safeRenderMarkdown(sections.title);
          }
          if (sections.script && resultScriptEl) {
            resultScriptEl.innerHTML = safeRenderMarkdown(sections.script);
          }
          if (sections.visual && resultVisualEl) {
            resultVisualEl.innerHTML = safeRenderMarkdown(sections.visual);
          }
          if (sections.copy && resultCopyEl) {
            resultCopyEl.innerHTML = safeRenderMarkdown(sections.copy);
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
        }
      };
      
      // 添加強制更新函數
      window.forceUpdateResults = function() {
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          
          const isScript = detectScriptContent(aiText);
          
          if (isScript) {
            const sections = parseAIContent(aiText);
            
            // 強制更新DOM元素
            if (resultTitleEl) {
              resultTitleEl.innerHTML = safeRenderMarkdown(sections.title || '未找到主題標題');
            }
            if (resultScriptEl) {
              resultScriptEl.innerHTML = safeRenderMarkdown(sections.script || '未找到腳本內容');
            }
            if (resultVisualEl) {
              resultVisualEl.innerHTML = safeRenderMarkdown(sections.visual || '未找到畫面感');
            }
            if (resultCopyEl) {
              resultCopyEl.innerHTML = safeRenderMarkdown(sections.copy || '未找到發佈文案');
            }
            
            // 顯示結果區塊
            resultsEl.style.display = 'block';
          } else {
          }
        } else {
        }
      };
      
      // 添加簡單測試函數
      window.testCurrentContent = function() {
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          
          // 測試主題標題提取
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          
          // 測試腳本內容提取
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          
          // 測試畫面感提取
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          
          // 測試發佈文案提取
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          
          // 直接更新結果區塊
          if (titleMatch && titleMatch[1]) {
            resultTitleEl.innerHTML = cleanMarkdownFormat(titleMatch[1].trim());
          }
          if (scriptMatch && scriptMatch[1]) {
            resultScriptEl.innerHTML = cleanMarkdownFormat(scriptMatch[1].trim());
          }
          if (visualMatch && visualMatch[1]) {
            resultVisualEl.innerHTML = cleanMarkdownFormat(visualMatch[1].trim());
          }
          if (copyMatch && copyMatch[1]) {
            resultCopyEl.innerHTML = cleanMarkdownFormat(copyMatch[1].trim());
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
        } else {
        }
      };
      
      // 添加超強力測試函數
      window.forceExtractContent = function() {
        
        // 從聊天記錄中獲取最後一條AI回應
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          
          // 強制提取主題標題
          let title = '';
          const titlePatterns = [
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              title = cleanMarkdownFormat(match[1].trim());
              break;
            }
          }
          
          // 強制提取腳本內容
          let script = '';
          const scriptPatterns = [
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              script = cleanMarkdownFormat(match[1].trim());
              break;
            }
          }
          
          // 強制提取畫面感
          let visual = '';
          const visualPatterns = [
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              visual = cleanMarkdownFormat(match[1].trim());
              break;
            }
          }
          
          // 強制提取發佈文案
          let copy = '';
          const copyPatterns = [
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = aiText.match(pattern);
            if (match && match[1]) {
              copy = cleanMarkdownFormat(match[1].trim());
              break;
            }
          }
          
          // 強制更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
          }
          if (script) {
            resultScriptEl.innerHTML = script;
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            resultTitleEl.innerHTML = escapeHtml('原始AI回應');
            resultScriptEl.innerHTML = escapeHtml(aiText.substring(0, 500) + '...');
            resultVisualEl.innerHTML = escapeHtml('請檢查控制台日誌');
            resultCopyEl.innerHTML = escapeHtml('解析失敗');
          }
        } else {
        }
      };
      // 添加終極解決方案：直接從頁面提取
      window.extractFromPage = function() {
        
        // 方法1：從聊天記錄中提取
        const chatMessages = document.querySelectorAll('.message.ai');
        if (chatMessages.length > 0) {
          const lastAIMessage = chatMessages[chatMessages.length - 1];
          const aiText = lastAIMessage.textContent || lastAIMessage.innerText;
          
          
          // 簡單粗暴的提取方法
          const lines = aiText.split('\n').filter(line => line.trim().length > 0);
          
          let title = '';
          let script = '';
          let visual = '';
          let copy = '';
          
          // 逐行掃描，找到關鍵詞就提取
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // 提取主題標題
            if (line.includes('主題標題') && line.includes('：')) {
              const match = line.match(/主題標題[：:]\s*(.+)/i);
              if (match && match[1]) {
                title = cleanMarkdownFormat(match[1].trim());
              }
            }
            
            // 提取腳本內容
            if (line.includes('腳本內容') && line.includes('：')) {
              let scriptLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('畫面感') || nextLine.includes('發佈文案') || nextLine.includes('3.') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  scriptLines.push(nextLine);
                }
              }
              if (scriptLines.length > 0) {
                script = cleanMarkdownFormat(scriptLines.join('\n'));
              }
            }
            
            // 提取畫面感
            if (line.includes('畫面感') && line.includes('：')) {
              let visualLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.includes('發佈文案') || nextLine.includes('4.')) {
                  break;
                }
                if (nextLine.length > 0) {
                  visualLines.push(nextLine);
                }
              }
              if (visualLines.length > 0) {
                visual = cleanMarkdownFormat(visualLines.join('\n'));
              }
            }
            
            // 提取發佈文案
            if (line.includes('發佈文案') && line.includes('：')) {
              let copyLines = [];
              for (let j = i + 1; j < lines.length; j++) {
                const nextLine = lines[j].trim();
                if (nextLine.length > 0) {
                  copyLines.push(nextLine);
                }
              }
              if (copyLines.length > 0) {
                copy = cleanMarkdownFormat(copyLines.join('\n'));
              }
            }
          }
          
          // 更新結果區塊
          if (title) {
            resultTitleEl.innerHTML = title;
          }
          if (script) {
            resultScriptEl.innerHTML = script;
          }
          if (visual) {
            resultVisualEl.innerHTML = visual;
          }
          if (copy) {
            resultCopyEl.innerHTML = copy;
          }
          
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          
          // 如果還是沒有內容，顯示原始文本
          if (!title && !script && !visual && !copy) {
            resultTitleEl.innerHTML = escapeHtml('原始AI回應');
            resultScriptEl.innerHTML = escapeHtml(aiText.substring(0, 500) + '...');
            resultVisualEl.innerHTML = escapeHtml('請檢查控制台日誌');
            resultCopyEl.innerHTML = escapeHtml('解析失敗');
          }
        } else {
        }
      };

      // 快速按鈕功能已移到 DOMContentLoaded 事件中

      // 檢查用戶是否要求生成腳本
      function checkIfScriptRequest(aiText) {
        
        // 檢查AI回應中是否包含腳本生成相關的關鍵詞
        const scriptRequestKeywords = [
          '短影音腳本',
          '生成腳本',
          '腳本生成',
          '腳本內容',
          '主題標題',
          '畫面感',
          '發佈文案',
          'Hook',
          'Value',
          'CTA',
          '短影音',
          '腳本',
          'Reels',
          'TikTok',
          '小紅書'
        ];
        
        const hasScriptKeywords = scriptRequestKeywords.some(keyword => 
          aiText.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // 檢查是否包含腳本結構標記
        const hasScriptStructure = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ].some(pattern => pattern.test(aiText));
        
        const isScriptRequest = hasScriptKeywords || hasScriptStructure;
        
        
        return isScriptRequest;
      }

      // ====== 長期記憶與會話：最小增量實作（不影響既有功能） ======
      function getCurrentSessionId(conversationType) {
        const key = `session_${conversationType}`;
        let sid = localStorage.getItem(key);
        if (!sid) {
          sid = `${conversationType}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
          localStorage.setItem(key, sid);
        }
        return sid;
      }

      async function recordConversationMessage(conversationType, role, content) {
        // 強制輸出日誌，確保函數被調用時一定會看到
        
        try {
          if (!content) {
            console.warn('⚠️ 長期記憶儲存跳過：內容為空');
            return;
          }
          
          // 優先從 localStorage 獲取最新的 token（確保使用當前登入用戶的 token）
          let token = sessionStorage.getItem('ipPlanningToken');
          
          // 如果 localStorage 沒有，嘗試從 window.Auth 獲取
          if (!token && typeof window.Auth !== 'undefined' && window.Auth.getToken) {
            token = window.Auth.getToken();
          }
          
          // 如果還是沒有，嘗試從全局變數獲取（但這可能不是最新的）
          if (!token) {
            token = ipPlanningToken;
          }
          
          // 如果還是沒有 token，無法儲存長期記憶
          if (!token) {
            console.error('❌❌❌ 長期記憶儲存失敗：未找到有效的認證 token ❌❌❌');
            console.error('詳細資訊:', {
              conversationType,
              role,
              contentLength: content.length,
              localStorageToken: !!sessionStorage.getItem('ipPlanningToken'),
              windowAuth: typeof window.Auth !== 'undefined',
              globalToken: !!ipPlanningToken
            });
            return;
          }
          
          // 調試：記錄 token 獲取情況（已移除調試日誌）
          
          // 同步更新全局變數（確保一致性）
          if (token !== ipPlanningToken) {
            ipPlanningToken = token;
          }
          
          // 獲取用戶資訊（優先從 localStorage 獲取最新資料）
          let user = null;
          try {
            const userStr = sessionStorage.getItem('ipPlanningUser');
            if (userStr) {
              user = JSON.parse(userStr);
            }
          } catch (e) {
            console.warn('無法解析用戶資料:', e);
          }
          
          // 如果 localStorage 沒有，使用全局變數
          if (!user) {
            user = ipPlanningUser || {};
          }
          
          // 確保 user_id 存在
          if (!user.user_id) {
            if (user.id) {
              user.user_id = user.id;
            } else {
              // 嘗試從 token 中解析 user_id（JWT payload）
              try {
                const parts = token.split('.');
                if (parts.length === 3) {
                  const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                  if (payload.sub) {
                    user.user_id = payload.sub;
                  } else if (payload.user_id) {
                    user.user_id = payload.user_id;
                  } else {
                    console.warn('JWT payload 中沒有找到 user_id，payload keys:', Object.keys(payload));
                  }
                }
              } catch (e) {
                console.warn('無法從 token 解析 user_id:', e);
              }
            }
            
            // 如果還是沒有 user_id，無法儲存
            if (!user.user_id) {
              console.error('長期記憶儲存失敗：無法獲取 user_id', {
                conversationType,
                role,
                user: user,
                hasToken: !!token
              });
              return;
            }
            
            // 更新全局變數和 localStorage
            ipPlanningUser = user;
            try {
              localStorage.setItem('ipPlanningUser', JSON.stringify(user));
            } catch (_) {}
          } else {
          }
          
          const sessionId = getCurrentSessionId(conversationType);
          
          // 發送長期記憶儲存請求
          const res = await fetch('https://api.aijob.com.tw/api/memory/long-term', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              conversation_type: conversationType,
              session_id: sessionId,
              message_role: role,
              message_content: content
            })
          });
          
          // 調試：記錄 API 請求詳情（已移除調試日誌）
          
          if (!res.ok && res.status !== 422) {
            // 不處理 422（重複記錄），其他錯誤嘗試處理
            const errorText = await res.text().catch(() => '');
            console.error('長期記憶儲存失敗:', {
              status: res.status,
              statusText: res.statusText,
              error: errorText,
              conversationType,
              role,
              user_id: user.user_id
            });
            
            if (res.status === 401) {
              // Token 可能已過期，嘗試刷新
              const ok = await tryRefreshTokenSafe();
              if (ok) {
                // 刷新成功後重新獲取最新的 token 並重試
                const newToken = sessionStorage.getItem('ipPlanningToken') || 
                               (window.Auth && window.Auth.getToken ? window.Auth.getToken() : null);
                if (newToken) {
                  return recordConversationMessage(conversationType, role, content);
                }
              } else {
                console.error('長期記憶儲存失敗：Token 刷新失敗');
              }
            } else if (res.status === 403) {
              console.error('長期記憶儲存失敗：權限不足 (403)');
            } else if (res.status >= 500) {
              console.error('長期記憶儲存失敗：伺服器錯誤 (500+)');
            }
          } else if (res.ok) {
            // 成功儲存（調試日誌已移除）
          } else if (res.status === 422) {
            // 422 表示重複記錄，這是正常的
          }
        } catch (error) {
          // 記錄錯誤但不影響使用者體驗
          console.error('長期記憶儲存時發生錯誤:', {
            error: error.message,
            stack: error.stack,
            conversationType,
            role
          });
        }
      }

      // 檢查 token 是否已過期
      function isTokenExpired(token) {
        if (!token) return true;
        try {
          // 解析 JWT token（簡單格式：header.payload.signature）
          const parts = token.split('.');
          if (parts.length !== 3) return true;
          
          // 解碼 payload
          const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
          
          // 檢查過期時間
          if (payload.exp) {
            const now = Math.floor(Date.now() / 1000);
            return payload.exp < now; // 已過期
          }
          return true; // 如果沒有 exp，認為已過期
        } catch (e) {
          console.error('檢查 token 過期時出錯:', e);
          return true; // 如果無法解析，視為過期
        }
      }

      // 檢查 token 是否即將過期或已過期
      function isTokenExpiringSoon(token) {
        if (!token) return true;
        try {
          // 解析 JWT token（簡單格式：header.payload.signature）
          const parts = token.split('.');
          if (parts.length !== 3) return true;
          
          // 解碼 payload
          const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
          
          // 檢查過期時間
          if (payload.exp) {
            const now = Math.floor(Date.now() / 1000);
            const expiresIn = payload.exp - now;
            // 如果已經過期，或將在 5 分鐘內過期，則返回 true
            return expiresIn < 300; // 5 分鐘 = 300 秒
          }
          return true; // 如果沒有 exp，認為已過期
        } catch (e) {
          // 解析失敗，認為已過期
          return true;
        }
      }

      // 強制登出並清除所有狀態
      function forceLogout(reason = '登入已過期，請重新登入') {
        // 清除 token 和用戶資料
        ipPlanningToken = null;
        ipPlanningUser = null;
        sessionStorage.removeItem('ipPlanningToken');
        sessionStorage.removeItem('ipPlanningUser');
        localStorage.removeItem('subscriptionStatus');
        
        // 更新 UI
        updateAuthUI(false);
        showLoginButton();
        
        // 顯示提示
        showToast(reason || '登入已過期，請重新登入', 5000);
        
        // 關閉用戶抽屜
        closeUserDrawer();
        
        // 更新訂閱狀態
        document.body.dataset.subscribed = 'false';
        
      }

      // 主動刷新 token（在頁面載入時調用）
      async function proactiveRefreshToken() {
        if (!ipPlanningToken || !ipPlanningUser) return false;
        
        // 檢查 token 是否即將過期
        if (!isTokenExpiringSoon(ipPlanningToken)) {
          return false; // token 還有效，不需要刷新
        }
        
        return await tryRefreshTokenSafe();
      }

      async function tryRefreshTokenSafe() {
        // 防止重複刷新：如果正在刷新或最近 30 秒內嘗試過，直接返回
        if (isRefreshingToken) {
          return false;
        }
        
        const now = Date.now();
        if (lastRefreshAttempt > 0 && (now - lastRefreshAttempt) < 30000) {
          // 30 秒內嘗試過，直接返回上次結果
          return false;
        }
        
        try {
          if (!ipPlanningToken) return false;
          
          isRefreshingToken = true;
          lastRefreshAttempt = now;
          
          // 如果 token 已經過期，可能無法通過驗證，但仍嘗試刷新
          const r = await fetch('https://api.aijob.com.tw/api/auth/refresh', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${ipPlanningToken}` }
          });
          
          if (!r.ok) {
            // 401 代表 refresh 失效（token 已過期且無法刷新）
            // 嘗試從回應中獲取錯誤訊息
            let errorMessage = '登入已過期，請重新登入';
            try {
              const errorData = await r.clone().json();
              if (errorData.detail) {
                errorMessage = errorData.detail;
              }
            } catch (e) {
              // 如果無法解析 JSON，使用預設訊息
            }
            
            // Token 無法刷新，強制登出
            isRefreshingToken = false;
            forceLogout(errorMessage);
            return false;
          }
          
          const data = await r.json();
          if (data?.access_token) {
            ipPlanningToken = data.access_token;
            sessionStorage.setItem('ipPlanningToken', ipPlanningToken);
            isRefreshingToken = false;
            lastRefreshAttempt = 0; // 成功後重置
            return true;
          }
          
          isRefreshingToken = false;
          return false;
        } catch (error) {
          // 網路錯誤：如果是網路錯誤，不登出（可能是暫時的連線問題）
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            isRefreshingToken = false;
            return false;
          }
          
          // 其他錯誤：強制登出
          isRefreshingToken = false;
          forceLogout('刷新登入狀態失敗，請重新登入');
          return false;
        }
      }

      // 會話與歷史：僅提供最小可用 API（可由 UI 觸發）
      async function getSessionList(conversationType) {
        if (!ipPlanningUser?.user_id) {
          console.warn('尚未建立 user_id，跳過會話列表');
          return [];
        }
        try {
          const res = await fetch(`https://api.aijob.com.tw/api/memory/sessions?conversation_type=${encodeURIComponent(conversationType)}`, {
            headers: ipPlanningToken ? { 'Authorization': `Bearer ${ipPlanningToken}` } : {}
          });
          if (res.ok) return (await res.json()).sessions || [];
          // 401 代表認證失敗或 API 端點不存在，靜默返回空陣列
          if (res.status === 401 || res.status === 404) {
            return [];
          }
        } catch (_) {}
        return [];
      }

      async function loadChatHistory(conversationType, sessionId) {
        if (!ipPlanningUser?.user_id) {
          console.warn('尚未建立 user_id，跳過歷史載入');
          return [];
        }
        try {
          const url = new URL('https://api.aijob.com.tw/api/memory/long-term');
          url.searchParams.set('conversation_type', conversationType);
          if (sessionId) url.searchParams.set('session_id', sessionId);
          const res = await fetch(url.toString(), {
            headers: ipPlanningToken ? { 'Authorization': `Bearer ${ipPlanningToken}` } : {}
          });
          if (res.ok) return (await res.json()).records || [];
          // 401/404 代表認證失敗或 API 端點不存在，靜默返回空陣列
          if (res.status === 401 || res.status === 404) {
            return [];
          }
        } catch (_) {}
        return [];
      }

      // 將歷史訊息回灌到聊天區（不影響現有訊息樣式）
      function renderHistoryToChat(records) {
        const chat = document.getElementById('chatMessages');
        if (!chat || !Array.isArray(records)) return;
        chat.innerHTML = '';
        const byTime = [...records].sort((a,b) => new Date(a.created_at||0) - new Date(b.created_at||0));
        byTime.forEach(r => {
          const role = r.message_role === 'assistant' ? 'assistant' : 'user';
          // 優先使用 ChatGPT 風格訊息
          if (typeof createChatGPTMessage === 'function') {
            const node = createChatGPTMessage(role, r.message_content || '');
            chat.appendChild(node);
          } else {
            // 後備樣式（AI 顧問樣式）
            const div = document.createElement('div');
            div.className = 'msg ' + (role === 'assistant' ? 'assistant' : 'user');
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';
            bubble.textContent = r.message_content || '';
            div.appendChild(bubble);
            chat.appendChild(div);
          }
        });
        // 捲到最底
        chat.scrollTop = chat.scrollHeight;
      }

      // 動態插入極簡會話UI（不改動既有 HTML）
      document.addEventListener('DOMContentLoaded', () => {
        const inject = (pageId, type) => {
          const page = document.getElementById(pageId);
          if (!page || page.querySelector('.session-mini')) return;
          const box = document.createElement('div');
          box.className = 'session-mini';
          box.style.cssText = 'margin:12px 0 8px;padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#f8fafc;display:flex;gap:8px;flex-wrap:wrap;';
          box.innerHTML = `
            <button id="${pageId}-new" style="padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:white;cursor:pointer;">🆕 新會話</button>
            <button id="${pageId}-list" style="padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:white;cursor:pointer;">📋 會話列表</button>
            <button id="${pageId}-load" style="padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:white;cursor:pointer;">🔄 載入本會話</button>
          `;
          const container = page.querySelector('.page') || page; // 保守插入
          container.insertBefore(box, container.firstChild);
          document.getElementById(`${pageId}-new`).onclick = () => {
            localStorage.removeItem(`session_${type}`);
            showToast('已建立新會話');
          };
          document.getElementById(`${pageId}-list`).onclick = async () => {
            const list = await getSessionList(type);
            if (!list.length) { alert('尚無會話'); return; }
            const lines = list.map((s, i) => `${i+1}. ${s.session_id}  (${s.count||0})`).join('\n');
            const pick = prompt(`選擇要載入的會話序號:\n${lines}\n\n輸入數字：`);
            const idx = Number(pick) - 1;
            if (!Number.isFinite(idx) || idx < 0 || idx >= list.length) return;
            const chosen = list[idx]?.session_id;
            const records = await loadChatHistory(type, chosen);
            renderHistoryToChat(records);
            showToast(`已載入 ${records.length} 筆歷史`);
          };
          document.getElementById(`${pageId}-load`).onclick = async () => {
            const sid = getCurrentSessionId(type);
            const records = await loadChatHistory(type, sid);
            renderHistoryToChat(records);
            showToast(`已載入 ${records.length} 筆歷史`);
          };
        };
        inject('mode2', 'ai_advisor');
        // inject('mode3', 'ip_planning'); // 已移除 IP人設規劃的三個功能按鈕
      });

      function checkAndUpdateResults(aiText) {
        
        // 檢查用戶是否要求生成腳本（只有這種情況才顯示腳本結果區塊）
        const isScriptRequest = checkIfScriptRequest(aiText);
        
        if (!isScriptRequest) {
          return;
        }
        
        // 更精確的腳本內容檢測
        const isScriptContent = detectScriptContent(aiText);
        
        
        if (isScriptContent) {
          // 顯示結果區塊
          resultsEl.style.display = 'block';
          
          // 確保DOM元素存在
          if (!resultTitleEl || !resultScriptEl || !resultVisualEl || !resultCopyEl) {
            console.error('DOM元素不存在:', {
              resultTitleEl: !!resultTitleEl,
              resultScriptEl: !!resultScriptEl,
              resultVisualEl: !!resultVisualEl,
              resultCopyEl: !!resultCopyEl
            });
            return;
          }
          
          try {
            // 使用更靈活的解析方法
            const sections = parseAIContent(aiText);
            
            // 更新DOM元素
            if (sections.title) {
              // 使用安全的 Markdown 渲染
              resultTitleEl.innerHTML = safeRenderMarkdown(sections.title);
            }
            
            if (sections.script) {
              // 使用安全的 Markdown 渲染
              resultScriptEl.innerHTML = safeRenderMarkdown(sections.script);
            }
            
            if (sections.visual) {
              // 使用安全的 Markdown 渲染
              resultVisualEl.innerHTML = safeRenderMarkdown(sections.visual);
            }
            
            if (sections.copy) {
              // 使用安全的 Markdown 渲染
              resultCopyEl.innerHTML = safeRenderMarkdown(sections.copy);
            }
            
            // 延遲檢查內容是否正確設置
            setTimeout(() => {
            }, 500);
            
          } catch (e) {
            console.error('解析結果時出錯:', e);
          }
        } else {
        }
      }
      
      // 新增：精確的腳本內容檢測函數
      function detectScriptContent(aiText) {
        
        // 1. 檢查是否包含腳本相關的結構標記（更靈活的檢測）
        const structureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        
        const hasStructureMarkers = structureMarkers.some(pattern => pattern.test(aiText));
        
        // 2. 檢查是否包含短影音腳本的關鍵元素
        const scriptElements = [
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i,
          /台詞[：:]/i
        ];
        
        const scriptElementCount = scriptElements.filter(pattern => pattern.test(aiText)).length;
        
        // 檢查是否包含時間標記（Hook、Value、CTA格式）
        const timeMarkersPatterns = [
          /\(\d+-\d+秒\)\s*Hook/i,
          /\(\d+-\d+秒\)\s*Value/i,
          /\(\d+-\d+秒\)\s*CTA/i,
          /Hook\s*\(\d+-\d+秒\)/i,
          /Value\s*\d+\s*\(\d+-\d+秒\)/i,
          /CTA\s*\(\d+-\d+秒\)/i
        ];
        const hasTimeMarkers = timeMarkersPatterns.some(pattern => pattern.test(aiText));
        
        // 檢查是否包含短影音相關內容
        const videoContent = [
          /畫面感/i,
          /發佈文案/i,
          /台詞[：:]/i,
          /鏡頭[：:]/i,
          /音效[：:]/i,
          /字幕[：:]/i
        ];
        const hasVideoContent = videoContent.some(pattern => pattern.test(aiText));
        
        // 更靈活的判斷條件
        const hasAnyScriptContent = hasStructureMarkers || scriptElementCount >= 3 || hasTimeMarkers || hasVideoContent;
        
        if (!hasAnyScriptContent) {
          // 調試日誌已移除
          return false;
        }
        
        // 2. 檢查是否包含腳本相關的關鍵詞組合
        const scriptKeywords = ['主題標題', '腳本內容', '畫面感', '發佈文案', 'Hook', 'Value', 'CTA'];
        const keywordCount = scriptKeywords.filter(keyword => aiText.includes(keyword)).length;
        
        // 3. 檢查是否包含短影音相關的內容指示詞
        const videoIndicators = [
          '短影音腳本',
          '短影音腳本結果',
          '生成腳本',
          '腳本生成',
          'Reels',
          'TikTok',
          '小紅書',
          '秒腳本',
          '影音內容',
          '短影音',
          '腳本'
        ];
        const hasVideoIndicators = videoIndicators.some(indicator => aiText.includes(indicator));
        
        // 4. 檢查文本長度（腳本內容通常較長）
        const isLongEnough = aiText.length > 300; // 提高長度要求
        
        // 5. 檢查是否包含多個段落（腳本通常有多個部分）
        const paragraphCount = aiText.split('\n\n').filter(p => p.trim().length > 0).length;
        const hasMultipleParagraphs = paragraphCount >= 4; // 提高段落要求
        
        // 6. 排除明顯的非腳本內容
        const nonScriptIndicators = [
          '你好',
          '謝謝',
          '不客氣',
          '請問',
          '不好意思',
          '抱歉',
          '我來幫你',
          '讓我為你',
          '很高興為您',
          '歡迎',
          '再見',
          '拜拜',
          '有什麼可以幫你',
          '需要什麼幫助',
          '請告訴我',
          '請輸入',
          '請選擇',
          '請點擊',
          '請查看',
          '請注意',
          '提醒',
          '建議',
          '推薦',
          '介紹',
          '說明',
          '解釋',
          '回答',
          '回覆',
          '回應'
        ];
        const hasNonScriptIndicators = nonScriptIndicators.some(indicator => 
          aiText.toLowerCase().includes(indicator.toLowerCase())
        );
        
        // 7. 檢查是否包含完整的腳本結構（至少包含3個區塊）
        const requiredStructureMarkers = [
          /主題標題[：:]/i,
          /腳本內容[：:]/i,
          /畫面感[：:]/i,
          /發佈文案[：:]/i,
          /\d+\.\s*主題標題/i,
          /\d+\.\s*腳本內容/i,
          /\d+\.\s*畫面感/i,
          /\d+\.\s*發佈文案/i
        ];
        const structureCount = requiredStructureMarkers.filter(pattern => pattern.test(aiText)).length;
        const hasCompleteStructure = structureCount >= 3;
        
        // 8. 檢查是否包含時間標記（腳本通常有時間標記）
        const timeMarkersGeneral = [
          /\d+[-\s]*\d*\s*秒/i,
          /\d+[-\s]*\d*\s*分鐘/i,
          /0-\d+\s*秒/i,
          /\d+-\d+\s*秒/i
        ];
        const hasTimeMarkersGeneral = timeMarkersGeneral.some(pattern => pattern.test(aiText));
        
        // 綜合判斷
        const score = {
          structureMarkers: hasStructureMarkers ? 3 : 0,
          scriptElements: Math.min(scriptElementCount, 4), // 腳本元素數量
          keywordCount: Math.min(keywordCount, 3),
          videoIndicators: hasVideoIndicators ? 2 : 0,
          length: isLongEnough ? 1 : 0,
          paragraphs: hasMultipleParagraphs ? 1 : 0,
          completeStructure: hasCompleteStructure ? 2 : 0,
          timeMarkers: hasTimeMarkers ? 1 : 0,
          timeMarkersGeneral: hasTimeMarkersGeneral ? 1 : 0,
          videoContent: hasVideoContent ? 1 : 0,
          nonScript: hasNonScriptIndicators ? -5 : 0 // 高懲罰
        };
        
        const totalScore = Object.values(score).reduce((sum, val) => sum + val, 0);
        
        
        // 更靈活的判斷條件
        const isScriptContent = totalScore >= 4 && (hasStructureMarkers || scriptElementCount >= 3);
        
        // 如果包含非腳本指示詞，降低評分但不完全拒絕
        if (hasNonScriptIndicators) {
        }
        
        
        return isScriptContent;
      }
      // 新增：更精確的AI內容解析函數
      function parseAIContent(aiText) {
        const sections = {
          title: '',
          script: '',
          visual: '',
          copy: ''
        };
        
        
        // 使用正則表達式精確提取每個區塊的內容
        try {
          // 通用內容提取策略 - 應對所有可能的AI格式變化
          let scriptContent = aiText;
          let extractionMethod = 'full';
          
          // 策略1: 檢查是否有 --- 分隔符
          const dashSections = aiText.split(/---/);
          if (dashSections.length > 1) {
            const contentSections = dashSections.slice(1);
            scriptContent = contentSections.join('---').trim();
            extractionMethod = 'dash-separated';
          }
          // 策略2: 檢查是否有明確的結構標記
          else if (aiText.includes('主題標題') || aiText.includes('腳本內容') || aiText.includes('畫面感') || aiText.includes('發佈文案')) {
            scriptContent = aiText;
            extractionMethod = 'structured';
          }
          // 策略3: 檢查是否有 Hook/Value/CTA 結構
          else if (aiText.includes('Hook') || aiText.includes('Value') || aiText.includes('CTA')) {
            scriptContent = aiText;
            extractionMethod = 'hook-value-cta';
          }
          // 策略4: 檢查是否有時間標記
          else if (aiText.match(/\d+-\d+秒/) || aiText.match(/\d+秒/)) {
            scriptContent = aiText;
            extractionMethod = 'time-marked';
          }
          // 策略5: 默認使用完整內容
          else {
            scriptContent = aiText;
            extractionMethod = 'full';
          }
          
          
          // 超級智能主題標題提取器 - 應對所有可能的AI格式
          function extractTitle(scriptContent) {
          const titlePatterns = [
              // 1. 表情符號 + 標題格式
              /[🎬📝🎯✨🔥📌]\s*主題標題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*主題[：:]\s*([^\n]+)/i,
              /[🎬📝🎯✨🔥📌]\s*標題[：:]\s*([^\n]+)/i,
              
              // 2. 標準標題格式
            /主題標題[：:]\s*([^\n]+)/i,
            /主題[：:]\s*([^\n]+)/i,
            /標題[：:]\s*([^\n]+)/i,
              
              // 3. 編號 + 標題格式
            /\d+\.\s*主題標題[：:]\s*([^\n]+)/i,
            /\d+\.\s*主題[：:]\s*([^\n]+)/i,
            /\d+\.\s*標題[：:]\s*([^\n]+)/i,
              
              // 4. 粗體標題格式
            /\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*主題標題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*主題\*\*[：:]\s*([^\n]+)/i,
            /\d+\.\s*\*\*標題\*\*[：:]\s*([^\n]+)/i,
              
              // 6. Markdown 標題格式
            /###\s*主題標題[：:]\s*([^\n]+)/i,
            /###\s*主題[：:]\s*([^\n]+)/i,
            /###\s*標題[：:]\s*([^\n]+)/i,
              /##\s*主題標題[：:]\s*([^\n]+)/i,
              /##\s*主題[：:]\s*([^\n]+)/i,
              /##\s*標題[：:]\s*([^\n]+)/i,
              
              // 7. 行首標題格式（--- 分隔後）
              /^主題標題[：:]\s*([^\n]+)/i,
              /^標題[：:]\s*([^\n]+)/i,
              /^主題[：:]\s*([^\n]+)/i,
              
              // 8. AI 狡猾格式：直接給標題，沒有前綴
            /^你的.*來了.*小紅書.*都在.*用的.*AI智能體.*$/i,
            /^.*AI智能體.*來了.*$/i,
            /^.*小紅書.*博主.*都在.*用的.*$/i,
              /^.*效率.*爆棚.*$/i,
              /^.*AI.*智能體.*這樣玩.*$/i,
              
              // 9. 引號標題格式
              /「([^」]+)」/,
              /"([^"]+)"/,
              /'([^']+)'/,
              
              // 10. 特殊標題模式
              /^.*你還在.*方法.*AI智能體.*效率.*爆棚.*$/i,
              /^.*AI智能體.*效率.*翻倍.*$/i,
              /^.*超級.*學伴.*$/i
          ];
          
          for (const pattern of titlePatterns) {
            const match = scriptContent.match(pattern);
            if (match) {
              // 處理有捕獲組的情況
              if (match[1] && match[1].trim()) {
                  const title = cleanMarkdownFormat(match[1].trim());
                  if (title.length > 5 && title.length < 100) { // 合理的標題長度
                    return title;
                  }
              }
              // 處理沒有前綴，直接匹配整行的情況
              else if (match[0] && match[0].trim()) {
                  const title = cleanMarkdownFormat(match[0].trim());
                  if (title.length > 5 && title.length < 100) {
                    return title;
                  }
                }
              }
            }
            
            // 如果沒有找到明確的標題，嘗試提取第一行作為標題
            const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
            for (const line of lines) {
              const trimmedLine = line.trim();
              // 跳過明顯不是標題的行
              if (trimmedLine.match(/^(Hook|Value|CTA|畫面感|發佈文案|\d+\.|\(|台詞|鏡頭|音效|字幕|主題建議|目標|切入點|內容方向|好的|沒問題|讓我)/i)) {
                continue;
              }
              // 檢查是否為合理的標題
              if (trimmedLine.length > 5 && trimmedLine.length < 100 && !trimmedLine.includes('：') && !trimmedLine.includes(':')) {
                return cleanMarkdownFormat(trimmedLine);
              }
            }
            
            return '';
          }
          
          // 提取主題標題
          sections.title = extractTitle(scriptContent);
          
          // 超級智能腳本內容提取器 - 應對所有可能的AI格式
          function extractScript(scriptContent) {
          const scriptPatterns = [
              // 1. 標準腳本內容格式
            /腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 2. 表情符號 + 腳本內容格式
              /[📝🎬📜✨🔥]\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /[📝🎬📜✨🔥]\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 3. 編號 + 腳本內容格式
            /\d+\.\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體腳本內容格式
            /\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
            /\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*腳本內容\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*腳本\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*畫面感|\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
              /###\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /###\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*畫面感|###\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              /##\s*腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*畫面感|##\s*發佈文案|畫面感|發佈文案|$))/i,
              
              // 7. 行首腳本內容格式（--- 分隔後）
            /^腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /^腳本[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              
              // 8. Hook/Value/CTA 結構格式
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i,
              
              // 9. 台詞格式
              /台詞[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i,
              /台詞\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              
              // 10. 特殊腳本模式
              /^.*你還在.*手動.*報告.*寫文案.*落伍.*超級助理.*AI智能體.*$/i,
              /^.*它不只是.*程式.*真人.*思考.*學習.*$/i,
              /^.*想像一下.*專屬團隊.*24小時.*待命.*$/i,
              /^.*重點是.*越來越聰明.*不斷進化.*$/i,
              /^.*想知道.*怎麼開始.*AI智能體.*$/i
          ];
          
          for (const pattern of scriptPatterns) {
            const match = scriptContent.match(pattern);
              if (match) {
                let scriptText = '';
                if (match[1] && match[1].trim()) {
                  scriptText = match[1].trim();
                } else if (match[0] && match[0].trim()) {
                  scriptText = match[0].trim();
                }
                
                if (scriptText && scriptText.length > 10) {
                  return cleanMarkdownFormat(scriptText);
                }
            }
          }
          
          // 如果沒有找到明確的腳本內容標記，嘗試提取 Hook、Value、CTA 部分
            
            // 支援多種時間標記格式
            const hookPatterns = [
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Hook[\s\S]*?(?=Value|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Hook\s*\(\d+-\d+秒\)[\s\S]*?(?=Value\s*\d+|CTA|畫面感|發佈文案|$)/i
            ];
            const valuePatterns = [
              /Value\s*\d+\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*Value\s*\d+[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i,
              /Value\s*\(\d+-\d+秒\)[\s\S]*?(?=Value|CTA|畫面感|發佈文案|$)/i
            ];
            const ctaPatterns = [
              /CTA\s*\(\d+-\d+秒\)[\s\S]*?(?=畫面感|發佈文案|$)/i,
              /\(\d+-\d+秒\)\s*CTA[\s\S]*?(?=畫面感|發佈文案|$)/i
            ];
            
            let extractedScriptContent = '';
            
            // 提取 Hook
            for (const pattern of hookPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                extractedScriptContent += match[0] + '\n\n';
                break;
              }
            }
            
            // 提取 Value
            for (const pattern of valuePatterns) {
              const matches = scriptContent.match(new RegExp(pattern.source, 'gi'));
              if (matches) {
                extractedScriptContent += matches.join('\n\n');
                break;
              }
            }
            
            // 提取 CTA
            for (const pattern of ctaPatterns) {
              const match = scriptContent.match(pattern);
              if (match) {
                extractedScriptContent += '\n\n' + match[0];
                break;
              }
            }
            
            if (extractedScriptContent.trim()) {
              return cleanMarkdownFormat(extractedScriptContent.trim());
            }
            
            return '';
          }
          
          // 提取腳本內容
          sections.script = extractScript(scriptContent);
          
          // 超級智能畫面感提取器 - 應對所有可能的AI格式
          function extractVisual(scriptContent) {
          const visualPatterns = [
              // 1. 標準畫面感格式
            /畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 2. 表情符號 + 畫面感格式
              /[🎬🎞️📹✨🔥]\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /[🎬🎞️📹✨🔥]\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 3. 編號 + 畫面感格式
            /\d+\.\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*畫面感\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              /\d+\.\s*畫面\s*\([^)]*\)[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 4. 粗體畫面感格式
            /\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
            /\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*畫面感\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
            /\d+\.\s*\*\*畫面\*\*[：:]\s*([\s\S]*?)(?=\n\s*(?:\d+\.\s*發佈文案|$))/i,
              
              // 6. Markdown 標題格式
            /###\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
            /###\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:###\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              /##\s*畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:##\s*發佈文案|發佈文案|$))/i,
              
              // 7. 行首畫面感格式（--- 分隔後）
            /^畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              /^畫面[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i,
              
              // 8. 特殊畫面感模式
              /^.*開場.*Hook.*鏡頭.*特寫.*$/i,
              /^.*核心價值.*鏡頭.*中景.*$/i,
              /^.*行動呼籲.*鏡頭.*指向.*$/i
          ];
          
          for (const pattern of visualPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                  return 'AI 未生成畫面感內容';
              } else {
                  const visual = cleanMarkdownFormat(match[1].trim());
                  return visual;
                }
              }
            }
            
            return '';
          }
          
          // 提取畫面感
          sections.visual = extractVisual(scriptContent);
          
          // 超級智能發佈文案提取器 - 應對所有可能的AI格式
          function extractCopy(scriptContent) {
          const copyPatterns = [
              // 1. 標準發佈文案格式
            /發佈文案[：:]\s*([\s\S]*?)$/i,
            /文案[：:]\s*([\s\S]*?)$/i,
              
              // 2. 表情符號 + 發佈文案格式
              /[📱📄📝✨🔥]\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /[📱📄📝✨🔥]\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 3. 編號 + 發佈文案格式
            /\d+\.\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*文案[：:]\s*([\s\S]*?)$/i,
              // 新增：編號 + 括號格式
              /\d+\.\s*發佈文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              /\d+\.\s*文案\s*\([^)]*\)[：:]\s*([\s\S]*?)$/i,
              
              // 4. 粗體發佈文案格式
            /\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 5. 混合格式
            /\d+\.\s*\*\*發佈文案\*\*[：:]\s*([\s\S]*?)$/i,
            /\d+\.\s*\*\*文案\*\*[：:]\s*([\s\S]*?)$/i,
              
              // 6. Markdown 標題格式
            /###\s*發佈文案[：:]\s*([\s\S]*?)$/i,
            /###\s*文案[：:]\s*([\s\S]*?)$/i,
              /##\s*發佈文案[：:]\s*([\s\S]*?)$/i,
              /##\s*文案[：:]\s*([\s\S]*?)$/i,
              
              // 7. 行首發佈文案格式（--- 分隔後）
            /^發佈文案[：:]\s*([\s\S]*?)$/i,
              /^文案[：:]\s*([\s\S]*?)$/i,
              
              // 8. 特殊發佈文案模式
              /^.*還在.*繁瑣.*工作.*AI智能體.*救星.*$/i,
              /^.*自動化.*提升效率.*客製化.*$/i,
              /^.*未來趨勢.*點擊.*主頁.*連結.*$/i,
              /^.*免費.*領取.*AI.*入門.*指南.*$/i
          ];
          
          for (const pattern of copyPatterns) {
            const match = scriptContent.match(pattern);
            if (match && match[1] && match[1].trim()) {
              // 檢查是否為「尚未生成」
              if (match[1].trim() === '尚未生成' || match[1].trim().includes('尚未生成')) {
                  return 'AI 未生成發佈文案內容';
              } else {
                  const copy = cleanMarkdownFormat(match[1].trim());
                  return copy;
                }
              }
            }
            
            return '';
          }
          
          // 提取發佈文案
          sections.copy = extractCopy(scriptContent);
          
          // 最終調試輸出
          
          // 如果任何欄位為空，嘗試最後的強制提取
          if (!sections.title || !sections.script || !sections.visual || !sections.copy) {
            
            // 強制提取主題標題
            if (!sections.title) {
              const lines = scriptContent.split('\n').filter(line => line.trim().length > 0);
              for (const line of lines) {
                if (line.length > 10 && line.length < 100 && !line.includes('：') && !line.includes(':')) {
                  sections.title = cleanMarkdownFormat(line.trim());
                  break;
                }
              }
            }
            
            // 強制提取腳本內容
            if (!sections.script) {
              const scriptMatch = scriptContent.match(/(?:Hook|Value|CTA)[\s\S]*?(?=畫面感|發佈文案|$)/i);
              if (scriptMatch) {
                sections.script = cleanMarkdownFormat(scriptMatch[0].trim());
              }
            }
            
            // 強制提取畫面感
            if (!sections.visual) {
              const visualMatch = scriptContent.match(/畫面感[：:]\s*([\s\S]*?)(?=發佈文案|$)/i);
              if (visualMatch && visualMatch[1]) {
                if (visualMatch[1].trim() === '尚未生成' || visualMatch[1].trim().includes('尚未生成')) {
                  sections.visual = 'AI 未生成畫面感內容';
                } else {
                  sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
                }
              }
            }
            
            // 強制提取發佈文案
            if (!sections.copy) {
              const copyMatch = scriptContent.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
              if (copyMatch && copyMatch[1]) {
                if (copyMatch[1].trim() === '尚未生成' || copyMatch[1].trim().includes('尚未生成')) {
                  sections.copy = 'AI 未生成發佈文案內容';
                } else {
                  sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
                }
              }
            }
          }
          
        } catch (error) {
          console.error('解析AI內容時出錯:', error);
        }
        
        
        // 如果所有內容都為空，嘗試強制提取
        if (!sections.title && !sections.script && !sections.visual && !sections.copy) {
          
          // 強制提取主題標題
          const titleMatch = aiText.match(/主題標題[：:]\s*([^\n]+)/i);
          if (titleMatch && titleMatch[1]) {
            sections.title = cleanMarkdownFormat(titleMatch[1].trim());
          }
          
          // 強制提取腳本內容
          const scriptMatch = aiText.match(/腳本內容[：:]\s*([\s\S]*?)(?=\n\s*(?:畫面感|發佈文案|$))/i);
          if (scriptMatch && scriptMatch[1]) {
            sections.script = cleanMarkdownFormat(scriptMatch[1].trim());
          }
          
          // 強制提取畫面感
          const visualMatch = aiText.match(/畫面感[：:]\s*([\s\S]*?)(?=\n\s*(?:發佈文案|$))/i);
          if (visualMatch && visualMatch[1]) {
            sections.visual = cleanMarkdownFormat(visualMatch[1].trim());
          }
          
          // 強制提取發佈文案
          const copyMatch = aiText.match(/發佈文案[：:]\s*([\s\S]*?)$/i);
          if (copyMatch && copyMatch[1]) {
            sections.copy = cleanMarkdownFormat(copyMatch[1].trim());
          }
        }
        
        return sections;
      }

      // ===== 模式3：IP人設規劃模式函數 =====
      // 注意：mode3 功能已分離到 mode3.html 和 mode3.js，以下代碼已廢棄
      // 保留註釋以標記原位置，實際代碼已移除
      
      /* 已移除的 mode3 函數（已遷移到 mode3.js）：
      - toggleMode3Instructions()
      - addMode3Message()
      - addMode3LoadingMessage()
      - removeMode3LoadingMessage()
      - updateMode3Message()
      - updateMode3LastMessage()
      - switchMode3Tab()
      - generateMode3IPProfile()
      - generateMode314DayPlan()
      - generateMode3TodayScripts()
      - saveMode3Result()
      - regenerateMode3Result()
      - exportMode3Result()
      - initializeMode3()
      - loadMode3History()
      - displayMode3History()
      - toggleMode3InstructionsDrawer()
      - toggleMode3ResultsDrawer()
      */
      
      // 以下為保留的兼容性函數（如果其他地方有調用）
      function toggleMode3Instructions() {
        const instructions = document.querySelector('.mode3-instructions');
        const chatMessages = document.querySelector('.mode3-chat-messages');
        
        if (instructions.classList.contains('collapsed')) {
          instructions.classList.remove('collapsed');
          chatMessages.classList.remove('expanded');
        } else {
          instructions.classList.add('collapsed');
          chatMessages.classList.add('expanded');
        }
      }

      // 舊的 sendMode3Message 函數已移除，請使用新的函數（在 line 18226）

      // 添加訊息到聊天區域 - 使用與 mode2 相同的結構
      function addMode3Message(sender, content) {
        const messagesContainer = document.getElementById('mode3-chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        // 為助手訊息添加 ID
        if (sender === 'assistant') {
          const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          messageDiv.id = messageId;
        }
        
        // 創建頭像元素
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (sender === 'user') {
          // 用戶頭像：使用 Gmail 頭像或默認頭像
          const userAvatarImg = document.getElementById('userAvatar');
          if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
            const img = document.createElement('img');
            img.src = userAvatarImg.src;
            img.alt = '用戶頭像';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = '👤';
          }
        } else {
          // AI 頭像：使用表情符號
          avatarDiv.textContent = '🤖';
        }
        
        // 創建訊息內容元素 - 使用與 mode2 相同的類名和處理
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (sender === 'assistant' && content) {
          // AI 回覆使用 markdown 渲染
          contentDiv.innerHTML = safeRenderMarkdown(content);
          // 對代碼塊進行語法高亮
          if (typeof hljs !== 'undefined') {
            contentDiv.querySelectorAll('pre code').forEach((block) => {
              hljs.highlightElement(block);
            });
          }
        } else if (sender === 'user') {
          contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageDiv;
      }

      // 添加載入訊息 - 使用與 mode2 相同的結構
      function addMode3LoadingMessage() {
        const messagesContainer = document.getElementById('mode3-chat-messages');
        const messageDiv = document.createElement('div');
        const messageId = 'loading-' + Date.now();
        messageDiv.id = messageId;
        messageDiv.className = 'message assistant';
        
        messageDiv.innerHTML = `
          <div class="message-avatar">🤖</div>
          <div class="message-content">
            <div class="typing-indicator">
              <span>AI正在思考中</span>
              <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageId;
      }
      
      // 移除載入訊息
      function removeMode3LoadingMessage(messageId) {
        const loadingMessage = document.getElementById(messageId);
        if (loadingMessage) {
          loadingMessage.remove();
        }
      }
      
      // 更新訊息內容 - 使用與 mode2 相同的結構
      function updateMode3Message(messageId, content) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
          const contentDiv = messageDiv.querySelector('.message-content');
          if (contentDiv) {
            // 使用 renderMarkdown 處理內容（與 mode2 相同）
            contentDiv.innerHTML = safeRenderMarkdown(content);
            // 對代碼塊進行語法高亮
            if (typeof hljs !== 'undefined') {
              contentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
              });
            }
            const messagesContainer = document.getElementById('mode3-chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
      }

      // 更新最後一條訊息
      function updateMode3LastMessage(messageId, sender, content) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
          messageDiv.className = `mode3-message mode3-${sender}-message`;
          
          // 創建頭像元素
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'mode3-message-avatar';
          
          if (sender === 'user') {
            // 用戶頭像：使用 Gmail 頭像或默認頭像
            const userAvatarImg = document.getElementById('userAvatar');
            if (userAvatarImg && userAvatarImg.src && userAvatarImg.src !== '') {
              const img = document.createElement('img');
              img.src = userAvatarImg.src;
              img.alt = '用戶頭像';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              avatarDiv.appendChild(img);
            } else {
              avatarDiv.textContent = '👤';
            }
          } else {
            // AI 頭像：使用表情符號
            avatarDiv.textContent = '🤖';
          }
          
          // 創建訊息內容元素
          const contentDiv = document.createElement('div');
          contentDiv.className = 'mode3-message-content';
          const safeContent = escapeHtml(content);
          contentDiv.innerHTML = `<p>${safeContent}</p>`;
          
          messageDiv.innerHTML = '';
          messageDiv.appendChild(avatarDiv);
          messageDiv.appendChild(contentDiv);
        }
      }

      // 切換結果標籤
      function switchMode3Tab(tabName) {
        // 移除所有標籤的active類別
        document.querySelectorAll('.mode3-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // 隱藏所有結果區塊
        document.querySelectorAll('.mode3-result-block').forEach(block => {
          block.classList.remove('active');
        });
        
        // 激活選中的標籤
        event.target.classList.add('active');
        
        // 顯示對應的結果區塊
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        if (resultBlock) {
          resultBlock.classList.add('active');
        }
      }

      // 生成IP Profile
      window.generateMode3IPProfile = async function() {
        const resultBlock = document.getElementById('mode3-profile-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        // 禁用按鈕並顯示載入狀態
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請根據我們的對話內容，生成一份完整的IP Profile。請使用自然語言、友善的語氣，以清晰易懂的方式呈現。重要標題和關鍵詞請使用**粗體**標記（Markdown格式）。絕對不要出現任何程式碼、技術術語或複雜的結構化格式。內容包含：1.**人設標籤**：列出3-5個標籤，用自然語言描述 2.**一句話定位**：用一句話清楚說明個人定位 3.**品牌原型**：簡潔描述品牌原型和特質 4.**語氣設定**：用友善的語言說明語氣特點 5.**核心價值觀**：列出3-5個核心價值，用簡短句子說明 6.**禁語清單**：列出應該避免使用的詞彙和表達方式 7.**視覺設定**：描述視覺風格、配色、字體等，用自然語言 8.**KPI指標**：說明關鍵指標，用易懂的方式呈現',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: '短影音平台',
              profile: 'IP人設規劃專家',
              topic: 'IP Profile生成',
              style: '自然語言、用戶友好、易讀易懂，使用Markdown粗體標記重要內容，不要程式碼或技術格式',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // 忽略解析錯誤
                  }
                }
              }
            }
            
            // 使用安全的 Markdown 渲染函數處理內容
            let renderedContent = '';
            if (typeof safeRenderMarkdown !== 'undefined') {
              renderedContent = safeRenderMarkdown(content);
            } else if (typeof renderMode3Markdown !== 'undefined') {
              renderedContent = renderMode3Markdown(content);
            } else {
              // 降級處理：轉義 HTML 並保留格式
              renderedContent = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            }
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>🚀</span> 重新生成';
            button.disabled = false;
          } else {
            throw new Error('生成失敗');
          }
        } catch (error) {
          console.error('生成IP Profile失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }

      // 生成14天規劃
      window.generateMode314DayPlan = async function() {
        const resultBlock = document.getElementById('mode3-plan-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請根據我們的對話內容和IP Profile，生成一份14天短影音規劃表。請使用自然語言、友善的語氣，以清晰易懂的方式呈現每一天的規劃。重要標題和關鍵詞請使用**粗體**標記（Markdown格式）。絕對不要出現任何程式碼、表格符號或複雜的結構化格式。每一天的規劃請包含：1.**每日主題**：用一句話說明當天的主題 2.**內容方向**：用2-3句自然語言描述內容重點 3.**拍攝建議**：用簡短易懂的句子說明拍攝要點 4.**發布時間**：建議發布時段 5.**互動策略**：用一句話說明如何與觀眾互動。請將每一天的內容用清晰的段落分隔，讓用戶容易閱讀。',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: '短影音平台',
              profile: 'IP人設規劃專家',
              topic: '14天規劃生成',
              style: '自然語言、用戶友好、易讀易懂，使用Markdown粗體標記重要內容，不要程式碼或表格格式',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // 忽略解析錯誤
                  }
                }
              }
            }
            
            // 使用安全的 Markdown 渲染函數處理內容
            let renderedContent = '';
            if (typeof safeRenderMarkdown !== 'undefined') {
              renderedContent = safeRenderMarkdown(content);
            } else if (typeof renderMode3Markdown !== 'undefined') {
              renderedContent = renderMode3Markdown(content);
            } else {
              // 降級處理：轉義 HTML 並保留格式
              renderedContent = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            }
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>🚀</span> 重新生成';
            button.disabled = false;
          } else {
            throw new Error('生成失敗');
          }
        } catch (error) {
          console.error('生成14天規劃失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }
      // 生成今日腳本
      window.generateMode3TodayScripts = async function() {
        const resultBlock = document.getElementById('mode3-scripts-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>⏳</span> 生成中...';
        
        try {
          const response = await fetch('https://api.aijob.com.tw/api/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: '請根據我們的對話內容和IP Profile，生成今日3支短影音腳本。請使用自然語言、友善的語氣，以清晰易懂的方式呈現。重要標題和關鍵詞請使用**粗體**標記（Markdown格式）。絕對不要出現任何程式碼、技術術語或複雜的結構化格式。每支腳本請包含：1.**主題標題**：用一句話清楚說明這支影片的主題 2.**開場鉤子**：用自然語言寫出吸引人的開場，讓觀眾想繼續看下去 3.**核心內容**：用2-3句自然語言說明影片要傳達的價值 4.**行動呼籲**：用一句話引導觀眾採取行動 5.**畫面描述**：用簡短易懂的句子描述畫面應該呈現什麼 6.**發佈文案**：寫一段適合社群媒體的文案。請將每支腳本用清晰的段落分隔，讓用戶容易閱讀和使用。',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: '短影音平台',
              profile: 'IP人設規劃專家',
              topic: '今日腳本生成',
              style: '自然語言、用戶友好、易讀易懂，使用Markdown粗體標記重要內容，不要程式碼或技術格式',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // 忽略解析錯誤
                  }
                }
              }
            }
            
            // 使用安全的 Markdown 渲染函數處理內容
            let renderedContent = '';
            if (typeof safeRenderMarkdown !== 'undefined') {
              renderedContent = safeRenderMarkdown(content);
            } else if (typeof renderMode3Markdown !== 'undefined') {
              renderedContent = renderMode3Markdown(content);
            } else {
              // 降級處理：轉義 HTML 並保留格式
              renderedContent = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            }
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>🚀</span> 重新生成';
            button.disabled = false;
          } else {
            throw new Error('生成失敗');
          }
        } catch (error) {
          console.error('生成今日腳本失敗:', error);
          button.innerHTML = '<span>❌</span> 生成失敗，請重試';
          button.disabled = false;
        }
      }

      // 儲存結果
      window.saveMode3Result = async function() {
        const token = sessionStorage.getItem('ipPlanningToken');
        const userStr = sessionStorage.getItem('ipPlanningUser');
        
        if (!token || !userStr) {
          showToast('請先登入', 3000);
          return;
        }
        
        try {
          const user = JSON.parse(userStr);
          const activeTab = document.querySelector('.mode3-tab.active');
          if (!activeTab) {
            showToast('請先選擇要儲存的結果', 3000);
            return;
          }
          
          // 判斷結果類型
          let resultType = '';
          let title = '';
          if (activeTab.textContent.includes('Profile')) {
            resultType = 'profile';
            title = 'IP Profile';
          } else if (activeTab.textContent.includes('規劃')) {
            resultType = 'plan';
            title = '14天短影音規劃';
          } else if (activeTab.textContent.includes('腳本')) {
            resultType = 'scripts';
            title = '今日3支腳本';
          }
          
          const resultBlock = document.getElementById(`mode3-${resultType}-result`);
          const content = resultBlock.querySelector('.mode3-result-content');
          
          if (!content || !content.innerHTML.trim()) {
            showToast('沒有可儲存的內容', 3000);
            return;
          }
          
          // 提取純文字內容（去除HTML標籤用於標題）
          const textContent = content.innerText || content.textContent || '';
          const shortTitle = textContent.substring(0, 50) || title;
          
          // 顯示儲存中通知
          showToast('正在儲存...', 2000);
          
          const response = await fetch('https://api.aijob.com.tw/api/ip-planning/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              user_id: user.user_id,
              result_type: resultType,
              title: shortTitle,
              content: content.innerHTML,
              metadata: {
                timestamp: new Date().toISOString(),
                source: 'mode3'
              }
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: '網路錯誤' }));
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }
          
          const data = await response.json();
          if (data.success) {
            showToast('✅ 結果已儲存到個人資料庫', 3000);
          } else {
            showToast('❌ ' + (data.error || '儲存失敗'), 3000);
            console.error('儲存失敗:', data);
          }
        } catch (error) {
          console.error('儲存結果失敗:', error);
          showToast('❌ 儲存失敗：' + (error.message || '請稍後再試'), 3000);
        }
      }

      // 重新生成結果
      function regenerateMode3Result() {
        const activeTab = document.querySelector('.mode3-tab.active');
        if (activeTab) {
          const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                         activeTab.textContent.includes('規劃') ? 'plan' : 'scripts';
          
          if (tabName === 'profile') {
            generateMode3IPProfile();
          } else if (tabName === 'plan') {
            generateMode314DayPlan();
          } else if (tabName === 'scripts') {
            generateMode3TodayScripts();
          }
        }
      }

      // 匯出結果（支援 CSV 和 JSON）
      window.exportMode3Result = function() {
        const activeTab = document.querySelector('.mode3-tab.active');
        if (!activeTab) {
          showToast('請先選擇要匯出的結果', 3000);
          return;
        }
        
        const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                       activeTab.textContent.includes('規劃') ? 'plan' : 'scripts';
        
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        const content = resultBlock.querySelector('.mode3-result-content');
        
        if (!content || !content.innerHTML.trim()) {
          showToast('沒有可匯出的內容', 3000);
          return;
        }
        
        try {
          // 提取純文字內容用於 CSV
          const textContent = content.innerText || content.textContent || '';
          
          // 生成 CSV 格式
          const csvContent = `類型,標題,內容,匯出時間\n"${tabName}","${tabName === 'profile' ? 'IP Profile' : tabName === 'plan' ? '14天規劃' : '今日腳本'}","${textContent.replace(/"/g, '""').replace(/\n/g, ' ')}","${new Date().toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          })}"`;
          
          // 創建 CSV 檔案
          const csvBlob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const csvUrl = URL.createObjectURL(csvBlob);
          const csvLink = document.createElement('a');
          csvLink.href = csvUrl;
          csvLink.download = `ip-${tabName}-${Date.now()}.csv`;
          csvLink.click();
          URL.revokeObjectURL(csvUrl);
          
          showToast('✅ 結果已匯出為 CSV 檔案', 3000);
        } catch (error) {
          console.error('匯出失敗:', error);
          showToast('匯出失敗，請稍後再試', 3000);
        }
      }

      // 初始化模式3
      function initializeMode3() {
        // 設置說明欄位預設為收起狀態
        setTimeout(() => {
          const instructions = document.querySelector('.mode3-instructions');
          const chatMessages = document.querySelector('.mode3-chat-messages');
          if (instructions && chatMessages) {
            instructions.classList.add('collapsed');
            chatMessages.classList.add('expanded');
          }
        }, 100);
        
        // 設置輸入框Enter鍵發送
        const input = document.getElementById('mode3-message-input');
        if (input) {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMode3Message();
            }
          });
        }
        
        // 載入歷史對話記錄
        loadMode3History();
      }
      
      // 載入IP人設規劃模式的歷史對話
      async function loadMode3History() {
        // 檢查是否已登入
        if (!ipPlanningUser?.user_id || !ipPlanningToken) {
          return;
        }
        
        
        try {
          // 載入對話記錄
          const conversationsResponse = await fetch(`https://api.aijob.com.tw/api/user/conversations/${ipPlanningUser.user_id}`);
          
          if (conversationsResponse.ok) {
            const conversationsData = await conversationsResponse.json();
            
            // 顯示歷史對話到聊天區域
            if (conversationsData.conversations && conversationsData.conversations.length > 0) {
              displayMode3History(conversationsData.conversations);
            }
          } else {
            console.error('載入對話記錄失敗:', conversationsResponse.status);
          }
        } catch (error) {
          console.error('載入歷史對話錯誤:', error);
        }
      }
      
      // 顯示歷史對話到IP人設規劃聊天區域
      function displayMode3History(conversations) {
        const messagesContainer = document.getElementById('mode3-chat-messages');
        if (!messagesContainer) return;
        
        // 清空現有的歡迎訊息
        messagesContainer.innerHTML = '';
        
        // 顯示歷史對話
        conversations.forEach(conversation => {
          if (conversation.messages && conversation.messages.length > 0) {
            conversation.messages.forEach(message => {
              if (message.role === 'user' || message.role === 'assistant') {
                addMode3Message(message.role, message.content);
              }
            });
          }
        });
        
        // 滾動到底部
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // 載入AI顧問模式的歷史對話
      async function loadMode2History() {
        // 檢查是否已登入
        if (!ipPlanningUser?.user_id || !ipPlanningToken) {
          return;
        }
        
        
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;
        
        // 重新整理時不自動載入歷史對話（聊天區域已在 DOMContentLoaded 時清空）
        // 用戶可以通過「🔄 載入本會話」按鈕主動載入歷史對話
      }
      
      // 顯示歷史對話到AI顧問聊天區域
      function displayMode2History(memories) {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;
        
        // 如果已經有訊息，不要清空
        if (messagesContainer.children.length > 0) {
          return;
        }
        
        // 按時間排序訊息
        const sortedMemories = memories
          .filter(mem => mem.conversation_type === 'ai_advisor')
          .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        
        // 顯示歷史對話
        sortedMemories.forEach(memory => {
          if (memory.message_role === 'user' || memory.message_role === 'assistant') {
            const messageDiv = createMessage(memory.message_role, memory.message_content);
                messagesContainer.appendChild(messageDiv);
          }
        });
        
        // 滾動到底部
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // 關閉聊天容器
      function closeChatContainer() {
        // 空函數，保留以備將來使用
      }
      
      // IP人設規劃使用說明抽屜控制
      function toggleMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          const isOpen = overlay.classList.contains('open');
          
          if (isOpen) {
            closeMode3InstructionsDrawer();
          } else {
            openMode3InstructionsDrawer();
          }
        }
      }
      
      function openMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.add('open');
          drawer.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.remove('open');
          drawer.classList.remove('open');
          document.body.style.overflow = '';
        }
      }
      
      // IP人設規劃生成結果抽屜控制
      function toggleMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          const isOpen = overlay.classList.contains('open');
          
          if (isOpen) {
            closeMode3ResultsDrawer();
          } else {
            openMode3ResultsDrawer();
          }
        }
      }
      
      function openMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.add('open');
          drawer.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.remove('open');
          drawer.classList.remove('open');
          document.body.style.overflow = '';
        }
      }

      // 手機版抽屜控制函數
      // toggleMobileDrawer、openMobileDrawer、closeMobileDrawer 函數已在頁面頂部定義，這裡不需要重複定義

      // 注意：mode3 初始化代碼已移除，因為 mode3 功能已分離到 mode3.html 和 mode3.js
    </script>
    
    <!-- IP人設規劃使用說明抽屜 -->
    <div class="mode3-instructions-overlay" id="mode3InstructionsOverlay" onclick="closeMode3InstructionsDrawer()"></div>
    <div class="mode3-instructions-drawer" id="mode3InstructionsDrawer">
      <div class="mode3-instructions-drawer-header">
        <h3>📋 IP人設規劃使用說明</h3>
        <button class="mode3-instructions-drawer-close" onclick="closeMode3InstructionsDrawer()">✕</button>
      </div>
      <div class="mode3-instructions-drawer-content">
        <p><strong>🎯 IP人設規劃模式</strong></p>
        <p>透過與AI深度對話，記錄您的人生曲線和個人特色，讓AI協助您建立完整的IP人設。</p>
        
        <p><strong>🚀 操作步驟：</strong></p>
        <div class="mode3-step-guide">
          <div class="mode3-step">
            <div class="mode3-step-number">1</div>
            <div class="mode3-step-content">
              <strong>開始對話</strong>
              <p>點擊快速按鈕或輸入框，與AI分享您的背景、專長、價值觀</p>
            </div>
          </div>
          <div class="mode3-step">
            <div class="mode3-step-number">2</div>
            <div class="mode3-step-content">
              <strong>深度交流</strong>
              <p>建議進行5-10輪對話，讓AI充分了解您的個人特色和目標</p>
            </div>
          </div>
          <div class="mode3-step">
            <div class="mode3-step-number">3</div>
            <div class="mode3-step-content">
              <strong>生成結果</strong>
              <p>隨時點擊右側生成按鈕，無需等待AI提醒</p>
            </div>
          </div>
        </div>
        
        <p><strong>💬 對話建議：</strong></p>
        <ul>
          <li>分享您的專業經驗和成就</li>
          <li>討論您的價值觀和人生目標</li>
          <li>描述您的個性和溝通風格</li>
          <li>探索您想分享的內容方向</li>
        </ul>
        
        <p><strong>📊 生成內容：</strong></p>
        <div class="mode3-result-types">
          <div class="mode3-result-type">
            <strong>🎭 IP Profile</strong>
            <p>個人品牌檔案：人設標籤、品牌原型、語氣設定</p>
          </div>
          <div class="mode3-result-type">
            <strong>📅 14天規劃</strong>
            <p>詳細的短影音內容規劃表</p>
          </div>
          <div class="mode3-result-type">
            <strong>📝 今日腳本</strong>
            <p>3支即時可用的短影音腳本</p>
          </div>
        </div>
        
        <p><strong>💡 重要提醒：</strong></p>
        <ul>
          <li>✅ <strong>隨時可以生成</strong>：不需要等AI提醒</li>
          <li>✅ <strong>建議順序</strong>：IP Profile → 14天規劃 → 今日腳本</li>
          <li>✅ <strong>可以重複生成</strong>：不滿意就點「🔄 重新生成」</li>
          <li>✅ <strong>AI有記憶</strong>：會記住您之前說過的內容</li>
        </ul>
      </div>
    </div>
    
    <!-- IP人設規劃生成結果抽屜 -->
    <div class="mode3-results-overlay" id="mode3ResultsOverlay" onclick="closeMode3ResultsDrawer()"></div>
    <div class="mode3-results-drawer" id="mode3ResultsDrawer">
      <div class="mode3-results-drawer-header">
        <h3>📊 生成結果</h3>
        <button class="mode3-results-drawer-close" onclick="closeMode3ResultsDrawer()">✕</button>
      </div>
      <div class="mode3-results-drawer-content">
        <!-- 結果標籤 -->
        <div class="mode3-tabs">
          <button class="mode3-tab active" onclick="switchMode3Tab('profile')">《IP Profile》</button>
          <button class="mode3-tab" onclick="switchMode3Tab('plan')">《14天短影音規劃表》</button>
          <button class="mode3-tab" onclick="switchMode3Tab('scripts')">《今日3支腳本》</button>
        </div>

        <!-- 結果內容 -->
        <div class="mode3-results-content">
          <!-- IP Profile 結果 -->
          <div id="mode3-profile-result" class="mode3-result-block active">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">🎭</div>
              <h4>IP Profile</h4>
              <p>與AI對話後，將在此顯示您的個人品牌檔案</p>
              <button class="mode3-generate-btn" onclick="generateMode3IPProfile()">
                <span>🚀</span> 生成IP Profile
              </button>
            </div>
          </div>

          <!-- 14天規劃結果 -->
          <div id="mode3-plan-result" class="mode3-result-block">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">📅</div>
              <h4>14天短影音規劃</h4>
              <p>基於您的IP Profile，生成詳細的內容規劃</p>
              <button class="mode3-generate-btn" onclick="generateMode314DayPlan()">
                <span>🚀</span> 生成14天規劃
              </button>
            </div>
          </div>

          <!-- 今日腳本結果 -->
          <div id="mode3-scripts-result" class="mode3-result-block">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">📝</div>
              <h4>今日3支腳本</h4>
              <p>根據您的規劃，生成今日可用的腳本</p>
              <button class="mode3-generate-btn" onclick="generateMode3TodayScripts()">
                <span>🚀</span> 生成今日腳本
              </button>
            </div>
          </div>
        </div>
        
        <!-- 操作按鈕 -->
        <div class="mode3-result-actions">
          <button class="mode3-action-btn" onclick="saveMode3Result()" title="儲存結果">
            <span>💾</span> 儲存結果
          </button>
          <button class="mode3-action-btn" onclick="regenerateMode3Result()" title="重新生成">
            <span>🔄</span> 重新生成
          </button>
          <button class="mode3-action-btn" onclick="exportMode3Result()" title="匯出結果">
            <span>📤</span> 匯出結果
          </button>
        </div>
      </div>
    </div>
    
    <!-- 手機版抽屜導航 -->
    <div class="mobile-drawer-overlay" id="mobileDrawerOverlay" onclick="closeMobileDrawer()"></div>
    <div class="mobile-drawer" id="mobileDrawer">
      <div class="mobile-drawer-header">
        <h3>選單</h3>
        <button class="mobile-drawer-close" onclick="closeMobileDrawer()">✕</button>
      </div>
      <div class="mobile-drawer-content">
        <a href="#homepage" class="mobile-drawer-item" onclick="switchPage('homepage'); closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-home"></i></span>
          <span class="mobile-drawer-text">首頁</span>
        </a>
        <a href="mode1.html" class="mobile-drawer-item" onclick="event.preventDefault(); closeMobileDrawer(); (async function() { try { if(window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') { const canAccess = await window.ReelMindCommon.checkFeatureAccess(); if(canAccess) { window.location.href = 'mode1.html'; } } else { window.location.href = 'mode1.html'; } } catch(error) { console.error('檢查功能訪問失敗:', error); } })(); return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-user-tie"></i></span>
          <span class="mobile-drawer-text">IP人設規劃</span>
        </a>
        <a href="mode3.html" class="mobile-drawer-item" onclick="event.preventDefault(); closeMobileDrawer(); (async function() { try { if(window.ReelMindCommon && typeof window.ReelMindCommon.checkFeatureAccess === 'function') { const canAccess = await window.ReelMindCommon.checkFeatureAccess(); if(canAccess) { window.location.href = 'mode3.html'; } } else { window.location.href = 'mode3.html'; } } catch(error) { console.error('檢查功能訪問失敗:', error); } })(); return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-magic"></i></span>
          <span class="mobile-drawer-text">一鍵生成</span>
        </a>
        <a href="forum.html" class="mobile-drawer-item" onclick="if(typeof closeMobileDrawer === 'function') { closeMobileDrawer(); } return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-comments"></i></span>
          <span class="mobile-drawer-text">論壇介紹</span>
        </a>
        <a href="guide.html" class="mobile-drawer-item" onclick="window.location.href='guide.html'; closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-book-open"></i></span>
          <span class="mobile-drawer-text">實戰指南</span>
        </a>
        <a href="about.html" class="mobile-drawer-item" onclick="window.location.href='about.html'; closeMobileDrawer(); return false;">
          <span class="mobile-drawer-icon"><i class="fas fa-info-circle"></i></span>
          <span class="mobile-drawer-text">關於我們</span>
        </a>
        <a href="#" id="mobileUserDBTab" class="mobile-drawer-item" onclick="handleUserDBClick(); closeMobileDrawer(); return false;" style="display:none;">
          <span class="mobile-drawer-icon"><i class="fas fa-database"></i></span>
          <span class="mobile-drawer-text">創作者資料庫</span>
        </a>
    </div>
    </div>

  <script>
  (function(){
    function goToPricing(plan){
      var base = 'subscription.html';
      var url = plan ? (base + '?plan=' + encodeURIComponent(plan)) : base;
      window.location.href = url;
    }
    function smoothScrollTo(id){
      try{
        var el = document.getElementById(id);
        if(el){ el.scrollIntoView({behavior:'smooth'}); }
      }catch(_){ window.location.hash = '#' + id; }
    }
    function goLogin(){
      // 一律使用主視窗跳轉（fb=前端基底網址）
      try{
        var fb = encodeURIComponent(window.location.origin);
        window.location.href = 'https://api.aijob.com.tw/api/auth/google?fb=' + fb;
      }catch(_){
        window.location.href = 'https://api.aijob.com.tw/api/auth/google';
      }
    }
    document.addEventListener('click', function(e){
      var t = e.target;
      if (!t) return;
      var txt = (t.innerText||'').trim();
      if (txt.includes('立即啟動') && txt.includes('AI')){ e.preventDefault(); goToPricing(); }
      if (txt === '登入解鎖你的專屬 AI 智能體'){ e.preventDefault(); goToLogin(); }
      if (txt === '立即訂閱'){ e.preventDefault(); goToPricing(); }
      if (txt.includes('已訂閱') && txt.includes('登入使用')){ e.preventDefault(); goLogin(); }
    }, true);
    window.goToPricing = goToPricing;
    window.smoothScrollTo = smoothScrollTo;
    window.goLogin = goLogin;
  })();
  
  // Mode3 IP人設規劃功能（從 index-ai-consultant.html 遷移）
  (function() {
    const API_BASE_URL = 'https://api.aijob.com.tw';
    let currentMode3ConversationType = 'ip_planning';
    let isMode3Sending = false; // 防止重複發送
    
    // 初始化 Mode3 聊天功能（防止重複綁定）
    let mode3ChatInitialized = false;
    function initMode3Chat() {
      const messageInput = document.getElementById('mode3-messageInput');
      const sendBtn = document.getElementById('mode3-sendBtn');
      const quickButtons = document.getElementById('mode3-quickButtons');
      
      if (!messageInput || !sendBtn || !quickButtons) return;
      
      // 如果已經初始化過，跳過（但允許在切換頁面時重新初始化）
      // 注意：這個檢查確保不會重複綁定事件監聽器
      if (mode3ChatInitialized) {
        // 如果已經初始化過，只重新設置按鈕狀態，不重複綁定事件
        sendBtn.disabled = !messageInput.value.trim();
        return;
      }
      mode3ChatInitialized = true;
      
      // 輸入框自動調整高度
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        sendBtn.disabled = !this.value.trim();
      });
      
      // 發送按鈕
      sendBtn.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
          sendMode3Message(message);
        }
      });
      
      // Enter 發送
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const message = messageInput.value.trim();
          if (message) {
            sendMode3Message(message);
          }
        }
      });
      
      // 快速按鈕 - 使用事件委託避免重複綁定，確保只處理 mode3 的按鈕
      quickButtons.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到其他監聽器
        const btn = e.target.closest('.quick-btn');
        // 確保按鈕在 mode3 容器內，並且是 mode3 的快速按鈕容器
        if (btn && btn.closest('#mode3') && quickButtons.id === 'mode3-quickButtons') {
          e.preventDefault();
          const text = btn.getAttribute('data-text');
          if (text) {
            sendMode3Message(text, 'ip_planning');
          }
        }
      });
    }
    
    // 發送 Mode3 訊息
    async function sendMode3Message(message, conversationType = 'ip_planning') {
      // 防止重複發送
      if (isMode3Sending) {
        return;
      }
      
      currentMode3ConversationType = conversationType;
      if (!message || !message.trim()) return;
      
      isMode3Sending = true;
      
      const chatMessages = document.getElementById('mode3-chatMessages');
      const messageInput = document.getElementById('mode3-messageInput');
      const sendBtn = document.getElementById('mode3-sendBtn');
      const quickButtons = document.getElementById('mode3-quickButtons');
      
      if (!chatMessages || !messageInput || !sendBtn) return;
      
      // 獲取用戶 token
      const token = sessionStorage.getItem('ipPlanningToken') || 
                   (window.Auth && window.Auth.getToken ? window.Auth.getToken() : null);
      const userStr = sessionStorage.getItem('ipPlanningUser');
      const user = userStr ? JSON.parse(userStr) : null;
      
      // 添加用戶訊息
      const userMessage = createMode3Message('user', message);
      chatMessages.appendChild(userMessage);
      
      // 隱藏快速按鈕
      if (quickButtons) {
        quickButtons.style.display = 'none';
      }
      
      // 清空輸入框並禁用
      messageInput.value = '';
      messageInput.disabled = true;
      sendBtn.disabled = true;
      messageInput.style.height = 'auto';
      
      // 記錄長期記憶
      try {
        await recordMode3ConversationMessage(conversationType, 'user', message, token, user);
      } catch (error) {
        console.error('記錄長期記憶錯誤:', error);
      }
      
      // 添加載入動畫（直接創建 AI 訊息容器，內容先顯示載入動畫）
      const aiMessage = createMode3Message('assistant', '');
      const contentDiv = aiMessage.querySelector('.message-content');
      // 先顯示載入動畫
      contentDiv.innerHTML = `
        <div class="typing-indicator">
          <span>AI思考中...</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      chatMessages.appendChild(aiMessage);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/chat/stream`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
          },
          body: JSON.stringify({
            message: message,
            history: [],
            user_id: user?.user_id || null
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // 不需要移除載入動畫，直接更新內容即可
        
        // 處理串流回應
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                // 記錄長期記憶
                try {
                  await recordMode3ConversationMessage(currentMode3ConversationType, 'assistant', fullContent, token, user);
                } catch (error) {
                  console.error('記錄長期記憶錯誤:', error);
                }
                break;
              }
              
              try {
                const parsed = JSON.parse(data);
                if (parsed.content) {
                  fullContent += parsed.content;
                  contentDiv.innerHTML = renderMode3Markdown(fullContent);
                  
                  // 語法高亮
                  if (typeof hljs !== 'undefined') {
                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                      if (!block.classList.contains('hljs')) {
                        hljs.highlightElement(block);
                      }
                    });
                  }
                  
                  chatMessages.scrollTop = chatMessages.scrollHeight;
                }
              } catch (e) {
                // 忽略解析錯誤
              }
            }
          }
        }
      } catch (error) {
        console.error('發送訊息錯誤:', error);
        // 直接更新現有的 AI 訊息內容為錯誤訊息
        if (contentDiv) {
          const safeErrorMsg = escapeHtml(error.message || '未知錯誤');
          contentDiv.innerHTML = `抱歉，發生了錯誤：${safeErrorMsg}`;
        } else {
          const errorMessage = createMode3Message('assistant', `抱歉，發生了錯誤：${error.message}`);
          chatMessages.appendChild(errorMessage);
        }
      } finally {
        // 恢復輸入框和按鈕
        messageInput.disabled = false;
        sendBtn.disabled = false;
        if (quickButtons) {
          quickButtons.style.display = 'flex';
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // 重置發送狀態
        isMode3Sending = false;
      }
    }
    
    // 創建 Mode3 訊息元素
    function createMode3Message(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      
      // 獲取用戶頭像（從 Google 登入）
      if (role === 'user') {
        const userStr = sessionStorage.getItem('ipPlanningUser');
        const user = userStr ? JSON.parse(userStr) : null;
        if (user && user.picture) {
          // 使用圖片作為頭像
          const img = document.createElement('img');
          img.src = user.picture;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.borderRadius = '50%';
          img.style.objectFit = 'cover';
          avatar.appendChild(img);
        } else {
          // 如果沒有圖片，使用首字母
          const userName = user?.name || 'U';
          avatar.textContent = userName.charAt(0).toUpperCase();
        }
      } else {
        // AI 頭像使用文字
        avatar.textContent = '🤖';
      }
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      if (content) {
        contentDiv.innerHTML = renderMode3Markdown(content);
      }
      
      // 用戶訊息使用 row-reverse，所以先添加內容再添加頭像
      if (role === 'user') {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(avatar);
      } else {
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
      }
      
      return messageDiv;
    }
    
    // 創建載入動畫
    function createMode3TypingIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'message assistant';
      indicator.innerHTML = `
        <div class="message-avatar">🤖</div>
        <div class="message-content">
          <div class="typing-indicator">
            <span>AI思考中...</span>
            <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      return indicator;
    }
    
    // Markdown 渲染
    function renderMode3Markdown(text) {
      if (typeof marked !== 'undefined') {
        return marked.parse(text);
      }
      return text.replace(/\n/g, '<br>');
    }
    
    // 記錄 Mode3 長期記憶
    async function recordMode3ConversationMessage(conversationType, role, content, token, user) {
      if (!token || !content) return;
      
      try {
        const user_id = user?.user_id || 
          (token ? JSON.parse(atob(token.split('.')[1])).user_id : null);
        
        if (!user_id) {
          console.warn('無法獲取 user_id，跳過長期記憶記錄');
          return;
        }
        
        const session_id = `${conversationType}_${user_id}_${Date.now()}`;
        
        await fetch(`${API_BASE_URL}/api/memory/long-term`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            conversation_type: conversationType,
            session_id: session_id,
            message_role: role,
            message_content: content,
            metadata: JSON.stringify({ user_id: user_id })
          })
        });
      } catch (error) {
        console.error('記錄長期記憶錯誤:', error);
      }
    }
    
    // IP人設規劃使用說明抽屜控制
    window.toggleMode3InstructionsDrawer = function() {
      const overlay = document.getElementById('mode3InstructionsOverlay');
      const drawer = document.getElementById('mode3InstructionsDrawer');
      
      if (overlay && drawer) {
        const isOpen = overlay.classList.contains('open');
        
        if (isOpen) {
          closeMode3InstructionsDrawer();
        } else {
          openMode3InstructionsDrawer();
        }
      }
    };
    
    window.openMode3InstructionsDrawer = function() {
      const overlay = document.getElementById('mode3InstructionsOverlay');
      const drawer = document.getElementById('mode3InstructionsDrawer');
      
      if (overlay && drawer) {
        overlay.classList.add('open');
        drawer.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
    };
    
    window.closeMode3InstructionsDrawer = function() {
      const overlay = document.getElementById('mode3InstructionsOverlay');
      const drawer = document.getElementById('mode3InstructionsDrawer');
      
      if (overlay && drawer) {
        overlay.classList.remove('open');
        drawer.classList.remove('open');
        document.body.style.overflow = '';
      }
    };
    
    // IP人設規劃生成結果抽屜控制
    window.toggleMode3ResultsDrawer = function() {
      const overlay = document.getElementById('mode3ResultsOverlay');
      const drawer = document.getElementById('mode3ResultsDrawer');
      
      if (overlay && drawer) {
        const isOpen = overlay.classList.contains('open');
        
        if (isOpen) {
          closeMode3ResultsDrawer();
        } else {
          openMode3ResultsDrawer();
        }
      }
    };
    
    window.openMode3ResultsDrawer = function() {
      const overlay = document.getElementById('mode3ResultsOverlay');
      const drawer = document.getElementById('mode3ResultsDrawer');
      
      if (overlay && drawer) {
        overlay.classList.add('open');
        drawer.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
    };
    
    window.closeMode3ResultsDrawer = function() {
      const overlay = document.getElementById('mode3ResultsOverlay');
      const drawer = document.getElementById('mode3ResultsDrawer');
      
      if (overlay && drawer) {
        overlay.classList.remove('open');
        drawer.classList.remove('open');
        document.body.style.overflow = '';
      }
    };
    
    // 切換生成結果標籤
    window.switchMode3Tab = function(tabName, event) {
      document.querySelectorAll('.mode3-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.mode3-result-block').forEach(block => {
        block.classList.remove('active');
      });
      
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        const tabs = document.querySelectorAll('.mode3-tab');
        tabs.forEach(tab => {
          if (tab.textContent.includes(tabName === 'profile' ? 'IP Profile' : tabName === 'plan' ? '14天' : '今日')) {
            tab.classList.add('active');
          }
        });
      }
      
      const resultBlock = document.getElementById(`mode3-${tabName}-result`);
      if (resultBlock) {
        resultBlock.classList.add('active');
      }
    };
    
    // 生成功能已在上面定義，這裡不需要重複定義
    // 如果上面的函數未定義，則使用佔位函數
    if (typeof generateMode3IPProfile === 'undefined') {
      window.generateMode3IPProfile = function() {
      };
    }
    
    if (typeof generateMode314DayPlan === 'undefined') {
      window.generateMode314DayPlan = function() {
      };
    }
    
    if (typeof generateMode3TodayScripts === 'undefined') {
      window.generateMode3TodayScripts = function() {
      };
    }
    
    // 這些函數已在上面定義，不需要重複定義
    // 如果上面的函數未定義，則使用佔位函數
    if (typeof saveMode3Result === 'undefined') {
      window.saveMode3Result = function() {
      };
    }
    
    // 根據用戶狀態更新 Hero 區域的"搶先體驗ReelMind"按鈕
    async function updateHeroExperienceButton() {
      const btn = document.getElementById('hero-experience-btn');
      if (!btn) return;
      
      // 檢查用戶登入和訂閱狀態
      let isLoggedIn = false;
      let isSubscribed = false;
      
      if (window.ReelMindCommon && typeof window.ReelMindCommon.checkLoginStatus === 'function') {
        isLoggedIn = await window.ReelMindCommon.checkLoginStatus();
        
        if (isLoggedIn && window.ReelMindCommon.checkSubscriptionStatus) {
          await window.ReelMindCommon.checkSubscriptionStatus();
          isSubscribed = window.ReelMindCommon.isSubscribed ? window.ReelMindCommon.isSubscribed() : false;
        }
      } else {
        // 降級處理：直接檢查 localStorage
        const token = sessionStorage.getItem('ipPlanningToken') || localStorage.getItem('token');
        const user = JSON.parse(sessionStorage.getItem('ipPlanningUser') || localStorage.getItem('user') || 'null');
        isLoggedIn = !!(token && user);
        if (isLoggedIn && user) {
          isSubscribed = user.is_subscribed === true || user.is_subscribed === 1 || user.is_subscribed === '1' || user.is_subscribed === 'true';
        }
      }
      
      // 只有未登入或未訂閱的用戶才顯示"搶先體驗ReelMind"
      // 已登入且已訂閱的用戶顯示"了解使用方式"
      if (isLoggedIn && isSubscribed) {
        btn.textContent = '了解使用方式';
        btn.setAttribute('onclick', "smoothScrollTo('rm-overview-v2'); return false;");
        btn.href = '#rm-overview-v2';
      } else {
        btn.textContent = '搶先體驗ReelMind';
        btn.setAttribute('onclick', "smoothScrollTo('experience-demo'); return false;");
        btn.href = '#experience-demo';
      }
    }
    
    // 頁面載入時更新按鈕
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateHeroExperienceButton);
    } else {
      updateHeroExperienceButton();
    }
    
    // 監聽用戶狀態變化（如果有的話）
    if (window.ReelMindCommon && window.ReelMindCommon.onUserStatusChange) {
      window.ReelMindCommon.onUserStatusChange(updateHeroExperienceButton);
    }
    
    if (typeof regenerateMode3Result === 'undefined') {
      window.regenerateMode3Result = function() {
      };
    }
    
    if (typeof exportMode3Result === 'undefined') {
      window.exportMode3Result = function() {
      };
    }
    
    // 當 mode3 頁面激活時初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initMode3Chat, 100);
      });
    } else {
      setTimeout(initMode3Chat, 100);
    }
    
    // 監聽頁面切換
    const originalSwitchPage = window.switchPage;
    if (originalSwitchPage) {
      window.switchPage = function(pageId) {
        originalSwitchPage(pageId);
        if (pageId === 'mode3') {
          setTimeout(initMode3Chat, 100);
          document.body.classList.add('mode3-active');
          document.documentElement.classList.add('mode3-active');
        } else {
          document.body.classList.remove('mode3-active');
          document.documentElement.classList.remove('mode3-active');
        }
      };
    }
  })();
  
  // 打字機動畫函數
  function initTypewriterAnimation() {
    const heroTitles = [
      { id: 'hero-title-1', text: 'ReelMind 打造你的爆款短影音!' },
      { id: 'hero-title-2', text: 'ReelMind 打造你的爆款短影音!' }
    ];
    
    heroTitles.forEach(({ id, text }) => {
      const titleElement = document.getElementById(id);
      if (!titleElement) {
        console.warn(`⚠️ 找不到元素: ${id}`);
        return;
      }
      
      // 檢查元素是否可見（不在 display: none 的父元素中）
      const isVisible = titleElement.offsetParent !== null;
      if (!isVisible) {
        console.warn(`⚠️ 元素 ${id} 不可見，跳過動畫`);
        return;
      }
      
      const textSpan = titleElement.querySelector('.typewriter-text');
      if (!textSpan) {
        console.warn(`⚠️ 找不到 .typewriter-text 在 ${id}`);
        return;
      }
      
      // 檢查父元素是否可見
      const parentView = titleElement.closest('#homepage-unsubscribed, #homepage-subscribed');
      if (parentView && parentView.style.display === 'none') {
        console.warn(`⚠️ 元素 ${id} 的父視圖被隱藏，跳過動畫`);
        return;
      }
      
      
      // 清除之前的動畫（如果存在）
      if (textSpan.dataset.animationId) {
        clearTimeout(parseInt(textSpan.dataset.animationId));
      }
      
      // 重置文字
      textSpan.textContent = '';
      textSpan.style.color = ''; // 重置顏色，繼承父元素
      textSpan.style.opacity = '1'; // 確保可見
      
      // 將換行符轉換為處理
      const lines = text.split('\n');
      let currentLineIndex = 0;
      let currentCharIndex = 0;
      let isTyping = true;
      let animationId = null;
      
      function typeChar() {
        if (!isTyping) return;
        
        // 再次檢查元素是否可見
        if (titleElement.offsetParent === null) {
          console.warn(`⚠️ 元素 ${id} 在動畫過程中變為不可見，停止動畫`);
          isTyping = false;
          return;
        }
        
        if (currentLineIndex < lines.length) {
          const currentLine = lines[currentLineIndex];
          
          if (currentCharIndex < currentLine.length) {
            // 添加當前字符
            if (currentCharIndex === 0 && currentLineIndex > 0) {
              textSpan.innerHTML += '<br>';
            }
            textSpan.textContent += currentLine[currentCharIndex];
            currentCharIndex++;
            
            // 繼續打字
            animationId = setTimeout(typeChar, 100);
            textSpan.dataset.animationId = animationId.toString();
          } else {
            // 當前行完成，移到下一行
            currentLineIndex++;
            currentCharIndex = 0;
            
            if (currentLineIndex < lines.length) {
              // 還有下一行，繼續
              animationId = setTimeout(typeChar, 300);
              textSpan.dataset.animationId = animationId.toString();
            } else {
              // 所有文字完成
              isTyping = false;
              delete textSpan.dataset.animationId;
            }
          }
        }
      }
      
      // 立即啟動動畫
      typeChar();
    });
  }
  
  // 確保函數在全局作用域可用
  window.initTypewriterAnimation = initTypewriterAnimation;
  </script>
  
  <!-- YouTube 延遲載入腳本 -->
  <script>
    (function() {
      // 處理 YouTube 延遲載入
      function initYouTubeLazyLoad() {
        const containers = document.querySelectorAll('.youtube-lazy-container');
        
        containers.forEach(function(container) {
          // 如果已經載入過，跳過
          if (container.dataset.loaded === 'true') {
            return;
          }
          
          // 點擊事件：載入實際的 iframe
          container.addEventListener('click', function() {
            const videoId = container.dataset.videoId;
            const autoplay = container.dataset.autoplay === '1' ? '1' : '0';
            
            if (!videoId) return;
            
            // 創建 iframe
            const iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.src = `https://www.youtube.com/embed/${videoId}${autoplay === '1' ? '?autoplay=1' : ''}`;
            iframe.title = container.querySelector('img')?.alt || 'YouTube 影片';
            iframe.frameBorder = '0';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            iframe.style.cssText = 'display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%;';
            
            // 清空容器內容並添加 iframe
            container.innerHTML = '';
            container.appendChild(iframe);
            container.dataset.loaded = 'true';
          });
          
          // 滑鼠懸停效果
          container.addEventListener('mouseenter', function() {
            const playButton = container.querySelector('.youtube-play-button');
            if (playButton) {
              playButton.style.transform = 'translate(-50%, -50%) scale(1.1)';
              playButton.style.background = 'rgba(255, 0, 0, 1)';
            }
          });
          
          container.addEventListener('mouseleave', function() {
            const playButton = container.querySelector('.youtube-play-button');
            if (playButton) {
              playButton.style.transform = 'translate(-50%, -50%) scale(1)';
              playButton.style.background = 'rgba(255, 0, 0, 0.9)';
            }
          });
        });
      }
      
      // DOM 載入完成後初始化
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initYouTubeLazyLoad);
      } else {
        initYouTubeLazyLoad();
      }
      
      // 導出到全局作用域
      window.initYouTubeLazyLoad = initYouTubeLazyLoad;
    })();
  </script>
  </body>
</html>
