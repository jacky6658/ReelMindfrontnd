<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    
    <!-- Primary SEO Meta Tags -->
    <title>IPäººè¨­è¦åŠƒ - ReelMind AI çŸ­å½±éŸ³æ™ºèƒ½é«” | AI å€‹äººå“ç‰Œå®šä½ Ã— 14å¤©è¦åŠƒ Ã— çŸ­å½±éŸ³è…³æœ¬</title>
    <meta name="title" content="IPäººè¨­è¦åŠƒ - ReelMind AI çŸ­å½±éŸ³æ™ºèƒ½é«” | AI å€‹äººå“ç‰Œå®šä½ Ã— 14å¤©è¦åŠƒ Ã— çŸ­å½±éŸ³è…³æœ¬" />
    <meta name="description" content="ReelMind AI IPäººè¨­è¦åŠƒåŠŸèƒ½ï¼šé€éæ·±åº¦å°è©±å»ºç«‹å€‹äººå“ç‰Œæª”æ¡ˆã€14å¤©çŸ­å½±éŸ³è¦åŠƒã€ä»Šæ—¥è…³æœ¬ã€‚æ”¯æ´ IGã€TikTokã€YouTube Shortsã€‚" />
    <meta name="keywords" content="AIçŸ­å½±éŸ³,IPäººè¨­è¦åŠƒ,å€‹äººå“ç‰Œå®šä½,çŸ­å½±éŸ³è¦åŠƒ,AIçŸ­å½±éŸ³å¹³å°" />
    <meta name="author" content="ReelMind AI" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="zh-Hant" />
    <link rel="canonical" href="https://aivideonew.zeabur.app/mode1.html" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://aivideonew.zeabur.app/mode1.html" />
    <meta property="og:title" content="IPäººè¨­è¦åŠƒ - ReelMind AI çŸ­å½±éŸ³æ™ºèƒ½é«”" />
    <meta property="og:description" content="é€éæ·±åº¦å°è©±å»ºç«‹å€‹äººå“ç‰Œæª”æ¡ˆã€14å¤©çŸ­å½±éŸ³è¦åŠƒã€ä»Šæ—¥è…³æœ¬ã€‚" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="IPäººè¨­è¦åŠƒ - ReelMind AI çŸ­å½±éŸ³æ™ºèƒ½é«”" />
    <meta name="twitter:description" content="é€éæ·±åº¦å°è©±å»ºç«‹å€‹äººå“ç‰Œæª”æ¡ˆã€14å¤©çŸ­å½±éŸ³è¦åŠƒã€ä»Šæ—¥è…³æœ¬ã€‚" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ¬%3C/text%3E%3C/svg%3E" />
    
    <!-- Markdown å’Œèªæ³•é«˜äº®å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    
    <!-- Font Awesome åœ–æ¨™åº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- CSS æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/variables.css" />
    <link rel="stylesheet" href="assets/css/animations.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    
    <!-- å…±äº« JavaScriptï¼ˆå¿…é ˆæŒ‰é †åºè¼‰å…¥ï¼‰ -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/security.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/common.js"></script>
  </head>
  <body class="mode3-fixed mode3 fig1">
    <!-- å°èˆªæ¬„ -->
    <div class="top-navbar">
      <div class="navbar-left">
        <button class="mobile-drawer-toggle" onclick="toggleMobileDrawer()">
          <span class="hamburger-icon">â˜°</span>
        </button>
        <div class="navbar-title clickable-title" onclick="window.location.href='index.html'">ReelMind</div>
        <div class="navbar-tabs">
          <a href="index.html" class="navbar-tab">é¦–é </a>
          <a href="mode1.html" class="navbar-tab active">IPäººè¨­è¦åŠƒ</a>
          <a href="mode2.html" class="navbar-tab">AIé¡§å•</a>
          <a href="mode3.html" class="navbar-tab">ä¸€éµç”Ÿæˆ</a>
          <a href="userDB.html" id="userDBTab" class="navbar-tab" style="display:none;">å‰µä½œè€…è³‡æ–™åº«</a>
        </div>
      </div>
      <div class="navbar-right">
        <div class="user-info" id="userInfo" style="display: none;" onclick="window.location.href='userDB.html'">
          <img id="userAvatar" class="user-avatar" src="" alt="ç”¨æˆ¶é ­åƒ" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
          <span id="userName" class="user-name"></span>
        </div>
        <div class="auth-buttons" id="authButtons" style="display: none;">
          <button id="loginBtn" class="login-btn" onclick="goToLogin()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ” ç™»å…¥</button>
        </div>
      </div>
    </div>

    <!-- Mode1 é é¢å…§å®¹ï¼ˆIPäººè¨­è¦åŠƒï¼‰ -->
    <div class="mode3-page">
      <!-- ä½¿ç”¨èªªæ˜æŒ‰éˆ• -->
      <div class="mode3-instructions-btn-container">
        <button class="mode3-instructions-btn" onclick="toggleMode3InstructionsDrawer()">
          <span class="mode3-instructions-icon">ğŸ“‹</span>
          <span class="mode3-instructions-text">ä½¿ç”¨èªªæ˜</span>
        </button>
      </div>
      
      <!-- ç”ŸæˆçµæœæŒ‰éˆ• -->
      <div class="mode3-results-btn-container">
        <button class="mode3-results-btn" onclick="toggleMode3ResultsDrawer()">
          <span class="mode3-results-icon">ğŸ“Š</span>
          <span class="mode3-results-text">ç”Ÿæˆçµæœ</span>
        </button>
      </div>

      <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
      <div id="mode3-chatMessages" class="chat-messages"></div>

      <!-- è¼¸å…¥å€åŸŸ -->
      <div class="input-row">
        <div class="input-container">
          <div class="input-wrapper">
            <div class="input-row-inner">
              <textarea id="mode3-messageInput" class="chat-input" placeholder="å‘AIé¡§å•æå•..." rows="1"></textarea>
              <button id="mode3-sendBtn" class="send-btn" disabled>
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            <!-- å¿«é€ŸæŒ‰éˆ•å€åŸŸ -->
            <div class="quick-buttons" id="mode3-quickButtons">
              <button class="quick-btn" data-text="æˆ‘æƒ³åˆ†äº«æˆ‘çš„å°ˆæ¥­ç¶“é©—">å°ˆæ¥­ç¶“é©—</button>
              <button class="quick-btn" data-text="æˆ‘æƒ³å»ºç«‹å€‹äººå“ç‰Œ">å€‹äººå“ç‰Œ</button>
              <button class="quick-btn" data-text="æˆ‘æƒ³åˆ†äº«ç”Ÿæ´»æ•…äº‹">ç”Ÿæ´»æ•…äº‹</button>
              <button class="quick-btn" data-text="æˆ‘æƒ³åšçŸ¥è­˜åˆ†äº«">çŸ¥è­˜åˆ†äº«</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- IPäººè¨­è¦åŠƒä½¿ç”¨èªªæ˜æŠ½å±œ -->
    <div class="mode3-instructions-overlay" id="mode3InstructionsOverlay" onclick="closeMode3InstructionsDrawer()"></div>
    <div class="mode3-instructions-drawer" id="mode3InstructionsDrawer">
      <div class="mode3-instructions-drawer-header">
        <h3>ğŸ“‹ IPäººè¨­è¦åŠƒä½¿ç”¨èªªæ˜</h3>
        <button class="mode3-instructions-drawer-close" onclick="closeMode3InstructionsDrawer()">âœ•</button>
      </div>
      <div class="mode3-instructions-drawer-content">
        <p><strong>ğŸ¯ IPäººè¨­è¦åŠƒæ¨¡å¼</strong></p>
        <p>é€éèˆ‡AIæ·±åº¦å°è©±ï¼Œè¨˜éŒ„æ‚¨çš„äººç”Ÿæ›²ç·šå’Œå€‹äººç‰¹è‰²ï¼Œè®“AIå”åŠ©æ‚¨å»ºç«‹å®Œæ•´çš„IPäººè¨­ã€‚</p>
        
        <p><strong>ğŸš€ æ“ä½œæ­¥é©Ÿï¼š</strong></p>
        <div class="mode3-step-guide">
          <div class="mode3-step">
            <div class="mode3-step-number">1</div>
            <div class="mode3-step-content">
              <strong>é–‹å§‹å°è©±</strong>
              <p>é»æ“Šå¿«é€ŸæŒ‰éˆ•æˆ–è¼¸å…¥æ¡†ï¼Œèˆ‡AIåˆ†äº«æ‚¨çš„èƒŒæ™¯ã€å°ˆé•·ã€åƒ¹å€¼è§€</p>
            </div>
          </div>
          <div class="mode3-step">
            <div class="mode3-step-number">2</div>
            <div class="mode3-step-content">
              <strong>æ·±åº¦äº¤æµ</strong>
              <p>å»ºè­°é€²è¡Œ5-10è¼ªå°è©±ï¼Œè®“AIå……åˆ†äº†è§£æ‚¨çš„å€‹äººç‰¹è‰²å’Œç›®æ¨™</p>
            </div>
          </div>
          <div class="mode3-step">
            <div class="mode3-step-number">3</div>
            <div class="mode3-step-content">
              <strong>ç”Ÿæˆçµæœ</strong>
              <p>éš¨æ™‚é»æ“Šå³å´ç”ŸæˆæŒ‰éˆ•ï¼Œç„¡éœ€ç­‰å¾…AIæé†’</p>
            </div>
          </div>
        </div>
        
        <p><strong>ğŸ’¬ å°è©±å»ºè­°ï¼š</strong></p>
        <ul>
          <li>åˆ†äº«æ‚¨çš„å°ˆæ¥­ç¶“é©—å’Œæˆå°±</li>
          <li>è¨è«–æ‚¨çš„åƒ¹å€¼è§€å’Œäººç”Ÿç›®æ¨™</li>
          <li>æè¿°æ‚¨çš„å€‹æ€§å’Œæºé€šé¢¨æ ¼</li>
          <li>æ¢ç´¢æ‚¨æƒ³åˆ†äº«çš„å…§å®¹æ–¹å‘</li>
        </ul>
        
        <p><strong>ğŸ“Š ç”Ÿæˆå…§å®¹ï¼š</strong></p>
        <div class="mode3-result-types">
          <div class="mode3-result-type">
            <strong>ğŸ­ IP Profile</strong>
            <p>å€‹äººå“ç‰Œæª”æ¡ˆï¼šäººè¨­æ¨™ç±¤ã€å“ç‰ŒåŸå‹ã€èªæ°£è¨­å®š</p>
          </div>
          <div class="mode3-result-type">
            <strong>ğŸ“… 14å¤©è¦åŠƒ</strong>
            <p>è©³ç´°çš„çŸ­å½±éŸ³å…§å®¹è¦åŠƒè¡¨</p>
          </div>
          <div class="mode3-result-type">
            <strong>ğŸ“ ä»Šæ—¥è…³æœ¬</strong>
            <p>3æ”¯å³æ™‚å¯ç”¨çš„çŸ­å½±éŸ³è…³æœ¬</p>
          </div>
        </div>
        
        <p><strong>ğŸ’¡ é‡è¦æé†’ï¼š</strong></p>
        <ul>
          <li>âœ… <strong>éš¨æ™‚å¯ä»¥ç”Ÿæˆ</strong>ï¼šä¸éœ€è¦ç­‰AIæé†’</li>
          <li>âœ… <strong>å»ºè­°é †åº</strong>ï¼šIP Profile â†’ 14å¤©è¦åŠƒ â†’ ä»Šæ—¥è…³æœ¬</li>
          <li>âœ… <strong>å¯ä»¥é‡è¤‡ç”Ÿæˆ</strong>ï¼šä¸æ»¿æ„å°±é»ã€ŒğŸ”„ é‡æ–°ç”Ÿæˆã€</li>
          <li>âœ… <strong>AIæœ‰è¨˜æ†¶</strong>ï¼šæœƒè¨˜ä½æ‚¨ä¹‹å‰èªªéçš„å…§å®¹</li>
        </ul>
      </div>
    </div>
    
    <!-- IPäººè¨­è¦åŠƒç”ŸæˆçµæœæŠ½å±œ -->
    <div class="mode3-results-overlay" id="mode3ResultsOverlay" onclick="closeMode3ResultsDrawer()"></div>
    <div class="mode3-results-drawer" id="mode3ResultsDrawer">
      <div class="mode3-results-drawer-header">
        <h3>ğŸ“Š ç”Ÿæˆçµæœ</h3>
        <button class="mode3-results-drawer-close" onclick="closeMode3ResultsDrawer()">âœ•</button>
      </div>
      <div class="mode3-results-drawer-content">
        <!-- çµæœæ¨™ç±¤ -->
        <div class="mode3-tabs">
          <button class="mode3-tab active" onclick="switchMode3Tab('profile', event)">ã€ŠIP Profileã€‹</button>
          <button class="mode3-tab" onclick="switchMode3Tab('plan', event)">ã€Š14å¤©çŸ­å½±éŸ³è¦åŠƒè¡¨ã€‹</button>
          <button class="mode3-tab" onclick="switchMode3Tab('scripts', event)">ã€Šä»Šæ—¥3æ”¯è…³æœ¬ã€‹</button>
        </div>

        <!-- çµæœå…§å®¹ -->
        <div class="mode3-results-content">
          <!-- IP Profile çµæœ -->
          <div id="mode3-profile-result" class="mode3-result-block active">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">ğŸ­</div>
              <h4>IP Profile</h4>
              <p>èˆ‡AIå°è©±å¾Œï¼Œå°‡åœ¨æ­¤é¡¯ç¤ºæ‚¨çš„å€‹äººå“ç‰Œæª”æ¡ˆ</p>
              <button class="mode3-generate-btn" onclick="generateMode3IPProfile()">
                <span>ğŸš€</span> ç”ŸæˆIP Profile
              </button>
            </div>
          </div>

          <!-- 14å¤©è¦åŠƒçµæœ -->
          <div id="mode3-plan-result" class="mode3-result-block">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">ğŸ“…</div>
              <h4>14å¤©çŸ­å½±éŸ³è¦åŠƒ</h4>
              <p>åŸºæ–¼æ‚¨çš„IP Profileï¼Œç”Ÿæˆè©³ç´°çš„å…§å®¹è¦åŠƒ</p>
              <button class="mode3-generate-btn" onclick="generateMode314DayPlan()">
                <span>ğŸš€</span> ç”Ÿæˆ14å¤©è¦åŠƒ
              </button>
            </div>
          </div>

          <!-- ä»Šæ—¥è…³æœ¬çµæœ -->
          <div id="mode3-scripts-result" class="mode3-result-block">
            <div class="mode3-result-placeholder">
              <div class="mode3-placeholder-icon">ğŸ“</div>
              <h4>ä»Šæ—¥3æ”¯è…³æœ¬</h4>
              <p>æ ¹æ“šæ‚¨çš„è¦åŠƒï¼Œç”Ÿæˆä»Šæ—¥å¯ç”¨çš„è…³æœ¬</p>
              <button class="mode3-generate-btn" onclick="generateMode3TodayScripts()">
                <span>ğŸš€</span> ç”Ÿæˆä»Šæ—¥è…³æœ¬
              </button>
            </div>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="mode3-result-actions">
          <button class="mode3-action-btn" onclick="saveMode3Result()" title="å„²å­˜çµæœ">
            <span>ğŸ’¾</span> å„²å­˜çµæœ
          </button>
          <button class="mode3-action-btn" onclick="regenerateMode3Result()" title="é‡æ–°ç”Ÿæˆ">
            <span>ğŸ”„</span> é‡æ–°ç”Ÿæˆ
          </button>
          <button class="mode3-action-btn" onclick="exportMode3Result()" title="åŒ¯å‡ºçµæœ">
            <span>ğŸ“¤</span> åŒ¯å‡ºçµæœ
          </button>
        </div>
      </div>
    </div>

    <!-- å½ˆå‡ºæç¤ºæ¡† -->
    <div id="toast" class="toast" style="display: none;"></div>

    <!-- Mode1 å°ˆç”¨ JavaScriptï¼ˆIPäººè¨­è¦åŠƒï¼‰ -->
    <script>
      // API_BASE_URL å·²åœ¨ config.js ä¸­å®šç¾©ç‚ºå…¨å±€è®Šæ•¸
      // é€™è£¡ç›´æ¥ä½¿ç”¨ window.APP_CONFIGï¼Œé¿å…é‡è¤‡è²æ˜
      const API_URL = window.APP_CONFIG?.API_BASE || 'https://aivideobackend.zeabur.app';
      let ipPlanningToken = localStorage.getItem('ipPlanningToken') || '';
      let ipPlanningUser = JSON.parse(localStorage.getItem('ipPlanningUser') || 'null');
      let isMode3Sending = false;
      let mode3ChatInitialized = false;
      let currentMode3ConversationType = 'ip_planning';

      // é é¢åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async function() {
        // æª¢æŸ¥æ¬Šé™ï¼ˆéœ€è¦ç™»å…¥å’Œè¨‚é–±ï¼‰
        if (window.ReelMindCommon) {
          const hasAccess = await window.ReelMindCommon.checkFeatureAccess();
          if (!hasAccess) {
            return;
          }
        }

        // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
        updateUserInfo();
        
        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        initMode3Chat();

        // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
        if (window.Auth && window.Auth.getToken()) {
          ipPlanningToken = window.Auth.getToken();
        }
        // å¾ localStorage æˆ– common.js ç²å–ç”¨æˆ¶è³‡è¨Š
        if (window.ReelMindCommon && window.ReelMindCommon.getUser) {
          ipPlanningUser = window.ReelMindCommon.getUser();
        } else {
          const userStr = localStorage.getItem('ipPlanningUser');
          ipPlanningUser = userStr ? JSON.parse(userStr) : null;
        }
      });

      // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
      function updateUserInfo() {
        if (window.ReelMindCommon && window.ReelMindCommon.isLoggedIn()) {
          const user = window.ReelMindCommon.getUser();
          if (user) {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const authButtons = document.getElementById('authButtons');
            const userDBTab = document.getElementById('userDBTab');
            
            if (userInfo && userAvatar && userName) {
              userAvatar.src = user.picture || user.avatar || 'https://via.placeholder.com/32';
              userName.textContent = user.name || 'ç”¨æˆ¶';
              userInfo.style.display = 'flex';
              if (authButtons) authButtons.style.display = 'none';
              if (userDBTab) userDBTab.style.display = 'inline-block';
            }
          }
        } else {
          const userInfo = document.getElementById('userInfo');
          const authButtons = document.getElementById('authButtons');
          if (userInfo) userInfo.style.display = 'none';
          if (authButtons) authButtons.style.display = 'block';
        }
      }

      // åˆå§‹åŒ– Mode3 èŠå¤©åŠŸèƒ½
      function initMode3Chat() {
        const messageInput = document.getElementById('mode3-messageInput');
        const sendBtn = document.getElementById('mode3-sendBtn');
        const quickButtons = document.getElementById('mode3-quickButtons');
        
        if (!messageInput || !sendBtn || !quickButtons) return;
        
        if (mode3ChatInitialized) {
          sendBtn.disabled = !messageInput.value.trim();
          return;
        }
        mode3ChatInitialized = true;
        
        // è¼¸å…¥æ¡†è‡ªå‹•èª¿æ•´é«˜åº¦
        messageInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 100) + 'px';
          sendBtn.disabled = !this.value.trim();
        });
        
        // ç™¼é€æŒ‰éˆ•
        sendBtn.addEventListener('click', () => {
          const message = messageInput.value.trim();
          if (message) {
            sendMode3Message(message);
          }
        });
        
        // Enter ç™¼é€
        messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
              sendMode3Message(message);
            }
          }
        });
        
        // å¿«é€ŸæŒ‰éˆ•
        quickButtons.addEventListener('click', (e) => {
          e.stopPropagation();
          const btn = e.target.closest('.quick-btn');
          if (btn && btn.closest('.mode3-page') && quickButtons.id === 'mode3-quickButtons') {
            e.preventDefault();
            const text = btn.getAttribute('data-text');
            if (text) {
              sendMode3Message(text, 'ip_planning');
            }
          }
        });
      }

      // ç™¼é€ Mode3 è¨Šæ¯
      async function sendMode3Message(message, conversationType = 'ip_planning') {
        if (isMode3Sending) {
          console.log('è¨Šæ¯ç™¼é€ä¸­ï¼Œè«‹ç¨å€™...');
          return;
        }
        
        currentMode3ConversationType = conversationType;
        if (!message || !message.trim()) return;
        
        isMode3Sending = true;
        
        const chatMessages = document.getElementById('mode3-chatMessages');
        const messageInput = document.getElementById('mode3-messageInput');
        const sendBtn = document.getElementById('mode3-sendBtn');
        const quickButtons = document.getElementById('mode3-quickButtons');
        
        if (!chatMessages || !messageInput || !sendBtn) return;
        
        const token = localStorage.getItem('ipPlanningToken') || 
                     (window.Auth && window.Auth.getToken ? window.Auth.getToken() : null);
        const userStr = localStorage.getItem('ipPlanningUser');
        const user = userStr ? JSON.parse(userStr) : null;
        
        // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
        const userMessage = createMode3Message('user', message);
        chatMessages.appendChild(userMessage);
        
        // éš±è—å¿«é€ŸæŒ‰éˆ•
        if (quickButtons) {
          quickButtons.style.display = 'none';
        }
        
        // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦ç¦ç”¨
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        messageInput.style.height = 'auto';
        
        // è¨˜éŒ„é•·æœŸè¨˜æ†¶
        try {
          await recordMode3ConversationMessage(conversationType, 'user', message, token, user);
        } catch (error) {
          console.error('è¨˜éŒ„é•·æœŸè¨˜æ†¶éŒ¯èª¤:', error);
        }
        
        // æ·»åŠ è¼‰å…¥å‹•ç•«
        const aiMessage = createMode3Message('assistant', '');
        const contentDiv = aiMessage.querySelector('.message-content');
        contentDiv.innerHTML = `
          <div class="typing-indicator">
            <span>AIæ€è€ƒä¸­...</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        chatMessages.appendChild(aiMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          const response = await fetch(`${API_URL}/api/chat/stream`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token && { 'Authorization': `Bearer ${token}` })
            },
            body: JSON.stringify({
              message: message,
              history: [],
              user_id: user?.user_id || null
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // è™•ç†ä¸²æµå›æ‡‰
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let fullContent = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') {
                  try {
                    await recordMode3ConversationMessage(currentMode3ConversationType, 'assistant', fullContent, token, user);
                  } catch (error) {
                    console.error('è¨˜éŒ„é•·æœŸè¨˜æ†¶éŒ¯èª¤:', error);
                  }
                  break;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.content) {
                    fullContent += parsed.content;
                    contentDiv.innerHTML = renderMode3Markdown(fullContent);
                    
                    // èªæ³•é«˜äº®
                    if (typeof hljs !== 'undefined') {
                      contentDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                          hljs.highlightElement(block);
                        }
                      });
                    }
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                } catch (e) {
                  // å¿½ç•¥è§£æéŒ¯èª¤
                }
              }
            }
          }
        } catch (error) {
          console.error('ç™¼é€è¨Šæ¯éŒ¯èª¤:', error);
          if (contentDiv) {
            const safeErrorMsg = window.escapeHtml ? window.escapeHtml(error.message || 'æœªçŸ¥éŒ¯èª¤') : (error.message || 'æœªçŸ¥éŒ¯èª¤');
            contentDiv.innerHTML = `æŠ±æ­‰ï¼Œç™¼ç”Ÿäº†éŒ¯èª¤ï¼š${safeErrorMsg}`;
          } else {
            const errorMessage = createMode3Message('assistant', `æŠ±æ­‰ï¼Œç™¼ç”Ÿäº†éŒ¯èª¤ï¼š${error.message}`);
            chatMessages.appendChild(errorMessage);
          }
        } finally {
          messageInput.disabled = false;
          sendBtn.disabled = false;
          if (quickButtons) {
            quickButtons.style.display = 'flex';
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
          isMode3Sending = false;
        }
      }

      // å‰µå»º Mode3 è¨Šæ¯å…ƒç´ 
      function createMode3Message(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        
        if (role === 'user') {
          const userStr = localStorage.getItem('ipPlanningUser');
          const user = userStr ? JSON.parse(userStr) : null;
          if (user && user.picture) {
            const img = document.createElement('img');
            img.src = user.picture;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            avatar.appendChild(img);
          } else {
            const userName = user?.name || 'U';
            avatar.textContent = userName.charAt(0).toUpperCase();
          }
        } else {
          avatar.textContent = 'ğŸ¤–';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        if (content) {
          contentDiv.innerHTML = renderMode3Markdown(content);
        }
        
        if (role === 'user') {
          messageDiv.appendChild(contentDiv);
          messageDiv.appendChild(avatar);
        } else {
          messageDiv.appendChild(avatar);
          messageDiv.appendChild(contentDiv);
        }
        
        return messageDiv;
      }

      // Markdown æ¸²æŸ“
      function renderMode3Markdown(text) {
        if (typeof marked !== 'undefined') {
          return marked.parse(text);
        }
        return text.replace(/\n/g, '<br>');
      }

      // è¨˜éŒ„ Mode3 é•·æœŸè¨˜æ†¶
      async function recordMode3ConversationMessage(conversationType, role, content, token, user) {
        if (!token || !content) return;
        
        try {
          const user_id = user?.user_id || 
            (token ? JSON.parse(atob(token.split('.')[1])).user_id : null);
          
          if (!user_id) {
            console.warn('ç„¡æ³•ç²å– user_idï¼Œè·³éé•·æœŸè¨˜æ†¶è¨˜éŒ„');
            return;
          }
          
          const session_id = `${conversationType}_${user_id}_${Date.now()}`;
          
          await fetch(`${API_URL}/api/memory/long-term`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              conversation_type: conversationType,
              session_id: session_id,
              message_role: role,
              message_content: content,
              metadata: JSON.stringify({ user_id: user_id })
            })
          });
        } catch (error) {
          console.error('è¨˜éŒ„é•·æœŸè¨˜æ†¶éŒ¯èª¤:', error);
        }
      }

      // åˆ‡æ›èªªæ˜æŠ½å±œ
      function toggleMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          const isOpen = overlay.classList.contains('open');
          
          if (isOpen) {
            closeMode3InstructionsDrawer();
          } else {
            openMode3InstructionsDrawer();
          }
        }
      }

      function openMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.add('open');
          drawer.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeMode3InstructionsDrawer() {
        const overlay = document.getElementById('mode3InstructionsOverlay');
        const drawer = document.getElementById('mode3InstructionsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.remove('open');
          drawer.classList.remove('open');
          document.body.style.overflow = '';
        }
      }

      // åˆ‡æ›çµæœæŠ½å±œ
      function toggleMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          const isOpen = overlay.classList.contains('open');
          
          if (isOpen) {
            closeMode3ResultsDrawer();
          } else {
            openMode3ResultsDrawer();
          }
        }
      }

      function openMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.add('open');
          drawer.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeMode3ResultsDrawer() {
        const overlay = document.getElementById('mode3ResultsOverlay');
        const drawer = document.getElementById('mode3ResultsDrawer');
        
        if (overlay && drawer) {
          overlay.classList.remove('open');
          drawer.classList.remove('open');
          document.body.style.overflow = '';
        }
      }

      // åˆ‡æ›çµæœæ¨™ç±¤
      function switchMode3Tab(tabName, event) {
        document.querySelectorAll('.mode3-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        document.querySelectorAll('.mode3-result-block').forEach(block => {
          block.classList.remove('active');
        });
        
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          const tabs = document.querySelectorAll('.mode3-tab');
          tabs.forEach(tab => {
            if (tab.textContent.includes(tabName === 'profile' ? 'IP Profile' : tabName === 'plan' ? '14å¤©' : 'ä»Šæ—¥')) {
              tab.classList.add('active');
            }
          });
        }
        
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        if (resultBlock) {
          resultBlock.classList.add('active');
        }
      }

      // ç”ŸæˆIP Profile
      async function generateMode3IPProfile() {
        const resultBlock = document.getElementById('mode3-profile-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>â³</span> ç”Ÿæˆä¸­...';
        
        try {
          const response = await fetch(`${API_URL}/api/chat/stream`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: 'è«‹æ ¹æ“šæˆ‘å€‘çš„å°è©±å…§å®¹ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´çš„IP Profileã€‚è«‹ä½¿ç”¨è‡ªç„¶èªè¨€ã€å‹å–„çš„èªæ°£ï¼Œä»¥æ¸…æ™°æ˜“æ‡‚çš„æ–¹å¼å‘ˆç¾ã€‚é‡è¦æ¨™é¡Œå’Œé—œéµè©è«‹ä½¿ç”¨**ç²—é«”**æ¨™è¨˜ï¼ˆMarkdownæ ¼å¼ï¼‰ã€‚çµ•å°ä¸è¦å‡ºç¾ä»»ä½•ç¨‹å¼ç¢¼ã€æŠ€è¡“è¡“èªæˆ–è¤‡é›œçš„çµæ§‹åŒ–æ ¼å¼ã€‚å…§å®¹åŒ…å«ï¼š1.**äººè¨­æ¨™ç±¤**ï¼šåˆ—å‡º3-5å€‹æ¨™ç±¤ï¼Œç”¨è‡ªç„¶èªè¨€æè¿° 2.**ä¸€å¥è©±å®šä½**ï¼šç”¨ä¸€å¥è©±æ¸…æ¥šèªªæ˜å€‹äººå®šä½ 3.**å“ç‰ŒåŸå‹**ï¼šç°¡æ½”æè¿°å“ç‰ŒåŸå‹å’Œç‰¹è³ª 4.**èªæ°£è¨­å®š**ï¼šç”¨å‹å–„çš„èªè¨€èªªæ˜èªæ°£ç‰¹é» 5.**æ ¸å¿ƒåƒ¹å€¼è§€**ï¼šåˆ—å‡º3-5å€‹æ ¸å¿ƒåƒ¹å€¼ï¼Œç”¨ç°¡çŸ­å¥å­èªªæ˜ 6.**ç¦èªæ¸…å–®**ï¼šåˆ—å‡ºæ‡‰è©²é¿å…ä½¿ç”¨çš„è©å½™å’Œè¡¨é”æ–¹å¼ 7.**è¦–è¦ºè¨­å®š**ï¼šæè¿°è¦–è¦ºé¢¨æ ¼ã€é…è‰²ã€å­—é«”ç­‰ï¼Œç”¨è‡ªç„¶èªè¨€ 8.**KPIæŒ‡æ¨™**ï¼šèªªæ˜é—œéµæŒ‡æ¨™ï¼Œç”¨æ˜“æ‡‚çš„æ–¹å¼å‘ˆç¾',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: 'çŸ­å½±éŸ³å¹³å°',
              profile: 'IPäººè¨­è¦åŠƒå°ˆå®¶',
              topic: 'IP Profileç”Ÿæˆ',
              style: 'è‡ªç„¶èªè¨€ã€ç”¨æˆ¶å‹å¥½ã€æ˜“è®€æ˜“æ‡‚ï¼Œä½¿ç”¨Markdownç²—é«”æ¨™è¨˜é‡è¦å…§å®¹ï¼Œä¸è¦ç¨‹å¼ç¢¼æˆ–æŠ€è¡“æ ¼å¼',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // å¿½ç•¥è§£æéŒ¯èª¤
                  }
                }
              }
            }
            
            const renderedContent = renderMode3Markdown(content);
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>ğŸš€</span> é‡æ–°ç”Ÿæˆ';
            button.disabled = false;
          } else {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
        } catch (error) {
          console.error('ç”ŸæˆIP Profileå¤±æ•—:', error);
          button.innerHTML = '<span>âŒ</span> ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦';
          button.disabled = false;
        }
      }

      // ç”Ÿæˆ14å¤©è¦åŠƒ
      async function generateMode314DayPlan() {
        const resultBlock = document.getElementById('mode3-plan-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>â³</span> ç”Ÿæˆä¸­...';
        
        try {
          const response = await fetch(`${API_URL}/api/chat/stream`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: 'è«‹æ ¹æ“šæˆ‘å€‘çš„å°è©±å…§å®¹å’ŒIP Profileï¼Œç”Ÿæˆä¸€ä»½14å¤©çŸ­å½±éŸ³è¦åŠƒè¡¨ã€‚è«‹ä½¿ç”¨è‡ªç„¶èªè¨€ã€å‹å–„çš„èªæ°£ï¼Œä»¥æ¸…æ™°æ˜“æ‡‚çš„æ–¹å¼å‘ˆç¾æ¯ä¸€å¤©çš„è¦åŠƒã€‚é‡è¦æ¨™é¡Œå’Œé—œéµè©è«‹ä½¿ç”¨**ç²—é«”**æ¨™è¨˜ï¼ˆMarkdownæ ¼å¼ï¼‰ã€‚çµ•å°ä¸è¦å‡ºç¾ä»»ä½•ç¨‹å¼ç¢¼ã€è¡¨æ ¼ç¬¦è™Ÿæˆ–è¤‡é›œçš„çµæ§‹åŒ–æ ¼å¼ã€‚æ¯ä¸€å¤©çš„è¦åŠƒè«‹åŒ…å«ï¼š1.**æ¯æ—¥ä¸»é¡Œ**ï¼šç”¨ä¸€å¥è©±èªªæ˜ç•¶å¤©çš„ä¸»é¡Œ 2.**å…§å®¹æ–¹å‘**ï¼šç”¨2-3å¥è‡ªç„¶èªè¨€æè¿°å…§å®¹é‡é» 3.**æ‹æ”å»ºè­°**ï¼šç”¨ç°¡çŸ­æ˜“æ‡‚çš„å¥å­èªªæ˜æ‹æ”è¦é» 4.**ç™¼å¸ƒæ™‚é–“**ï¼šå»ºè­°ç™¼å¸ƒæ™‚æ®µ 5.**äº’å‹•ç­–ç•¥**ï¼šç”¨ä¸€å¥è©±èªªæ˜å¦‚ä½•èˆ‡è§€çœ¾äº’å‹•ã€‚è«‹å°‡æ¯ä¸€å¤©çš„å…§å®¹ç”¨æ¸…æ™°çš„æ®µè½åˆ†éš”ï¼Œè®“ç”¨æˆ¶å®¹æ˜“é–±è®€ã€‚',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: 'çŸ­å½±éŸ³å¹³å°',
              profile: 'IPäººè¨­è¦åŠƒå°ˆå®¶',
              topic: '14å¤©è¦åŠƒç”Ÿæˆ',
              style: 'è‡ªç„¶èªè¨€ã€ç”¨æˆ¶å‹å¥½ã€æ˜“è®€æ˜“æ‡‚ï¼Œä½¿ç”¨Markdownç²—é«”æ¨™è¨˜é‡è¦å…§å®¹ï¼Œä¸è¦ç¨‹å¼ç¢¼æˆ–è¡¨æ ¼æ ¼å¼',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // å¿½ç•¥è§£æéŒ¯èª¤
                  }
                }
              }
            }
            
            const renderedContent = renderMode3Markdown(content);
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>ğŸš€</span> é‡æ–°ç”Ÿæˆ';
            button.disabled = false;
          } else {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
        } catch (error) {
          console.error('ç”Ÿæˆ14å¤©è¦åŠƒå¤±æ•—:', error);
          button.innerHTML = '<span>âŒ</span> ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦';
          button.disabled = false;
        }
      }

      // ç”Ÿæˆä»Šæ—¥è…³æœ¬
      async function generateMode3TodayScripts() {
        const resultBlock = document.getElementById('mode3-scripts-result');
        const button = resultBlock.querySelector('.mode3-generate-btn');
        
        button.disabled = true;
        button.innerHTML = '<span>â³</span> ç”Ÿæˆä¸­...';
        
        try {
          const response = await fetch(`${API_URL}/api/chat/stream`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ipPlanningToken}`
            },
            body: JSON.stringify({
              message: 'è«‹æ ¹æ“šæˆ‘å€‘çš„å°è©±å…§å®¹å’ŒIP Profileï¼Œç”Ÿæˆä»Šæ—¥3æ”¯çŸ­å½±éŸ³è…³æœ¬ã€‚è«‹ä½¿ç”¨è‡ªç„¶èªè¨€ã€å‹å–„çš„èªæ°£ï¼Œä»¥æ¸…æ™°æ˜“æ‡‚çš„æ–¹å¼å‘ˆç¾ã€‚é‡è¦æ¨™é¡Œå’Œé—œéµè©è«‹ä½¿ç”¨**ç²—é«”**æ¨™è¨˜ï¼ˆMarkdownæ ¼å¼ï¼‰ã€‚çµ•å°ä¸è¦å‡ºç¾ä»»ä½•ç¨‹å¼ç¢¼ã€æŠ€è¡“è¡“èªæˆ–è¤‡é›œçš„çµæ§‹åŒ–æ ¼å¼ã€‚æ¯æ”¯è…³æœ¬è«‹åŒ…å«ï¼š1.**ä¸»é¡Œæ¨™é¡Œ**ï¼šç”¨ä¸€å¥è©±æ¸…æ¥šèªªæ˜é€™æ”¯å½±ç‰‡çš„ä¸»é¡Œ 2.**é–‹å ´é‰¤å­**ï¼šç”¨è‡ªç„¶èªè¨€å¯«å‡ºå¸å¼•äººçš„é–‹å ´ï¼Œè®“è§€çœ¾æƒ³ç¹¼çºŒçœ‹ä¸‹å» 3.**æ ¸å¿ƒå…§å®¹**ï¼šç”¨2-3å¥è‡ªç„¶èªè¨€èªªæ˜å½±ç‰‡è¦å‚³é”çš„åƒ¹å€¼ 4.**è¡Œå‹•å‘¼ç±²**ï¼šç”¨ä¸€å¥è©±å¼•å°è§€çœ¾æ¡å–è¡Œå‹• 5.**ç•«é¢æè¿°**ï¼šç”¨ç°¡çŸ­æ˜“æ‡‚çš„å¥å­æè¿°ç•«é¢æ‡‰è©²å‘ˆç¾ä»€éº¼ 6.**ç™¼ä½ˆæ–‡æ¡ˆ**ï¼šå¯«ä¸€æ®µé©åˆç¤¾ç¾¤åª’é«”çš„æ–‡æ¡ˆã€‚è«‹å°‡æ¯æ”¯è…³æœ¬ç”¨æ¸…æ™°çš„æ®µè½åˆ†éš”ï¼Œè®“ç”¨æˆ¶å®¹æ˜“é–±è®€å’Œä½¿ç”¨ã€‚',
              user_id: ipPlanningUser?.user_id || 'anonymous',
              platform: 'çŸ­å½±éŸ³å¹³å°',
              profile: 'IPäººè¨­è¦åŠƒå°ˆå®¶',
              topic: 'ä»Šæ—¥è…³æœ¬ç”Ÿæˆ',
              style: 'è‡ªç„¶èªè¨€ã€ç”¨æˆ¶å‹å¥½ã€æ˜“è®€æ˜“æ‡‚ï¼Œä½¿ç”¨Markdownç²—é«”æ¨™è¨˜é‡è¦å…§å®¹ï¼Œä¸è¦ç¨‹å¼ç¢¼æˆ–æŠ€è¡“æ ¼å¼',
              duration: '30'
            })
          });
          
          if (response.ok) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.content) {
                      content += parsed.content;
                    }
                  } catch (e) {
                    // å¿½ç•¥è§£æéŒ¯èª¤
                  }
                }
              }
            }
            
            const renderedContent = renderMode3Markdown(content);
            resultBlock.innerHTML = `<div class="mode3-result-content">${renderedContent}</div>`;
            button.innerHTML = '<span>ğŸš€</span> é‡æ–°ç”Ÿæˆ';
            button.disabled = false;
          } else {
            throw new Error('ç”Ÿæˆå¤±æ•—');
          }
        } catch (error) {
          console.error('ç”Ÿæˆä»Šæ—¥è…³æœ¬å¤±æ•—:', error);
          button.innerHTML = '<span>âŒ</span> ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦';
          button.disabled = false;
        }
      }

      // å„²å­˜çµæœ
      async function saveMode3Result() {
        const token = localStorage.getItem('ipPlanningToken');
        const userStr = localStorage.getItem('ipPlanningUser');
        
        if (!token || !userStr) {
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('è«‹å…ˆç™»å…¥', 3000);
          }
          return;
        }
        
        try {
          const user = JSON.parse(userStr);
          const activeTab = document.querySelector('.mode3-tab.active');
          if (!activeTab) {
            if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
              window.ReelMindCommon.showToast('è«‹å…ˆé¸æ“‡è¦å„²å­˜çš„çµæœ', 3000);
            }
            return;
          }
          
          let resultType = '';
          let title = '';
          if (activeTab.textContent.includes('Profile')) {
            resultType = 'profile';
            title = 'IP Profile';
          } else if (activeTab.textContent.includes('è¦åŠƒ')) {
            resultType = 'plan';
            title = '14å¤©çŸ­å½±éŸ³è¦åŠƒ';
          } else if (activeTab.textContent.includes('è…³æœ¬')) {
            resultType = 'scripts';
            title = 'ä»Šæ—¥3æ”¯è…³æœ¬';
          }
          
          const resultBlock = document.getElementById(`mode3-${resultType}-result`);
          const content = resultBlock.querySelector('.mode3-result-content');
          
          if (!content || !content.innerHTML.trim()) {
            if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
              window.ReelMindCommon.showToast('æ²’æœ‰å¯å„²å­˜çš„å…§å®¹', 3000);
            }
            return;
          }
          
          const textContent = content.innerText || content.textContent || '';
          const shortTitle = textContent.substring(0, 50) || title;
          
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('æ­£åœ¨å„²å­˜...', 2000);
          }
          
          const response = await fetch(`${API_URL}/api/ip-planning/save`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              user_id: user.user_id,
              result_type: resultType,
              title: shortTitle,
              content: content.innerHTML,
              metadata: {
                timestamp: new Date().toISOString(),
                source: 'mode3'
              }
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'ç¶²è·¯éŒ¯èª¤' }));
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }
          
          const data = await response.json();
          if (data.success) {
            if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
              window.ReelMindCommon.showToast('âœ… çµæœå·²å„²å­˜åˆ°å€‹äººè³‡æ–™åº«', 3000);
            }
          } else {
            if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
              window.ReelMindCommon.showToast('âŒ ' + (data.error || 'å„²å­˜å¤±æ•—'), 3000);
            }
          }
        } catch (error) {
          console.error('å„²å­˜çµæœå¤±æ•—:', error);
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + (error.message || 'è«‹ç¨å¾Œå†è©¦'), 3000);
          }
        }
      }

      // é‡æ–°ç”Ÿæˆçµæœ
      function regenerateMode3Result() {
        const activeTab = document.querySelector('.mode3-tab.active');
        if (activeTab) {
          const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                         activeTab.textContent.includes('è¦åŠƒ') ? 'plan' : 'scripts';
          
          if (tabName === 'profile') {
            generateMode3IPProfile();
          } else if (tabName === 'plan') {
            generateMode314DayPlan();
          } else if (tabName === 'scripts') {
            generateMode3TodayScripts();
          }
        }
      }

      // åŒ¯å‡ºçµæœ
      function exportMode3Result() {
        const activeTab = document.querySelector('.mode3-tab.active');
        if (!activeTab) {
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„çµæœ', 3000);
          }
          return;
        }
        
        const tabName = activeTab.textContent.includes('Profile') ? 'profile' : 
                       activeTab.textContent.includes('è¦åŠƒ') ? 'plan' : 'scripts';
        
        const resultBlock = document.getElementById(`mode3-${tabName}-result`);
        const content = resultBlock.querySelector('.mode3-result-content');
        
        if (!content || !content.innerHTML.trim()) {
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„å…§å®¹', 3000);
          }
          return;
        }
        
        try {
          const textContent = content.innerText || content.textContent || '';
          
          const csvContent = `é¡å‹,æ¨™é¡Œ,å…§å®¹,åŒ¯å‡ºæ™‚é–“\n"${tabName}","${tabName === 'profile' ? 'IP Profile' : tabName === 'plan' ? '14å¤©è¦åŠƒ' : 'ä»Šæ—¥è…³æœ¬'}","${textContent.replace(/"/g, '""').replace(/\n/g, ' ')}","${new Date().toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          })}"`;
          
          const csvBlob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const csvUrl = URL.createObjectURL(csvBlob);
          const csvLink = document.createElement('a');
          csvLink.href = csvUrl;
          csvLink.download = `ip-${tabName}-${Date.now()}.csv`;
          csvLink.click();
          URL.revokeObjectURL(csvUrl);
          
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('âœ… çµæœå·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆ', 3000);
          }
        } catch (error) {
          console.error('åŒ¯å‡ºå¤±æ•—:', error);
          if (window.ReelMindCommon && window.ReelMindCommon.showToast) {
            window.ReelMindCommon.showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 3000);
          }
        }
      }

      // ç™»å…¥å‡½æ•¸
      function goToLogin() {
        if (window.ReelMindCommon && window.ReelMindCommon.goToLogin) {
          window.ReelMindCommon.goToLogin();
        } else {
          window.location.href = 'index.html';
        }
      }

      // æ‰‹æ©Ÿç‰ˆæŠ½å±œåˆ‡æ›
      function toggleMobileDrawer() {
        console.log('Toggle mobile drawer');
      }
    </script>
  </body>
</html>

